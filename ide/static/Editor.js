function Editor(
	render,
	persistence,
	items,
	translate,
	userId
) {

var tr = translate

var self = this;

var Items = items;

var RoundedRadius = 8

var gDragStartItem = null
var gDragItems = []
var gFreeBuilders = {}
var gMoveAllPos = null
var gMoveAllPrim = null
var gShouldMoveAll = false
var gNoLink = Utils.listToSet([
	"junction",
	"vertical",
	"horizontal",
	"f_line",
	"f_more",
	"f_label",
	"duration",
	"loopbegin",
	"loopend",
	"ctrlStart",
	"ctrlEnd",
	"pause",
	"timer",
	"address",
	"gdur",
	"end",
	"f_cloud",
	"f_ptr_left",
	"f_ptr_right"
])

var gUserSettings = {}

// Working data
this.readonly = false
this.render = render;
this.canvas = new CanvasCache(render);
this.storage = new Storage(persistence);
this.undo = new Undo();
this.persistence = persistence;
this.grips = [];




var gFormatNames = [
  "font",
  "align",
  "padding",
  "lineColor",
  "lineThickness",
  "textColor",
  "fillColor",
  "secondaryColor",
  "shadow",
  "lineStyle",
  "arrowStart",
  "arrowEnd"
]

var gNonCopiableFields = {
  tb: true,
  primitives: true
}

// Public methods

this.renameDiagram = renameDiagram
this.buildTextBoxes = buildTextBoxes
this.setReadonly = setReadonly
this.findVisualItem = findVisualItem;
this.startVisualDrag = startVisualDrag;
this.visualDrag = visualDrag;
this.endVisualDrag = endVisualDrag;
this.findSocket = findSocket;
this.fireSocket = fireSocket;
this.darkenSocket = darkenSocket;
this.clickSocket = clickSocket;

this.loadDiagram = loadDiagram;
this.createDiagram = createDiagram;
this.diagramToJson = diagramToJson;
this.autoSizeIcons = autoSizeIcons;

this.hit = hit;
this.setCallback = setCallback;

this.canEditText = canEditText;
this.startEditText = startEditText;
this.startEditTextAt = startEditTextAt;
this.measureDiagram = measureDiagram;
this.getIconCount = getIconCount;

this.showInsertionSockets = showInsertionSockets;
this.performUndo = performUndo;
this.performRedo = performRedo;
this.clearUndo = clearUndo;
this.toggleSilhouette = toggleSilhouette;
this.drawToOtherRender = drawToOtherRender;
this.addParameters = addParameters;
this.drawToOtherRender = drawToOtherRender;
this.mouseClick = mouseClick;
this.buildBlockMenu = buildBlockMenu;
this.deselect = deselect;
this.blockSelect = blockSelect;
this.beginBlockSelect = beginBlockSelect;
this.isSelected = isSelected;
this.deleteSelection = deleteSelection;

this.redraw = redraw;

this.setItemWidth = setItemWidth;
this.buildMenuAt = buildMenuAt;
this.insertFreeItem = insertFreeItem
this.setFreeItemSize = setFreeItemSize
this.moveHandle = moveHandle
this.saveHandlePos = saveHandlePos
this.getDiagramAsItems = getDiagramAsItems
this.setBackground = setBackground
this.setFormat = setFormat
this.getFormat = getFormat
this.getItemRect = getItemRect
this.getFonts = getFonts
this.getFont = getFont
this.clearFormat = clearFormat
this.getSelection = getSelection
this.copy = copy
this.cut = cut
this.paste = paste
this.selectAll = selectAll
this.findDraggable = findDraggable
this.setContent = setContent
this.setUserSettings = setUserSettings
this.startEdit = startEdit

this.arrowUp = arrowUp
this.arrowDown = arrowDown
this.arrowLeft = arrowLeft
this.arrowRight = arrowRight
this.getItem = getItem
this.selectOneItem = selectOneItem
this.toggleTreeType = toggleTreeType
this.getFontsForItems = getFontsForItems

var Callbacks = {};

var gTransplants = {};
gTransplants.leftInnerLine = leftInnerLine;
gTransplants.leftInnerLineTs = leftInnerLineTs;
gTransplants.leftInnerLineEx = leftInnerLineEx;
gTransplants.leftOuterCorner = leftOuterCorner;
gTransplants.leftInnerCorner = leftInnerCorner;
gTransplants.topOuterCorner = topOuterCorner;
gTransplants.topInnerCorner = topInnerCorner;
gTransplants.createCycle = createCycle;
gTransplants.onOuterFloor = onOuterFloor;
gTransplants.onInnerFloor = onInnerFloor;
gTransplants.rightLine = rightLine;
gTransplants.leftOuterLine = leftOuterLine;
gTransplants.leftOuterLineTs = leftOuterLineTs;
gTransplants.rightCorner = rightCorner;
gTransplants.onOuterSilFloor = onOuterSilFloor;
gTransplants.leftOuterCornerSil = leftOuterCornerSil;
gTransplants.shortCycleDown = shortCycleDown;
gTransplants.leftOuterCornerTs = leftOuterCornerTs;



// Autogenerated with DRAKON Editor 1.32


function ActionInfo(name, args) {
    // item 14468
    this.name = name;
    this.args = args;
}

function CanvasCache(render) {
    // item 16328
    this.graph = new Utils.Manhattan()
    this.free = new Utils.SortedSet()
    this.render = render
    this.sockets = []
    // item 1021
    this.pgraph = createPhysicalGraph(
    	this.graph,
    	render
    )
}

function Command(type, table, id, action) {
    // item 2282
    this.type = type;
    this.table = table;
    this.id = id;
    this.fields = action || {};
    this.undo = null;
}

function Draggable(id, type, dims) {
    // item 16225
    this.id = id;
    this.type = type;
    this.dims = dims;
}

function Grip(id, type, dims, box, touchBox) {
    // item 16232
    this.id = id;
    this.type = type;
    this.dims = dims;
    this.box = box;
    this.touchBox = touchBox;
}

function Guide(edge, min, max) {
    // item 19508
    this.edge = edge
    this.min = min
    this.max = max
    this.found = false
}

function MinDistFinder(referenceItem, itemId, criteria) {
    // item 20154
    this.check = MinDistFinder_check
    // item 20155
    this.referenceItem = referenceItem
    this.itemId = itemId
    this.criteria = criteria
    // item 20168
    this.minDist = 2000000000
    this.found = null
}

function MinDistFinder_check(id, item) {
    // item 20164
    if ((id == this.itemId) || (!(this.criteria(item)))) {
        
    } else {
        // item 20163
        var dist = findDistance(
        	this.referenceItem,
        	item
        )
        // item 20161
        if (dist < this.minDist) {
            // item 20162
            this.found = id
            this.minDist = dist
        }
    }
}

function Socket(id, center, type, action) {
    // item 3143
    this.id = id;
    this.center =  Utils.copyPoint(center);
    this.type = type;
    this.action = action;
    this.box = Utils.boxFromPoint(
    	center.x,
    	center.y,
    	Config.SOCKET_TOUCH_RADIUS,
    	Config.SOCKET_TOUCH_RADIUS
    );
}

function SocketInfo(itemId, type, action, name) {
    // item 11677
    this.id = itemId;
    this.type = type;
    this.action = action;
    this.name = name;
}

function Storage(persistence) {
    // item 1269
    this.persistence = persistence;
    this.graph = new Utils.Manhattan();
    this.free = new Utils.SortedSet()
    this.selection = createSelection();
    this.nextId = 1;
}

function StorageItem(id, type, isLine, isVertical) {
    // item 1180
    this.id = id;
    this.type = type;
    this.isLine = isLine;
    this.isVertical = isVertical;
    this.x = 0;
    this.y = 0;
    this.w = 0;
    this.h = 0;
    this.a = 0;
    this.b = 0;
    this.content = null;
    this.head = null;
    this.tail = null;
    this.flag1 = 0;
}

function Undo() {
    // item 1628
    this.next = 0;
    this.steps = [];
}

function accumulateFormat(names, result, filled, content) {
    // item 177690001
    var _ind17769 = 0;
    var _col17769 = names;
    var _len17769 = _col17769.length;
    while (true) {
        // item 177690002
        if (_ind17769 < _len17769) {
            
        } else {
            break;
        }
        // item 177690004
        var name = _col17769[_ind17769];
        // item 17774
        var rvalue = result[name]
        var cvalue = content[name]
        // item 17771
        if (hasValue(cvalue)) {
            // item 17777
            if (filled[name]) {
                // item 17779
                if ((cvalue == rvalue) || (name == "fillColor")) {
                    
                } else {
                    // item 17782
                    result[name] = null
                }
            } else {
                // item 17778
                filled[name] = true
                result[name] = cvalue
            }
        } else {
            // item 17783
            filled[name] = true
            result[name] = null
        }
        // item 177690003
        _ind17769++;
    }
}

function addAllSubs(graph, skewer, result) {
    // item 209980001
    var _ind20998 = 0;
    var _col20998 = skewer.list;
    var _len20998 = _col20998.length;
    while (true) {
        // item 209980002
        if (_ind20998 < _len20998) {
            
        } else {
            break;
        }
        // item 209980004
        var itemId = _col20998[_ind20998];
        // item 21047
        var item = graph.getItem(itemId)
        // item 21000
        if (item.role == "sub") {
            // item 209800001
            var _ind20980 = 0;
            var _col20980 = graph.nodes;
            var _keys20980 = Object.keys(_col20980); 
            var _len20980 = _keys20980.length;
            while (true) {
                // item 209800002
                if (_ind20980 < _len20980) {
                    
                } else {
                    break;
                }
                // item 209800004
                var id = _keys20980[_ind20980]; var node = _col20980[id];
                // item 20982
                if (node.role == "sub") {
                    // item 20985
                    result.add(id)
                }
                // item 209800003
                _ind20980++;
            }
            break;
        }
        // item 209980003
        _ind20998++;
    }
}

function addBlockItems(editor, subgraph, commands) {
    // item 13380
    var idMap = {};
    // item 13381
    addSubgraphItems(
    	editor,
    	subgraph,
    	commands,
    	idMap
    );
    // item 13379
    return {
    	first: idMap[subgraph.first],
    	last: idMap[subgraph.last]
    };
}

function addDrnGrips(editor, id, freeGrips) {
    // item 16244
    var item = getAnyItem(editor.storage, id)
    // item 16251
    var left = item.x - item.w;
    var right = item.x + item.w;
    var top = item.y - item.h;
    var bottom = item.y + item.h;
    // item 16261
    var grips = editor.grips;
    // item 16250
    var dims = {
    	x: item.x,
    	y: item.y,
    	w: item.w,
    	h: item.h
    };
    // item 16794
    if (item.free) {
        // item 18785
        var candies = Items.getCandies(item)
        copyPoints(candies, freeGrips)
        // item 18784
        addGrips(
        	grips,	
        	id,
        	candies,	
        	dims
        )
        // item 17313
        var handles = Items.getHandles(item)
        // item 18783
        addGrips(
        	grips,	
        	id,
        	handles,	
        	dims
        )
    } else {
        // item 16245
        if (((item.isLine) || (item.type == "duration")) || (item.type == "end")) {
            
        } else {
            // item 17355
            if (item.type == "junction") {
                // item 17358
                addGrip(
                	grips,
                	id,
                	item.x,
                	item.y,
                	Const.DRN_MOVE,
                	dims
                );
            } else {
                // item 18782
                var candies = Items.getCandies(item)
                // item 18781
                addGrips(
                	grips,	
                	id,
                	candies,	
                	dims
                )
            }
        }
    }
}

function addDummyJunction(graph, id, x, y, group) {
    // item 12744
    var junc = makeDummyJunction(id, x, y);
    junc.group = group;
    // item 12745
    graph.addItem(junc);
}

function addDummyLine(graph, id, isVertical, head, tail, role) {
    // item 12761
    var item = makeDummyLine(
    	id,
    	isVertical,
    	head,
    	tail,
    	role
    );
    // item 12762
    graph.addItem(item);
}

function addEditLink(editor, item, menu) {
    // item 19835
    if (canHaveLink(item)) {
        // item 19839
        menu.push(
            { type: "item", text: tr("MES_EXTERNAL_LINK") + "...", 
        	code: function(x, y){
                	editLink(editor, item, x, y)
            }}
        );
    }
}

function addFindReferences(menu, item) {
    // item 22686
    if ((item.role == "header") && (Callbacks.findReferences)) {
        // item 22684
        var content = getContent(item)
        // item 22685
        var text = content.txt
        // item 22692
        if (text) {
            // item 22689
            menu.push(
                {
            	type: "item", 
            	text: translate("MES_FIND_REFERENCES"),
            	code: function(){
                    Callbacks.findReferences(text)
                }}
            )
            // item 22690
            menu.push(
                { type: "separator" }
            )
        }
    }
}

function addFollowLink(editor, item, menu) {
    // item 19819
    var content = getContent(item)
    // item 19816
    if (content.link) {
        // item 19876
        var link = Utils.truncateText(
        	content.link,
        	Config.CONTEXT_ITEM_LENGTH + 10
        )
        // item 19821
        menu.push(
            { type: "item", text: link, code: function(){
                followLink(editor, item.id)
            }}
        );
        // item 19864
        menu.push(
            { type: "separator" }
        );
    }
}

function addGrip(grips, id, x, y, type, dims) {
    // item 16258
    var box = Utils.boxFromPoint(
    	x,
    	y,
    	Config.GRIP,
    	Config.GRIP
    );
    // item 16449
    var touchBox = Utils.boxFromPoint(
    	x,
    	y,
    	Config.GRIP_TOUCH,
    	Config.GRIP_TOUCH
    );
    // item 16257
    var grip = new Grip(
    	id,
    	type,
    	dims,
    	box,
    	touchBox
    );
    // item 16259
    grips.push(grip);
}

function addGrips(grips, id, candies, dims) {
    // item 187790001
    var _ind18779 = 0;
    var _col18779 = candies;
    var _len18779 = _col18779.length;
    while (true) {
        // item 187790002
        if (_ind18779 < _len18779) {
            
        } else {
            break;
        }
        // item 187790004
        var candy = _col18779[_ind18779];
        // item 21614
        changeMindGrip(candy)
        // item 18777
        addGrip(
        	grips,
        	id,
        	candy.x,
        	candy.y,
        	candy.name,
        	dims
        );
        // item 187790003
        _ind18779++;
    }
}

function addImagesToMenu(menu, images) {
    // item 215800001
    var _ind21580 = 0;
    var _col21580 = menu;
    var _len21580 = _col21580.length;
    while (true) {
        // item 215800002
        if (_ind21580 < _len21580) {
            
        } else {
            break;
        }
        // item 215800004
        var item = _col21580[_ind21580];
        // item 21582
        if (item.text in images) {
            // item 21585
            item.image = images[item.text]
        }
        // item 215800003
        _ind21580++;
    }
}

function addItemsSubset(items, output) {
    // item 17495
    if (items) {
        // item 174890001
        var _ind17489 = 0;
        var _col17489 = items;
        var _keys17489 = Object.keys(_col17489); 
        var _len17489 = _keys17489.length;
        while (true) {
            // item 174890002
            if (_ind17489 < _len17489) {
                
            } else {
                break;
            }
            // item 174890004
            var id = _keys17489[_ind17489]; var item = _col17489[id];
            // item 17491
            output.push(item)
            // item 174890003
            _ind17489++;
        }
    }
}

function addMany(set, items) {
    // item 209040001
    var _ind20904 = 0;
    var _col20904 = items;
    var _len20904 = _col20904.length;
    while (true) {
        // item 209040002
        if (_ind20904 < _len20904) {
            
        } else {
            break;
        }
        // item 209040004
        var item = _col20904[_ind20904];
        // item 20906
        set.add(item)
        // item 209040003
        _ind20904++;
    }
}

function addMarkCommands(graph, items, commands) {
    // item 230430001
    var _ind23043 = 0;
    var _col23043 = items;
    var _len23043 = _col23043.length;
    while (true) {
        // item 230430002
        if (_ind23043 < _len23043) {
            
        } else {
            break;
        }
        // item 230430004
        var item = _col23043[_ind23043];
        // item 23045
        var node = graph.getNode(item.id)
        var marked = (node.flag1 == 1)
        // item 23046
        if (item.marked == marked) {
            
        } else {
            // item 23051
            var command = getOrCreateUpdate(
            	commands,
            	item.id
            )
            // item 23049
            if (item.marked) {
                // item 23052
                command.fields.flag1 = 1
            } else {
                // item 23053
                command.fields.flag1 = 0
            }
        }
        // item 230430003
        _ind23043++;
    }
}

function addMarkCompleted(editor, item, menu) {
    // item 20353
    if ((ignoreCommand()) || (!(canHaveLink(item)))) {
        
    } else {
        // item 20317
        var text
        // item 20323
        var content = Utils.copyObject(
        	getContent(item)
        )
        // item 20318
        if (content.status) {
            // item 20324
            delete content.status
            // item 20326
            text = "MES_CLEAR_MARK"
        } else {
            // item 20325
            content.status = "completed"
            // item 20327
            text = "MES_MARK_COMPLETED"
        }
        // item 20328
        var action = function() {
        	setContent(item.id, content)
        }
        // item 20316
        menu.push({
        	type: "item",
        	text: tr(text),
        	code: action
        });
        // item 20331
        menu.push(
            { type: "separator" }
        );
    }
}

function addMindMenuAction(action, menu) {
    // item 21373
    var callback = function() {
    	mindAction(action.action, action.itemId, action.type)
    }
    // item 21372
    var item = {
        type: "item",
        text: tr(action.text),
        code: callback
    }
    // item 21592
    if (action.image) {
        // item 21595
        item.image = action.image
    }
    // item 21591
    menu.push(item)
}

function addMindPasteAction(action, subtree, menu) {
    // item 21941
    var toPaste = {
    	"MES_ADD_LEFT_ITEM": "MES_PASTE_LEFT_ITEM",
    	"MES_ADD_RIGHT_ITEM": "MES_PASTE_RIGHT_ITEM",
    	"MES_ADD_ITEM_ABOVE": "MES_PASTE_ITEM_ABOVE",
    	"MES_ADD_ITEM_BELOW": "MES_PASTE_ITEM_BELOW",
    	"MES_ADD_VER_CHILD": "MES_PASTE_VER_CHILD",
    	"MES_ADD_CHILD": "MES_PASTE_CHILD",
    	"MES_ADD_ITEM": "MES_PASTE_ITEM"
    }
    // item 21935
    var callback = function() {
    	mindPasteAction(action.action, action.itemId, subtree)
    }
    // item 21942
    var text = toPaste[action.text]
    // item 21934
    var item = {
        type: "item",
        text: tr(text),
        code: callback
    }
    // item 21937
    if (action.image) {
        // item 21940
        item.image = action.image
    }
    // item 21936
    menu.push(item)
}

function addParameters() {
    // item 17537
    if (ignoreCommand()) {
        
    } else {
        // item 16650
        if (hasDrakon()) {
            // item 12380
            var parameters = getParameters(self);
            // item 12377
            if (parameters) {
                // item 12382
                selectItem(self, parameters.id);
                // item 12383
                redrawCanvas(self);
            } else {
                // item 12381
                insertAndEdit(self, null, "params")
            }
        } else {
            // item 16653
            console.log("Not DRAKON")
        }
    }
}

function addSubgraphItems(editor, subgraph, commands, idMap) {
    // item 12642
    var newId;
    // item 12712
    var graph = subgraph.graph;
    // item 126310001
    var _ind12631 = 0;
    var _col12631 = graph.nodes;
    var _keys12631 = Object.keys(_col12631); 
    var _len12631 = _keys12631.length;
    while (true) {
        // item 126310002
        if (_ind12631 < _len12631) {
            
        } else {
            break;
        }
        // item 126310004
        var id = _keys12631[_ind12631]; var node = _col12631[id];
        // item 12648
        newId = generateId(editor.storage);
        idMap[id] = newId;
        // item 126310003
        _ind12631++;
    }
    // item 127890001
    var _ind12789 = 0;
    var _col12789 = graph.nodes;
    var _keys12789 = Object.keys(_col12789); 
    var _len12789 = _keys12789.length;
    while (true) {
        // item 127890002
        if (_ind12789 < _len12789) {
            
        } else {
            break;
        }
        // item 127890004
        var id = _keys12789[_ind12789]; var node = _col12789[id];
        // item 12791
        newId = idMap[id];
        // item 12792
        pushInsertNode(
        	commands,
        	newId,
        	node
        );
        // item 127890003
        _ind12789++;
    }
    // item 126340001
    var _ind12634 = 0;
    var _col12634 = graph.edges;
    var _keys12634 = Object.keys(_col12634); 
    var _len12634 = _keys12634.length;
    while (true) {
        // item 126340002
        if (_ind12634 < _len12634) {
            
        } else {
            break;
        }
        // item 126340004
        var id = _keys12634[_ind12634]; var edge = _col12634[id];
        // item 12644
        newId = generateId(editor.storage);
        idMap[id] = newId;
        // item 12713
        var head = idMap[edge.head];
        var tail = idMap[edge.tail];
        // item 12639
        if (edge.isVertical) {
            // item 12638
            pushInsertVertical(
            	commands,
            	newId,
            	head,
            	tail,
            	edge.role
            );
        } else {
            // item 12646
            pushInsertHorizontal(
            	commands,
            	newId,
            	head,
            	tail,
            	edge.role
            );
        }
        // item 126340003
        _ind12634++;
    }
}

function addToUndo(undo, before, commands, after) {
    // item 22729
    commands = postEdit(commands)
    // item 22728
    addToUndoCore(
    	undo,
    	before,
    	commands,
    	after
    )
}

function addToUndoCore(undo, before, commands, after) {
    // item 22724
    var newSteps = undo.steps.slice(
    	0,
    	undo.next
    );
    // item 22727
    var step = {
    	before: before,
    	commands: commands,
    	after: after,
    	info: CallTrace.peek()
    }
    // item 22725
    newSteps.push(step);
    // item 22726
    undo.steps = newSteps;
    undo.next = newSteps.length;
}

function addTrace(name, args) {
    // item 18938
    CallTrace.add(name, args)
}

function addTypeToMenu(menu) {
    // item 220550001
    var _ind22055 = 0;
    var _col22055 = menu;
    var _len22055 = _col22055.length;
    while (true) {
        // item 220550002
        if (_ind22055 < _len22055) {
            
        } else {
            break;
        }
        // item 220550004
        var item = _col22055[_ind22055];
        // item 22057
        item.type = Mind.getDefaultIconType(item.action)
        // item 220550003
        _ind22055++;
    }
}

function adjustFontSize(node) {
    // item 23104
    if ((self.storage.version >= 20180619) && (node.type == "branch")) {
        // item 23099
        var content = node.content
        // item 23075
        if (content) {
            
        } else {
            // item 23092
            content = new Utils.Content("", "")
        }
        // item 23093
        if (content.font) {
            
        } else {
            // item 23102
            content = Utils.copyObject(content)
            // item 23074
            var fontInfo = getDefaultFont()
            // item 23107
            var size = Math.max(
            	fontInfo.size,
            	Config.BRANCH_HEADER_SIZE
            )
            // item 23098
            content.font = Utils.buildFontString(
            	false,
            	true,
            	size,
            	fontInfo.family
            )
        }
        // item 23101
        node.content = content
    }
}

function adjustForWildCycles(pgraph, header, movedNodes) {
    // item 21091
    var minX = header.x + Config.METRE
    var actualX = minX
    // item 210890001
    var _ind21089 = 0;
    var _col21089 = pgraph.graph.nodes;
    var _keys21089 = Object.keys(_col21089); 
    var _len21089 = _keys21089.length;
    while (true) {
        // item 210890002
        if (_ind21089 < _len21089) {
            
        } else {
            break;
        }
        // item 210890004
        var id = _keys21089[_ind21089]; var node = _col21089[id];
        // item 21092
        if ((node.x > header.x) && (node.box.left < actualX)) {
            // item 21098
            actualX = node.box.left
        }
        // item 210890003
        _ind21089++;
    }
    // item 21099
    if (actualX < minX) {
        // item 21103
        var hDelta = actualX - minX
        // item 21102
        pgraph.moveRight(
        	header.id,
        	hDelta,
        	movedNodes
        );
    }
}

function alignEdges(pgraph, leftId, rightId, movedNodes) {
    // item 4318
    var graph = pgraph.graph;
    // item 4319
    var left = nextPointBelow(
    	graph,
    	leftId
    );
    // item 4320
    var right = nextPointBelow(
    	graph,
    	rightId
    );
    // item 4321
    var y;
    var edgeId;
    // item 4322
    if (left.y < right.y) {
        // item 4325
        y = right.y;
        edgeId = leftId;
    } else {
        // item 4326
        y = left.y;
        edgeId = rightId;
    }
    // item 4327
    var edge = graph.getEdge(edgeId);
    var tail = graph.getTail(edge);
    // item 4328
    var h = tail.y - tail.box.top;
    var lowestTail = y + Config.METRE + h;
    // item 4329
    if (tail.y >= lowestTail) {
        
    } else {
        // item 4332
        var delta = lowestTail - tail.y;
        // item 4333
        pgraph.moveDown(
        	tail.id,
        	delta,
        	movedNodes
        );
    }
    // item 4422
    return y;
}

function analyzeSelection(editor) {
    // item 16987
    var free = editor.storage.free
    var selection = editor.storage.selection
    var ids = Object.keys(selection.ids)
    var greens = []
    var frees = []
    var blues = []
    // item 169960001
    var _ind16996 = 0;
    var _col16996 = ids;
    var _len16996 = _col16996.length;
    while (true) {
        // item 169960002
        if (_ind16996 < _len16996) {
            
        } else {
            break;
        }
        // item 169960004
        var id = _col16996[_ind16996];
        // item 16998
        if (selection.ids[id] == "green") {
            // item 17006
            greens.push(id)
        } else {
            // item 17001
            var item = free.get(id)
            // item 17002
            if (item) {
                // item 17005
                frees.push(id)
            } else {
                // item 18478
                blues.push(id)
            }
        }
        // item 169960003
        _ind16996++;
    }
    // item 17007
    return {
    	greens: greens,
    	frees: frees,
    	blues: blues
    }
}

function appendInsertionSocket(sockets, itemId, type, operation) {
    // item 11798
    var socket = new SocketInfo(itemId, operation, type, "insert");
    // item 11797
    sockets.push(socket);
}

function appendMindSocket(sockets, targetId, operation, action, socketType) {
    // item 22239
    var type = {
    	action: action.action,
    	socketType: socketType,
    	itemId: action.itemId
    }
    // item 22238
    appendInsertionSocket(
    	sockets,
    	targetId,
    	type,
    	operation
    )
}

function appendNodeMindSocket(graph, sockets, node, operation, socketType, action) {
    var _sw226170000_ = 0;
    // item 22626
    var x = 0
    var y = 0
    var half = Config.METRE / 2
    // item 226170000
    _sw226170000_ = action.action;
    // item 226170001
    if (_sw226170000_ === "miv01") {
        // item 22627
        x = - node.w + Config.METRE * 1.5
        y = node.h
        // item 22662
        var type = makeSocketType(
        	socketType,
        	action,
        	x,
        	y
        )
        // item 22661
        appendInsertionSocket(
        	sockets,
        	node.id,
        	type,
        	operation
        )
    } else {
        // item 226170002
        if (_sw226170000_ === "miv04") {
            // item 22644
            x = - node.w
            y = node.h
            // item 22662
            var type = makeSocketType(
            	socketType,
            	action,
            	x,
            	y
            )
            // item 22661
            appendInsertionSocket(
            	sockets,
            	node.id,
            	type,
            	operation
            )
        } else {
            // item 226170003
            if ((_sw226170000_ === "mih02") || (_sw226170000_ === "mih03")) {
                // item 22636
                x = node.w + half
                // item 22662
                var type = makeSocketType(
                	socketType,
                	action,
                	x,
                	y
                )
                // item 22661
                appendInsertionSocket(
                	sockets,
                	node.id,
                	type,
                	operation
                )
            } else {
                // item 226170005
                if ((_sw226170000_ === "mih04") || (_sw226170000_ === "mih05")) {
                    // item 22635
                    x = -node.w - half
                    // item 22662
                    var type = makeSocketType(
                    	socketType,
                    	action,
                    	x,
                    	y
                    )
                    // item 22661
                    appendInsertionSocket(
                    	sockets,
                    	node.id,
                    	type,
                    	operation
                    )
                } else {
                    // item 226170007
                    if (_sw226170000_ === "mih01") {
                        // item 22628
                        x = 0
                        y = node.h
                        // item 22662
                        var type = makeSocketType(
                        	socketType,
                        	action,
                        	x,
                        	y
                        )
                        // item 22661
                        appendInsertionSocket(
                        	sockets,
                        	node.id,
                        	type,
                        	operation
                        )
                    } else {
                        // item 226170008
                        if (_sw226170000_ === "miv03") {
                            // item 22648
                            if ((node.up) || (node.role == "header")) {
                                
                            } else {
                                // item 22647
                                y = -node.h - half
                                // item 22662
                                var type = makeSocketType(
                                	socketType,
                                	action,
                                	x,
                                	y
                                )
                                // item 22661
                                appendInsertionSocket(
                                	sockets,
                                	node.id,
                                	type,
                                	operation
                                )
                            }
                        } else {
                            // item 226170009
                            if ((_sw226170000_ === "miv02") && (node.left)) {
                                // item 22668
                                var leftNode = graph.getNodeLeftEx(node)
                                // item 22671
                                if (leftNode.down) {
                                    
                                } else {
                                    // item 22652
                                    y = node.h + half
                                    // item 22662
                                    var type = makeSocketType(
                                    	socketType,
                                    	action,
                                    	x,
                                    	y
                                    )
                                    // item 22661
                                    appendInsertionSocket(
                                    	sockets,
                                    	node.id,
                                    	type,
                                    	operation
                                    )
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}

function appendNodeMindSockets(graph, sockets, node, operation, socketType, actions) {
    // item 222500001
    var _ind22250 = 0;
    var _col22250 = actions;
    var _len22250 = _col22250.length;
    while (true) {
        // item 222500002
        if (_ind22250 < _len22250) {
            
        } else {
            break;
        }
        // item 222500004
        var action = _col22250[_ind22250];
        // item 22669
        appendNodeMindSocket(
        	graph,
        	sockets,
        	node,
        	operation,
        	socketType,
        	action
        )
        // item 222500003
        _ind22250++;
    }
}

function appendSingleMindSocket(sockets, item, operation, socketType, actions) {
    // item 22272
    var dx = 0
    var dy = 0
    // item 22316
    if ((item.isLine) && ((hasUpTs(self.storage.graph, item)) || (!(item.role == "bridge")))) {
        
    } else {
        // item 22247
        var action = actions[0]
        // item 22192
        var type = makeSocketType(
        	socketType,
        	action,
        	dx,
        	dy
        )
        // item 22191
        appendInsertionSocket(
        	sockets,
        	item.id,
        	type,
        	operation
        )
    }
}

function appendSocket(sockets, itemId, action) {
    // item 14492
    var name, realAction;
    // item 14489
    if (typeof action == "string") {
        // item 14488
        name = action;
        realAction = gTransplants[action];
        // item 14503
        if (realAction) {
            
        } else {
            // item 14506
            Utils.throwError(
             "transplant not found: " + action);
        }
    } else {
        // item 14493
        name = "no name";
        realAction = action;
    }
    // item 11678
    var socket = new SocketInfo(itemId, "liana", realAction, name);
    // item 6209
    sockets.push(socket);
}

function applyCommands(editor, commandList, selectAfter) {
    // item 22717
    applyCommandsCore(
    	editor,
    	commandList,
    	selectAfter,
    	true,
    	true
    )
}

function applyCommandsCore(editor, commandList, selectAfter, deselect, redraw) {
    // item 22707
    if (commandList.length === 0) {
        
    } else {
        // item 22700
        commandList = calculateUndo(
        	editor.storage,
        	commandList
        );
        // item 22701
        var before = copyState(editor);
        var after = copyState(editor);
        // item 22715
        if (deselect) {
            // item 22716
            after.selection = createSelection();
            // item 22703
            if (selectAfter) {
                // item 22710
                if (typeof selectAfter == "object") {
                    // item 227130001
                    var _ind22713 = 0;
                    var _col22713 = selectAfter;
                    var _len22713 = _col22713.length;
                    while (true) {
                        // item 227130002
                        if (_ind22713 < _len22713) {
                            
                        } else {
                            break;
                        }
                        // item 227130004
                        var id = _col22713[_ind22713];
                        // item 22712
                        after.selection.add(id, false);
                        // item 227130003
                        _ind22713++;
                    }
                } else {
                    // item 22706
                    after.selection.add(selectAfter, true);
                }
            }
        }
        // item 22702
        runAndSaveCommands(
        	editor, 
        	before, 
        	commandList, 
        	after, 
        	redraw
        );
    }
}

function arrowDown(ctrl, shift, visibleBox) {
    // item 20293
    if (ctrl) {
        // item 22560
        if (ignoreCommand()) {
            
        } else {
            // item 20296
            moveByArrow(0, 1, visibleBox)
        }
    } else {
        // item 20252
        var isBelow = function(item, current) {
        	return item.y > current.y
        }
        // item 20253
        var manFinder = findBelow
        // item 20254
        onArrow(manFinder, isBelow)
    }
}

function arrowLeft(ctrl, shift, visibleBox) {
    // item 20297
    if (ctrl) {
        // item 22562
        if (ignoreCommand()) {
            
        } else {
            // item 20300
            moveByArrow(-1, 0, visibleBox)
        }
    } else {
        // item 20255
        var isToLeft = function(item, current) {
        	return item.x < current.x
        }
        // item 20256
        var manFinder = findLeft
        // item 20257
        onArrow(manFinder, isToLeft)
    }
}

function arrowRight(ctrl, shift, visibleBox) {
    // item 20301
    if (ctrl) {
        // item 22564
        if (ignoreCommand()) {
            
        } else {
            // item 20304
            moveByArrow(1, 0, visibleBox)
        }
    } else {
        // item 20258
        var isToRight = function(item, current) {
        	return item.x > current.x
        }
        // item 20259
        var manFinder = findRight
        // item 20260
        onArrow(manFinder, isToRight)
    }
}

function arrowUp(ctrl, shift, visibleBox) {
    // item 20289
    if (ctrl) {
        // item 22566
        if (ignoreCommand()) {
            
        } else {
            // item 20292
            moveByArrow(0, -1, visibleBox)
        }
    } else {
        // item 20248
        var isAbove = function(item, current) {
        	return item.y < current.y
        }
        // item 20250
        var manFinder = findAbove
        // item 20251
        onArrow(manFinder, isAbove)
    }
}

function autoCycleMarks(edit) {
    var _sw230020000_ = 0;
    // item 23010
    var branches = []
    var addresses = []
    var graph = self.storage.graph
    // item 230000001
    var _ind23000 = 0;
    var _col23000 = graph.nodes;
    var _keys23000 = Object.keys(_col23000); 
    var _len23000 = _keys23000.length;
    while (true) {
        // item 230000002
        if (_ind23000 < _len23000) {
            
        } else {
            break;
        }
        // item 230000004
        var id = _keys23000[_ind23000]; var node = _col23000[id];
        // item 230020000
        _sw230020000_ = node.type;
        // item 230020001
        if (_sw230020000_ === "branch") {
            // item 23020
            copyCoreBranchInfo(
            	branches,
            	node
            )
        } else {
            // item 230020002
            if (_sw230020000_ === "address") {
                // item 23017
                copyCoreBranchInfo(
                	addresses,
                	node
                )
            }
        }
        // item 230000003
        _ind23000++;
    }
    // item 230210001
    var _ind23021 = 0;
    var _col23021 = branches;
    var _len23021 = _col23021.length;
    while (true) {
        // item 230210002
        if (_ind23021 < _len23021) {
            
        } else {
            break;
        }
        // item 230210004
        var branch = _col23021[_ind23021];
        // item 230260001
        var _ind23026 = 0;
        var _col23026 = addresses;
        var _len23026 = _col23026.length;
        while (true) {
            // item 230260002
            if (_ind23026 < _len23026) {
                
            } else {
                break;
            }
            // item 230260004
            var address = _col23026[_ind23026];
            // item 23028
            if ((address.x >= branch.x) && (address.text == branch.text)) {
                // item 23032
                address.marked = true
                branch.marked = true
            }
            // item 230260003
            _ind23026++;
        }
        // item 230210003
        _ind23021++;
    }
    // item 23037
    var commands = {}
    // item 23054
    addMarkCommands(
    	graph,
    	branches,
    	commands
    )
    // item 23055
    addMarkCommands(
    	graph,
    	addresses,
    	commands
    )
    // item 23060
    combineRunCommands(
    	edit,
    	commands
    )
}

function autoSizeIcons() {
    // item 16597
    addTrace(
    	"autoSizeIcons",
    	[]
    );
    // item 16608
    var editor = self;
    // item 17086
    buildBoxesForFree(editor)
    // item 16596
    var before = copyState(editor);
    var after = copyState(editor);
    // item 16600
    var graph = editor.storage.graph;
    // item 16599
    var ids = Object.keys(graph.nodes);
    // item 16592
    var i;
    var count = ids.length;
    var allCommands = [];
    // item 165930001
    i = 0;
    while (true) {
        // item 165930002
        if (i < count) {
            
        } else {
            break;
        }
        // item 16591
        var id = ids[i];
        // item 16601
        var node = graph.getNode(id);
        // item 16602
        if (node.type == "junction") {
            
        } else {
            // item 19970
            allCommands = setTextExecute(
            	editor,
            	id,
            	node.content,
            	allCommands
            );
        }
        // item 165930003
        i++;
    }
    // item 16605
    if (allCommands.length == 0) {
        
    } else {
        // item 22694
        runAndSaveCommands(
        	editor,
        	before,
        	allCommands,
        	after,
        	true
        )
    }
}

function bakeCommands(graph, commands) {
    // item 161660001
    var _ind16166 = 0;
    var _col16166 = commands;
    var _keys16166 = Object.keys(_col16166); 
    var _len16166 = _keys16166.length;
    while (true) {
        // item 161660002
        if (_ind16166 < _len16166) {
            
        } else {
            break;
        }
        // item 161660004
        var id = _keys16166[_ind16166]; var command = _col16166[id];
        // item 16168
        if ((command.type == "update") && (command.table == "nodes")) {
            // item 16175
            var node = graph.getNode(id);
            // item 161730001
            var _ind16173 = 0;
            var _col16173 = command.fields;
            var _keys16173 = Object.keys(_col16173); 
            var _len16173 = _keys16173.length;
            while (true) {
                // item 161730002
                if (_ind16173 < _len16173) {
                    
                } else {
                    break;
                }
                // item 161730004
                var field = _keys16173[_ind16173]; var value = _col16173[field];
                // item 16172
                node[field] = value;
                // item 161730003
                _ind16173++;
            }
        }
        // item 161660003
        _ind16166++;
    }
}

function beginBlockSelect() {
    // item 14589
    var editor = self;
    // item 13804
    editor.storage.selection = createSelection();
    // item 19183
    redrawCanvas(self);
}

function belongsToCycle(graph, cycleStartNode, edgeId) {
    // item 7833
    var rightUpId =graph.getNodeRight(cycleStartNode);
    var rightUp = graph.getNode(rightUpId);
    var rightDownId = graph.getNodeDown(rightUp);
    var node = graph.getNode(rightDownId);
    var id;
    while (true) {
        // item 7834
        if (node.left) {
            // item 7837
            id = graph.getNodeLeft(node);
        } else {
            // item 7838
            if (node.up) {
                
            } else {
                // item 7839
                return false;
            }
            // item 7841
            if (node.up == edgeId) {
                // item 7842
                return true;
            }
            // item 7844
            id = graph.getNodeUp(node);
        }
        // item 7845
        node = graph.getNode(id);
    }
}

function blockSelect(box) {
    // item 13546
    var graph = self.storage.graph
    var free = self.storage.free
    var selection = self.storage.selection
    // item 13650
    if (selection.blockSelect(graph, free, box)) {
        // item 13555
        redrawCanvas(self);
        // item 13543
        return true;
    } else {
        // item 13653
        return false;
    }
}

function buildAddSockets(graph, insertionSocket, operation) {
    // item 11754
    var sockets = [];
    // item 117640001
    if ((insertionSocket === "branch") || (insertionSocket === "case")) {
        // item 117730001
        var _ind11773 = 0;
        var _col11773 = graph.edges;
        var _keys11773 = Object.keys(_col11773); 
        var _len11773 = _keys11773.length;
        while (true) {
            // item 117730002
            if (_ind11773 < _len11773) {
                
            } else {
                break;
            }
            // item 117730004
            var tid = _keys11773[_ind11773]; var target = _col11773[tid];
            // item 11775
            if (target.isVertical) {
                // item 11822
                if ((isAboveLastCase(graph, target)) && (insertionSocket == "case")) {
                    // item 11825
                    appendInsertionSocket(
                    	sockets,
                    	target.id,
                    	insertionSocket,
                    	operation
                    );
                }
            } else {
                // item 11785
                var branch = getBranchForEdge(graph, target);
                // item 11786
                if ((branch) && (branch.type == insertionSocket)) {
                    // item 11800
                    appendInsertionSocket(
                    	sockets,
                    	target.id,
                    	insertionSocket,
                    	operation
                    );
                }
            }
            // item 117730003
            _ind11773++;
        }
    } else {
        // item 117640003
        if (insertionSocket === "duration") {
            // item 149790001
            var _ind14979 = 0;
            var _col14979 = graph.nodes;
            var _keys14979 = Object.keys(_col14979); 
            var _len14979 = _keys14979.length;
            while (true) {
                // item 149790002
                if (_ind14979 < _len14979) {
                    
                } else {
                    break;
                }
                // item 149790004
                var nid = _keys14979[_ind14979]; var node = _col14979[nid];
                // item 14997
                if (goodForPeriod(node)) {
                    // item 15000
                    appendInsertionSocket(
                    	sockets,
                    	nid,
                    	insertionSocket,
                    	operation
                    );
                }
                // item 149790003
                _ind14979++;
            }
        } else {
            // item 117640004
            if (insertionSocket === "path") {
                // item 154190001
                var _ind15419 = 0;
                var _col15419 = graph.edges;
                var _keys15419 = Object.keys(_col15419); 
                var _len15419 = _keys15419.length;
                while (true) {
                    // item 154190002
                    if (_ind15419 < _len15419) {
                        
                    } else {
                        break;
                    }
                    // item 154190004
                    var tid = _keys15419[_ind15419]; var target = _col15419[tid];
                    // item 15421
                    if ((target.isVertical) || (!(target.role == "parallel"))) {
                        
                    } else {
                        // item 15425
                        appendInsertionSocket(
                        	sockets,
                        	target.id,
                        	insertionSocket,
                        	operation
                        );
                    }
                    // item 154190003
                    _ind15419++;
                }
                // item 154260001
                var _ind15426 = 0;
                var _col15426 = graph.nodes;
                var _keys15426 = Object.keys(_col15426); 
                var _len15426 = _keys15426.length;
                while (true) {
                    // item 154260002
                    if (_ind15426 < _len15426) {
                        
                    } else {
                        break;
                    }
                    // item 154260004
                    var nid = _keys15426[_ind15426]; var node = _col15426[nid];
                    // item 15428
                    if (lastParallel(graph, node)) {
                        // item 15445
                        appendInsertionSocket(
                        	sockets,
                        	node.id,
                        	insertionSocket,
                        	operation
                        );
                    }
                    // item 154260003
                    _ind15426++;
                }
            } else {
                // item 117560001
                var _ind11756 = 0;
                var _col11756 = graph.edges;
                var _keys11756 = Object.keys(_col11756); 
                var _len11756 = _keys11756.length;
                while (true) {
                    // item 117560002
                    if (_ind11756 < _len11756) {
                        
                    } else {
                        break;
                    }
                    // item 117560004
                    var tid = _keys11756[_ind11756]; var target = _col11756[tid];
                    // item 11758
                    if (downRole(target)) {
                        // item 11799
                        appendInsertionSocket(
                        	sockets,
                        	target.id,
                        	insertionSocket,
                        	operation
                        );
                    } else {
                        // item 18043
                        var straightExit = Utils.canInsertInHorizontal(
                        	graph,
                        	target
                        )
                        // item 18042
                        if (straightExit) {
                            // item 11799
                            appendInsertionSocket(
                            	sockets,
                            	target.id,
                            	insertionSocket,
                            	operation
                            );
                        }
                    }
                    // item 117560003
                    _ind11756++;
                }
            }
        }
    }
    // item 11755
    return sockets;
}

function buildBackMenu(editor, x, y) {
    // item 17233
    var menu = []
    // item 17230
    if (getClipboardType() == "free") {
        // item 17236
        menu.push(
            { type: "item", text: tr("MES_PASTE"),
              code: function() {
                 pasteFree(editor, x, y)
            }}
        );
    }
    // item 17502
    if (self.readonly) {
        
    } else {
        // item 17505
        menu.push(
            { type: "item", text: tr("MES_BACKGROUND"),
              code: function(cx, cy) {
                 changeBackground(cx, cy)
              }
            }
        );
    }
    // item 17234
    return menu
}

function buildBlockMenu() {
    // item 16312
    var menu = [];
    var block = self.storage.selection.block;
    // item 16318
    if (block) {
        // item 16316
        block.oldIds = {};
        // item 16321
        if (block.top) {
            // item 16313
            menu.push(
                { type: "item", text: tr("MES_COPY"),
                  code: function() {
                    copyBlock(true, false); 
                  }
                }
            );
            // item 16482
            if (self.readonly) {
                
            } else {
                // item 16314
                menu.push(
                    { type: "item", text: tr("MES_CUT"),
                      code: function() { copyBlock(true, true); }
                    }
                );
                // item 16317
                menu.push(
                    { type: "item", text: tr("MES_DELETE"),
                      code: function() { copyBlock(false, true); }
                    }
                );
                // item 17628
                menu.push(
                    { type: "separator" }
                );
                // item 17630
                var idsMap = getSelectedIds(self)
                var ids = Object.keys(idsMap)
                // item 17629
                menu.push(
                    { type: "item", text: tr("MES_FORMAT"),
                      code: function(x, y){
                        changeFormat(x, y, ids);
                    }}
                );
            }
        }
    }
    // item 16315
    return menu;
}

function buildBoxesForFree(editor) {
    // item 17082
    var free = editor.storage.free
    // item 170800001
    var _ind17080 = 0;
    var _col17080 = free.set;
    var _keys17080 = Object.keys(_col17080); 
    var _len17080 = _keys17080.length;
    while (true) {
        // item 170800002
        if (_ind17080 < _len17080) {
            
        } else {
            break;
        }
        // item 170800004
        var id = _keys17080[_ind17080]; var node = _col17080[id];
        // item 17083
        var fields = Drakon.fitItem(node, render)
        // item 17084
        node.tb = fields.tb
        node.tb2 = fields.tb2
        // item 170800003
        _ind17080++;
    }
}

function buildBranchPointers(editor, addressNode) {
    // item 10253
    var graph = editor.storage.graph;
    // item 10252
    var allHeaders = findManyNodesBy(graph, "type", "branch");
    // item 10254
    var isNotMe = function(node) {
    	return getText(node) != getText(addressNode);
    }
    // item 10267
    var byX = function(left, right) {
    	if (left.x < right.x) { return -1; }
    	if (left.x > right.x) { return 1; }
    	return 0;
    };
    // item 10255
    var headers = allHeaders.filter(isNotMe);
    headers.sort(byX);
    // item 10266
    var commands = headers.map(function(node) {
    	return makePointToCommand(editor, addressNode.id, node);
    });
    // item 10268
    return commands;
}

function buildCallout(render, content, id, x, y, commList) {
    // item 18873
    content.h0x = Config.FREE_WIDTH + 20
    content.h0y = Config.FREE_HEIGHT + 40
    // item 18874
    pushInsertFree(
    	render,
    	commList,
    	id,
    	"callout",
    	x,
    	y,
    	Config.FREE_WIDTH,
    	Config.FREE_HEIGHT,
    	content
    );
}

function buildCircle(render, content, id, x, y, commList) {
    // item 19196
    var type = "f_circle"
    // item 19194
    pushInsertFree(
    	render,
    	commList,
    	id,
    	type,
    	x,
    	y,
    	Config.FREE_WIDTH,
    	Config.FREE_WIDTH,
    	content
    );
}

function buildCloud(render, content, id, x, y, commList) {
    // item 19203
    var type = "f_cloud"
    // item 19201
    pushInsertFree(
    	render,
    	commList,
    	id,
    	type,
    	x,
    	y,
    	Config.FREE_WIDTH,
    	Config.FREE_WIDTH / 2,
    	content
    );
}

function buildDb(render, content, id, x, y, commList) {
    // item 19210
    var type = "f_db"
    // item 19208
    pushInsertFree(
    	render,
    	commList,
    	id,
    	type,
    	x,
    	y,
    	Config.FREE_WIDTH,
    	Config.FREE_WIDTH,
    	content
    );
}

function buildExpandMenu(editor, item) {
    // item 5451
    var menu = [
        { type: "item", text: tr("MES_ADD_LINE"),
          image: "expand.png",
          code: function(){
            expandBolt(editor, item.id);
        }}
    ];
    // item 5452
    return menu;
}

function buildFormatMenu(editor, ids) {
    // item 18484
    var menu = []
    // item 18486
    menu.push(
        { type: "item", text: tr("MES_FORMAT"),
          code: function(x, y){
            changeFormat(x, y, ids);
        }}
    );
    // item 18485
    return menu
}

function buildFreeBlockMenu(editor, ids, allIds) {
    // item 17264
    var menu = []
    // item 17270
    menu.push(
        { type: "item", text: tr("MES_COPY"), code: function(){
            copyFree(editor, ids, true, false)
        }}
    );
    // item 17266
    if (self.readonly) {
        
    } else {
        // item 17272
        menu.push(
            { type: "item", text: tr("MES_CUT"), code: function(){
                copyFree(editor, ids, true, true)
            }}
        );
        // item 17273
        menu.push(
            { type: "separator" }
        );
        // item 17274
        menu.push(
            { type: "item", text: tr("MES_DELETE"), code: function(){
                deleteFreeItems(editor, ids);
            }}
        );
        // item 17624
        menu.push(
            { type: "separator" }
        );
        // item 17625
        menu.push(
            { type: "item", text: tr("MES_FORMAT"),
              code: function(x, y){
                changeFormat(x, y, allIds);
            }}
        );
    }
    // item 17275
    return menu
}

function buildFreeBuilders() {
    // item 18825
    gFreeBuilders = {}
    // item 18858
    gFreeBuilders["gdur-left"] = function(r, c, id, x, y, list) {
    	buildGdur(r, c, id, x, y, list, false)
    }
    gFreeBuilders["gdur-right"] = function(r, c, id, x, y, list) {
    	buildGdur(r, c, id, x, y, list, true)
    }
    // item 18866
    gFreeBuilders.f_line = function(r, c, id, x, y, list) {
    	buildLine(r, c, id, x, y, list)
    }
    gFreeBuilders.f_arrow = function(r, c, id, x, y, list) {
    	buildLine(r, c, id, x, y, list, "arrow")
    }
    // item 18882
    gFreeBuilders.f_label = buildLabel
    // item 18875
    gFreeBuilders.callout = buildCallout
    gFreeBuilders.f_shelf = buildShelf
    gFreeBuilders.f_rounded = buildRounded
    gFreeBuilders.f_ptr_right = buildPtrRight
    gFreeBuilders.f_ptr_left = buildPtrLeft
    gFreeBuilders.f_more = buildMore
    gFreeBuilders.f_circle = buildCircle
    gFreeBuilders.f_cloud = buildCloud
    gFreeBuilders.f_db = buildDb
}

function buildGdur(render, content, id, x, y, commList, right) {
    // item 18854
    content.right = right
    // item 18857
    content.h0x = 60
    content.h0y = 80
    content.h1x = 60
    content.h1y = 80
    // item 18853
    pushInsertFree(
    	render,
    	commList,
    	id,
    	"gdur",
    	x,
    	y,
    	Config.DEF_ICON_WIDTH_S,
    	Config.MIN_ICON_HEIGHT,
    	content
    );
}

function buildIconMenu(editor, item) {
    // item 16571
    if (self.readonly) {
        // item 10557
        var graph = editor.storage.graph;
        var menu = [];
        // item 22682
        addFindReferences(menu, item)
        // item 19815
        addFollowLink(editor, item, menu)
        // item 12435
        if (canCopyOne(graph, item)) {
            // item 12438
            menu.push(
                { type: "item", text: tr("MES_COPY"), code: function(){
                    copyOne(editor, item.id, false);
                }}
            );
        }
        // item 16573
        menu.push(
            { type: "item", text: tr("MES_COPY_TEXT"), code: function(){
                copyText(editor, item.content);
            }}
        );
        // item 16578
        return menu
    } else {
        // item 16572
        return buildIconMenuCore(editor, item)
    }
}

function buildIconMenuCore(editor, item) {
    var _sw165250000_ = 0;
    var _sw165010000_ = 0;
    // item 16536
    var graph = editor.storage.graph;
    var menu = [];
    // item 22683
    addFindReferences(menu, item)
    // item 20329
    addMarkCompleted(editor, item, menu)
    // item 19865
    addFollowLink(editor, item, menu)
    // item 16544
    var canDelete = canDeleteItem(editor, item);
    // item 16540
    if (canCopyOne(graph, item)) {
        // item 16543
        menu.push(
            { type: "item", text: tr("MES_COPY"), code: function(){
                copyOne(editor, item.id, false);
            }}
        );
        // item 16545
        if (canDelete) {
            // item 16548
            menu.push(
                { type: "item", text: tr("MES_CUT"), code: function(){
                    copyOne(editor, item.id, true);
                }}
            );
        }
        // item 16550
        if (getClipboardType() == "case") {
            // item 16554
            if (item.type == "case") {
                // item 16553
                menu.push(
                    { type: "item", text: tr("MES_PASTE"),
                      code: function(){
                        pasteCase(editor, item.id);
                    }}
                );
            }
        } else {
            // item 16556
            if (((getClipboardType() == "branch") && (item.type == "branch")) && (!(isEndBranch(graph, item)))) {
                // item 16560
                menu.push(
                    { type: "item", text: tr("MES_PASTE"),
                      code: function(){
                        pasteBranch(editor, item.id);
                    }}
                );
            }
        }
        // item 16549
        menu.push(
            { type: "separator" }
        );
    }
    // item 16562
    if (canDelete) {
        // item 16565
        menu.push(
            { type: "item", text: tr("MES_DELETE"), code: function(){
                deleteItem(editor, item.id);
            }}
        );
        // item 16566
        menu.push(
            { type: "separator" }
        );
    }
    // item 16495
    menu.push(
        { type: "item", text: tr("MES_COPY_TEXT"), code: function(){
            copyText(editor, item.content);
        }}
    );
    // item 16512
    if (getClipboardType() == "text") {
        // item 16515
        menu.push(
            { type: "item", text: tr("MES_PASTE_TEXT"), code: function(){
                pasteText(editor, item.id);
            }}
        );
    }
    // item 165250000
    _sw165250000_ = item.type;
    // item 165250001
    if (_sw165250000_ === "address") {
        
    } else {
        // item 16567
        if (hasUpperText(item)) {
            // item 16570
            menu.push(
                { type: "item", text: tr("MES_CHANGE_UPPER"), code: function(){
                    startEditUpperText(item.id);
                }}
            );
        }
        // item 16516
        menu.push(
            { type: "item", text: tr("MES_CHANGE_TEXT"), code: function(){
                startEditText(item.id);
            }}
        );
    }
    // item 165010000
    _sw165010000_ = item.type;
    // item 165010001
    if (_sw165010000_ === "question") {
        // item 16497
        menu.push(
            { type: "item", text: tr("MES_SWAP_YES_NO"), code: function(){
                swapYesNo(editor, item.id);
            }}
        );
        // item 19941
        if (userId) {
            // item 19920
            menu.push(
                { type: "separator" }
            );
            // item 19919
            menu.push(
                { type: "item", text: tr("MES_CHANGE_YES_NO"), code: function(){
                    changeYesNo()
                }}
            );
        }
    } else {
        // item 165010002
        if (_sw165010000_ === "case") {
            // item 16508
            menu.push(
                { type: "item", text: tr("MES_INSERT_CASE"), image: "case.png",
                  code: function(){
                    insertAndEdit(editor, item.id, "case");
                }}
            );
        } else {
            // item 165010003
            if (_sw165010000_ === "address") {
                // item 16524
                menu = menu.concat(
                	buildBranchPointers(editor, item)
                );
            } else {
                // item 165010004
                if ((_sw165010000_ === "branch") && (!(isEndBranch(graph, item)))) {
                    // item 16537
                    menu.push(
                    	createInsertBranchMenuItem(
                    		editor, item
                    ));
                    // item 19652
                    if (isLastBranch(graph, item)) {
                        // item 19653
                        menu.push(
                        	createInsertEndBranchMenuItem(
                        		editor, item
                        ));
                    }
                }
            }
        }
    }
    // item 16498
    if (item.role === "header") {
        // item 16511
        if (getParameters(editor)) {
            
        } else {
            // item 16510
            menu.push(
                { type: "item", text: tr("MES_ADD_PARAMS"), 
                  image: "params-1.png",
                  code: function() {
                    insertAndEdit(editor, null, "params");
                }}
            );
        }
        // item 16517
        if (isSilhouette(editor.storage.graph)) {
            // item 16519
            menu.push(
                { type: "item", text: tr("MES_TRANS_TO_PRIM"), 
                  image: "primitive.png",
                  code: function() {
                    toPrimitive(editor);
                }}
            );
        } else {
            // item 16518
            menu.push(
                { type: "item", text: tr("MES_TRANS_TO_SILH"),
                  image: "silhouette.png",
                  code: function() {
                    toSilhouette(editor);
                }}
            );
        }
    }
    // item 19846
    addEditLink(editor, item, menu)
    // item 17626
    menu.push(
        { type: "separator" }
    );
    // item 17627
    menu.push(
        { type: "item", text: tr("MES_FORMAT"),
          code: function(x, y){
            changeFormat(x, y, [item.id]);
        }}
    );
    // item 16496
    return menu;
}

function buildInsertMenu(editor, item) {
    // item 5422
    var graph = editor.storage.graph;
    var menu = [];
    // item 13020
    if (getClipboardType() == "block") {
        // item 13023
        menu.push(
            { type: "item", text: tr("MES_PASTE"), code: function(){
                pasteBlock(editor, item.id);
            }},
            { type: "separator" }
        );
    }
    // item 2073
    var menu2 = [
        { type: "item", text: tr("BUT_ACTION"), 
          image: "action.png",
          code: function(){
            insertAndEdit(editor, item.id, "action");
        }},
        { type: "item", text: tr("BUT_QUESTION"),
          image: "question.png",
          code: function(){
            insertAndEdit(editor, item.id, "question");
        }},
        { type: "item", text: tr("BUT_SELECT"),
          image: "select.png",
          code: function(){
            insertAndEdit(editor, item.id, "select");
        }},
        { type: "item", text: tr("BUT_FOREACH"),
          image: "foreach.png",
          code: function(){
            insertAndEdit(editor, item.id, "foreach");
        }},
        { type: "item", text: tr("BUT_INSERTION"),
          image: "insertion.png",
          code: function(){
            insertAndEdit(editor, item.id, "insertion");
        }},
        { type: "item", text: tr("BUT_COMMENT"),
          image: "comment.png",
          code: function(){
            insertAndEdit(editor, item.id, "comment");
        }}
    ];
    menu = menu.concat(menu2);
    // item 5419
    if (isBolt(graph, item)) {
        // item 5423
        menu.push(createBoltMenuItem(editor, item));
    }
    // item 2074
    return menu;
}

function buildInsertionSockets(graph, insertionSocket) {
    // item 13434
    var parts = insertionSocket.split("-");
    // item 13432
    var operation;
    var socketType;
    // item 13436
    if ((parts.length == 2) && (parts[0] == "clip")) {
        // item 13440
        operation = "paste";
        socketType = parts[1];
    } else {
        // item 13435
        operation = "insert";
        socketType = insertionSocket;
    }
    // item 13433
    return buildAddSockets(
    	graph,
    	socketType,
    	operation
    );
}

function buildLabel(render, content, id, x, y, commList) {
    // item 19100
    content.txt = "Text"
    content.lineThickness = 0
    content.align = "center"
    content.padding = 0
    // item 19098
    pushInsertFree(
    	render,
    	commList,
    	id,
    	"f_label",
    	x,
    	y,
    	Config.FREE_WIDTH,
    	Config.FREE_HEIGHT - Config.SIZE_SNAP,
    	content
    );
}

function buildLine(render, content, id, x, y, commList, arrowEnd) {
    // item 18865
    content.arrowEnd = arrowEnd
    // item 18864
    pushInsertFree(
    	render,
    	commList,
    	id,
    	"f_line",
    	x,
    	y,
    	100,
    	0,
    	content
    );
}

function buildMacroLoop(render, cont, cont2) {
    // item 12835
    var graph = new Utils.Manhattan();
    // item 12832
    var upper = makeDummyItem(1, render, "loopbegin", cont);
    var lower = makeDummyItem(2, render, "loopend", cont2);
    // item 12906
    var width = Math.max(upper.w, lower.w);
    // item 12854
    upper.w = width;
    lower.w = width;
    lower.y = upper.h + lower.h + Config.METRE * 3;
    // item 12853
    graph.addItem(upper);
    graph.addItem(lower);
    // item 12847
    graph.addItem(makeDummyLine(
    	3,
    	true,
    	1,
    	2,
    	"down"
    ));
    // item 12841
    return {
    	graph: graph,
    	first: 1,
    	last: 2
    };
}

function buildMacroParallel(render) {
    // item 15338
    var id = 5;
    // item 15339
    var right = Config.METRE * 5;
    var bottom = Config.METRE * 10;
    // item 15342
    var qitem = makeDummyJunction(1, 0, 0);
    var jRightUp = makeDummyJunction(2, right, 0);
    var jRightDown = makeDummyJunction(3, right, bottom);
    var jLeftDown = makeDummyJunction(4, 0, bottom);
    // item 15340
    var graph = new Utils.Manhattan();
    // item 15341
    graph.addItem(qitem);
    graph.addItem(jRightUp);
    graph.addItem(jRightDown);
    graph.addItem(jLeftDown);
    // item 15351
    graph.addItem(makeDummyLine(
    	id++,
    	false,
    	qitem.id,
    	jRightUp.id,
    	"parallel"
    ));
    // item 15352
    graph.addItem(makeDummyLine(
    	id++,
    	true,
    	jRightUp.id,
    	jRightDown.id,
    	"par-down"
    ));
    // item 15353
    graph.addItem(makeDummyLine(
    	id++,
    	false,
    	jLeftDown.id,
    	jRightDown.id,
    	null
    ));
    // item 15354
    graph.addItem(makeDummyLine(
    	id++,
    	true,
    	qitem.id,
    	jLeftDown.id,
    	"par-down"
    ));
    // item 15346
    return {
    	graph: graph,
    	first: qitem.id,
    	last: jLeftDown.id
    };
}

function buildMacroQuestion(render, cont, flag1) {
    // item 12457
    var id = 5;
    // item 12444
    var qitem = makeDummyItem(1, render, "question", cont);
    qitem.flag1 = flag1;
    // item 12459
    var right = qitem.w + Config.METRE * 2;
    var bottom = qitem.h + Config.METRE * 4;
    // item 12708
    var jRightUp = makeDummyJunction(2, right, 0);
    var jRightDown = makeDummyJunction(3, right, bottom);
    var jLeftDown = makeDummyJunction(4, 0, bottom);
    // item 12474
    var graph = new Utils.Manhattan();
    // item 12475
    graph.addItem(qitem);
    graph.addItem(jRightUp);
    graph.addItem(jRightDown);
    graph.addItem(jLeftDown);
    // item 12821
    graph.addItem(makeDummyLine(
    	id++,
    	false,
    	qitem.id,
    	jRightUp.id,
    	null
    ));
    // item 12822
    graph.addItem(makeDummyLine(
    	id++,
    	true,
    	jRightUp.id,
    	jRightDown.id,
    	"down"
    ));
    // item 12823
    graph.addItem(makeDummyLine(
    	id++,
    	false,
    	jLeftDown.id,
    	jRightDown.id,
    	"left"
    ));
    // item 12824
    graph.addItem(makeDummyLine(
    	id++,
    	true,
    	qitem.id,
    	jLeftDown.id,
    	"down"
    ));
    // item 12816
    return {
    	graph: graph,
    	first: qitem.id,
    	last: jLeftDown.id
    };
}

function buildMacroSelect(render, selectCont, caseConts) {
    // item 12748
    var i;
    var count = caseConts.length;
    var id = 2;
    var caseHeight = 0;
    var cases = [];
    // item 127460001
    i = 0;
    while (true) {
        // item 127460002
        if (i < count) {
            
        } else {
            break;
        }
        // item 12749
        var caseCont = caseConts[i];
        var dummyCase = makeDummyItem(id, render, "case", caseCont);
        dummyCase.group = 1;
        id += 10;
        // item 12750
        caseHeight = Math.max(caseHeight, dummyCase.h);
        // item 12751
        cases.push(dummyCase);
        // item 127460003
        i++;
    }
    // item 12755
    var graph = new Utils.Manhattan();
    // item 12721
    var select = makeDummyItem(1, render, "select", selectCont);
    select.group = 1;
    // item 12723
    var topLine = select.h + Config.METRE;
    var caseLine = topLine + Config.METRE + caseHeight;
    var bottomLine = caseLine + caseHeight + 
    	Config.METRE * 3;
    // item 12770
    var case0 = cases[0];
    var skewerWidth = Math.max(select.w, case0.w);
    case0.y = caseLine;
    case0.h = caseHeight;
    case0.w = skewerWidth;
    select.w = skewerWidth;
    // item 12754
    graph.addItem(select);
    graph.addItem(case0);
    // item 12769
    var upJoint = 3;
    var downJoint = 4;
    // item 12731
    addDummyJunction(graph,  upJoint, 0, topLine, 1);
    addDummyJunction(graph,  downJoint, 0, bottomLine, null);
    // item 12764
    addDummyLine(graph, 5, true, 1, upJoint, null);
    addDummyLine(graph, 6, true, upJoint, 2, null);
    addDummyLine(graph, 7, true, 2, downJoint, "down");
    // item 12779
    var x = select.w + Config.METRE;
    // item 127710001
    i = 1;
    while (true) {
        // item 127710002
        if (i < count) {
            
        } else {
            break;
        }
        // item 12773
        var thisCase = cases[i];
        // item 12777
        x += thisCase.w;
        // item 12774
        thisCase.h = caseHeight;
        thisCase.y = caseLine;
        thisCase.x = x;
        // item 12775
        var upJoint2 = thisCase.id + 1;
        var downJoint2 = thisCase.id + 2;
        // item 12780
        addDummyJunction(graph,  upJoint2, x, topLine, 1);
        addDummyJunction(graph,  downJoint2, x, bottomLine, null);
        graph.addItem(thisCase);
        // item 12781
        addDummyLine(graph, id++, false, upJoint, upJoint2, null);
        addDummyLine(graph, id++, true, upJoint2, thisCase.id, null);
        addDummyLine(graph, id++, true, thisCase.id, downJoint2, "down");
        addDummyLine(graph, id++, false, downJoint, downJoint2, "left");
        // item 12776
        upJoint = upJoint2;
        downJoint = downJoint2;
        x += thisCase.w + Config.METRE;
        // item 127710003
        i++;
    }
    // item 12730
    return {
    	graph: graph,
    	first: 1,
    	last: 4
    };
}

function buildMacroSimple(render, type, content) {
    // item 12917
    var graph = new Utils.Manhattan();
    // item 12916
    var item = makeDummyItem(1, render, type, content);
    // item 12930
    graph.addItem(item);
    // item 12921
    return {
    	graph: graph,
    	first: 1,
    	last: 1
    };
}

function buildMenuAt(x, y) {
    var _sw164270000_ = 0;
    // item 16424
    var id;
    var menu;
    var item = null
    // item 16423
    var ids = getSelectedIds(this);
    var idList = Object.keys(ids);
    // item 164270000
    _sw164270000_ = idList.length;
    // item 164270001
    if (_sw164270000_ === 0) {
        // item 16288
        var draggable = findVisualItem(
        	x,
        	y
        );
        // item 16436
        if (draggable) {
            // item 16435
            id = draggable.id;
        } else {
            // item 16438
            id = null;
        }
        // item 16289
        if (id) {
            // item 17096
            var foundItem = getAnyItem(self.storage, id)
            // item 19783
            item = {
            	type: foundItem.type,
            	content: Utils.copyObject(foundItem.content)
            }
            // item 17097
            if (foundItem.free) {
                // item 17099
                menu = buildMenuForFree(self, id)
            } else {
                // item 21113
                if (isMind()) {
                    // item 21115
                    menu = buildMenuForMind(self, id);
                } else {
                    // item 16299
                    menu = buildMenuForItem(self, id);
                }
            }
        } else {
            // item 16440
            menu = buildBackMenu(self, x, y)
        }
    } else {
        // item 164270002
        if (_sw164270000_ === 1) {
            // item 16434
            id = idList[0];
            // item 16289
            if (id) {
                // item 17096
                var foundItem = getAnyItem(self.storage, id)
                // item 19783
                item = {
                	type: foundItem.type,
                	content: Utils.copyObject(foundItem.content)
                }
                // item 17097
                if (foundItem.free) {
                    // item 17099
                    menu = buildMenuForFree(self, id)
                } else {
                    // item 21113
                    if (isMind()) {
                        // item 21115
                        menu = buildMenuForMind(self, id);
                    } else {
                        // item 16299
                        menu = buildMenuForItem(self, id);
                    }
                }
            } else {
                // item 16440
                menu = buildBackMenu(self, x, y)
            }
        } else {
            // item 22110
            if (isMind()) {
                // item 17258
                menu = buildFormatMenu(self, idList)
            } else {
                // item 17250
                var selection = analyzeSelection(self)
                // item 17252
                if (selection.greens.length > 1) {
                    // item 16298
                    menu = buildBlockMenu();
                } else {
                    // item 17254
                    if (selection.frees.length == 0) {
                        // item 17258
                        menu = buildFormatMenu(self, idList)
                    } else {
                        // item 17259
                        menu = buildFreeBlockMenu(
                        	self,
                        	selection.frees,
                        	idList
                        )
                    }
                }
            }
        }
    }
    // item 16302
    return {
    	menu: menu,
    	item: item
    };
}

function buildMenuForFree(editor, itemId) {
    // item 17112
    var item = getAnyItem(editor.storage, itemId)
    // item 17104
    var menu = []
    // item 20330
    addMarkCompleted(editor, item, menu)
    // item 19866
    addFollowLink(editor, item, menu)
    // item 17110
    menu.push(
        { type: "item", text: tr("MES_COPY"), code: function(){
            copyFree(editor, [itemId], true, false)
        }}
    );
    // item 17106
    if (self.readonly) {
        
    } else {
        // item 17113
        menu.push(
            { type: "item", text: tr("MES_CUT"), code: function(){
                copyFree(editor, [itemId], true, true)
            }}
        );
        // item 17114
        menu.push(
            { type: "separator" }
        );
        // item 17115
        menu.push(
            { type: "item", text: tr("MES_DELETE"), code: function(){
                deleteFreeItems(editor, [item.id]);
            }}
        );
    }
    // item 17116
    menu.push(
        { type: "separator" }
    );
    // item 17117
    menu.push(
        { type: "item", text: tr("MES_COPY_TEXT"), code: function(){
            copyText(editor, item.content);
        }}
    );
    // item 17118
    if ((getClipboardType() == "text") && (!(self.readonly))) {
        // item 17121
        menu.push(
            { type: "item", text: tr("MES_PASTE_TEXT"), code: function(){
                pasteText(editor, item.id);
            }}
        );
    }
    // item 17123
    if (hasUpperText(item)) {
        // item 17126
        menu.push(
            { type: "item", text: tr("MES_CHANGE_UPPER"), code: function(){
                startEditUpperText(item.id);
            }}
        );
    }
    // item 17122
    menu.push(
        { type: "item", text: tr("MES_CHANGE_TEXT"), code: function(){
            startEditText(item.id);
        }}
    );
    // item 18630
    if (self.readonly) {
        
    } else {
        // item 19847
        addEditLink(editor, item, menu)
        // item 18600
        menu.push(
            { type: "separator" }
        );
        // item 18601
        menu.push(
            {   type: "item", text: tr("MES_TO_FRONT"),
                code: function(){
                   toFront(editor, itemId);
            }}
        )
        menu.push(
            {   type: "item", text: tr("MES_TO_BACK"),
                code: function(){
                   toBack(editor, itemId);
            }}
        )
        // item 17824
        menu.push(
            { type: "separator" }
        );
        // item 17825
        menu.push(
            {   type: "item", text: tr("MES_FORMAT"),
                code: function(x, y){
                   changeFormat(x, y, [item.id]);
            }}
        );
    }
    // item 17109
    return menu
}

function buildMenuForItem(editor, itemId) {
    var _sw20430000_ = 0;
    var _sw116440000_ = 0;
    // item 2057
    var item = editor.storage.graph.getItem(
    	itemId
    );
    // item 5426
    var graph = editor.storage.graph;
    // item 2050
    var menu = null;
    // item 16483
    if (self.readonly) {
        // item 16485
        if ((item.type == "junction") || (item.isLine)) {
            
        } else {
            // item 16489
            menu = buildIconMenu(
            	editor,
            	item
            );
        }
    } else {
        // item 20430000
        _sw20430000_ = item.type;
        // item 20430001
        if (_sw20430000_ === "horizontal") {
            // item 18046
            if (Utils.canInsertInHorizontal(graph, item)) {
                // item 18048
                menu = buildInsertMenu(
                	editor,
                	item
                );
                // item 18049
                var expand = buildExpandMenu(
                	editor,
                	item
                );
                // item 18051
                menu.push(
                    { type: "separator" }
                );
                // item 18050
                menu = menu.concat(expand)
            } else {
                // item 11643
                var branch = getBranchForEdge(graph, item);
                menu = [];
                // item 11665
                if (branch) {
                    // item 116440000
                    _sw116440000_ = branch.type;
                    // item 116440001
                    if (_sw116440000_ === "case") {
                        // item 13086
                        if (getClipboardType() == "case") {
                            // item 13089
                            menu.push(
                                { type: "item", text: tr("MES_PASTE"),
                                  code: function(){
                                    pasteCase(editor, branch.id);
                                }}
                            );
                        }
                        // item 11664
                        menu.push(createInsertCaseMenuItem(
                        	editor,
                        	branch
                        ));
                    } else {
                        // item 116440002
                        if (_sw116440000_ === "branch") {
                            
                        } else {
                            // item 116440003
                            throw "Unexpected switch value: " + _sw116440000_;
                        }
                        // item 13414
                        if (getClipboardType() == "branch") {
                            // item 13413
                            menu.push(
                                { type: "item", text: tr("MES_PASTE"),
                                  code: function(){
                                    pasteBranch(editor, branch.id);
                                }}
                            );
                        }
                        // item 11663
                        menu.push(createInsertBranchMenuItem(
                        	editor,
                        	branch
                        ));
                    }
                } else {
                    // item 15526
                    if (item.role == "parallel") {
                        // item 15528
                        menu.push(
                            { type: "item", text: tr("MES_NEW_PATH"),
                        	image: "par.png",
                              code: function(){
                                insertPathInside(editor, item.id);
                            }},
                            { type: "item", text: tr("MES_DELETE_PATH"),
                              code: function() {
                                deletePath(editor, item.id);
                            }}
                        );
                    }
                }
            }
        } else {
            // item 20430002
            if (_sw20430000_ === "junction") {
                // item 15615
                if (lastParallel(graph, item)) {
                    // item 15617
                    menu = [
                        { type: "item", text: tr("MES_NEW_PATH"),
                    	image: "par.png",
                          code: function(){
                            insertPathOutside(editor, item.id);
                        }},
                        { type: "item", text: tr("MES_DELETE_PATH"),
                          code: function() {
                            deletePath(editor, item.left);
                        }}
                    ];
                } else {
                    // item 15746
                    if (middleParallel(graph, item)) {
                        // item 15748
                        menu = [
                            { type: "item", text: tr("MES_NEW_PATH"),
                        	image: "par.png",
                              code: function(){
                                insertPathInside(editor, item.right);
                            }},
                            { type: "item", text: tr("MES_DELETE_PATH"),
                              code: function() {
                                deletePath(editor, item.left);
                            }}
                        ];
                    } else {
                        // item 11618
                        if (item.left) {
                            // item 11620
                            var leftEdge = graph.getEdge(item.left);
                            // item 11621
                            if (isRightHand(graph, leftEdge)) {
                                // item 11623
                                menu = buildExpandMenu(
                                	editor,
                                	leftEdge
                                );
                            } else {
                                // item 11631
                                if (item.up) {
                                    // item 11630
                                    var upEdge = graph.getEdge(item.up);
                                    // item 11633
                                    if (isBolt(graph, upEdge)) {
                                        // item 11636
                                        menu = [createBoltMenuItem(editor, upEdge)];
                                    }
                                } else {
                                    // item 11638
                                    if (item.down) {
                                        // item 11637
                                        var downEdge = graph.getEdge(item.down);
                                        // item 11640
                                        if (isBolt(graph, downEdge)) {
                                            // item 11642
                                            menu = [createBoltMenuItem(editor, downEdge)];
                                        }
                                    }
                                }
                            }
                        } else {
                            // item 11631
                            if (item.up) {
                                // item 11630
                                var upEdge = graph.getEdge(item.up);
                                // item 11633
                                if (isBolt(graph, upEdge)) {
                                    // item 11636
                                    menu = [createBoltMenuItem(editor, upEdge)];
                                }
                            } else {
                                // item 11638
                                if (item.down) {
                                    // item 11637
                                    var downEdge = graph.getEdge(item.down);
                                    // item 11640
                                    if (isBolt(graph, downEdge)) {
                                        // item 11642
                                        menu = [createBoltMenuItem(editor, downEdge)];
                                    }
                                }
                            }
                        }
                    }
                }
            } else {
                // item 20430003
                if (_sw20430000_ === "vertical") {
                    // item 15294
                    if (downRole(item)) {
                        // item 2056
                        menu = buildInsertMenu(
                        	editor,
                        	item
                        );
                    }
                } else {
                    // item 2060
                    menu = buildIconMenu(
                    	editor,
                    	item
                    );
                }
            }
        }
    }
    // item 2037
    return menu;
}

function buildMenuForMind(editor, itemId) {
    // item 21134
    var item = editor.storage.graph.getItem(
    	itemId
    );
    // item 21792
    if ((item.isLine) || (item.type == "junction")) {
        // item 21798
        return buildMenuForMindJunction(editor, itemId)
    } else {
        // item 21799
        return buildMenuForMindIcon(editor, itemId)
    }
}

function buildMenuForMindIcon(editor, itemId) {
    // item 21622
    var item = editor.storage.graph.getItem(
    	itemId
    );
    // item 21623
    var graph = editor.storage.graph;
    // item 21621
    var menu = [];
    // item 22693
    addFindReferences(menu, item)
    // item 21640
    if (editor.readonly) {
        
    } else {
        // item 21639
        addMarkCompleted(editor, item, menu)
    }
    // item 21638
    addFollowLink(editor, item, menu)
    // item 21624
    if (editor.readonly) {
        
    } else {
        // item 21628
        var actions = getMindActions(editor, item)
        // item 21671
        if (actions.length > 0) {
            // item 216290001
            var _ind21629 = 0;
            var _col21629 = actions;
            var _len21629 = _col21629.length;
            while (true) {
                // item 216290002
                if (_ind21629 < _len21629) {
                    
                } else {
                    break;
                }
                // item 216290004
                var action = _col21629[_ind21629];
                // item 21627
                addMindMenuAction(action, menu)
                // item 216290003
                _ind21629++;
            }
            // item 21670
            menu.push({ type: "separator" })
        }
    }
    // item 21648
    menu.push(
        { type: "item", text: tr("MES_COPY"), code: function(){
            copyMind(item.id, false);
        }}
    );
    // item 21650
    if (editor.readonly) {
        
    } else {
        // item 21654
        var deleteAction = findMindDelete(item)
        // item 21655
        if (deleteAction) {
            // item 21649
            menu.push(
                { type: "item", text: tr("MES_CUT"), code: function(){
                    copyMind(item.id, true);
                }}
            );
        }
        // item 21945
        if ((actions.length > 0) && (getClipboardType() == "mind")) {
            // item 21948
            menu.push(
                { type: "item", text: tr("MES_PASTE"), 
                  code: function(x, y) {
                    pasteMind(x, y, actions);
                }}
            );
        }
        // item 21950
        if (deleteAction) {
            // item 21656
            menu.push({ type: "separator" })
            // item 21653
            menu.push(
              {
                type: "item", text: tr("MES_DELETE"),
                code: function(){mindAction(deleteAction, itemId, null)}
              }
            )
        }
    }
    // item 21669
    menu.push({ type: "separator" })
    // item 21659
    menu.push(
        { type: "item", text: tr("MES_COPY_TEXT"), code: function(){
            copyText(editor, item.content);
        }}
    );
    // item 21660
    if (getClipboardType() == "text") {
        // item 21663
        menu.push(
            { type: "item", text: tr("MES_PASTE_TEXT"), code: function(){
                pasteText(editor, item.id);
            }}
        );
    }
    // item 22672
    if (hasUpperText(item)) {
        // item 22675
        menu.push(
            { type: "item", text: tr("MES_CHANGE_UPPER"), code: function(){
                startEditUpperText(item.id);
            }}
        );
    }
    // item 21664
    menu.push(
        { type: "item", text: tr("MES_CHANGE_TEXT"), code: function(){
            startEditText(item.id);
        }}
    );
    // item 21667
    addEditLink(editor, item, menu)
    // item 22589
    if (editor.readonly) {
        
    } else {
        // item 21802
        menu.push(
            { type: "item", text: tr("MES_TURN_INTO"),
              code: function(x, y){
                turnInto(x, y, item.id);
            }}
        );
        // item 21665
        menu.push(
            { type: "separator" }
        );
        // item 21666
        menu.push(
            { type: "item", text: tr("MES_FORMAT"),
              code: function(x, y){
                changeFormat(x, y, [item.id]);
            }}
        );
    }
    // item 21620
    return menu
}

function buildMenuForMindJunction(editor, itemId) {
    // item 21680
    var menu = [];
    // item 21683
    if (editor.readonly) {
        
    } else {
        // item 21681
        var item = editor.storage.graph.getItem(
        	itemId
        );
        // item 21682
        var graph = editor.storage.graph;
        // item 21687
        var actions = getMindActions(editor, item)
        // item 21730
        if (actions.length > 0) {
            // item 216880001
            var _ind21688 = 0;
            var _col21688 = actions;
            var _len21688 = _col21688.length;
            while (true) {
                // item 216880002
                if (_ind21688 < _len21688) {
                    
                } else {
                    break;
                }
                // item 216880004
                var action = _col21688[_ind21688];
                // item 21686
                addMindMenuAction(action, menu)
                // item 216880003
                _ind21688++;
            }
        }
        // item 21953
        if ((actions.length > 0) && (getClipboardType() == "mind")) {
            // item 21961
            var subtree = getClipboard("mind")
            // item 21962
            if (subtree) {
                // item 219600001
                var _ind21960 = 0;
                var _col21960 = actions;
                var _len21960 = _col21960.length;
                while (true) {
                    // item 219600002
                    if (_ind21960 < _len21960) {
                        
                    } else {
                        break;
                    }
                    // item 219600004
                    var action = _col21960[_ind21960];
                    // item 21959
                    addMindPasteAction(action, subtree, menu)
                    // item 219600003
                    _ind21960++;
                }
            }
        }
    }
    // item 21679
    return menu
}

function buildMindSockets(graph, insertionSocket) {
    // item 22140
    var parts = insertionSocket.split("-");
    // item 22139
    var operation, socketType
    var sockets = []
    // item 22145
    if (parts[1] == "clip") {
        // item 22146
        operation = "paste"
        socketType = ""
    } else {
        // item 22141
        operation = "insert"
        socketType = parts[1]
    }
    // item 222250001
    var _ind22225 = 0;
    var _col22225 = graph.edges;
    var _keys22225 = Object.keys(_col22225); 
    var _len22225 = _keys22225.length;
    while (true) {
        // item 222250002
        if (_ind22225 < _len22225) {
            
        } else {
            break;
        }
        // item 222250004
        var eid = _keys22225[_ind22225]; var edge = _col22225[eid];
        // item 22268
        var actions = getMindActions(self, edge)
        // item 22229
        if (actions.length == 0) {
            
        } else {
            // item 22227
            appendSingleMindSocket(
            	sockets,
            	edge,
            	operation,
            	socketType,
            	actions
            )
        }
        // item 222250003
        _ind22225++;
    }
    // item 221970001
    var _ind22197 = 0;
    var _col22197 = graph.nodes;
    var _keys22197 = Object.keys(_col22197); 
    var _len22197 = _keys22197.length;
    while (true) {
        // item 221970002
        if (_ind22197 < _len22197) {
            
        } else {
            break;
        }
        // item 221970004
        var nid = _keys22197[_ind22197]; var node = _col22197[nid];
        // item 22199
        var actions = getMindActions(self, node)
        // item 22200
        if (actions.length == 0) {
            
        } else {
            // item 22203
            if (node.type == "junction") {
                // item 22231
                appendSingleMindSocket(
                	sockets,
                	node,
                	operation,
                	socketType,
                	actions
                )
            } else {
                // item 22206
                appendNodeMindSockets(
                	graph,
                	sockets,
                	node,
                	operation,
                	socketType,
                	actions
                )
            }
        }
        // item 221970003
        _ind22197++;
    }
    // item 22132
    return sockets
}

function buildMore(render, content, id, x, y, commList, subtype) {
    // item 19107
    content.subtype = subtype
    content.lineThickness = 2
    // item 19108
    var size = Items.newMore(content)
    // item 19105
    pushInsertFree(
    	render,
    	commList,
    	id,
    	"f_more",
    	x,
    	y,
    	size.w,
    	size.h,
    	content
    );
}

function buildMoveCommands(pgraph, moved, commands) {
    // item 23060001
    var _ind2306 = 0;
    var _col2306 = moved;
    var _keys2306 = Object.keys(_col2306); 
    var _len2306 = _keys2306.length;
    while (true) {
        // item 23060002
        if (_ind2306 < _len2306) {
            
        } else {
            break;
        }
        // item 23060004
        var id = _keys2306[_ind2306]; var _ = _col2306[id];
        // item 2308
        var item = pgraph.graph.getItem(id);
        // item 2899
        if (id in commands) {
            // item 2902
            var fields = commands[id].fields;
            fields.x = item.x;
            fields.y = item.y;
        } else {
            // item 2309
            var command = new Command(
            	"update",
            	"nodes",
            	id,
            	{
            		x: item.x,
            		y: item.y
            	}
            );
            // item 2310
            commands[id] = command;
        }
        // item 23060003
        _ind2306++;
    }
}

function buildPtrLeft(render, content, id, x, y, commList) {
    // item 23235
    content.h0x = 20
    // item 18919
    pushInsertFree(
    	render,
    	commList,
    	id,
    	"f_ptr_left",
    	x,
    	y,
    	Config.FREE_WIDTH,
    	Config.FREE_HEIGHT,
    	content
    );
}

function buildPtrRight(render, content, id, x, y, commList) {
    // item 18911
    content.h0x = 20
    // item 18912
    pushInsertFree(
    	render,
    	commList,
    	id,
    	"f_ptr_right",
    	x,
    	y,
    	Config.FREE_WIDTH,
    	Config.FREE_HEIGHT,
    	content
    );
}

function buildRounded(render, content, id, x, y, commList) {
    // item 18903
    content.radius = RoundedRadius
    // item 18901
    pushInsertFree(
    	render,
    	commList,
    	id,
    	"f_rounded",
    	x,
    	y,
    	Config.FREE_WIDTH,
    	Config.FREE_HEIGHT,
    	content
    );
}

function buildShelf(render, content, id, x, y, commList) {
    // item 18895
    pushInsertFree(
    	render,
    	commList,
    	id,
    	"shelf",
    	x,
    	y,
    	Config.FREE_WIDTH,
    	Config.FREE_HEIGHT * 2,
    	content
    );
}

function buildSideMarks(canvas) {
    // item 3685
    var graph = canvas.graph;
    // item 18580
    if (isFree(graph)) {
        
    } else {
        // item 9650
        if (isSilhouette(graph)) {
            // item 9659
            canvas.zone = 1;
            // item 96530001
            var _ind9653 = 0;
            var _col9653 = graph.nodes;
            var _keys9653 = Object.keys(_col9653); 
            var _len9653 = _keys9653.length;
            while (true) {
                // item 96530002
                if (_ind9653 < _len9653) {
                    
                } else {
                    break;
                }
                // item 96530004
                var nid = _keys9653[_ind9653]; var node = _col9653[nid];
                // item 9655
                if (node.type === "branch") {
                    // item 9812
                    var newZone = makeNewZone(canvas);
                    // item 15366
                    stack = [];
                    // item 9658
                    mark2DownBig(stack, canvas,  node, newZone);
                }
                // item 96530003
                _ind9653++;
            }
        } else {
            // item 3702
            var head = findHead(graph);
            // item 3719
            canvas.zone = 2;
            // item 15365
            var stack = [];
            // item 3703
            mark2DownBig(stack, canvas,  head, 1);
        }
        // item 38450001
        var _ind3845 = 0;
        var _col3845 = graph.nodes;
        var _keys3845 = Object.keys(_col3845); 
        var _len3845 = _keys3845.length;
        while (true) {
            // item 38450002
            if (_ind3845 < _len3845) {
                
            } else {
                break;
            }
            // item 38450004
            var nid = _keys3845[_ind3845]; var node = _col3845[nid];
            // item 3847
            if (node.type === "junction") {
                // item 3850
                var type = describeJunction(node);
                var edge;
                // item 38510001
                if (type === "left-down") {
                    // item 3860
                    edge = graph.getEdge(
                    	node.down
                    );
                    // item 3865
                    node.mark = edge.upperMark
                } else {
                    // item 38510002
                    if (type === "left-up") {
                        // item 3861
                        edge = graph.getEdge(
                        	node.up
                        );
                        // item 3865
                        node.mark = edge.upperMark
                    } else {
                        // item 38510003
                        if (type === "right-down") {
                            // item 3862
                            edge = graph.getEdge(
                            	node.right
                            );
                            // item 3864
                            node.mark = edge.lowerMark
                        } else {
                            // item 38510004
                            if (type === "right-up") {
                                // item 7922
                                edge = graph.getEdge(
                                	node.up
                                );
                                // item 7923
                                node.mark = edge.lowerMark
                            }
                        }
                    }
                }
            }
            // item 38450003
            _ind3845++;
        }
        // item 3650
        if (Config.SHOW_ZONES) {
            // item 3605
            drawMarks(canvas);
        }
    }
}

function buildSockets(editor, graph, initialId) {
    // item 3413
    var sockets;
    // item 16579
    if ((self.readonly) || (!(initialId in graph.items))) {
        // item 3412
        sockets = [];
    } else {
        // item 11365
        var id = findTransplantSource(graph, initialId)
        // item 3235
        if (id) {
            // item 11380
            editor.transplantSource = id;
            // item 5031
            var item = graph.getItem(id);
            // item 5028
            if (item.isLine) {
                
            } else {
                // item 5032
                id = item.up;
            }
            // item 10483
            if (item.type === "address") {
                // item 10485
                sockets = findAddressSockets(
                	graph,
                	id
                );
            } else {
                // item 18337
                if (isShortTExit(graph, item)) {
                    // item 18340
                    sockets = findTExitSockets(
                    	graph,
                    	item
                    );
                } else {
                    // item 3519
                    var poisoned = findPoisoned(
                    	graph,
                    	id
                    );
                    var isArrow = leadsToArrow(graph, id);
                    // item 20395
                    if (isBetweenTs(graph, item)) {
                        // item 20397
                        sockets = findTsSockets(
                        	graph,
                        	id,
                        	poisoned
                        );
                    } else {
                        // item 20700
                        if (isBetweenTs2(graph, item)) {
                            // item 20702
                            sockets = findTs2Sockets(
                            	graph,
                            	id,
                            	poisoned
                            );
                        } else {
                            // item 3132
                            sockets = findTargetSockets(
                            	graph,
                            	id,
                            	poisoned,
                            	isArrow
                            );
                        }
                    }
                }
            }
        } else {
            // item 3412
            sockets = [];
        }
    }
    // item 3414
    return sockets;
}

function buildTextBoxes() {
    // item 16615
    var editor = self;
    // item 17085
    buildBoxesForFree(editor)
    // item 16614
    var graph = editor.storage.graph;
    // item 166160001
    var _ind16616 = 0;
    var _col16616 = graph.nodes;
    var _keys16616 = Object.keys(_col16616); 
    var _len16616 = _keys16616.length;
    while (true) {
        // item 166160002
        if (_ind16616 < _len16616) {
            
        } else {
            break;
        }
        // item 166160004
        var id = _keys16616[_ind16616]; var node = _col16616[id];
        // item 16613
        var fields = Drakon.fitItem(node, render)
        // item 16618
        node.tb = fields.tb
        node.tb2 = fields.tb2
        // item 166160003
        _ind16616++;
    }
    // item 17976
    var free = editor.storage.free
    // item 179700001
    var _ind17970 = 0;
    var _col17970 = free.list;
    var _len17970 = _col17970.length;
    while (true) {
        // item 179700002
        if (_ind17970 < _len17970) {
            
        } else {
            break;
        }
        // item 179700004
        var id = _col17970[_ind17970];
        // item 17975
        var item = free.get(id)
        // item 17969
        var fields = Drakon.fitItem(item, render)
        // item 17972
        item.tb = fields.tb
        item.tb2 = fields.tb2
        // item 179700003
        _ind17970++;
    }
}

function calculateCommandUndo(storage, command) {
    var _sw167400000_ = 0;
    var _sw28870000_ = 0;
    // item 1660
    if (command.type === "insert") {
        // item 28870000
        _sw28870000_ = command.table;
        // item 28870001
        if (_sw28870000_ === "nodes") {
            // item 2895
            command.fields.isLine = false;
        } else {
            // item 28870002
            if (_sw28870000_ === "edges") {
                // item 2896
                command.fields.isLine = true;
            }
        }
    } else {
        // item 1658
        var undo = {}
        var old
        var graph = storage.graph
        var free = storage.free
        // item 167400000
        _sw167400000_ = command.table;
        // item 167400001
        if ((_sw167400000_ === "nodes") || (_sw167400000_ === "edges")) {
            // item 1650
            old = graph.getItem(command.id)
            // item 1663
            if (command.type === "update") {
                // item 17551
                takeOldValues(
                	command.fields,
                	old,
                	undo
                )
            } else {
                // item 16650001
                var _ind1665 = 0;
                var _col1665 = old;
                var _keys1665 = Object.keys(_col1665); 
                var _len1665 = _keys1665.length;
                while (true) {
                    // item 16650002
                    if (_ind1665 < _len1665) {
                        
                    } else {
                        break;
                    }
                    // item 16650004
                    var name = _keys1665[_ind1665]; var value = _col1665[name];
                    // item 1667
                    undo[name] = value;
                    // item 16650003
                    _ind1665++;
                }
            }
        } else {
            // item 167400003
            if (_sw167400000_ === "free") {
                // item 16751
                old = free.get(command.id)
                // item 1663
                if (command.type === "update") {
                    // item 17551
                    takeOldValues(
                    	command.fields,
                    	old,
                    	undo
                    )
                } else {
                    // item 16650001
                    var _ind1665 = 0;
                    var _col1665 = old;
                    var _keys1665 = Object.keys(_col1665); 
                    var _len1665 = _keys1665.length;
                    while (true) {
                        // item 16650002
                        if (_ind1665 < _len1665) {
                            
                        } else {
                            break;
                        }
                        // item 16650004
                        var name = _keys1665[_ind1665]; var value = _col1665[name];
                        // item 1667
                        undo[name] = value;
                        // item 16650003
                        _ind1665++;
                    }
                }
            } else {
                // item 167400004
                if (_sw167400000_ === "diagrams") {
                    
                } else {
                    // item 167400005
                    throw "Unexpected switch value: " + _sw167400000_;
                }
                // item 17552
                takeOldValues(
                	command.fields,
                	storage,
                	undo
                )
            }
        }
        // item 1659
        command.undo = undo;
    }
}

function calculateUndo(storage, commands) {
    // item 4402
    var commands2 = normalizeCommands(commands)
    // item 181420001
    var _ind18142 = 0;
    var _col18142 = commands2;
    var _len18142 = _col18142.length;
    while (true) {
        // item 181420002
        if (_ind18142 < _len18142) {
            
        } else {
            break;
        }
        // item 181420004
        var command = _col18142[_ind18142];
        // item 18144
        calculateCommandUndo(storage, command);
        // item 181420003
        _ind18142++;
    }
    // item 18145
    return commands2;
}

function canAddMore(editor, count) {
    // item 14543
    var graph = editor.storage.graph;
    var iconCount = getIconCount(graph);
    var total = iconCount + count;
    // item 14536
    if (total > Config.MAX_ICONS) {
        // item 14535
        showWarningPopup("Cannot add more icons to the diagram");
        // item 14539
        return false;
    } else {
        // item 14540
        return true;
    }
}

function canBeEdited(id) {
    // item 20030
    if (id) {
        // item 20028
        var item = getAnyItem(
        	self.storage,
        	id
        );
        // item 20033
        if (((item) && (!(item.isLine))) && (!(item.type === "junction"))) {
            // item 20034
            return true
        } else {
            // item 20035
            return false
        }
    } else {
        // item 20035
        return false
    }
}

function canCopyOne(graph, item) {
    var _sw124220000_ = 0;
    // item 19030
    if (item.isLine) {
        // item 19033
        return false;
    } else {
        // item 124220000
        _sw124220000_ = item.type;
        // item 124220001
        if (((((_sw124220000_ === "beginend") || (_sw124220000_ === "end")) || (_sw124220000_ === "address")) || (_sw124220000_ === "loopend")) || (_sw124220000_ === "junction")) {
            // item 12432
            return false;
        } else {
            // item 124220006
            if (_sw124220000_ === "branch") {
                // item 13420
                return true
            } else {
                // item 12434
                return item.role != "params"
            }
        }
    }
}

function canDeleteBranch(graph, item) {
    // item 10543
    var aboveId = graph.getNodeUp(item);
    var above = graph.getNode(aboveId);
    // item 10544
    if (above.left) {
        // item 10550
        var leftEdge = graph.getEdge(above.left);
        // item 10551
        if (leftEdge.role === "rarrow") {
            // item 10548
            return false;
        } else {
            // item 10549
            if (above.right) {
                // item 10547
                return true;
            } else {
                // item 19566
                var left = graph.getNode(leftEdge.head)
                // item 19569
                if (left.up) {
                    // item 10548
                    return false;
                } else {
                    // item 10547
                    return true;
                }
            }
        }
    } else {
        // item 10548
        return false;
    }
}

function canDeleteCase(graph, caseNode) {
    // item 8328
    var incoming = {};
    // item 8329
    var upId = graph.getNodeUp(caseNode);
    var upNode = graph.getNode(upId);
    // item 8330
    if (upNode.left) {
        // item 8334
        if (upNode.right) {
            // item 8341
            var id = graph.getNodeDown(caseNode);
            // item 8340
            var can = canDeleteOnIfBranch(
            	graph,
            	id,
            	incoming
            );
            // item 8953
            if (can) {
                // item 8951
                var visited = {};
                // item 8952
                return probeDeleteItem(graph, caseNode, visited);
            } else {
                // item 8956
                return false;
            }
        } else {
            // item 8337
            var leftId = graph.getNodeLeft(upNode);
            var left = graph.getNode(leftId);
            // item 8338
            if (left.left) {
                // item 8341
                var id = graph.getNodeDown(caseNode);
                // item 8340
                var can = canDeleteOnIfBranch(
                	graph,
                	id,
                	incoming
                );
                // item 8953
                if (can) {
                    // item 8951
                    var visited = {};
                    // item 8952
                    return probeDeleteItem(graph, caseNode, visited);
                } else {
                    // item 8956
                    return false;
                }
            } else {
                // item 8339
                return false;
            }
        }
    } else {
        // item 8333
        return false;
    }
}

function canDeleteIfBranch(graph, edgeId, incoming) {
    // item 5583
    var edge = graph.getEdge(edgeId);
    var rightNode = graph.getTail(edge);
    // item 8830
    if (isDegenerateExit(rightNode)) {
        // item 5589
        return true;
    } else {
        // item 5616
        var downEdge = graph.getEdge(rightNode.down);
        // item 5590
        return canDeleteOnIfBranch(
        	graph,
        	downEdge.tail,
        	incoming
        );
    }
}

function canDeleteItem(editor, item) {
    var _sw24420000_ = 0;
    // item 8293
    var graph = editor.storage.graph;
    // item 2437
    if (item.isLine) {
        // item 2440
        return false;
    } else {
        // item 24420000
        _sw24420000_ = item.type;
        // item 24420001
        if ((((_sw24420000_ === "junction") || (_sw24420000_ === "address")) || (_sw24420000_ === "end")) || (_sw24420000_ === "beginend")) {
            // item 2440
            return false;
        } else {
            // item 24420005
            if (_sw24420000_ === "question") {
                // item 5547
                return canDeleteQuestion(
                	graph,
                	item
                );
            } else {
                // item 24420006
                if (_sw24420000_ === "select") {
                    // item 8297
                    return canDeleteSelect(
                    	graph,
                    	item
                    );
                } else {
                    // item 24420007
                    if (_sw24420000_ === "case") {
                        // item 8300
                        return canDeleteCase(
                        	graph,
                        	item
                        );
                    } else {
                        // item 24420008
                        if (_sw24420000_ === "branch") {
                            // item 10537
                            return canDeleteBranch(
                            	graph,
                            	item
                            );
                        } else {
                            // item 2441
                            return true;
                        }
                    }
                }
            }
        }
    }
}

function canDeleteOnIfBranch(graph, nodeId, incoming) {
    var _sw56170000_ = 0;
    // item 5596
    var node = graph.getNode(nodeId);
    // item 5598
    if (node.down) {
        // item 5608
        var nextNodeId = graph.getNodeDown(
        	node
        );
        // item 56170000
        _sw56170000_ = node.type;
        // item 56170001
        if (_sw56170000_ === "junction") {
            // item 5624
            if ((node.left) && (!(node.left in incoming))) {
                // item 5637
                var leftNodeId = graph.getNodeLeft(
                	node
                );
                var leftNode = graph.getNode(
                	leftNodeId
                );
                // item 5628
                if (leftNode.type === "question") {
                    // item 5654
                    return true;
                } else {
                    // item 5642
                    return false;
                }
            } else {
                // item 5639
                return canDeleteOnIfBranch(
                	graph,
                	nextNodeId,
                	incoming
                );
            }
        } else {
            // item 56170002
            if (_sw56170000_ === "question") {
                // item 5643
                var trunkOk = canDeleteOnIfBranch(
                	graph,
                	nextNodeId,
                	incoming
                );
                // item 5648
                if (trunkOk) {
                    // item 5651
                    return canDeleteIfBranch(
                    	graph,
                    	node.right,
                    	incoming
                    );
                } else {
                    // item 5650
                    return false;
                }
            } else {
                // item 56170003
                if (_sw56170000_ === "select") {
                    // item 8350
                    var trunkOk = canDeleteOnIfBranch(
                    	graph,
                    	nextNodeId,
                    	incoming
                    );
                    // item 8351
                    if (trunkOk) {
                        // item 8373
                        return canDeleteSelectCore(
                        	graph,
                        	node,
                        	incoming
                        );
                    } else {
                        // item 8353
                        return false;
                    }
                } else {
                    // item 5607
                    return canDeleteOnIfBranch(
                    	graph,
                    	nextNodeId,
                    	incoming
                    );
                }
            }
        }
    } else {
        // item 5644
        if (node.right) {
            // item 5647
            incoming[node.right] = true;
        }
        // item 5602
        return true;
    }
}

function canDeleteQuestion(graph, question) {
    // item 5577
    var incoming = {};
    // item 5553
    var can = canDeleteIfBranch(
    	graph,
    	question.right,
    	incoming
    );
    // item 8809
    if (can) {
        // item 8831
        var rightId =graph.getNodeRight(question);
        var right = graph.getNode(rightId);
        // item 8832
        if (isDegenerateExit(right)) {
            // item 8833
            return true;
        } else {
            // item 8835
            var visited = {};
            // item 8836
            return probeDeleteItem(graph, right, visited);
        }
    } else {
        // item 8812
        return false;
    }
}

function canDeleteSelect(graph, select) {
    // item 8307
    var incoming = {};
    // item 8309
    var can = canDeleteSelectCore(
    	graph,
    	select,
    	incoming
    );
    // item 8945
    if (can) {
        // item 8950
        var visited = {};
        // item 8949
        return probeDeleteSelect(
        	graph,
        	select,
        	visited
        );
    } else {
        // item 8948
        return false;
    }
}

function canDeleteSelectCore(graph, select, incoming) {
    // item 8433
    var joints = getSelectJoints(
    	graph,
    	select.id
    );
    // item 8434
    var count = joints.length;
    var i;
    // item 84350001
    i = 1;
    while (true) {
        // item 84350002
        if (i < count) {
            
        } else {
            // item 8369
            return true;
        }
        // item 8437
        var joint = joints[i];
        var caseId = graph.getNodeDown(joint);
        // item 8438
        var can = canDeleteOnIfBranch(
        	graph,
        	caseId,
        	incoming
        );
        // item 8367
        if (can) {
            
        } else {
            // item 8370
            return false;
        }
        // item 84350003
        i++;
    }
}

function canEditText(x, y) {
    // item 12312
    var draggable = self.findVisualItem(
    	x,
    	y
    );
    // item 12313
    if ((draggable) && (canBeEdited(draggable.id))) {
        // item 12320
        return draggable.id;
    } else {
        // item 12319
        return null;
    }
}

function canGo(edgeId, sourceEdge) {
    // item 4849
    if ((edgeId) && (!(edgeId == sourceEdge))) {
        // item 4853
        return true;
    } else {
        // item 4854
        return false;
    }
}

function canGuide(item) {
    // item 19309
    if (item.type == "f_line") {
        // item 19312
        return false
    } else {
        // item 19313
        return true
    }
}

function canGuideDrakon(item) {
    // item 19362
    if (item.isLine) {
        // item 19361
        return false
    } else {
        // item 19413
        var type = item.type
        // item 19391
        if (((((type == "duration") || (type == "junction")) || (type == "case")) || (type == "branch")) || (type == "address")) {
            // item 19361
            return false
        } else {
            // item 19360
            return true
        }
    }
}

function canHaveLink(item) {
    // item 19805
    if (item.type in gNoLink) {
        // item 19808
        return false
    } else {
        // item 19809
        return true
    }
}

function canJoinTo(desc) {
    // item 3579
    if (((desc === "left-down") || (desc === "left-up")) || (desc === "right-up")) {
        // item 3582
        return desc;
    } else {
        // item 3585
        return null;
    }
}

function canTransplantFrom(graph, id) {
    // item 3390
    if (id) {
        // item 3379
        var item = graph.getItem(id);
        // item 3381
        if (item.isLine) {
            // item 3392
            if (item.isVertical) {
                // item 15295
                if (((item.role == "down") && (!(isEdgeOnMainSkewer(graph, item)))) && (!(hasItemsBelow(graph, item)))) {
                    // item 3394
                    return true;
                } else {
                    // item 3393
                    return false;
                }
            } else {
                // item 18331
                if (((isShortTExit(graph, item)) || (isBetweenTs(graph, item))) || (isBetweenTs2(graph, item))) {
                    // item 18333
                    return true
                } else {
                    // item 3393
                    return false;
                }
            }
        } else {
            // item 10463
            if (item.type === "address") {
                // item 10478
                if (isOnBranchSkewer(graph, id)) {
                    // item 10480
                    return false;
                } else {
                    // item 10464
                    return true;
                }
            } else {
                // item 11890
                if (item.type === "junction") {
                    // item 11878
                    var cat = describeJunction(item);
                    // item 11879
                    if ((cat == "left-up") && (questionOnLeft(graph, item))) {
                        // item 11881
                        return true;
                    } else {
                        // item 5035
                        if (item.up) {
                            // item 5037
                            return canTransplantFrom(graph, item.up);
                        } else {
                            // item 5036
                            return false;
                        }
                    }
                } else {
                    // item 5035
                    if (item.up) {
                        // item 5037
                        return canTransplantFrom(graph, item.up);
                    } else {
                        // item 5036
                        return false;
                    }
                }
            }
        }
    } else {
        // item 5036
        return false;
    }
}

function changeBackground(x, y) {
    // item 17515
    var fun = Callbacks.changeBackground
    // item 17511
    if (fun) {
        // item 17514
        fun(x, y)
    }
}

function changeFormat(x, y, ids) {
    // item 17638
    var fun = Callbacks.changeFormat
    // item 17634
    if (fun) {
        // item 17637
        fun(x, y, ids)
    }
}

function changeMindElementType(id, type) {
    // item 21866
    addTrace(
    	"change type",
    	[id, type]
    )
    // item 21872
    var fields = {
    	type: type
    }
    // item 21867
    if (type == "raction") {
        // item 21870
        var graph = self.storage.graph
        var item = graph.getNode(id)
        var content = Utils.copyObject(item.content)
        // item 21871
        content.radius = RoundedRadius
        fields.content = content
    }
    // item 21863
    var command = new Command(
    	"update",
    	"nodes",
    	id,
    	fields
    )
    // item 21864
    var commands = [command]
    // item 21865
    applyCommands(
    	self,
    	commands,
    	null
    )
}

function changeMindGrip(grip) {
    var _sw216040000_ = 0;
    // item 21601
    if (isMind()) {
        // item 216040000
        _sw216040000_ = grip.name;
        // item 216040001
        if (_sw216040000_ === Const.DRN_SIZE_R) {
            // item 21612
            grip.name = Const.MIND_SIZE_R
        } else {
            // item 216040002
            if (_sw216040000_ === Const.DRN_SIZE_L) {
                // item 21613
                grip.name = Const.MIND_SIZE_L
            }
        }
    }
}

function changeYesNo() {
    // item 19930
    var fun = Callbacks.changeYesNo
    // item 19926
    if (fun) {
        // item 19929
        fun()
    }
}

function checkGuide(guide, other, min, max) {
    // item 19514
    if (guide.edge == other) {
        // item 19517
        guide.found = true
        guide.min = Math.min(guide.min, min)
        guide.max = Math.max(guide.max, max)
    }
}

function clearFormat(ids, format) {
    // item 17953
    if (ignoreCommand()) {
        
    } else {
        // item 17950
        var editor = self
        // item 17951
        var makeContent = function(item) {
        	var old = getContent(item)
        	var newContent = removeFormat(old)
        	return newContent
        }
        // item 17952
        setContentForManyItems(
        	editor,
        	ids,
        	makeContent
        )
    }
}

function clearPathForSquare(pgraph, x, x2, yUp, dims, downNode, movedNodes) {
    // item 15594
    rayTraceRight(
    	pgraph,
    	x,
    	x2,
    	yUp,
    	movedNodes
    );
    // item 15595
    rayTraceDown(
    	pgraph,
    	x2,
    	yUp,
    	dims.y + Config.METRE,
    	movedNodes
    );
    // item 15597
    if (dims.y > downNode.y) {
        // item 15596
        rayTraceDownEx(
        	pgraph,
        	downNode.x,
        	downNode.y,
        	dims.y,
        	downNode.id,
        	movedNodes
        );
    }
}

function clearUndo() {
    // item 15878
    self.undo = new Undo();
}

function clickMindSocket(socket) {
    // item 22355
    if (socket.type == "paste") {
        // item 22359
        var subtree = getClipboard("mind")
        // item 22360
        if (subtree) {
            // item 22358
            mindPasteAction(
            	socket.action.action,
            	socket.action.itemId,
            	subtree
            )
        }
    } else {
        // item 22287
        mindAction(
        	socket.action.action,
        	socket.action.itemId,
        	socket.action.socketType
        )
    }
    // item 22286
    redraw()
}

function clickSocket(prim) {
    var _sw122140000_ = 0;
    // item 19788
    if (ignoreCommand()) {
        // item 19791
        return null
    } else {
        // item 12213
        var res;
        var socket =  self.canvas.sockets[prim];
        // item 22177
        if (isMind()) {
            // item 22179
            clickMindSocket(
            	socket
            )
        } else {
            // item 122140000
            _sw122140000_ = socket.type;
            // item 122140001
            if (_sw122140000_ === "liana") {
                // item 12212
                res = transplantLiana(self, prim);
            } else {
                // item 122140002
                if (_sw122140000_ === "insert") {
                    // item 12222
                    res = insertInSocket(self, prim);
                } else {
                    // item 122140003
                    if (_sw122140000_ === "paste") {
                        // item 13453
                        res = pasteInSocket(self, prim);
                    } else {
                        // item 13790
                        res = null;
                    }
                }
            }
        }
        // item 13792
        commandDone();
        // item 13791
        return res;
    }
}

function clipTypeToSocket(type) {
    // item 22443
    var map = {
        "block": "clip-block",
        "case": "clip-case",
        "branch": "clip-branch",
    	"duration": "clip-duration",
    	"mind": "mind-clip"
    }
    // item 22446
    return map[type]
}

function cloneDictionary(input) {
    // item 4773
    var output = {};
    // item 47750001
    var _ind4775 = 0;
    var _col4775 = input;
    var _keys4775 = Object.keys(_col4775); 
    var _len4775 = _keys4775.length;
    while (true) {
        // item 47750002
        if (_ind4775 < _len4775) {
            
        } else {
            break;
        }
        // item 47750004
        var key = _keys4775[_ind4775]; var value = _col4775[key];
        // item 4777
        var clone = cloneNotEmpty(value);
        output[key] = clone;
        // item 47750003
        _ind4775++;
    }
    // item 4774
    return output;
}

function cloneNotEmpty(object) {
    // item 4765
    var clone = {};
    // item 47630001
    var _ind4763 = 0;
    var _col4763 = object;
    var _keys4763 = Object.keys(_col4763); 
    var _len4763 = _keys4763.length;
    while (true) {
        // item 47630002
        if (_ind4763 < _len4763) {
            
        } else {
            break;
        }
        // item 47630004
        var key = _keys4763[_ind4763]; var value = _col4763[key];
        // item 4760
        if (value === null) {
            
        } else {
            // item 4767
            clone[key] = value;
        }
        // item 47630003
        _ind4763++;
    }
    // item 4766
    return clone;
}

function collapseBolt(editor, edgeId) {
    // item 18217
    var editing = collapseBoltCore(
    	editor,
    	edgeId
    )
    // item 7089
    applyCommands(
    	editor,
    	editing.commandList,
    	null
    )
}

function collapseBoltCore(editor, edgeId) {
    // item 18214
    addTrace(
    	"remove line",
    	[edgeId]
    );
    // item 18199
    var movedNodes = {};
    var commands = {};
    // item 18192
    var pgraph = createPhysicalGraph(
    	editor.storage.graph,
    	editor.render
    );
    var graph = pgraph.graph;
    // item 18193
    var edge = graph.getEdge(edgeId);
    var head = graph.getHead(edge);
    var tail = graph.getTail(edge);
    var delta = tail.y - head.y;
    // item 18207
    var leftEdge = graph.getEdge(head.left);
    var rightEdge = graph.getEdge(tail.right);
    // item 18194
    pgraph.deletePhysicalItem(
    	head.left
    );
    // item 18195
    pgraph.deletePhysicalItem(
    	edgeId
    );
    // item 18196
    pgraph.deletePhysicalItem(
    	head.id
    );
    // item 18215
    rebuildPhysicsCache(pgraph);
    // item 18203
    pgraph.moveDown(
    	tail.id,
    	-delta,
    	movedNodes
    );
    // item 18213
    delete movedNodes[tail.id];
    // item 18198
    buildMoveCommands(
    	pgraph,
    	movedNodes,
    	commands
    );
    // item 18197
    var commandList = Utils.objectValues(commands);
    // item 18204
    pushDeleteEdge(
    	commandList,
    	leftEdge.id
    );
    // item 18205
    pushDeleteEdge(
    	commandList,
    	edgeId
    );
    // item 18206
    pushDeleteEdge(
    	commandList,
    	rightEdge.id
    );
    // item 18208
    pushDeleteNode(
    	commandList,
    	head.id
    );
    // item 18209
    pushDeleteNode(
    	commandList,
    	tail.id
    );
    // item 18212
    var newEdge = generateId(editor.storage);
    // item 18211
    pushInsertHorizontal(
    	commandList,
    	newEdge,
    	leftEdge.head,
    	rightEdge.tail,
    	null
    );
    // item 18216
    return {
    	commandList: commandList
    }
}

function combineRunCommands(edit, newCommands) {
    // item 22803
    var newList = Utils.objectValues(newCommands)
    // item 23061
    if (newList.length == 0) {
        
    } else {
        // item 23064
        edit.dirty = true
        // item 22804
        var newList2 = calculateUndo(
        	self.storage,
        	newList
        )
        // item 22809
        performLocalChange(
        	self,
        	newList2,
        	false
        )
        // item 22805
        edit.commands = edit.commands.concat(newList2)
    }
}

function commandDone() {
    // item 13802
    var fun = Callbacks.commandDone;
    // item 13798
    if (fun) {
        // item 13801
        fun();
    }
}

function concatAndSaveUndo(editor, commandList1, commandList2, before, after) {
    // item 18243
    var commandList = commandList1.concat(
    	commandList2
    )
    // item 18244
    commandList = normalizeCommands(commandList)
    // item 18242
    addToUndo(editor.undo, before, commandList, after)
}

function connectHor(editor, commList, left, right, role) {
    // item 8224
    var id = generateId(editor.storage);
    // item 8225
    pushInsertHorizontal(
    	commList,
    	id,
    	left,
    	right,
    	role
    );
}

function connectVer(editor, commList, up, down, role) {
    // item 8244
    var id = generateId(editor.storage);
    // item 8246
    pushInsertVertical(
    	commList,
    	id,
    	up,
    	down,
    	role
    );
    // item 18252
    return id
}

function contEqual(cont1, cont2) {
    // item 15901
    if (cont1) {
        // item 15904
        if (((cont2) && (cont1.txt == cont2.txt)) && (cont1.txt2 == cont2.txt2)) {
            // item 15915
            return true;
        } else {
            // item 15910
            return false;
        }
    } else {
        // item 15907
        if (cont2) {
            // item 15911
            return false;
        } else {
            // item 15912
            return true;
        }
    }
}

function convertGroup(idMap, node) {
    // item 12804
    if (node.group) {
        // item 12808
        if (node.group in idMap) {
            // item 12811
            return idMap[node.group];
        } else {
            // item 12812
            return node.group;
        }
    } else {
        // item 12807
        return null;
    }
}

function copy() {
    // item 22415
    if (isMind()) {
        // item 22418
        editAction(
        	function(editor, id) { copyMind(id, false) },
        	function() { },
        	function(editor, ids) { copyFree(editor, ids, true, false) }
        )
    } else {
        // item 18547
        editAction(
        	function(editor, id) { copyOne(editor, id, false) },
        	function() { copyBlock(true, false) },
        	function(editor, ids) { copyFree(editor, ids, true, false) }
        )
    }
}

function copyAndSort(items, free) {
    // item 17438
    var error = null
    // item 17310
    if (items) {
        // item 16778
        var sorted = Utils.sortLinkedList(items, "next")
        // item 167790001
        var _ind16779 = 0;
        var _col16779 = sorted;
        var _len16779 = _col16779.length;
        while (true) {
            // item 167790002
            if (_ind16779 < _len16779) {
                
            } else {
                break;
            }
            // item 167790004
            var item = _col16779[_ind16779];
            // item 16781
            free.add(item.id, item)
            // item 167790003
            _ind16779++;
        }
        // item 17434
        var keys = Object.keys(items)
        // item 17435
        if (keys.length == free.list.length) {
            
        } else {
            // item 17439
            error = "ERR_FREE_ORDER"
        }
    }
    // item 17440
    return error
}

function copyBlock(doCopy, andDelete) {
    // item 18943
    addTrace(
    	"copy block",
    	[doCopy, andDelete]
    );
    // item 14319
    var right = null;
    var lower = null;
    // item 14590
    var selection = copySelection(
    	self.storage.selection
    )
    var gblock = selection.block;
    // item 14206
    if ((gblock) && (gblock.top)) {
        // item 14247
        var graph = self.storage.graph;
        var render = self.render;
        // item 14225
        var edges = {};
        // item 142210001
        var _ind14221 = 0;
        var _col14221 = gblock.nodes;
        var _keys14221 = Object.keys(_col14221); 
        var _len14221 = _keys14221.length;
        while (true) {
            // item 142210002
            if (_ind14221 < _len14221) {
                
            } else {
                break;
            }
            // item 142210004
            var nodeId = _keys14221[_ind14221]; var _ = _col14221[nodeId];
            // item 14223
            var node = graph.getNode(nodeId);
            // item 14224
            Utils.addNotNilToSet(edges, node.left);
            Utils.addNotNilToSet(edges, node.up);
            Utils.addNotNilToSet(edges, node.right);
            Utils.addNotNilToSet(edges, node.down);
            // item 142210003
            _ind14221++;
        }
        // item 14242
        var topNode = graph.getNode(gblock.top);
        var bottomNode = graph.getNode(gblock.bottom);
        // item 14313
        delete edges[topNode.up];
        // item 14314
        if (hasLeft(graph, bottomNode)) {
            // item 14317
            lower = findBottomNodes(
            	graph,
            	gblock.nodes,
            	bottomNode
            );
            // item 14356
            var rid = lower[lower.length - 1];
            right = graph.getNode(rid);
            // item 14318
            delete edges[bottomNode.left];
            // item 14388
            if (right.right) {
                // item 14391
                delete edges[right.right];
            }
        } else {
            // item 14312
            delete edges[bottomNode.down];
        }
        // item 14246
        var graph2 = copyGraphSection(
        	graph,
        	gblock.nodes,
        	edges,
        	gblock.top
        );
        // item 14248
        var subgraph = {
        	graph: graph2,
        	first: gblock.top,
        	last: gblock.bottom
        };
        // item 14333
        if (lower) {
            // item 14336
            cutOffSilhBottom(
            	subgraph,
            	lower
            );
        }
        // item 14260
        if (andDelete) {
            // item 18942
            addTrace(
            	"delete subgraph",
            	[gblock.top, gblock.bottom]
            );
            // item 14382
            var addressId = null;
            // item 14377
            if (lower) {
                // item 14380
                edges[topNode.up] = true;
                // item 14381
                delete gblock.nodes[bottomNode.id];
                delete edges[bottomNode.up];
                addressId = graph.getNodeUp(bottomNode);
                delete gblock.nodes[addressId];
                // item 14411
                if (right.right) {
                    // item 14414
                    edges[right.right] = true;
                }
            } else {
                // item 14263
                edges[topNode.up] = true;
                edges[bottomNode.down] = true;
            }
            // item 14265
            var commandList = [];
            // item 14264
            pushDeleteSubgraph(
            	commandList,
            	gblock.nodes,
            	edges
            );
            // item 18253
            var edgeId = null
            // item 14397
            if (lower) {
                // item 14400
                var aboveId = graph.getNodeUp(topNode);
                // item 14401
                connectVer(
                	self,
                	commandList,
                	aboveId,
                	addressId,
                	"down",
                	null
                );
                // item 14402
                if (right.right) {
                    // item 14407
                    var afterRightId = graph.getNodeRight(right);
                    // item 14406
                    connectHor(
                    	self,
                    	commandList,
                    	bottomNode.id,
                    	afterRightId,
                    	"sil_floor",
                    	null
                    );
                    // item 14405
                    delete edges[right.right];
                }
            } else {
                // item 14395
                var aboveId = graph.getNodeUp(topNode);
                var belowId = graph.getNodeDown(bottomNode);
                // item 16393
                var oldLowEdge = graph.getEdge(bottomNode.down);
                var oldRole = oldLowEdge.role;
                // item 14396
                edgeId = connectVer(
                	self,
                	commandList,
                	aboveId,
                	belowId,
                	oldRole,
                	null
                );
            }
            // item 18254
            runAndCollapse(
            	self,
            	commandList,
            	edgeId
            )
        }
        // item 14567
        if (doCopy) {
            // item 18970
            addTrace(
            	"copy subgraph",
            	[gblock.top, gblock.bottom]
            );
            // item 14232
            var type = "block";
            var socket = "clip-block";
            // item 14230
            copyToClipboard(
            	type,
            	subgraph
            );
            // item 16581
            if (self.readonly) {
                
            } else {
                // item 14231
                showInsertionSockets(socket);
            }
        }
        // item 14624
        commandDone();
    }
}

function copyBranch(render, graph, id) {
    // item 13188
    var bgraph = findBranchGraph(graph, id);
    // item 19023
    if (bgraph) {
        // item 13189
        var nodes = bgraph.nodes;
        var edges = bgraph.edges;
        // item 13122
        var graph2 = copyGraphSection(
        	graph,
        	nodes,
        	edges,
        	bgraph.top
        );
        // item 19732
        replaceExit(render, bgraph, graph2)
        // item 13144
        return {
        	graph: graph2,
        	top: bgraph.top,
        	bottom: bgraph.bottom,
        	rBottom: bgraph.rBottom
        };
    } else {
        // item 19026
        return null
    }
}

function copyCoreBranchInfo(output, node) {
    // item 23033
    var text = getContent(node).txt || ""
    // item 23034
    if (text) {
        // item 23018
        var item = {
        	id: node.id,
        	x: node.x,
        	text: text,
        	marked: false
        }
        // item 23019
        output.push(item)
    }
}

function copyFree(editor, ids, doCopy, andDelete) {
    // item 17152
    var free = editor.storage.free
    // item 17158
    if (doCopy) {
        // item 17298
        var linkedList = []
        var idSet = Utils.listToSet(ids)
        // item 172850001
        var _ind17285 = 0;
        var _col17285 = free.list;
        var _len17285 = _col17285.length;
        while (true) {
            // item 172850002
            if (_ind17285 < _len17285) {
                
            } else {
                break;
            }
            // item 172850004
            var id = _col17285[_ind17285];
            // item 17299
            if (id in idSet) {
                // item 17302
                linkedList.push({
                	id: id,
                	next: ""
                })
            }
            // item 172850003
            _ind17285++;
        }
        // item 17176
        setNextPointers(linkedList)
        // item 17162
        var items = []
        // item 171630001
        var _ind17163 = 0;
        var _col17163 = linkedList;
        var _len17163 = _col17163.length;
        while (true) {
            // item 171630002
            if (_ind17163 < _len17163) {
                
            } else {
                break;
            }
            // item 171630004
            var node = _col17163[_ind17163];
            // item 17165
            var original = free.get(node.id)
            var item = copyStorageItem(original)
            item.next = node.next
            // item 17166
            items.push(item)
            // item 171630003
            _ind17163++;
        }
        // item 17167
        var payload = {
        	items: items
        }
        // item 17161
        copyToClipboard(
        	"free",
        	payload
        );
    }
    // item 17169
    if (andDelete) {
        // item 17168
        deleteFreeItems(editor, ids)
    }
}

function copyGraphSection(graph, nodes, edges, startId) {
    // item 13372
    var graph2 = copyGraphSectionNoMove(
    	graph,
    	nodes,
    	edges
    );
    // item 13369
    var start = graph.getNode(startId);
    // item 13370
    moveGraphBy(graph2, -start.x, -start.y);
    // item 13371
    return graph2;
}

function copyGraphSectionNoMove(graph, nodes, edges) {
    // item 13195
    var graph2 = new Utils.Manhattan();
    // item 131920001
    var _ind13192 = 0;
    var _col13192 = nodes;
    var _keys13192 = Object.keys(_col13192); 
    var _len13192 = _keys13192.length;
    while (true) {
        // item 131920002
        if (_ind13192 < _len13192) {
            
        } else {
            break;
        }
        // item 131920004
        var id = _keys13192[_ind13192]; var _ = _col13192[id];
        // item 13194
        var node = graph.getNode(id);
        var node2 = Utils.copyObject(node);
        // item 14374
        node2.left = null;
        node2.up = null;
        node2.right = null;
        node2.down = null;
        // item 13196
        graph2.addItem(node2);
        // item 131920003
        _ind13192++;
    }
    // item 131970001
    var _ind13197 = 0;
    var _col13197 = edges;
    var _keys13197 = Object.keys(_col13197); 
    var _len13197 = _keys13197.length;
    while (true) {
        // item 131970002
        if (_ind13197 < _len13197) {
            
        } else {
            break;
        }
        // item 131970004
        var id = _keys13197[_ind13197]; var _ = _col13197[id];
        // item 13199
        var edge = graph.getEdge(id);
        var edge2 = Utils.copyObject(edge);
        // item 13200
        graph2.addItem(edge2);
        // item 131970003
        _ind13197++;
    }
    // item 13212
    return graph2;
}

function copyMind(itemId, andDelete) {
    // item 21888
    var graph = self.storage.graph
    // item 21889
    var subtree = Mind.copySubtree(
    	graph,
    	itemId
    )
    // item 21890
    copyToClipboard(
    	"mind",
    	subtree
    )
    // item 21893
    if (andDelete) {
        // item 21891
        deleteMind(itemId)
    }
    // item 22354
    showInsertionSockets("mind-clip")
}

function copyOne(editor, id, cut) {
    var _sw128790000_ = 0;
    // item 12877
    var subgraph = null;
    var type = "block";
    var graph = editor.storage.graph;
    var render = editor.render;
    // item 12878
    var main = graph.getItem(id);
    // item 19034
    if (canCopyOne(graph, main)) {
        // item 128790000
        _sw128790000_ = main.type;
        // item 128790001
        if (_sw128790000_ === "question") {
            // item 12971
            subgraph = buildMacroQuestion(
            	render,
            	main.content,
            	main.flag1
            );
            // item 12936
            if (subgraph) {
                // item 12939
                copyToClipboard(
                	type,
                	subgraph
                );
                // item 16580
                if (self.readonly) {
                    
                } else {
                    // item 12988
                    if (cut) {
                        // item 12989
                        deleteItem(editor, id);
                    }
                    // item 22447
                    var socket = clipTypeToSocket(type)
                    // item 13449
                    if (socket) {
                        // item 13450
                        showInsertionSockets(socket);
                    }
                }
            }
        } else {
            // item 128790002
            if (_sw128790000_ === "select") {
                // item 12986
                var cases = findCases(graph, main);
                // item 12987
                subgraph = buildMacroSelect(
                	render,
                	main.content,
                	cases
                );
                // item 12936
                if (subgraph) {
                    // item 12939
                    copyToClipboard(
                    	type,
                    	subgraph
                    );
                    // item 16580
                    if (self.readonly) {
                        
                    } else {
                        // item 12988
                        if (cut) {
                            // item 12989
                            deleteItem(editor, id);
                        }
                        // item 22447
                        var socket = clipTypeToSocket(type)
                        // item 13449
                        if (socket) {
                            // item 13450
                            showInsertionSockets(socket);
                        }
                    }
                }
            } else {
                // item 128790003
                if (_sw128790000_ === "loopbegin") {
                    // item 12969
                    var lowId = Drakon.findEndLoop(graph, main);
                    var low = graph.getNode(lowId);
                    // item 12970
                    subgraph = buildMacroLoop(
                    	render,
                    	main.content,
                    	low.content
                    );
                    // item 12936
                    if (subgraph) {
                        // item 12939
                        copyToClipboard(
                        	type,
                        	subgraph
                        );
                        // item 16580
                        if (self.readonly) {
                            
                        } else {
                            // item 12988
                            if (cut) {
                                // item 12989
                                deleteItem(editor, id);
                            }
                            // item 22447
                            var socket = clipTypeToSocket(type)
                            // item 13449
                            if (socket) {
                                // item 13450
                                showInsertionSockets(socket);
                            }
                        }
                    }
                } else {
                    // item 128790004
                    if (_sw128790000_ === "case") {
                        // item 12940
                        subgraph = {
                        	content: main.content
                        };
                        // item 13069
                        type = "case";
                        // item 12936
                        if (subgraph) {
                            // item 12939
                            copyToClipboard(
                            	type,
                            	subgraph
                            );
                            // item 16580
                            if (self.readonly) {
                                
                            } else {
                                // item 12988
                                if (cut) {
                                    // item 12989
                                    deleteItem(editor, id);
                                }
                                // item 22447
                                var socket = clipTypeToSocket(type)
                                // item 13449
                                if (socket) {
                                    // item 13450
                                    showInsertionSockets(socket);
                                }
                            }
                        }
                    } else {
                        // item 128790005
                        if (_sw128790000_ === "branch") {
                            // item 13190
                            subgraph = copyBranch(render, graph, id);
                            // item 19020
                            if (subgraph) {
                                // item 13191
                                type = "branch";
                                // item 12936
                                if (subgraph) {
                                    // item 12939
                                    copyToClipboard(
                                    	type,
                                    	subgraph
                                    );
                                    // item 16580
                                    if (self.readonly) {
                                        
                                    } else {
                                        // item 12988
                                        if (cut) {
                                            // item 12989
                                            deleteItem(editor, id);
                                        }
                                        // item 22447
                                        var socket = clipTypeToSocket(type)
                                        // item 13449
                                        if (socket) {
                                            // item 13450
                                            showInsertionSockets(socket);
                                        }
                                    }
                                }
                            }
                        } else {
                            // item 128790006
                            if (_sw128790000_ === "duration") {
                                // item 15274
                                subgraph = main.content;
                                // item 15271
                                type = "duration";
                                // item 12936
                                if (subgraph) {
                                    // item 12939
                                    copyToClipboard(
                                    	type,
                                    	subgraph
                                    );
                                    // item 16580
                                    if (self.readonly) {
                                        
                                    } else {
                                        // item 12988
                                        if (cut) {
                                            // item 12989
                                            deleteItem(editor, id);
                                        }
                                        // item 22447
                                        var socket = clipTypeToSocket(type)
                                        // item 13449
                                        if (socket) {
                                            // item 13450
                                            showInsertionSockets(socket);
                                        }
                                    }
                                }
                            } else {
                                // item 18990
                                if (main.role == "params") {
                                    
                                } else {
                                    // item 13062
                                    subgraph = buildMacroSimple(
                                    	render,
                                    	main.type,
                                    	main.content
                                    );
                                    // item 12936
                                    if (subgraph) {
                                        // item 12939
                                        copyToClipboard(
                                        	type,
                                        	subgraph
                                        );
                                        // item 16580
                                        if (self.readonly) {
                                            
                                        } else {
                                            // item 12988
                                            if (cut) {
                                                // item 12989
                                                deleteItem(editor, id);
                                            }
                                            // item 22447
                                            var socket = clipTypeToSocket(type)
                                            // item 13449
                                            if (socket) {
                                                // item 13450
                                                showInsertionSockets(socket);
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}

function copyPoints(src, dst) {
    // item 191140001
    var _ind19114 = 0;
    var _col19114 = src;
    var _len19114 = _col19114.length;
    while (true) {
        // item 191140002
        if (_ind19114 < _len19114) {
            
        } else {
            break;
        }
        // item 191140004
        var point = _col19114[_ind19114];
        // item 19116
        var copy = {
        	x: point.x,
        	y: point.y,
        	id: point.id
        }
        dst.push(copy)
        // item 191140003
        _ind19114++;
    }
}

function copySelection(selection) {
    // item 14630
    if ((selection) && (selection.ids)) {
        // item 14634
        return Utils.copyObjectDeep(selection);
    } else {
        // item 14633
        return createSelection();
    }
}

function copyState(editor) {
    // item 1830
    var selection = copySelection(
    	editor.storage.selection
    );
    var pan = null;
    // item 1828
    return {
    	origin: pan,
    	selection: selection
    };
}

function copyStorageItem(item) {
    // item 801
    var copy = {
    	id:	item.id,
    	type:	item.type,
    	isLine: item.isLine,
    	isVertical: item.isVertical,
    	x:	item.x,
    	y:	item.y,
    	w:	item.w,
    	h:	item.h,
    	a:	item.a,
    	b:	item.b,
    	content:	item.content,
    	head:	item.head,
    	tail:	item.tail,
    	flag1:  item.flag1,
    	role:   item.role,
    	group: item.group,
    	tb: item.tb,
    	free: item.free,
    	next: item.next
    };
    // item 15920
    if (item.tb2) {
        // item 15923
        copy.tb2 = item.tb2;
    }
    // item 15924
    return copy;
}

function copyText(editor, cont) {
    // item 9562
    var content = {
    	content: cont
    };
    // item 13054
    copyToClipboard("text", content);
}

function copyToClipboard(type, subgraph) {
    // item 12999
    var fun = Callbacks.copyToClipboard;
    // item 12995
    if (fun) {
        // item 12998
        fun(type, subgraph);
    }
}

function createBoltMenuItem(editor, edge) {
    // item 11629
    return	{type: "item", text: tr("MES_REMOVE_LINE"),
    	      image: "collapse.png",
    		code: function() {
    			collapseBolt(editor, edge.id);
    	}};
}

function createCycle(editor, pgraph, source, target) {
    // item 6919
    var graph = pgraph.graph;
    // item 6911
    var movedNodes = {};
    var commands = {};
    // item 6912
    extendEdge(
    	pgraph,
    	target,
    	0,
    	movedNodes
    );
    // item 6921
    var sourceEdge = graph.getEdge(
    	source
    );
    var sourceTail = graph.getTail(
    	sourceEdge
    );
    var sourceHead = graph.getHead(
    	sourceEdge
    );
    var targetEdge = graph.getEdge(
    	target
    );
    var targetTail = graph.getTail(
    	targetEdge
    );
    // item 6922
    var dims = findLedgeDimensions(
    	graph,
    	targetTail.id,
    	sourceTail.id
    );
    // item 6926
    var x = targetTail.x;
    var x2 = dims.x;
    var y = targetTail.box.top - Config.METRE;
    // item 15600
    clearPathForSquare(
    	pgraph,
    	x,
    	x2,
    	y,
    	dims,
    	sourceTail,
    	movedNodes
    );
    // item 19064
    if ((isDownLeft(sourceHead)) && (dims.y > sourceHead.y)) {
        // item 19068
        var dy = dims.y - sourceHead.y
        // item 19069
        pgraph.moveDown(
        	sourceHead.id,
        	dy,
        	movedNodes
        );
    }
    // item 6910
    buildMoveCommands(
    	pgraph,
    	movedNodes,
    	commands
    );
    // item 6909
    var commandList = Utils.objectValues(commands);
    // item 6933
    deleteLiana(
    	editor,
    	graph,
    	sourceEdge,
    	commandList
    );
    // item 6946
    pushDeleteEdge(
    	commandList,
    	targetEdge.id
    );
    // item 6934
    var upperJun = insertJunctionBetween(
    	editor,
    	graph,
    	targetEdge.head,
    	targetEdge.tail,
    	y,
    	commandList
    );
    // item 6935
    var arrowId = generateId(editor.storage);
    var upRightId = generateId(editor.storage);
    var upId = generateId(editor.storage);
    // item 6937
    pushInsertJunction(
    	commandList,
    	upRightId,
    	x2,
    	y
    );
    // item 6936
    pushInsertHorizontal(
    	commandList,
    	arrowId,
    	upperJun,
    	upRightId,
    	"arrow"
    );
    // item 18036
    if (isDownLeft(sourceHead)) {
        // item 18038
        pushUpdate(
        	commandList,
        	"nodes",
        	sourceHead.id,
        	{
        		x: x2
        	}
        )
        // item 18039
        pushInsertVertical(
        	commandList,
        	upId,
        	upRightId,
        	sourceHead.id,
        	null
        );
    } else {
        // item 18020
        var downRightId = generateId(editor.storage);
        var rightId = generateId(editor.storage);
        var downLeftId = generateId(editor.storage);
        var downId = generateId(editor.storage);
        // item 18022
        pushInsertJunction(
        	commandList,
        	downRightId,
        	x2,
        	dims.y
        );
        // item 18023
        pushInsertJunction(
        	commandList,
        	downLeftId,
        	sourceHead.x,
        	dims.y
        );
        // item 6945
        pushInsertVertical(
        	commandList,
        	upId,
        	upRightId,
        	downRightId,
        	null
        );
        // item 6943
        pushInsertHorizontal(
        	commandList,
        	rightId,
        	downLeftId,
        	downRightId,
        	"right"
        );
        // item 6944
        pushInsertDown(
        	commandList,
        	downId,
        	sourceHead.id,
        	downLeftId
        );
    }
    // item 6920
    return commandList;
}

function createDiagram(name, type) {
    // item 16626
    var storage = new Storage(self.persistence)
    storage.type = type
    storage.version = Config.DIAGRAM_VERSION
    // item 16628
    setStorage(self, storage)
    // item 12275
    var commList = [];
    // item 12273
    var render = self.render;
    // item 18564
    var font = getDefault("font")
    // item 18565
    if (font) {
        
    } else {
        // item 18568
        font = Utils.buildFontString(
        	false,
        	false,
        	Config.FONT_SIZE,
        	Config.FONT_FAMILY
        )
    }
    // item 17956
    self.render.setDefaultFont(
    	font
    )
    // item 207550001
    if (type === "drakon") {
        // item 15917
        var cEnd = makeCont(getEnd());
        // item 16379
        var header = createHeader(name)
        // item 16380
        var footer = makeDummyItem(
        	2,
        	render,
        	"end",
        	cEnd
        );
        // item 12274
        var headerY = 100;
        var x = 300;
        var footerY = headerY + header.h + footer.h + 200;
        // item 16381
        header.x = x;
        header.y = headerY;
        header.role = "header";
        footer.x = x;
        footer.y = footerY;
        footer.w = Config.MIN_ICON_WIDTH;
        // item 12280
        var headerId = generateId(self.storage);
        var footerId = generateId(self.storage);
        var edgeId = generateId(self.storage);
        // item 16382
        pushInsertNode(
        	commList,
        	headerId,
        	header
        );
        // item 16383
        pushInsertNode(
        	commList,
        	footerId,
        	footer
        );
        // item 12281
        pushInsertDown(
        	commList,
        	edgeId,
        	headerId,
        	footerId
        );
    } else {
        // item 207550002
        if (type === "mind") {
            // item 20778
            self.storage.nextId = createMind(
            	render,
            	name,
            	commList
            )
        }
    }
    // item 17591
    setNotNullFields(
    	commList,
    	["background", "diaLine"]
    )
    // item 18819
    setNotNullFields(
    	commList,
    	["background", "diaLineThickness"]
    )
    // item 17936
    commList.push(new Command(
    	"update",
    	"diagrams",
    	"diagram",
    	{font: font}
    ));
    // item 12283
    var state = {
    	origin: null,
    	selection: createSelection()
    };
    // item 12285
    self.storage.name = name;
    // item 12284
    executeCommands(
    	self,
    	commList,
    	state,
    	false,
    	false,
    	new ActionInfo("create diagram", [name])
    );
    // item 23110
    persistChanges(commList, false)
}

function createGraph(obj) {
    // item 13040
    var graph = new Utils.Manhattan();
    // item 130420001
    var _ind13042 = 0;
    var _col13042 = obj.nodes;
    var _keys13042 = Object.keys(_col13042); 
    var _len13042 = _keys13042.length;
    while (true) {
        // item 130420002
        if (_ind13042 < _len13042) {
            
        } else {
            break;
        }
        // item 130420004
        var id = _keys13042[_ind13042]; var node = _col13042[id];
        // item 13044
        graph.addItem(node);
        // item 130420003
        _ind13042++;
    }
    // item 130450001
    var _ind13045 = 0;
    var _col13045 = obj.edges;
    var _keys13045 = Object.keys(_col13045); 
    var _len13045 = _keys13045.length;
    while (true) {
        // item 130450002
        if (_ind13045 < _len13045) {
            
        } else {
            break;
        }
        // item 130450004
        var id = _keys13045[_ind13045]; var edge = _col13045[id];
        // item 13047
        graph.addItem(edge);
        // item 130450003
        _ind13045++;
    }
    // item 13041
    return graph;
}

function createHeader(name) {
    // item 21195
    var cName = makeHeaderCont(name);
    // item 21196
    var header = makeDummyItem(
    	1,
    	render,
    	"duration",
    	cName
    )
    header.type = "beginend"
    header.w = Math.max(Config.DEF_ICON_WIDTH_S, header.w)
    // item 21197
    return header
}

function createInsertBranchMenuItem(editor, item) {
    // item 11662
    return { 
        type: "item", text: tr("MES_INSERT_BRANCH"),
        image: "branch.png",
        code: function(){
            insertAndEdit(editor, item.id, "branch");
        }};
}

function createInsertCaseMenuItem(editor, item) {
    // item 11656
    return {
      type: "item", text: tr("MES_INSERT_CASE"),
      image: "case.png",
      code: function(){
    	insertAndEdit(editor, item.id, "case");
    }};
}

function createInsertEndBranchMenuItem(editor, item) {
    // item 19659
    return { 
        type: "item", text: tr("MES_INSERT_END_BRANCH"),
        image: "end.png",
        code: function(){
            insertAndEdit(editor, item.id, "end_branch");
        }};
}

function createItemDraggable(editor, itemId, x, y) {
    // item 19885
    var item = getAnyItem(editor.storage, itemId)
    // item 19884
    var link = Items.getLinkHandle(item)
    // item 19886
    if (link) {
        // item 19889
        var box = Utils.boxFromPoint(
        	link.x,
        	link.y,
        	Config.GRIP_TOUCH,
        	Config.GRIP_TOUCH
        )
        // item 19890
        if (Utils.hitBox(box, x, y)) {
            // item 19893
            var result = new Draggable(
            	itemId,
            	Const.LINK,
            	null
            )
            result.data = link.link
            // item 19894
            return result
        } else {
            // item 19883
            return new Draggable(
            	itemId,
            	Const.DRN_MOVE,
            	null
            );
        }
    } else {
        // item 19883
        return new Draggable(
        	itemId,
        	Const.DRN_MOVE,
        	null
        );
    }
}

function createMind(render, name, commList) {
    // item 22470
    var header = createHeader(name)
    // item 20791
    header.id = "1"
    header.x = 100
    header.y = 100
    header.role = "header"
    // item 20786
    pushInsertNode(
    	commList,
    	header.id,
    	header
    )
    // item 22414
    return 2
}

function createMindHor(render, name, commList) {
    // item 22377
    var cName = makeHeaderCont(name)
    var id = 1
    // item 22378
    var header = makeDummyItem(
    	id++,
    	render,
    	"beginend",
    	cName
    )
    // item 22380
    var sub1 = makeDummyItem(
    	id++,
    	render,
    	"action",
    	makeRCont()
    )
    // item 22381
    var sub2 = makeDummyItem(
    	id++,
    	render,
    	"action",
    	makeRCont()
    )
    // item 22382
    var sub3 = makeDummyItem(
    	id++,
    	render,
    	"action",
    	makeRCont()
    )
    // item 22383
    header.y = 100
    var midY = header.y + header.h +
    	Config.METRE
    var subY = midY + sub1.h + 
    	Config.METRE
    // item 22397
    sub1.y = subY
    sub2.y = subY
    sub3.y = subY
    // item 22411
    header.role = "header"
    // item 22396
    header.x = 100
    sub1.x = header.x - sub1.w * 2 -
    	Config.METRE
    sub2.x = header.x
    sub3.x = header.x + sub1.w * 2 +
    	Config.METRE
    // item 22379
    pushInsertNode(
    	commList,
    	header.id,
    	header
    )
    // item 22393
    pushInsertNode(
    	commList,
    	sub1.id,
    	sub1
    )
    // item 22394
    pushInsertNode(
    	commList,
    	sub2.id,
    	sub2
    )
    // item 22395
    pushInsertNode(
    	commList,
    	sub3.id,
    	sub3
    )
    // item 22409
    var j1 = String(id++)
    var j2 = String(id++)
    var j3 = String(id++)
    // item 22384
    pushInsertJunction(
    	commList,
    	j1,
    	sub1.x,
    	midY
    )
    // item 22385
    pushInsertJunction(
    	commList,
    	j2,
    	sub2.x,
    	midY
    )
    // item 22386
    pushInsertJunction(
    	commList,
    	j3,
    	sub3.x,
    	midY
    )
    // item 22401
    pushInsertVertical(
    	commList,
    	id++,
    	header.id,
    	j2,
    	null
    )
    // item 22402
    pushInsertVertical(
    	commList,
    	id++,
    	j1,
    	sub1.id,
    	null
    )
    // item 22403
    pushInsertVertical(
    	commList,
    	id++,
    	j2,
    	sub2.id,
    	null
    )
    // item 22404
    pushInsertVertical(
    	commList,
    	id++,
    	j3,
    	sub3.id,
    	null
    )
    // item 22408
    pushInsertHorizontal(
    	commList,
    	id++,
    	j1,
    	j2,
    	"bridge"
    )
    // item 22410
    pushInsertHorizontal(
    	commList,
    	id++,
    	j2,
    	j3,
    	"bridge"
    )
    // item 22412
    return id
}

function createPhysicalGraph(graph, render) {
    // item 21519
    var expands
    // item 21516
    if (isMind()) {
        // item 21521
        expands = Mind.getSoftExpanders()
    } else {
        // item 14673
        expands = getSoftExpanders()
    }
    // item 14672
    var pgraph = new PhysicalGraph(
    	Items,
    	graph,
    	render,
    	expands
    );
    // item 16327
    return pgraph;
}

function createSelection() {
    // item 22117
    var simplified = isMind()
    // item 22116
    return new Drakon.Selection(simplified)
}

function createTask(itemId) {
    // item 22104
    var task = new Mind.ME()
    task.graph(self.storage.graph)
    task.itemId(itemId)
    task.render(self.render)
    task.nextId(self.storage.nextId)
    task.items(Items)
    // item 22105
    return task
}

function cut() {
    // item 18549
    if (ignoreCommand()) {
        
    } else {
        // item 22419
        if (isMind()) {
            // item 22422
            editAction(
            	function(editor, id) { copyMind(id, true) },
            	function() { },
            	function(editor, ids) { copyFree(editor, ids, true, true) }
            )
        } else {
            // item 18548
            editAction(
            	function(editor, id) { copyOne(editor, id, true) },
            	function() { copyBlock(true, true) },
            	function(editor, ids) { copyFree(editor, ids, true, true) }
            )
        }
    }
}

function cutOffSilhBottom(subgraph, lower) {
    // item 14375
    var graph = subgraph.graph;
    var map = {};
    // item 14351
    var id = graph.getMaxId() + 1;
    // item 14352
    var prev = null;
    // item 143570001
    var _ind14357 = 0;
    var _col14357 = lower;
    var _len14357 = _col14357.length;
    while (true) {
        // item 143570002
        if (_ind14357 < _len14357) {
            
        } else {
            break;
        }
        // item 143570004
        var lowNodeId = _col14357[_ind14357];
        // item 14359
        var lowNode = graph.getNode(lowNodeId);
        var address = graph.getNodeUpEx(lowNode);
        var above = graph.getNodeUpEx(address);
        var x = lowNode.x;
        var y = lowNode.y;
        // item 14360
        graph.removeItem(address.up);
        graph.removeItem(address.down);
        // item 14361
        if (lowNode.right) {
            // item 14364
            graph.removeItem(lowNode.right);
        }
        // item 14366
        graph.removeItem(lowNode.id);
        graph.removeItem(address.id);
        // item 14367
        map[lowNodeId] = id;
        var junc = makeDummyJunction(id++, x, y);
        graph.addItem(junc);
        // item 14371
        graph.addItem(makeDummyLine(
        	id++,
        	true,
        	above.id,
        	junc.id,
        	"down"
        ));
        // item 14368
        if (prev) {
            // item 14372
            graph.addItem(makeDummyLine(
            	id++,
            	false,
            	prev.id,
            	junc.id,
            	"left"
            ));
        }
        // item 14365
        prev = junc;
        // item 143570003
        _ind14357++;
    }
    // item 14376
    subgraph.last = map[subgraph.last];
}

function darkenSocket(prim) {
    // item 12205
    self.canvas.render.setItemProperty(prim, "active", false);
    // item 12206
    self.dirty = true;
}

function defaultBuilder(render, content, id, type, x, y, commList) {
    // item 18888
    pushInsertFree(
    	render,
    	commList,
    	id,
    	type,
    	x,
    	y,
    	Config.FREE_WIDTH,
    	Config.FREE_HEIGHT,
    	content
    );
}

function deleteAddressLiana(editor, graph, edge, commandList) {
    // item 10523
    var tail = graph.getTail(edge);
    var below = graph.getEdge(tail.down);
    // item 10528
    pushDeleteEdge(
    	commandList,
    	edge.id
    );
    // item 10524
    deleteLiana(
    	editor,
    	graph,
    	below,
    	commandList
    );
    // item 10525
    pushDeleteNode(
    	commandList,
    	tail.id
    );
    // item 15143
    var pgraph = createPhysicalGraph(
    	editor.storage.graph,
    	editor.render
    );
    // item 10530
    return commandList;
}

function deleteArrow(graph, node, plan) {
    // item 6625
    plan.edges[node.up] = true;
    plan.nodes[node.id] = true;
    // item 6626
    var upRightId = graph.getNodeUp(node);
    var upRight = graph.getNode(upRightId);
    // item 6627
    plan.edges[upRight.left] = true;
    plan.nodes[upRight.id] = true;
    // item 6631
    var leftId = graph.getNodeLeft(upRight);
    var left = graph.getNode(leftId);
    // item 6628
    if (leftId in plan.nodes) {
        
    } else {
        // item 6632
        pokeVer(graph, left, plan);
    }
}

function deleteBranch(editor, id) {
    // item 18945
    addTrace(
    	"delete branch",
    	[id]
    );
    // item 10755
    var graph = editor.storage.graph;
    // item 13180
    var bgraph = findBranchGraph(graph, id);
    // item 10754
    var commandList = [];
    var nodes = bgraph.nodes;
    var edges = bgraph.edges;
    // item 19616
    var right, leftBottom, rightBottom
    // item 13182
    var above = graph.getNode(bgraph.top);
    var left = graph.getNodeLeftEx(above);
    var bottom = graph.getNode(bgraph.bottom);
    // item 19618
    if (bgraph.isLastUp) {
        // item 19621
        right = null
        // item 19635
        rightBottom = null
    } else {
        // item 19625
        edges[above.right] = true
        // item 19617
        right = graph.getNodeRightEx(above)
        // item 19633
        if (bgraph.isLast) {
            // item 19635
            rightBottom = null
        } else {
            // item 19634
            rightBottom = goDownToEnd(graph, right.id)
            // item 19626
            edges[rightBottom.left] = true
        }
    }
    // item 13183
    edges[above.left] = true
    // item 13184
    if (bgraph.exit) {
        // item 19623
        leftBottom = null
    } else {
        // item 19622
        leftBottom = graph.getNodeLeftEx(bottom)
        // item 13187
        edges[bottom.left] = true
    }
    // item 10783
    pushDeleteSubgraph(
    	commandList,
    	nodes,
    	edges
    );
    // item 19630
    if (right) {
        // item 10784
        connectHor(
        	editor,
        	commandList,
        	left.id, right.id,
        	null, null
        );
        // item 10786
        if (rightBottom) {
            // item 10789
            connectHor(
            	editor,
            	commandList,
            	leftBottom.id, rightBottom.id,
            	"sil_floor", null
            );
        }
    }
    // item 10753
    applyCommands(
    	editor,
    	commandList,
    	null
    );
}

function deleteComplex(editor, id) {
    // item 18946
    addTrace(
    	"complex delete",
    	[id]
    );
    // item 5935
    var graph = editor.storage.graph;
    // item 5889
    var commandList = [];
    // item 5655
    var plan = makeDeletionPlan(
    	editor,
    	id
    );
    // item 8477
    var pgraph = createPhysicalGraph(
    	graph,
    	editor.render
    );
    var graph2 = pgraph.graph;
    // item 59010001
    var _ind5901 = 0;
    var _col5901 = plan.edges;
    var _keys5901 = Object.keys(_col5901); 
    var _len5901 = _keys5901.length;
    while (true) {
        // item 59010002
        if (_ind5901 < _len5901) {
            
        } else {
            break;
        }
        // item 59010004
        var edgeId = _keys5901[_ind5901]; var edge = _col5901[edgeId];
        // item 5900
        pushDeleteEdge(commandList, edgeId);
        // item 59010003
        _ind5901++;
    }
    // item 59040001
    var _ind5904 = 0;
    var _col5904 = plan.nodes;
    var _keys5904 = Object.keys(_col5904); 
    var _len5904 = _keys5904.length;
    while (true) {
        // item 59040002
        if (_ind5904 < _len5904) {
            
        } else {
            break;
        }
        // item 59040004
        var nodeId = _keys5904[_ind5904]; var node = _col5904[nodeId];
        // item 5903
        pushDeleteNodeEx(graph, commandList, nodeId);
        // item 59040003
        _ind5904++;
    }
    // item 18260
    var newEdgeIds = []
    // item 58910001
    var _ind5891 = 0;
    var _col5891 = plan.newEdges;
    var _keys5891 = Object.keys(_col5891); 
    var _len5891 = _keys5891.length;
    while (true) {
        // item 58910002
        if (_ind5891 < _len5891) {
            
        } else {
            break;
        }
        // item 58910004
        var oldId = _keys5891[_ind5891]; var newEdge = _col5891[oldId];
        // item 5932
        if ((newEdge.up in plan.nodes) || (newEdge.down in plan.nodes)) {
            
        } else {
            // item 5906
            var edgeId = generateId(editor.storage);
            newEdgeIds.push(edgeId)
            // item 5927
            if (newEdge.dir === "up") {
                // item 15309
                var downNode = graph.getNode(newEdge.down);
                var downEdge = graph.getEdge(downNode.up);
                // item 5907
                pushInsertVertical(
                	commandList,
                	edgeId,
                	newEdge.up,
                	newEdge.down,
                	downEdge.role
                );
            } else {
                // item 5931
                var leftNode = graph.getNode(newEdge.up);
                var edge = graph.getEdge(leftNode.right);
                // item 5930
                pushInsertHorizontal(
                	commandList,
                	edgeId,
                	newEdge.up,
                	newEdge.down,
                	edge.role
                );
            }
        }
        // item 58910003
        _ind5891++;
    }
    // item 18264
    var singleEdgeId = null
    // item 18261
    if (newEdgeIds.length == 1) {
        // item 18265
        singleEdgeId = newEdgeIds[0]
    }
    // item 18266
    runAndCollapse(
    	editor,
    	commandList,
    	singleEdgeId
    )
}

function deleteDuration(editor, id) {
    // item 18947
    addTrace(
    	"delete duration",
    	[id]
    );
    // item 15119
    var graph = editor.storage.graph;
    // item 15114
    var node = graph.getNode(id);
    // item 15115
    var commandList = [];
    // item 15116
    pushDeleteEdge(commandList, node.right);
    // item 15117
    pushDeleteNode(commandList, id);
    // item 15118
    applyCommands(
    	editor,
    	commandList,
    	null
    );
}

function deleteFreeItems(editor, frees) {
    // item 18948
    addTrace(
    	"delete free items",
    	frees
    );
    // item 17033
    var free = editor.storage.free
    var frees = Utils.listToSet(frees)
    // item 17045
    var notDeleted = function(id) {
    	return !(id in frees)
    }
    // item 17046
    var makeElement = function(id) {
    	return { id: id, next: "" }
    }
    // item 17044
    var remaining = free.list
    	.filter(notDeleted)
    	.map(makeElement)
    // item 17048
    setNextPointers(remaining)
    // item 17034
    var commandList = []
    // item 170570001
    var _ind17057 = 0;
    var _col17057 = frees;
    var _keys17057 = Object.keys(_col17057); 
    var _len17057 = _keys17057.length;
    while (true) {
        // item 170570002
        if (_ind17057 < _len17057) {
            
        } else {
            break;
        }
        // item 170570004
        var id = _keys17057[_ind17057]; var _ = _col17057[id];
        // item 17056
        var deleteCommand = new Command(
        	"delete",
        	"free",
        	id,
        	null
        )
        commandList.push(deleteCommand)
        // item 170570003
        _ind17057++;
    }
    // item 170620001
    var _ind17062 = 0;
    var _col17062 = remaining;
    var _len17062 = _col17062.length;
    while (true) {
        // item 170620002
        if (_ind17062 < _len17062) {
            
        } else {
            break;
        }
        // item 170620004
        var node = _col17062[_ind17062];
        // item 17064
        var old = free.get(node.id)
        // item 17065
        if (old.next == node.next) {
            
        } else {
            // item 17068
            pushUpdate(
            	commandList,
            	"free",
            	node.id,
            	{ next: node.next }
            )
        }
        // item 170620003
        _ind17062++;
    }
    // item 17069
    applyCommands(
    	editor,
    	commandList,
    	null
    );
}

function deleteItem(editor, id) {
    var _sw55540000_ = 0;
    // item 2430
    var graph = editor.storage.graph;
    // item 2431
    if (id) {
        // item 2453
        var item = graph.getItem(id);
        // item 2454
        if (canDeleteItem(editor, item)) {
            // item 9520
            if (item.role === "params") {
                // item 9522
                deleteParams(editor, id);
            } else {
                // item 55540000
                _sw55540000_ = item.type;
                // item 55540001
                if (_sw55540000_ === "duration") {
                    // item 15108
                    deleteDuration(editor, id);
                } else {
                    // item 55540002
                    if (((((_sw55540000_ === "question") || (_sw55540000_ === "select")) || (_sw55540000_ === "loopbegin")) || (_sw55540000_ === "loopend")) || (_sw55540000_ === "case")) {
                        // item 5561
                        deleteComplex(editor, id);
                    } else {
                        // item 55540007
                        if (_sw55540000_ === "branch") {
                            // item 10737
                            deleteBranch(editor, id);
                        } else {
                            // item 15529
                            deleteSimpleItem(editor, id);
                        }
                    }
                }
            }
        }
    }
}

function deleteJunctionBetween(editor, graph, center, commandList) {
    // item 4642
    if ((center.up) && (center.down)) {
        // item 4587
        var up = graph.getEdge(center.up);
        var down = graph.getEdge(center.down);
        // item 4578
        pushDeleteEdge(
        	commandList,
        	center.up
        );
        // item 4579
        pushDeleteEdge(
        	commandList,
        	center.down
        );
        // item 4580
        pushDeleteNode(
        	commandList,
        	center.id
        );
        // item 4586
        var newLeft = generateId(editor.storage);
        // item 4585
        pushInsertVertical(
        	commandList,
        	newLeft,
        	up.head,
        	down.tail,
        	down.role
        );
    }
}

function deleteLastPath(editor, edge, left, right) {
    // item 18949
    addTrace(
    	"delete last path",
    	[edge.id]
    );
    // item 15709
    var graph = editor.storage.graph;
    // item 15710
    var rightDown = goDownToEnd(graph, right.id);
    var leftDown = graph.getNodeLeftEx(rightDown);
    var uuId = graph.getNodeUp(left);
    var udId = graph.getNodeDown(left);
    var duId = graph.getNodeUp(leftDown);
    var ddId = graph.getNodeDown(leftDown);
    // item 15711
    var nodes = {};
    var edges = {};
    // item 15712
    nodes[left.id] = true;
    nodes[leftDown.id] = true;
    // item 15715
    graph.enumerateManhattan(
    	right.id,
    	nodes,
    	edges
    );
    // item 15724
    edges[left.up] = true;
    edges[left.down] = true;
    edges[leftDown.up] = true;
    edges[leftDown.down] = true;
    // item 15714
    var commandList = [];
    // item 15713
    pushDeleteSubgraph(
    	commandList,
    	nodes,
    	edges
    );
    // item 15725
    var lowEdge = graph.getEdge(leftDown.down);
    // item 15727
    if (udId == leftDown.id) {
        // item 15726
        connectVer(
        	editor,
        	commandList,
        	uuId,
        	ddId,
        	lowEdge.role,
        	null
        );
    } else {
        // item 15730
        connectVer(
        	editor,
        	commandList,
        	uuId,
        	udId,
        	"down",
        	null
        );
        // item 15731
        connectVer(
        	editor,
        	commandList,
        	duId,
        	ddId,
        	lowEdge.role,
        	null
        );
    }
    // item 15717
    applyCommands(
    	editor,
    	commandList,
    	null
    );
}

function deleteLiana(editor, graph, edge, commandList) {
    // item 8971
    var newHor = null
    var sGraph = editor.storage.graph;
    // item 4349
    var tail = graph.getTail(edge);
    // item 4351
    pushDeleteEdge(
    	commandList,
    	edge.id
    );
    // item 4559
    if (tail.left) {
        // item 4563
        var leftEdge = graph.getEdge(tail.left);
        var leftNode = graph.getNode(leftEdge.head);
        // item 4352
        if (tail.right) {
            // item 4564
            pushDeleteEdge(
            	commandList,
            	tail.left
            );
            // item 4350
            var rightEdge = sGraph.getEdge(tail.right);
            // item 4364
            pushDeleteEdge(
            	commandList,
            	tail.right
            );
            // item 4365
            newHor = generateId(editor.storage);
            // item 4369
            pushInsertHorizontal(
            	commandList,
            	newHor,
            	leftEdge.head,
            	rightEdge.tail,
            	rightEdge.role
            );
            // item 4368
            pushDeleteNode(
            	commandList,
            	tail.id
            );
        } else {
            // item 5345
            if (tail.down) {
                
            } else {
                // item 5349
                pushDeleteEdge(
                	commandList,
                	tail.left
                );
                // item 4581
                deleteJunctionBetween(
                	editor,
                	graph,
                	leftNode,
                	commandList
                );
                // item 5347
                pushDeleteNode(
                	commandList,
                	tail.id
                );
            }
        }
    } else {
        // item 4561
        if (tail.right) {
            // item 4583
            var rightEdge = graph.getEdge(tail.right);
            var rightNode = graph.getNode(rightEdge.tail);
            var rightType = describeJunction(rightNode);
            // item 4589
            pushDeleteEdge(
            	commandList,
            	tail.right
            );
            // item 8039
            if (rightType === "left-up") {
                // item 8042
                pushDeleteArrow(
                	editor,
                	graph,
                	rightNode,
                	commandList
                );
            } else {
                // item 4588
                deleteJunctionBetween(
                	editor,
                	graph,
                	rightNode,
                	commandList
                );
            }
            // item 5348
            pushDeleteNode(
            	commandList,
            	tail.id
            );
        } else {
            // item 4582
            Utils.throwError("Bad liana");
        }
    }
    // item 19073
    return newHor
}

function deleteMiddlePath(editor, edge, left, right) {
    // item 18950
    addTrace(
    	"delete middle path",
    	[edge.id]
    );
    // item 15680
    var graph = editor.storage.graph;
    // item 15681
    var rightDown = goDownToEnd(graph, right.id);
    var leftDown = graph.getNodeLeftEx(rightDown);
    var right2 = graph.getNodeRightEx(right);
    var right2Down = goDownToEnd(graph, right2.id);
    // item 15682
    var nodes = {};
    var edges = {};
    // item 15683
    nodes[left.id] = true;
    nodes[leftDown.id] = true;
    nodes[right2.id] = true;
    nodes[right2Down.id] = true;
    // item 15686
    graph.enumerateManhattan(
    	right.id,
    	nodes,
    	edges
    );
    // item 15687
    delete nodes[left.id];
    delete nodes[leftDown.id];
    delete nodes[right2.id];
    delete nodes[right2Down.id];
    // item 15685
    var commandList = [];
    // item 15684
    pushDeleteSubgraph(
    	commandList,
    	nodes,
    	edges
    );
    // item 15693
    connectHor(
    	editor,
    	commandList,
    	left.id,
    	right2.id,
    	"parallel",
    	null
    );
    // item 15694
    connectHor(
    	editor,
    	commandList,
    	leftDown.id,
    	right2Down.id,
    	null,
    	null
    );
    // item 15688
    applyCommands(
    	editor,
    	commandList,
    	null
    );
}

function deleteMind(itemId) {
    // item 22437
    var graph = self.storage.graph
    // item 22431
    var item = graph.getItem(itemId)
    // item 22432
    var action = findMindDelete(item)
    // item 22433
    if (action) {
        // item 22436
        mindAction(action, itemId, null)
    }
}

function deleteNodeAndUp(pgraph, id, newHor) {
    // item 5170
    var graph = pgraph.graph
    var node = graph.getNode(id);
    var leftId = null
    var rightId = null
    // item 5172
    if (node.left) {
        // item 5171
        leftId = graph.getNodeLeft(node)
        pgraph.deletePhysicalItem(node.left);
    }
    // item 5176
    if (node.up) {
        // item 5175
        pgraph.deletePhysicalItem(node.up);
    }
    // item 5180
    if (node.right) {
        // item 5179
        rightId = graph.getNodeRight(node)
        pgraph.deletePhysicalItem(node.right)
    }
    // item 5184
    if (node.down) {
        // item 5183
        pgraph.deletePhysicalItem(node.down);
    }
    // item 5187
    pgraph.deletePhysicalItem(id);
    // item 19076
    if (newHor) {
        // item 19075
        var line = makeDummyLine(
        	newHor,
        	false,
        	leftId,
        	rightId,
        	null
        )
        // item 19074
        pgraph.insertPhysicalItem(line)
    }
    // item 14761
    rebuildPhysicsCache(pgraph);
}

function deleteParams(editor, id) {
    // item 18951
    addTrace(
    	"delete parameters",
    	[id]
    );
    // item 9555
    var graph = editor.storage.graph;
    // item 9538
    var node = graph.getNode(id);
    // item 9542
    var commandList = [];
    // item 9550
    pushDeleteEdge(commandList, node.left);
    // item 9551
    pushDeleteNode(commandList, id);
    // item 9554
    applyCommands(
    	editor,
    	commandList,
    	null
    );
}

function deletePath(editor, edgeId) {
    // item 15623
    var graph = editor.storage.graph;
    var edge = graph.getEdge(edgeId);
    var left = graph.getHead(edge);
    var right = graph.getTail(edge);
    // item 15627
    if (right.right) {
        // item 15628
        deleteMiddlePath(editor, edge, left, right);
    } else {
        // item 15624
        if (left.left) {
            // item 15630
            deleteRightPath(editor, edge, left, right);
        } else {
            // item 15631
            deleteLastPath(editor, edge, left, right);
        }
    }
}

function deleteRight(graph, node, plan) {
    // item 7881
    if (isArrowStart(graph, node)) {
        // item 7883
        deleteArrow(
        	graph,
        	node,
        	plan
        );
    } else {
        // item 7886
        if (node.id in plan.nodes) {
            // item 7888
            plan.edges[node.right] = true;
            // item 7889
            var rightId =graph.getNodeRight(node);
            var right = graph.getNode(rightId);
            // item 7890
            deleteRight(graph, right, plan);
        }
    }
}

function deleteRightPath(editor, edge, left, right) {
    // item 18952
    addTrace(
    	"delete right path",
    	[edge.id]
    );
    // item 15657
    var graph = editor.storage.graph;
    // item 15658
    var rightDown = goDownToEnd(graph, right.id);
    var leftDown = graph.getNodeLeftEx(rightDown);
    // item 15660
    var nodes = {};
    var edges = {};
    // item 15664
    nodes[left.id] = true;
    nodes[leftDown.id] = true;
    // item 15659
    graph.enumerateManhattan(
    	right.id,
    	nodes,
    	edges
    );
    // item 15661
    delete nodes[left.id];
    delete nodes[leftDown.id];
    // item 15656
    var commandList = [];
    // item 15655
    pushDeleteSubgraph(
    	commandList,
    	nodes,
    	edges
    );
    // item 15662
    applyCommands(
    	editor,
    	commandList,
    	null
    );
}

function deleteSelection() {
    // item 16585
    if (ignoreCommand()) {
        
    } else {
        // item 18967
        addTrace(
        	"delete selection",
        	[]
        );
        // item 22423
        if (isMind()) {
            // item 22425
            editAction(
            	function(editor, itemId) {deleteMind(itemId)},
            	function() {  },
            	deleteFreeItems
            )
        } else {
            // item 18546
            editAction(
            	deleteItem,
            	function() { copyBlock(false, true) },
            	deleteFreeItems
            )
        }
    }
}

function deleteSimpleItem(editor, id) {
    // item 18953
    addTrace(
    	"delete one item",
    	[id]
    );
    // item 2531
    var graph = editor.storage.graph;
    var render = editor.render;
    // item 2535
    var item = graph.getItem(id);
    // item 2543
    var commandList = [];
    // item 2544
    var up = graph.getNeighbourUp(id);
    var down = graph.getNeighbourDown(id);
    // item 15308
    var downEdge = graph.getEdge(item.down);
    // item 2545
    pushDeleteEdge(commandList, item.up);
    // item 4080
    pushDeleteEdge(commandList, item.down);
    // item 4088
    pushDeleteNodeEx(graph, commandList, id);
    // item 2552
    var edgeId = generateId(editor.storage);
    // item 4095
    pushInsertVertical(
    	commandList,
    	edgeId,
    	up,
    	down,
    	downEdge.role
    );
    // item 18250
    runAndCollapse(
    	editor,
    	commandList,
    	edgeId
    )
}

function describeJunction(node) {
    // item 3458
    if (node.up) {
        // item 3461
        if (node.left) {
            // item 3465
            if (node.right) {
                // item 3469
                if (node.down) {
                    // item 3473
                    return "cross"
                } else {
                    // item 3474
                    return "up-t"
                }
            } else {
                // item 3482
                if (node.down) {
                    // item 3475
                    return "left-t"
                } else {
                    // item 3481
                    return "left-up"
                }
            }
        } else {
            // item 3479
            if (node.right) {
                // item 3485
                if (node.down) {
                    // item 3484
                    return "right-t"
                } else {
                    // item 3487
                    return "right-up"
                }
            } else {
                // item 3488
                if (node.down) {
                    // item 3490
                    Utils.throwError("vertical")
                } else {
                    // item 3476
                    return "lowest"
                }
            }
        }
    } else {
        // item 3491
        if (node.left) {
            // item 3493
            if (node.right) {
                // item 3495
                if (node.down) {
                    // item 3497
                    return "t"
                } else {
                    // item 3498
                    Utils.throwError("horizontal")
                }
            } else {
                // item 3504
                if (node.down) {
                    // item 3499
                    return "left-down"
                } else {
                    // item 3503
                    return "rightmost"
                }
            }
        } else {
            // item 3501
            if (node.right) {
                // item 3507
                if (node.down) {
                    // item 3506
                    return "right-down"
                } else {
                    // item 3509
                    return "leftmost"
                }
            } else {
                // item 3510
                if (node.down) {
                    // item 3512
                    return "highest"
                } else {
                    // item 3500
                    Utils.throwError("empty")
                }
            }
        }
    }
}

function deselect() {
    // item 13504
    deselectAll(self);
    // item 13505
    redrawCanvas(self);
}

function deselectAll(editor) {
    // item 2038
    editor.storage.selection = createSelection();
}

function detectCycle(graph, origin, targetId) {
    var _sw93010000_ = 0;
    var _sw93220000_ = 0;
    // item 9281
    var node, id;
    var counter = 0;
    var verList = graph.getVertical(origin.id)
    var vertical = Utils.listToSet(verList)
    // item 9282
    node = graph.getNode(targetId);
    while (true) {
        // item 9283
        if (node.id in vertical) {
            // item 9317
            counter = 0;
            while (true) {
                // item 9335
                id = graph.getNodeUp(node);
                node = graph.getNode(id);
                // item 9318
                if (node.id == origin.id) {
                    // item 9321
                    return false;
                }
                // item 93220000
                _sw93220000_ = node.type;
                // item 93220001
                if (_sw93220000_ === "loopbegin") {
                    // item 9331
                    if (counter === 0) {
                        // item 9333
                        return true;
                    }
                    // item 9329
                    counter--;
                } else {
                    // item 93220002
                    if (_sw93220000_ === "loopend") {
                        // item 9330
                        counter++;
                    }
                }
            }
            break;
        }
        // item 93010000
        _sw93010000_ = node.type;
        // item 93010001
        if (_sw93010000_ === "loopend") {
            // item 9298
            if (counter === 0) {
                // item 9309
                return true;
            }
            // item 9310
            counter--;
        } else {
            // item 93010002
            if (_sw93010000_ === "loopbegin") {
                // item 9311
                counter++;
            }
        }
        // item 9285
        if (node.down) {
            // item 9291
            id = graph.getNodeDown(node);
        } else {
            // item 9288
            if (node.left) {
                
            } else {
                // item 9313
                return false;
            }
            // item 9294
            var leftEdge = graph.getEdge(node.left);
            // item 9295
            if (leftEdge.role === "left") {
                
            } else {
                // item 9313
                return false;
            }
            // item 9314
            id = graph.getNodeLeft(node);
        }
        // item 9315
        node = graph.getNode(id);
    }
}

function detectInternalCycle(graph, sourceId, targetId) {
    // item 9265
    var origin = findPathOrigin(graph, sourceId);
    // item 9424
    var start = findLeftMostOnSurface(
    	graph,
    	origin,
    	targetId
    );
    // item 9266
    return detectCycle(
    	graph,
    	start,
    	targetId
    );
}

function detectOuterCycle(graph, sourceId, targetId) {
    // item 9434
    var origin = graph.getNode(sourceId);
    // item 9436
    var start = findLeftMostOnSurface(
    	graph,
    	origin,
    	targetId
    );
    // item 9435
    return detectCycle(
    	graph,
    	start,
    	targetId
    );
}

function diagramToJson() {
    // item 16416
    var sane = getDiagramCopy(self)
    // item 12241
    return JSON.stringify(sane)
}

function downRole(item) {
    // item 15315
    if ((item.role == "down") || (item.role == "par-down")) {
        // item 15293
        return true;
    } else {
        // item 15321
        return false;
    }
}

function drawBasicItems(storage, canvas) {
    // item 16668
    var graph = storage.graph
    var free = storage.free
    // item 22966
    var skewers = {}
    // item 22963
    if (isDrakon()) {
        // item 229670001
        var _ind22967 = 0;
        var _col22967 = graph.nodes;
        var _keys22967 = Object.keys(_col22967); 
        var _len22967 = _keys22967.length;
        while (true) {
            // item 229670002
            if (_ind22967 < _len22967) {
                
            } else {
                break;
            }
            // item 229670004
            var id = _keys22967[_ind22967]; var item = _col22967[id];
            // item 22970
            if ((item.type == "branch") || (item.type == "beginend")) {
                // item 22969
                markVerticals(graph, item, skewers)
            }
            // item 229670003
            _ind22967++;
        }
    }
    // item 108290001
    var _ind10829 = 0;
    var _col10829 = graph.nodes;
    var _keys10829 = Object.keys(_col10829); 
    var _len10829 = _keys10829.length;
    while (true) {
        // item 108290002
        if (_ind10829 < _len10829) {
            
        } else {
            break;
        }
        // item 108290004
        var id = _keys10829[_ind10829]; var item = _col10829[id];
        // item 10833
        insertCanvasItem(canvas, item, skewers)
        // item 108290003
        _ind10829++;
    }
    // item 108310001
    var _ind10831 = 0;
    var _col10831 = graph.edges;
    var _keys10831 = Object.keys(_col10831); 
    var _len10831 = _keys10831.length;
    while (true) {
        // item 108310002
        if (_ind10831 < _len10831) {
            
        } else {
            break;
        }
        // item 108310004
        var id = _keys10831[_ind10831]; var item = _col10831[id];
        // item 10834
        insertCanvasItem(canvas, item, skewers)
        // item 108310003
        _ind10831++;
    }
    // item 166690001
    var _ind16669 = 0;
    var _col16669 = free.list;
    var _len16669 = _col16669.length;
    while (true) {
        // item 166690002
        if (_ind16669 < _len16669) {
            
        } else {
            break;
        }
        // item 166690004
        var id = _col16669[_ind16669];
        // item 16793
        var item = free.set[id]
        // item 16671
        insertCanvasItem(canvas, item, skewers)
        // item 166690003
        _ind16669++;
    }
}

function drawDrakonGuides(render, graph, movedId, visibleBox) {
    // item 19540
    var item = graph.getItem(movedId)
    // item 22544
    if (canGuideDrakon(item)) {
        // item 19543
        var topEdge = getTop(item)
        var bottomEdge = getBottom(item)
        // item 19399
        var min = getLeft(item)
        var max = getRight(item)
        // item 19533
        var g1 = new Guide(topEdge, min, max)
        var g2 = new Guide(bottomEdge, min, max)
        // item 193780001
        var _ind19378 = 0;
        var _col19378 = graph.nodes;
        var _keys19378 = Object.keys(_col19378); 
        var _len19378 = _keys19378.length;
        while (true) {
            // item 193780002
            if (_ind19378 < _len19378) {
                
            } else {
                break;
            }
            // item 193780004
            var id = _keys19378[_ind19378]; var node = _col19378[id];
            // item 19380
            if (((id == movedId) || (!(canGuideDrakon(node)))) || (!(Utils.boxesIntersect(visibleBox, node.box)))) {
                
            } else {
                // item 19446
                var top = getTop(node)
                var bottom = getBottom(node)
                // item 19445
                var left = getLeft(node)
                var right = getRight(node)
                // item 19534
                checkGuide(g1, top, left, right)
                checkGuide(g2, bottom, left, right)
            }
            // item 193780003
            _ind19378++;
        }
        // item 19535
        drawHorizontalGuide(render, g1)
        drawHorizontalGuide(render, g2)
    }
}

function drawEdgeMark(canvas, edge, upper) {
    // item 3658
    var render = canvas.render;
    var graph = canvas.graph;
    // item 3636
    var head = graph.getHead(edge);
    var tail = graph.getTail(edge);
    // item 3637
    var x, y, w, h, length;
    var color;
    var shift;
    // item 3641
    var zone;
    // item 3627
    if (upper) {
        // item 3643
        zone = edge.upperMark;
        shift = 3;
    } else {
        // item 3642
        zone = edge.lowerMark;
        shift = -3;
    }
    // item 3645
    if (zone) {
        // item 3647
        color = getZoneColor(canvas, zone);
        // item 3630
        if (edge.isVertical) {
            // item 3689
            length = (tail.y - head.y) / 2;
            // item 3649
            x = head.x + shift;
            y = head.y + length;
            w = 2;
            h = length - 5;
        } else {
            // item 3688
            length = (tail.x - head.x) / 2;
            shift = -shift;
            // item 3648
            x = head.x + length;
            y = head.y + shift;
            w = length - 5;
            h = 2;
        }
        // item 3646
        render.createAction(
        	x, y, w, h,
        	color,
        	null,
        	"line_candies"
        );
    }
}

function drawFreeGuides(editor, visibleBox) {
    // item 19479
    if (gDragItems.length == 1) {
        // item 19480
        var free = editor.canvas.free
        var movedId = gDragItems[0]
        // item 19481
        var movedItem = free.get(movedId)
        // item 19482
        if (canGuide(movedItem)) {
            // item 19489
            var topE = getTop(movedItem)
            var bottomE = getBottom(movedItem)
            var hcE = movedItem.y
            // item 19488
            var leftE = getLeft(movedItem)
            var rightE = getRight(movedItem)
            var vcE = movedItem.x
            // item 19490
            var gh0 = new Guide(topE, leftE, rightE)
            var gh1 = new Guide(hcE, leftE, rightE)
            var gh2 = new Guide(bottomE, leftE, rightE)
            // item 19491
            var gv0 = new Guide(leftE, topE, bottomE)
            var gv1 = new Guide(vcE, topE, bottomE)
            var gv2 = new Guide(rightE, topE, bottomE)
            // item 194920001
            var _ind19492 = 0;
            var _col19492 = free.list;
            var _len19492 = _col19492.length;
            while (true) {
                // item 194920002
                if (_ind19492 < _len19492) {
                    
                } else {
                    break;
                }
                // item 194920004
                var id = _col19492[_ind19492];
                // item 19493
                if (id == movedId) {
                    
                } else {
                    // item 19496
                    var item = free.set[id]
                    // item 19495
                    if (canGuide(item)) {
                        // item 19498
                        var top = getTop(item)
                        var bottom = getBottom(item)
                        // item 19494
                        var left = getLeft(item)
                        var right = getRight(item)
                        // item 19499
                        var box = new Utils.Box(left, top, right, bottom)
                        // item 19497
                        if (Utils.boxesIntersect(visibleBox, box)) {
                            // item 19501
                            checkGuide(gh0, top, left, right)
                            checkGuide(gh1, item.y, left, right)
                            checkGuide(gh2, bottom, left, right)
                            
                            checkGuide(gv0, left, top, bottom)
                            checkGuide(gv1, item.x, top, bottom)
                            checkGuide(gv2, right, top, bottom)
                        }
                    }
                }
                // item 194920003
                _ind19492++;
            }
            // item 19528
            var render = editor.render
            // item 19529
            drawVerticalGuide(render, gv0)
            drawVerticalGuide(render, gv1)
            drawVerticalGuide(render, gv2)
            // item 19530
            drawHorizontalGuide(render, gh0)
            drawHorizontalGuide(render, gh1)
            drawHorizontalGuide(render, gh2)
        }
    }
}

function drawHorizontalGuide(render, guide) {
    // item 19525
    if (guide.found) {
        // item 19522
        var format = getGuideFormat()
        // item 19524
        var w = guide.max - guide.min
        // item 19523
        render.createLine(
        	guide.min,
        	guide.edge,
        	w,
        	0,
        	format,
        	"guides"
        )
    }
}

function drawMarks(canvas) {
    // item 3671
    canvas.zoneColors = {};
    // item 3687
    var graph = canvas.graph;
    // item 36120001
    var _ind3612 = 0;
    var _col3612 = graph.edges;
    var _keys3612 = Object.keys(_col3612); 
    var _len3612 = _keys3612.length;
    while (true) {
        // item 36120002
        if (_ind3612 < _len3612) {
            
        } else {
            break;
        }
        // item 36120004
        var id = _keys3612[_ind3612]; var edge = _col3612[id];
        // item 3617
        drawEdgeMark(canvas, edge, true);
        // item 3618
        drawEdgeMark(canvas, edge, false);
        // item 36120003
        _ind3612++;
    }
    // item 36190001
    var _ind3619 = 0;
    var _col3619 = graph.nodes;
    var _keys3619 = Object.keys(_col3619); 
    var _len3619 = _keys3619.length;
    while (true) {
        // item 36190002
        if (_ind3619 < _len3619) {
            
        } else {
            break;
        }
        // item 36190004
        var id = _keys3619[_ind3619]; var node = _col3619[id];
        // item 3621
        drawNodeMark(canvas, node);
        // item 36190003
        _ind3619++;
    }
}

function drawMoveAll(render) {
    // item 19146
    if (gMoveAllPos) {
        // item 19152
        gMoveAllPrim = render.createMoveAll(
        	gMoveAllPos.x,
        	gMoveAllPos.y,
        	"free_candies"
        );
    } else {
        // item 19145
        gMoveAllPrim = null
    }
}

function drawNodeMark(canvas, node) {
    // item 3665
    if (node.mark) {
        // item 3668
        var color = getZoneColor(canvas, node.mark);
        // item 3669
        var x = node.x;
        var y = node.y;
        var w = 10;
        var h = 10;
        // item 3670
        canvas.render.createAction(
        	x, y, w, h,
        	color,
        	"black",
        	"line_candies"
        );
    }
}

function drawToOtherRender(render) {
    // item 12390
    var canvas = new CanvasCache(render);
    // item 12391
    drawBasicItems(self.storage, canvas);
}

function drawVerticalGuide(render, guide) {
    // item 19518
    if (guide.found) {
        // item 19235
        var format = getGuideFormat()
        // item 19269
        var h = guide.max - guide.min
        // item 19236
        render.createLine(
        	guide.edge,
        	guide.min,
        	0,
        	h,
        	format,
        	"guides"
        )
    }
}

function drill(pgraph, x, top, bottom, movedNodes) {
    // item 4495
    var graph = pgraph.graph;
    // item 4499
    var box = new Utils.Box(
    	x - Config.METRE,
    	top + Config.METRE / 2,
    	x + Config.METRE,
    	bottom
    );
    while (true) {
        // item 4500
        var hit = hitsAnyone(graph, box);
        // item 4498
        if (hit) {
            
        } else {
            break;
        }
        // item 8260
        var hitItem = graph.getItem(hit);
        // item 8257
        if (hitItem.isLine) {
            // item 8261
            if ((hitItem.isVertical) || (hitItem.role == "lstick")) {
                
            } else {
                // item 8264
                moveHorLineAway(
                	pgraph,
                	hitItem,
                	box,
                	movedNodes
                );
            }
        } else {
            // item 4502
            var delta = getIntersectionDelta(
            	box,
            	hitItem
            );
            // item 4504
            pgraph.moveRight(
            	hit,
            	delta,
            	movedNodes
            );
        }
    }
}

function dropDown(pgraph, node, bottom, movedNodes) {
    // item 10226
    dropDownCore(
    	pgraph,
    	node,
    	bottom,
    	-10000000,
    	movedNodes
    );
}

function dropDownCore(pgraph, node, bottom, minRight, movedNodes) {
    // item 10201
    var graph = pgraph.graph;
    // item 10208
    var rightEdge;
    // item 10205
    var below = findNodesBelowEx(graph, node, bottom);
    // item 10206
    var lowest = below[below.length - 1];
    // item 10207
    var dims = findLedgeDimensions(
    	graph,
    	node.id,
    	lowest.id
    );
    // item 10223
    var nodeRight = node.box.right + Config.METRE;
    // item 10209
    rightEdge = Math.max(dims.x, nodeRight);
    // item 10224
    rightEdge = Math.max(rightEdge, minRight);
    // item 10210
    var scan = new Utils.Box(
    	rightEdge - Config.METRE + 1,
    	node.y,
    	rightEdge,
    	bottom
    );
    // item 102110001
    var _ind10211 = 0;
    var _col10211 = graph.nodes;
    var _keys10211 = Object.keys(_col10211); 
    var _len10211 = _keys10211.length;
    while (true) {
        // item 102110002
        if (_ind10211 < _len10211) {
            
        } else {
            break;
        }
        // item 102110004
        var nid = _keys10211[_ind10211]; var n = _col10211[nid];
        // item 10213
        if (Utils.boxesIntersect(scan, n.box)) {
            // item 10216
            var delta = scan.right - n.box.left;
            // item 10217
            pgraph.moveRight(
            	n.id,
            	delta,
            	movedNodes
            );
        }
        // item 102110003
        _ind10211++;
    }
    // item 10218
    var vDelta = bottom - node.y;
    pgraph.moveDown(
    	node.id,
    	vDelta,
    	movedNodes
    );
}

function editAction(simpleItemAction, blockAction, freeItemAction) {
    // item 18529
    var free = self.storage.free
    var selection = analyzeSelection(self)
    // item 18530
    if (selection.greens.length == 1) {
        // item 18540
        var itemId = selection.greens[0]
        // item 18537
        if (free.get(itemId)) {
            // item 18544
            freeItemAction(
            	self,
            	[itemId]
            )
        } else {
            // item 18543
            simpleItemAction(self, itemId)
        }
        // item 18525
        commandDone();
    } else {
        // item 18533
        if (selection.greens.length > 1) {
            // item 18524
            blockAction(self)
            // item 18525
            commandDone();
        } else {
            // item 18535
            if (selection.frees.length == 0) {
                
            } else {
                // item 18545
                freeItemAction(
                	self,
                	selection.frees
                )
                // item 18525
                commandDone();
            }
        }
    }
}

function editLink(editor, item, x, y) {
    // item 19852
    var fun = Callbacks.editLink
    // item 19848
    if (fun) {
        // item 19853
        var content = Utils.copyObject(getContent(item))
        // item 19851
        fun(item.id, content, x, y)
    }
}

function endVisualDrag() {
    // item 16473
    if ((self.readonly) || (!(self.dragOn))) {
        
    } else {
        // item 20356
        self.dragOn = false
        // item 19320
        self.render.clearGuides()
        // item 12173
        var updates = []
        // item 16847
        if (gDragStartItem) {
            // item 14470
            addTrace(
            	"move items",
            	[gDragStartItem]
            );
            // item 19059
            var cgraph = self.canvas.graph
            // item 121700001
            var _ind12170 = 0;
            var _col12170 = self.changedNodes;
            var _keys12170 = Object.keys(_col12170); 
            var _len12170 = _keys12170.length;
            while (true) {
                // item 121700002
                if (_ind12170 < _len12170) {
                    
                } else {
                    break;
                }
                // item 121700004
                var nodeId = _keys12170[_ind12170]; var _ = _col12170[nodeId];
                // item 19060
                if (nodeId in cgraph.nodes) {
                    
                } else {
                    // item 19063
                    updates = []
                    break;
                }
                // item 12169
                var node = cgraph.getNode(
                	nodeId
                );
                // item 12172
                var change = new Command(
                	"update",
                	"nodes",
                	node.id,
                	{
                		x: node.x,
                		y: node.y
                	}
                );
                updates.push(change);
                // item 121700003
                _ind12170++;
            }
        } else {
            // item 16855
            addTrace(
            	"move free items",
            	gDragItems
            );
            // item 16854
            var free = self.canvas.free
            var ofree = self.storage.free
            // item 168490001
            var _ind16849 = 0;
            var _col16849 = gDragItems;
            var _len16849 = _col16849.length;
            while (true) {
                // item 168490002
                if (_ind16849 < _len16849) {
                    
                } else {
                    break;
                }
                // item 168490004
                var id = _col16849[_ind16849];
                // item 16851
                var item = free.get(id)
                var oitem = ofree.get(id)
                // item 16958
                if ((item.x == oitem.x) && (item.y == oitem.y)) {
                    
                } else {
                    // item 16857
                    var change = new Command(
                    	"update",
                    	"free",
                    	id,
                    	{
                    		x: item.x,
                    		y: item.y
                    	}
                    );
                    updates.push(change);
                }
                // item 168490003
                _ind16849++;
            }
            // item 16856
            gDragItems = []
        }
        // item 12174
        submitCommands(self, updates, false)
        // item 16354
        var ids = getSelectedIds(self);
        // item 16355
        rebuildGrips(self, ids);
    }
}

function endsWithRightTurn(graph, nodeId) {
    // item 5006
    var node = graph.getNode(nodeId);
    // item 5003
    if (node.down) {
        // item 5016
        var downEdge = graph.getEdge(
        	node.down
        );
        // item 5007
        return endsWithRightTurn(
        	graph,
        	downEdge.tail
        );
    } else {
        // item 5008
        if (node.left) {
            // item 5012
            return false;
        } else {
            // item 5010
            if (node.right) {
                // item 7911
                var edge = graph.getEdge(node.right);
                // item 7912
                if (edge.role === "right") {
                    // item 5013
                    return false;
                } else {
                    // item 5014
                    return true;
                }
            } else {
                // item 5013
                return false;
            }
        }
    }
}

function executeCommands(editor, commands, state, isUndo, redraw) {
    // item 22546
    self.dragOn = false
    // item 19990
    performLocalChange(
    	editor,
    	commands,
    	isUndo
    )
    // item 20011
    persistAndRedraw(
    	editor,
    	state,
    	redraw
    )
}

function expandBolt(editor, edgeId) {
    // item 14474
    addTrace(
    	"add line",
    	[edgeId]
    );
    // item 11914
    var pgraph = createPhysicalGraph(
    	editor.storage.graph,
    	editor.render
    );
    // item 11908
    var commandList = expandBoltCore(editor, pgraph, edgeId);
    // item 11911
    applyCommands(
    	editor,
    	commandList,
    	null
    );
}

function expandBoltCore(editor, pgraph, edgeId) {
    // item 7112
    var movedNodes = {};
    var commands = {};
    // item 7107
    var graph = pgraph.graph;
    // item 7108
    var edge = graph.getEdge(edgeId);
    var head = graph.getHead(edge);
    var tail = graph.getTail(edge);
    var width = tail.x - head.box.right;
    // item 7122
    var minWidth = Config.METRE * 4;
    var actWidth;
    // item 7123
    if (width < minWidth) {
        // item 7126
        var delta = minWidth - width;
        // item 7127
        pgraph.moveRight(
        	tail.id,
        	delta,
        	movedNodes
        );
        // item 7130
        actWidth = minWidth;
    } else {
        // item 7129
        actWidth = width;
    }
    // item 7128
    var half = Math.floor(actWidth / Config.METRE / 2)
    	* Config.METRE;
    var x = head.box.right + half;
    // item 7109
    pgraph.deletePhysicalItem(
    	edgeId
    );
    // item 7131
    var fakeNode = generateId(editor.storage);
    var fakeEdge = generateId(editor.storage);
    // item 7134
    pgraph.insertPhysicalItem({
    	id: fakeNode,
    	x: x,
    	y: head.y,
    	type: "junction",
    	isLine: false
    });
    // item 7135
    pgraph.insertPhysicalEdge(
    	fakeEdge,
    	fakeNode,
    	tail.id,
    	false,
    	null
    );
    // item 14689
    rebuildPhysicsCache(pgraph);
    // item 7116
    pgraph.moveDown(
    	tail.id,
    	minWidth,
    	movedNodes
    );
    // item 7121
    delete movedNodes[fakeNode];
    // item 7111
    buildMoveCommands(
    	pgraph,
    	movedNodes,
    	commands
    );
    // item 7110
    var commandList = Utils.objectValues(commands);
    // item 7117
    pushDeleteEdge(
    	commandList,
    	edgeId
    );
    // item 7120
    var leftEdge = generateId(editor.storage);
    var rightEdge = generateId(editor.storage);
    var boltEdge = generateId(editor.storage);
    var newTop = generateId(editor.storage);
    var newBottom = generateId(editor.storage);
    // item 7138
    var bottom = head.y + minWidth;
    // item 7136
    pushInsertJunction(
    	commandList,
    	newTop,
    	x,
    	head.y
    );
    // item 7139
    pushInsertJunction(
    	commandList,
    	newBottom,
    	x,
    	bottom
    );
    // item 7137
    pushInsertDown(
    	commandList,
    	boltEdge,
    	newTop,
    	newBottom
    );
    // item 7119
    pushInsertHorizontal(
    	commandList,
    	leftEdge,
    	head.id,
    	newTop,
    	null
    );
    // item 7140
    pushInsertHorizontal(
    	commandList,
    	rightEdge,
    	newBottom,
    	tail.id,
    	null
    );
    // item 11910
    return commandList;
}

function expandBranchAddress(pgraph, id, maxH, commands) {
    // item 22937
    var node = pgraph.graph.getNode(id)
    var deltaH = maxH - node.h
    var newY = node.y - deltaH
    // item 22938
    if (deltaH >= 0) {
        // item 22942
        var upDownBox = new Utils.Box(
        	node.x - node.w,
        	node.y,
        	node.x + node.w,
        	node.y
        )
        // item 22944
        var movedNodes = {}
        // item 22943
        pgraph.pushObjects(
            upDownBox,
            {},
            -(deltaH * 2 + node.h),
            "vertical",
            movedNodes
        );
        // item 22941
        buildMoveCommands(
        	pgraph,
        	movedNodes,
        	commands
        );
    }
    // item 22935
    var ownCommand = getOrCreateUpdate(
    	commands,
    	id
    )
    // item 22936
    ownCommand.fields.h = maxH
    ownCommand.fields.y = newY
}

function expandBranchHeader(pgraph, id, maxH, commands) {
    // item 22808
    var node = pgraph.graph.getNode(id)
    var deltaH = maxH - node.h
    var newY = node.y + deltaH
    // item 22913
    if (deltaH > 0) {
        // item 22918
        var upDownBox = new Utils.Box(
        	node.x - node.w,
        	node.y + node.h,
        	node.x + node.w,
        	node.y + node.h
        )
        // item 22920
        var movedNodes = {}
        // item 22919
        pgraph.pushObjects(
            upDownBox,
            {},
            deltaH * 2,
            "vertical",
            movedNodes
        );
        // item 22917
        buildMoveCommands(
        	pgraph,
        	movedNodes,
        	commands
        );
    }
    // item 22806
    var ownCommand = getOrCreateUpdate(
    	commands,
    	id
    )
    // item 22807
    ownCommand.fields.h = maxH
    ownCommand.fields.y = newY
}

function extendEdge(pgraph, edgeId, h, movedNodes) {
    // item 4175
    var graph = pgraph.graph;
    // item 4176
    var edge = graph.getEdge(edgeId);
    var head = graph.getHead(edge);
    var tail = graph.getTail(edge);
    // item 4177
    var height = getEdgeHeight(head, tail);
    var minHeight = (Config.METRE + h) * 2;
    // item 4178
    if (height < minHeight) {
        // item 4181
        var delta = minHeight - height;
        // item 4201
        pgraph.moveDown(
        	tail.id,
        	delta,
        	movedNodes
        );
    }
}

function findAbove(graph, item) {
    // item 20179
    if (item.up) {
        // item 20183
        return graph.getNodeUp(item)
    } else {
        // item 20182
        return null
    }
}

function findAddressSockets(graph, id) {
    // item 10503
    var sockets = [];
    // item 10499
    var edge = graph.getEdge(id);
    // item 104910001
    var _ind10491 = 0;
    var _col10491 = graph.edges;
    var _keys10491 = Object.keys(_col10491); 
    var _len10491 = _keys10491.length;
    while (true) {
        // item 104910002
        if (_ind10491 < _len10491) {
            
        } else {
            break;
        }
        // item 104910004
        var tid = _keys10491[_ind10491]; var target = _col10491[tid];
        // item 15296
        if (((downRole(target)) && (target.upperMark === edge.lowerMark)) && (!(detectInternalCycle(graph, 
edge.tail, target.tail)))) {
            // item 10500
            appendSocket(
            	sockets,
            	target.id,
            	"leftInnerLine"
            );
        }
        // item 104910003
        _ind10491++;
    }
    // item 10504
    return sockets;
}

function findArrowStart(graph, rightUpId) {
    // item 11502
    var rightUp = graph.getNode(rightUpId);
    var rightDown = graph.getNodeDownEx(rightUp);
    var leftDown = graph.getNodeLeftEx(rightDown);
    // item 11997
    if (leftDown.type == "question") {
        // item 12000
        return rightDown.id;
    } else {
        // item 14249
        if (leftDown.left) {
            // item 14251
            return null;
        } else {
            // item 11503
            return leftDown.id;
        }
    }
}

function findBelow(graph, item) {
    // item 20189
    if (item.down) {
        // item 20193
        return graph.getNodeDown(item)
    } else {
        // item 20192
        return null
    }
}

function findBottomNodes(graph, nodes, node) {
    // item 14353
    var result = [];
    while (true) {
        // item 14355
        result.push(node.id);
        // item 14408
        if (node.right) {
            
        } else {
            break;
        }
        // item 14332
        var nextId = graph.getNodeRight(node);
        // item 14325
        if (nextId in nodes) {
            
        } else {
            break;
        }
        // item 14330
        node = graph.getNode(nextId);
    }
    // item 14354
    return result;
}

function findBranchGraph(graph, id) {
    // item 13156
    var nodes = {};
    var edges = {};
    // item 18994
    var branch = graph.getNode(id);
    var above = graph.getNodeUpEx(branch);
    var left = graph.getNodeLeftEx(above);
    var bottom = goDownToEnd(graph, branch.id);
    // item 19573
    nodes[above.id] = true
    // item 19570
    var isLast, rBottom, exit
    var leftBottom, rightBottom
    var rBottom
    // item 19591
    if (above.right) {
        // item 19590
        var right = graph.getNodeRightEx(above)
        rightBottom = goDownToEnd(graph, right.id)
        isLast = (rightBottom.type == "end")
        exit = false
        // item 19606
        if (isLast) {
            // item 19609
            rBottom = goRightToEnd(graph, bottom.id);
        } else {
            // item 13164
            nodes[rightBottom.id] = true;
            // item 19608
            rBottom = graph.getNodeLeftEx(rightBottom);
        }
        // item 19595
        leftBottom = graph.getNodeLeftEx(bottom)
        nodes[leftBottom.id] = true
    } else {
        // item 19594
        rightBottom = null
        isLast = true
        exit = (bottom.type == "end")
        // item 19599
        if (exit) {
            // item 19610
            rBottom = goRightToEnd(graph, bottom.id);
            // item 19611
            leftBottom = null
        } else {
            // item 19609
            rBottom = goRightToEnd(graph, bottom.id);
            // item 19595
            leftBottom = graph.getNodeLeftEx(bottom)
            nodes[leftBottom.id] = true
        }
    }
    // item 13158
    graph.enumerateManhattan(
    	id,
    	nodes,
    	edges
    );
    // item 19612
    if (leftBottom) {
        // item 13167
        delete nodes[leftBottom.id];
        // item 13174
        delete edges[bottom.left];
    }
    // item 13179
    if (rightBottom) {
        // item 13171
        delete nodes[rightBottom.id];
        // item 13175
        delete edges[rightBottom.left];
    }
    // item 13176
    return {
    	nodes: nodes,
    	edges: edges,
    	top: above.id,
    	bottom: bottom.id,
    	rBottom: rBottom.id,
    	isLast: isLast,
    	exit: exit,
    	isLastUp: !(above.right)
    };
}

function findBranchLeft(graph, header) {
    // item 20337
    var left = header.box.left
    var node = header
    while (true) {
        // item 20338
        if (node.down) {
            
        } else {
            break;
        }
        // item 20341
        node = graph.getNodeDownEx(node)
        // item 20351
        if (node.type == "junction") {
            
        } else {
            // item 20344
            left = Math.min(left, node.box.left)
            // item 20345
            if (node.left) {
                // item 20348
                var timer = graph.getNodeLeftEx(node)
                // item 20349
                left = Math.min(left, timer.box.left)
            }
        }
    }
    // item 20342
    return left
}

function findCases(graph, select) {
    // item 12977
    var result = [];
    var jointId = graph.getNodeDown(select);
    while (true) {
        // item 12978
        var joint = graph.getNode(jointId);
        // item 12979
        var caseId = graph.getNodeDown(joint);
        var caseNode = graph.getNode(caseId);
        // item 12980
        result.push(caseNode.content);
        // item 12982
        if (joint.right) {
            
        } else {
            break;
        }
        // item 12984
        jointId = graph.getNodeRight(joint);
    }
    // item 12981
    return result;
}

function findClosest(editor, referenceItem, criteria) {
    // item 20169
    var finder = new MinDistFinder(
    	referenceItem,
    	referenceItem.id,
    	criteria
    )
    // item 20118
    var graph = editor.storage.graph
    // item 201200001
    var _ind20120 = 0;
    var _col20120 = graph.items;
    var _keys20120 = Object.keys(_col20120); 
    var _len20120 = _keys20120.length;
    while (true) {
        // item 201200002
        if (_ind20120 < _len20120) {
            
        } else {
            break;
        }
        // item 201200004
        var id = _keys20120[_ind20120]; var item = _col20120[id];
        // item 20170
        finder.check(id, item)
        // item 201200003
        _ind20120++;
    }
    // item 20128
    var free = editor.storage.free
    // item 201290001
    var _ind20129 = 0;
    var _col20129 = free.set;
    var _keys20129 = Object.keys(_col20129); 
    var _len20129 = _keys20129.length;
    while (true) {
        // item 201290002
        if (_ind20129 < _len20129) {
            
        } else {
            break;
        }
        // item 201290004
        var id = _keys20129[_ind20129]; var item = _col20129[id];
        // item 20173
        finder.check(id, item)
        // item 201290003
        _ind20129++;
    }
    // item 20119
    return finder.found
}

function findCornerSocket(graph, edge, target) {
    // item 3908
    var result = null;
    // item 7158
    if (isArrowStart(graph, target)) {
        
    } else {
        // item 3907
        var tail = graph.getTail(edge);
        // item 3880
        var desc = describeJunction(target);
        // item 10807
        var roof = goUpToEnd(graph, edge.head);
        // item 10808
        if (target.y > roof.y) {
            // item 38810001
            if (desc === "left-up") {
                // item 10805
                var leftEdge = graph.getEdge(target.left);
                var upEdge = graph.getEdge(target.up);
                // item 39260001
                if (target.mark === edge.upperMark) {
                    // item 3906
                    if (((target.y > tail.y) && (!(detectOuterCycle(graph, 
edge.tail, target.id)))) && (!(upEdge.role == "par-down"))) {
                        // item 10188
                        if (leftEdge.role === "sil_floor") {
                            // item 10186
                            result = "leftOuterCornerSil";
                        } else {
                            // item 3910
                            result = "leftOuterCorner";
                        }
                    }
                } else {
                    // item 39260002
                    if (((((target.mark === edge.lowerMark) && (target.x < tail.x)) && (!(detectInternalCycle(graph, 
edge.tail, target.id)))) && (!(upEdge.role == "par-down"))) && (!(leftEdge.role === "sil_floor"))) {
                        // item 3935
                        result = "leftInnerCorner";
                    }
                }
            } else {
                // item 38810002
                if (desc === "left-down") {
                    // item 7161
                    var vertical = graph.getEdge(
                    	target.down
                    );
                    // item 15297
                    if (downRole(vertical)) {
                        // item 39430001
                        if (target.mark === edge.upperMark) {
                            // item 3941
                            if ((target.y > tail.y) && (!(detectOuterCycle(graph, 
edge.tail, target.id)))) {
                                // item 3942
                                result = "topOuterCorner";
                            }
                        } else {
                            // item 39430002
                            if ((target.mark === edge.lowerMark) && (!(detectInternalCycle(graph, 
edge.tail, target.id)))) {
                                // item 3952
                                result = "topInnerCorner";
                            }
                        }
                    }
                } else {
                    // item 38810003
                    if (((desc === "right-up") && (target.mark === edge.upperMark)) && (target.x > tail.x)) {
                        // item 7988
                        var rightEdge = graph.getEdge(target.right);
                        // item 7989
                        if (((rightEdge.role === "right") && (isUnderCase(graph, tail.id))) && (isUnderCase(graph, target.id))) {
                            // item 3924
                            result = "rightCorner";
                        }
                    }
                }
            }
        }
    }
    // item 3909
    return result;
}

function findCycleStartCandidates(graph, node, mark) {
    // item 6196
    var candidates = [];
    var count = 0;
    while (true) {
        // item 16441
        if (count < 0) {
            break;
        }
        // item 6182
        if (node.up) {
            // item 6188
            var edge = graph.getEdge(node.up);
            // item 15298
            if (((downRole(edge)) && (edge.upperMark === mark)) && (count === 0)) {
                // item 6195
                candidates.push(edge.id);
            }
            // item 6194
            node = graph.getNode(edge.head);
        } else {
            // item 6189
            if (hasLeft(graph, node)) {
                
            } else {
                break;
            }
            // item 6191
            node = leftToEndNoDuration(graph, node.id)
        }
        // item 9249
        if (node.type === "loopbegin") {
            // item 9253
            count--;
        } else {
            // item 9254
            if (node.type === "loopend") {
                // item 9257
                count++;
            }
        }
    }
    // item 6197
    return candidates;
}

function findDiagramBox(graph) {
    // item 9628
    var left = Number.MAX_VALUE
    var right = -Number.MAX_VALUE
    var top = Number.MAX_VALUE
    var bottom = -Number.MAX_VALUE
    // item 18702
    var box = findDiagramBoxCore(
    	graph,
    	left,
    	top,
    	right,
    	bottom
    )
    // item 9647
    var border = Config.METRE;
    // item 18583
    left = getRidOfMinMax(box.left, 0)
    right = getRidOfMinMax(box.right, 300)
    top = getRidOfMinMax(box.top, 0)
    bottom = getRidOfMinMax(box.bottom, 300)
    // item 9629
    return new Utils.Box(
    	left - border,
    	top - border,
    	right + border,
    	bottom + border
    );
}

function findDiagramBoxCore(graph, left, top, right, bottom) {
    // item 186960001
    var _ind18696 = 0;
    var _col18696 = graph.nodes;
    var _keys18696 = Object.keys(_col18696); 
    var _len18696 = _keys18696.length;
    while (true) {
        // item 186960002
        if (_ind18696 < _len18696) {
            
        } else {
            break;
        }
        // item 186960004
        var id = _keys18696[_ind18696]; var node = _col18696[id];
        // item 18700
        var box = node.box;
        // item 18701
        left = Math.min(left, box.left)
        top = Math.min(top, box.top)
        right = Math.max(right, box.right)
        bottom = Math.max(bottom, box.bottom)
        // item 186960003
        _ind18696++;
    }
    // item 18699
    return new Utils.Box(
    	left,
    	top,
    	right,
    	bottom
    );
}

function findDistance(item1, item2) {
    // item 20147
    var dx = item2.x - item1.x
    var dy = item2.y - item1.y
    // item 20146
    return Math.sqrt(dx * dx + dy * dy)
}

function findDownSocket(graph, edge, target, tJoint, isArrow) {
    // item 3997
    var result = null;
    // item 3996
    var head = graph.getHead(edge);
    var tail = graph.getTail(edge);
    var targetHead = graph.getHead(target);
    var targetTail = graph.getTail(target);
    var origin = findPathOrigin(graph, tail.id);
    // item 5300
    if (tJoint) {
        // item 5302
        if (((((target.upperMark === edge.lowerMark) && (!(isNakedCorner(graph, target)))) && (!(targetHead.y < origin.y))) && (!(detectInternalCycle(graph, 
edge.tail, target.tail)))) && (!(isNextToCorner(graph, targetTail)))) {
            // item 5307
            result = "leftInnerLine";
        }
    } else {
        // item 40050001
        if (target.upperMark === edge.lowerMark) {
            // item 5266
            if (((((isNakedCorner(graph, target)) || (targetHead.y < origin.y)) || (detectInternalCycle(graph, 
edge.tail, target.tail))) || (isArrow == "sq")) || (isNextToCorner(graph, targetTail))) {
                
            } else {
                // item 3999
                result = "leftInnerLine";
            }
        } else {
            // item 40050002
            if (target.lowerMark === edge.upperMark) {
                // item 4037
                if ((((targetHead.x > head.x) && (!(endsWithRightTurn(graph, target.tail)))) && (!(isInCycleBody(graph, target.id)))) && (!(isArrow))) {
                    // item 10229
                    var targetCeiling = goUpToEnd(graph, target.head);
                    // item 10230
                    if (tail.y > targetCeiling.y) {
                        // item 4038
                        result = "rightLine";
                    }
                }
            } else {
                // item 40050003
                if (((((target.upperMark === edge.upperMark) && (targetTail.y > tail.y)) && (!(isNakedCorner(graph, target)))) && (!(detectOuterCycle(graph, 
edge.tail, target.tail)))) && (!(isNextToCorner(graph, targetTail)))) {
                    // item 8037
                    if (isArrow) {
                        // item 11894
                        if (isArrow == "sq") {
                            // item 11896
                            result = "shortCycleDown";
                        }
                    } else {
                        // item 4073
                        result = "leftOuterLine";
                    }
                }
            }
        }
    }
    // item 3998
    return result;
}

function findDraggable(x, y) {
    // item 16304
    var prim = findSocket(x, y);
    // item 16305
    if (prim) {
        // item 16308
        return new Draggable(
        	prim,
        	Const.DRN_SOCKET,
        	null
        );
    } else {
        // item 18904
        var i
        var length = self.grips.length
        // item 162110001
        i = length - 1;
        while (true) {
            // item 162110002
            if (i >= 0) {
                
            } else {
                // item 16831
                var itemId = findFreeItem(
                	self,
                	x,
                	y
                );
                // item 16832
                if (itemId) {
                    // item 19877
                    return createItemDraggable(
                    	self,
                    	itemId,
                    	x,
                    	y
                    )
                } else {
                    // item 12180
                    itemId = 
                      self.canvas.pgraph.findPhysicalItem(
                    	x,
                    	y
                    );
                    // item 16217
                    if (itemId) {
                        // item 19877
                        return createItemDraggable(
                        	self,
                        	itemId,
                        	x,
                        	y
                        )
                    } else {
                        // item 16219
                        return null;
                    }
                }
                break;
            }
            // item 18905
            var grip = self.grips[i]
            // item 16213
            if (Utils.hitBox(grip.touchBox, x, y)) {
                // item 16216
                return new Draggable(
                	grip.id,
                	grip.type,
                	Utils.copyObject(grip.dims)
                );
            }
            // item 162110003
            i--;
        }
    }
}

function findEdgeAbove(commandList, nodeId) {
    // item 182940001
    var _ind18294 = 0;
    var _col18294 = commandList;
    var _len18294 = _col18294.length;
    while (true) {
        // item 182940002
        if (_ind18294 < _len18294) {
            
        } else {
            // item 18296
            return null
        }
        // item 182940004
        var command = _col18294[_ind18294];
        // item 18297
        if ((((command.type == "insert") && (command.table == "edges")) && (command.fields.tail == nodeId)) && (command.fields.role == "down")) {
            // item 18307
            return command.id
        }
        // item 182940003
        _ind18294++;
    }
}

function findFreeItem(editor, x, y) {
    // item 16824
    var free = editor.storage.free
    var i
    // item 168220001
    i = free.list.length - 1;
    while (true) {
        // item 168220002
        if (i >= 0) {
            
        } else {
            // item 16830
            return null
        }
        // item 16895
        var id = free.list[i]
        var item = free.set[id]
        // item 16826
        if (hitFreeItem(item, x, y)) {
            // item 16829
            return id
        }
        // item 168220003
        i--;
    }
}

function findFreeItemsBox(free, left, top, right, bottom) {
    // item 187080001
    var _ind18708 = 0;
    var _col18708 = free.set;
    var _keys18708 = Object.keys(_col18708); 
    var _len18708 = _keys18708.length;
    while (true) {
        // item 187080002
        if (_ind18708 < _len18708) {
            
        } else {
            break;
        }
        // item 187080004
        var id = _keys18708[_ind18708]; var item = _col18708[id];
        // item 18814
        var box = getBox(item, null)
        // item 18711
        left = Math.min(box.left, left)
        top = Math.min(box.top, top)
        right = Math.max(box.right, right)
        bottom = Math.max(box.bottom, bottom)
        // item 187080003
        _ind18708++;
    }
    // item 18712
    return new Utils.Box(
    	left,
    	top,
    	right,
    	bottom
    );
}

function findGripAllPoint(grips) {
    // item 19122
    var count = grips.length
    var LARGE = 10000000
    var top = LARGE
    var left = LARGE
    var right = -LARGE
    var i
    // item 19125
    if (count == 0) {
        // item 19128
        return null
    } else {
        // item 191230001
        i = 0;
        while (true) {
            // item 191230002
            if (i < count) {
                
            } else {
                break;
            }
            // item 19129
            var grip = grips[i]
            // item 19130
            left = Math.min(left, grip.x)
            right = Math.max(right, grip.x)
            top = Math.min(top, grip.y)
            // item 191230003
            i++;
        }
        // item 19131
        var xavg = (left + right) / 2
        // item 19132
        return new Utils.Point(
        	xavg,
        	top - 30
        )
    }
}

function findHead(graph) {
    // item 36950001
    var _ind3695 = 0;
    var _col3695 = graph.nodes;
    var _keys3695 = Object.keys(_col3695); 
    var _len3695 = _keys3695.length;
    while (true) {
        // item 36950002
        if (_ind3695 < _len3695) {
            
        } else {
            // item 3701
            Utils.throwError(
             "Head not found");
            break;
        }
        // item 36950004
        var id = _keys3695[_ind3695]; var node = _col3695[id];
        // item 3697
        if (node.role === "header") {
            // item 3700
            return node;
        }
        // item 36950003
        _ind3695++;
    }
}

function findInsertedEdge(commandList) {
    // item 119240001
    var _ind11924 = 0;
    var _col11924 = commandList;
    var _len11924 = _col11924.length;
    while (true) {
        // item 119240002
        if (_ind11924 < _len11924) {
            
        } else {
            // item 11936
            Utils.throwError(
             "down edge not found");
            break;
        }
        // item 119240004
        var command = _col11924[_ind11924];
        // item 11927
        if (((command.type == "insert") && (command.table == "edges")) && (downRole(command.fields))) {
            // item 11934
            return command.id;
        }
        // item 119240003
        _ind11924++;
    }
}

function findItemsToDrag(editor, id) {
    // item 19180
    gShouldMoveAll = true
    // item 16864
    var selection = getSelectedIds(editor)
    // item 19175
    if ((id) && (!(id in selection))) {
        // item 19179
        gShouldMoveAll = false
        // item 16868
        return [id]
    } else {
        // item 19178
        return getAllFreeSelected(editor, selection)
    }
}

function findLedgeDimensions(graph, source, target) {
    // item 6298
    var min = -1000000;
    var result = new Utils.Point(min, min);
    var srcNode = graph.getNode(source);
    var leftX = srcNode.x;
    // item 7598
    recordDimension(srcNode, result);
    // item 7591
    if (source == target) {
        // item 7590
        recordDimension(srcNode, result);
    } else {
        // item 6396
        if (srcNode.right) {
            // item 6399
            scanRight(leftX, graph, srcNode, target, result);
        } else {
            // item 7168
            if (srcNode.down) {
                // item 6300
                scanDown(leftX, graph, srcNode, target, result);
            } else {
                // item 7170
                scanLeft(leftX, graph, srcNode, target, result);
            }
        }
    }
    // item 6446
    result.y += Config.METRE;
    result.x += Config.METRE;
    // item 6299
    return result;
}

function findLedgeFromOrigin(graph, nodeId, targetId) {
    // item 7620
    var origin = findPathOrigin(graph, nodeId);
    var below = graph.getNodeDown(origin);
    // item 7622
    if (below == targetId) {
        // item 7621
        return new Utils.Point(
        	origin.box.right,
        	origin.box.bottom
        );
    } else {
        // item 7625
        return findLedgeDimensions(
        	graph,
        	below,
        	targetId
        );
    }
}

function findLeft(graph, item) {
    // item 20199
    if (item.left) {
        // item 20203
        return graph.getNodeLeft(item)
    } else {
        // item 20202
        return null
    }
}

function findLeftMostOnSurface(graph, source, targetId) {
    // item 9421
    var x = 100000000;
    var found = null;
    // item 9422
    var visitor = function(node) {
    	if (node.x < x) {
    		x = node.x;
    		found = node;
    	}
    };
    // item 9423
    scanSurface(
    	graph,
    	source,
    	targetId,
    	visitor
    );
    // item 9420
    return found;
}

function findLeftSkewerEdge(pgraph, id) {
    // item 15225
    var graph = pgraph.graph;
    // item 15206
    var node = graph.getNode(id);
    var x = node.x;
    // item 15205
    var vertical = graph.getVertical(id);
    // item 152070001
    var _ind15207 = 0;
    var _col15207 = vertical;
    var _len15207 = _col15207.length;
    while (true) {
        // item 152070002
        if (_ind15207 < _len15207) {
            
        } else {
            break;
        }
        // item 152070004
        var iid = _col15207[_ind15207];
        // item 15210
        var item = graph.getItem(iid);
        // item 15211
        if (((item.isLine) || (item.type == "beginend")) || (item.type == "end")) {
            
        } else {
            // item 15216
            var duration = Drakon.getDuration(graph, item);
            var left;
            // item 15215
            if (duration) {
                // item 15220
                left = duration.box.left;
            } else {
                // item 15219
                left = item.box.left
            }
            // item 15221
            x = Math.min(x, left);
        }
        // item 152070003
        _ind15207++;
    }
    // item 16412
    if (x == node.x) {
        // item 16415
        x = node.x - Config.DEF_ICON_WIDTH;
    }
    // item 15209
    return x;
}

function findLeftSocket(graph, edge, target) {
    // item 4055
    var result = null;
    // item 4051
    var tail = graph.getTail(edge);
    var targetTail = graph.getTail(target);
    // item 4052
    if (tail.y < targetTail.y) {
        // item 40440001
        if (target.upperMark === edge.lowerMark) {
            // item 4924
            result = "onInnerFloor";
        } else {
            // item 40440002
            if (target.upperMark === edge.upperMark) {
                // item 4058
                result = "onOuterFloor";
            }
        }
    }
    // item 4056
    return result;
}

function findLowerNodes(graph, leftBottom) {
    // item 13333
    var result = [];
    // item 13335
    var floor0 = leftBottom;
    while (true) {
        // item 13339
        var floor1 = graph.getNodeUpEx(floor0);
        result.push(floor0);
        result.push(floor1);
        // item 13336
        if (floor0.right) {
            
        } else {
            break;
        }
        // item 13340
        floor0 = graph.getNodeRightEx(floor0);
    }
    // item 13334
    return result;
}

function findManyNodesBy(graph, property, value) {
    // item 10251
    var result = [];
    // item 102440001
    var _ind10244 = 0;
    var _col10244 = graph.nodes;
    var _keys10244 = Object.keys(_col10244); 
    var _len10244 = _keys10244.length;
    while (true) {
        // item 102440002
        if (_ind10244 < _len10244) {
            
        } else {
            break;
        }
        // item 102440004
        var id = _keys10244[_ind10244]; var node = _col10244[id];
        // item 10246
        if (node[property] === value) {
            // item 10249
            result.push(node);
        }
        // item 102440003
        _ind10244++;
    }
    // item 10250
    return result;
}

function findMindDelete(item) {
    // item 21241
    var graph = self.storage.graph
    var result = null
    // item 22577
    if ((item.isLine) || (item.type == "junction")) {
        
    } else {
        // item 22581
        if (item.up) {
            // item 21242
            var above = graph.getNodeUpEx(item)
            // item 21244
            if (above.type == "junction") {
                // item 21243
                var type = describeJunction(above)
                // item 212450001
                if (type === "left-down") {
                    // item 21253
                    var left = graph.getNodeLeftEx(above)
                    var leftType = describeJunction(left)
                    // item 21254
                    if (leftType == "up-t") {
                        // item 21256
                        result = "mdh02"
                    } else {
                        // item 21252
                        result = "mdh03"
                    }
                } else {
                    // item 212450002
                    if (type === "right-down") {
                        // item 21258
                        var right = graph.getNodeRightEx(above)
                        var rightType = describeJunction(right)
                        // item 21259
                        if (rightType == "up-t") {
                            // item 21261
                            result = "mdh04"
                        } else {
                            // item 21257
                            result = "mdh05"
                        }
                    } else {
                        // item 21264
                        result = "mdh06"
                    }
                }
            } else {
                // item 21263
                result = "mdh01"
            }
        } else {
            // item 22585
            if (item.left) {
                // item 21494
                var leftmost = goLeftToEnd(
                	graph,
                	item.id
                )
                // item 21493
                if (leftmost.up) {
                    // item 21498
                    if (leftmost.down) {
                        // item 21500
                        result = "mdv03"
                    } else {
                        // item 21503
                        var upJ = graph.getNodeUpEx(leftmost)
                        var aboveEdge = graph.getEdge(upJ.right)
                        // item 21505
                        if (aboveEdge.role == "link") {
                            // item 21506
                            result = "mdv01"
                        } else {
                            // item 21504
                            var upperSibling = graph.getNodeRightEx(upJ)
                            // item 21501
                            if (upperSibling.role == "header") {
                                // item 21502
                                result = "mdv01"
                            } else {
                                // item 21509
                                result = "mdv02"
                            }
                        }
                    }
                }
            }
        }
    }
    // item 21481
    return result
}

function findNextOnWall(graph, src) {
    // item 4836
    var node = src.node;
    var edge = src.edge.id;
    // item 4825
    if (canGo(node.right, edge)) {
        // item 4831
        var rightEdge = graph.getEdge(node.right);
        // item 4828
        if (rightEdge.role === "left") {
            
        } else {
            // item 4842
            return grabForward(
            	graph,
            	node.right
            );
        }
    } else {
        // item 4838
        if (canGo(node.down, edge)) {
            // item 4875
            return grabForward(
            	graph,
            	node.down
            );
        } else {
            // item 4876
            if (canGo(node.left, edge)) {
                // item 4878
                return grabBack(
                	graph,
                	node.left
                );
            } else {
                // item 4879
                if (canGo(node.up, edge)) {
                    // item 4881
                    return grabBack(
                    	graph,
                    	node.up
                    );
                }
            }
        }
    }
    // item 4882
    Utils.throwError(
     "Invalid op");
}

function findNodeByRole(graph, role) {
    // item 94600001
    var _ind9460 = 0;
    var _col9460 = graph.nodes;
    var _keys9460 = Object.keys(_col9460); 
    var _len9460 = _keys9460.length;
    while (true) {
        // item 94600002
        if (_ind9460 < _len9460) {
            
        } else {
            // item 9467
            return null;
        }
        // item 94600004
        var id = _keys9460[_ind9460]; var node = _col9460[id];
        // item 9463
        if (node.role === role) {
            // item 9466
            return node;
        }
        // item 94600003
        _ind9460++;
    }
}

function findNodesBelow(graph, nodeId, bottom) {
    // item 7311
    var id = nodeId;
    var result = [];
    while (true) {
        // item 7313
        var node = graph.getNode(id);
        // item 7305
        if (node.y > bottom) {
            break;
        }
        // item 7314
        result.push(node);
        // item 7308
        if (node.down) {
            // item 7315
            id = graph.getNodeDown(node);
        } else {
            // item 7369
            if (node.left) {
                
            } else {
                break;
            }
            // item 7371
            id = graph.getNodeLeft(node);
        }
    }
    // item 7312
    return result;
}

function findNodesBelowEx(graph, node, bottom) {
    // item 11481
    var result = traverseRightSide(
    	graph,
    	node.id,
    	node.x,
    	bottom
    );
    // item 11475
    if (result.length == 0) {
        // item 11491
        return [node];
    } else {
        // item 11490
        return result;
    }
}

function findPathOrigin(graph, nodeId) {
    // item 7453
    var node = graph.getNode(nodeId);
    var upId = graph.getNodeUp(node);
    // item 7458
    return findPathOriginUp(graph, upId);
}

function findPathOriginLeft(graph, nodeId) {
    // item 7465
    var id = nodeId;
    var node;
    while (true) {
        // item 7466
        node = graph.getNode(id);
        // item 7711
        if (node.down) {
            // item 7471
            return node;
        }
        // item 7467
        if (node.left) {
            
        } else {
            // item 7913
            id = graph.getNodeUp(node);
            // item 7714
            return findPathOriginUp(graph, id);
        }
        // item 7472
        id = graph.getNodeLeft(node);
    }
}

function findPathOriginUp(graph, nodeId) {
    // item 7494
    var id = nodeId;
    var node;
    while (true) {
        // item 7495
        node = graph.getNode(id);
        // item 7496
        if (hasLeft(graph, node)) {
            break;
        }
        // item 7500
        id = graph.getNodeUp(node);
    }
    // item 7501
    id = graph.getNodeLeft(node);
    // item 7499
    return findPathOriginLeft(graph, id);
}

function findPoisoned(graph, id) {
    // item 3540
    var edge = graph.getEdge(id);
    var result = {};
    // item 18334
    if (edge.isVertical) {
        // item 3542
        var center = graph.getTail(edge);
        // item 3543
        if ((center.left) && (!(questionOnLeft(graph, center)))) {
            // item 3546
            result[center.left] = true;
            // item 3548
            var leftArm = graph.getEdge(center.left);
            // item 3549
            var leftNode = graph.getHead(leftArm);
            // item 3551
            result[leftNode.id] = true;
            // item 3550
            Utils.addNotNilToSet(result, leftNode.down);
            // item 4660
            if (((isUpT(center)) || (isUpT(leftNode))) || (!(leftNode.type === "junction"))) {
                
            } else {
                // item 4659
                Utils.addNotNilToSet(result, leftNode.up);
            }
        }
        // item 3552
        if (center.right) {
            // item 3555
            result[center.right] = true;
            // item 3556
            var rightArm = graph.getEdge(center.right);
            // item 3557
            var rightNode = graph.getTail(rightArm);
            // item 3559
            result[rightNode.id] = true;
            // item 3558
            Utils.addNotNilToSet(result, rightNode.down);
            // item 4665
            if ((isUpT(center)) || (isUpT(rightNode))) {
                
            } else {
                // item 4664
                Utils.addNotNilToSet(result, rightNode.up);
            }
        }
        // item 14690
        var leg = graph.getVertical(id);
        var legSet = Utils.listToSet(leg);
        Utils.mergeSets(result, legSet);
    }
    // item 3562
    return result;
}

function findRight(graph, item) {
    // item 20209
    if (item.right) {
        // item 20213
        return graph.getNodeRight(item)
    } else {
        // item 20212
        return null
    }
}

function findRightEdge(graph, nodeId, bottom) {
    // item 7334
    var id = nodeId;
    var result = [];
    while (true) {
        // item 7336
        var node = graph.getNode(id);
        // item 7328
        if (node.y > bottom) {
            break;
        }
        // item 7337
        result.push(node);
        // item 7331
        if (node.down) {
            
        } else {
            break;
        }
        // item 7338
        id = graph.getNodeDown(node);
    }
    // item 7335
    return result;
}

function findRightSocket(graph, edge, target) {
    // item 7865
    var result = null;
    // item 7861
    var tail = graph.getTail(edge);
    var targetTail = graph.getTail(target);
    // item 7862
    if ((tail.y < targetTail.y) && (target.upperMark === edge.upperMark)) {
        // item 7867
        result = "onOuterFloor";
    }
    // item 7866
    return result;
}

function findSecondBranch(graph, cross) {
    // item 9879
    var rightId =graph.getNodeRight(cross);
    var bottom = goDownToEnd(graph, rightId);
    // item 9880
    return bottom.id;
}

function findSiblingAddresses(graph, junction, nextBranchId, found) {
    // item 9881
    var result = [];
    while (true) {
        // item 9860
        var aboveId = graph.getNodeUp(junction);
        // item 9865
        result.push(aboveId);
        // item 9866
        if (junction.right) {
            
        } else {
            break;
        }
        // item 9864
        var rightId =graph.getNodeRight(junction);
        // item 9861
        if (rightId == nextBranchId) {
            break;
        }
        // item 9869
        junction = graph.getNode(rightId);
    }
    // item 9882
    return result;
}

function findSilSocket(graph, edge, target) {
    // item 10002
    var result = null;
    // item 9998
    var tail = graph.getTail(edge);
    var targetTail = graph.getTail(target);
    // item 10006
    if (target.upperMark === edge.upperMark) {
        // item 10004
        result = "onOuterSilFloor";
    }
    // item 10003
    return result;
}

function findSocket(x, y) {
    // item 122280001
    var _ind12228 = 0;
    var _col12228 = self.canvas.sockets;
    var _keys12228 = Object.keys(_col12228); 
    var _len12228 = _keys12228.length;
    while (true) {
        // item 122280002
        if (_ind12228 < _len12228) {
            
        } else {
            // item 12233
            return null;
        }
        // item 122280004
        var prim = _keys12228[_ind12228]; var socket = _col12228[prim];
        // item 12230
        if (Utils.hitBox(socket.box, x, y)) {
            // item 12234
            return prim;
        }
        // item 122280003
        _ind12228++;
    }
}

function findSourceHorizontal(graph, edge) {
    var _sw182680000_ = 0;
    // item 11366
    var left = graph.getHead(edge);
    var right = graph.getTail(edge);
    // item 11370
    if (right.type == "junction") {
        // item 18267
        var rightType = describeJunction(right)
        // item 182680000
        _sw182680000_ = left.type;
        // item 182680001
        if (_sw182680000_ === "junction") {
            // item 11371
            var leftType = describeJunction(left)
            // item 11374
            if ((rightType == "left-up") && ((leftType == "right-t") || (leftType == "up-t"))) {
                // item 11375
                return right.id;
            } else {
                // item 11378
                if (((rightType == "left-t") && (leftType == "right-up")) || ((rightType == "left-up") && (leftType == "right-up"))) {
                    // item 11379
                    return left.id;
                } else {
                    // item 11492
                    if (((leftType == "right-t") && (rightType == "left-down")) && (edge.role == "arrow")) {
                        // item 11389
                        return findArrowStart(graph, right.id);
                    } else {
                        // item 11496
                        return null;
                    }
                }
            }
        } else {
            // item 182680002
            if (_sw182680000_ === "question") {
                // item 183100001
                if (rightType === "left-up") {
                    // item 18277
                    return right.id
                } else {
                    // item 183100002
                    if (rightType === "left-t") {
                        // item 18318
                        return edge.id
                    } else {
                        // item 11358
                        return null;
                    }
                }
            } else {
                // item 11358
                return null;
            }
        }
    } else {
        // item 11358
        return null;
    }
}

function findSourceJunction(graph, node) {
    // item 11566
    var type = describeJunction(node);
    // item 115700001
    if (type === "up-t") {
        // item 11577
        var upId = graph.getNodeUp(node);
        var up = graph.getNode(upId);
        // item 11578
        if (up.type == "address") {
            // item 11580
            return upId;
        } else {
            // item 11596
            return null;
        }
    } else {
        // item 115700002
        if (type === "right-t") {
            // item 11581
            var rightId = graph.getNodeRight(node);
            var right = graph.getNode(rightId);
            // item 11582
            if (right.type == "junction") {
                // item 11585
                if (describeJunction(right) == "left-up") {
                    // item 11586
                    return rightId;
                } else {
                    // item 11598
                    var rightEdge = graph.getEdge(node.right);
                    // item 11599
                    if (rightEdge.role == "arrow") {
                        // item 11600
                        return findArrowStart(graph, rightEdge.tail);
                    } else {
                        // item 11594
                        return null;
                    }
                }
            } else {
                // item 11594
                return null;
            }
        } else {
            // item 115700003
            if (type === "left-t") {
                // item 11589
                var leftId = graph.getNodeLeft(node);
                var left = graph.getNode(leftId);
                // item 11590
                if ((left.type == "junction") && (describeJunction(left) == "right-up")) {
                    // item 11593
                    return leftId;
                } else {
                    // item 11595
                    return null;
                }
            } else {
                // item 115700004
                if (type === "left-down") {
                    // item 11604
                    var leftEdge = graph.getEdge(node.left);
                    // item 11605
                    if (leftEdge.role == "arrow") {
                        // item 11607
                        return findArrowStart(graph, node.id);
                    } else {
                        // item 11601
                        return null;
                    }
                } else {
                    // item 115700005
                    if (type === "left-up") {
                        // item 11863
                        if (questionOnLeft(graph, node)) {
                            // item 11865
                            return node.id;
                        } else {
                            // item 11888
                            var leftEdge = graph.getEdge(node.left);
                            // item 15359
                            if (leftEdge.role) {
                                // item 11615
                                if (leftEdge.role == "sil_floor") {
                                    // item 11617
                                    return graph.getNodeUp(node);
                                } else {
                                    // item 11611
                                    var upId = graph.getNodeUp(node);
                                    var up = graph.getNode(upId);
                                    var leftUpEdge = graph.getEdge(up.left);
                                    // item 11612
                                    if (leftUpEdge.role == "arrow") {
                                        // item 14252
                                        var left = graph.getNode(leftEdge.head);
                                        // item 14253
                                        if (left.left) {
                                            // item 11608
                                            return null;
                                        } else {
                                            // item 11614
                                            return left.id;
                                        }
                                    } else {
                                        // item 11608
                                        return null;
                                    }
                                }
                            } else {
                                // item 11364
                                return null;
                            }
                        }
                    } else {
                        // item 11364
                        return null;
                    }
                }
            }
        }
    }
}

function findSourceVertical(graph, edge) {
    // item 11532
    var up = graph.getHead(edge);
    var down = graph.getTail(edge);
    // item 11533
    if ((up.type == "junction") && (down.type == "junction")) {
        // item 11537
        var upType = describeJunction(up);
        var downType = describeJunction(down);
        // item 11538
        if ((upType == "left-down") && (downType == "left-up")) {
            // item 11553
            var roof = graph.getEdge(up.left);
            // item 11554
            if (roof.role == "arrow") {
                // item 11555
                return findArrowStart(graph, up.id);
            } else {
                // item 11556
                return null;
            }
        } else {
            // item 11556
            return null;
        }
    } else {
        // item 11558
        if (up.type == "address") {
            // item 11564
            return up.id;
        } else {
            // item 11561
            if (down.type == "address") {
                // item 11565
                return down.id;
            } else {
                // item 11531
                return null;
            }
        }
    }
}

function findTExitSocket(graph, sourceEdge, targetEdge) {
    // item 18365
    if (targetEdge.upperMark == sourceEdge.lowerMark) {
        // item 18376
        var head = graph.getHead(sourceEdge);
        var tail = graph.getTail(sourceEdge);
        var targetHead = graph.getHead(targetEdge);
        var targetTail = graph.getTail(targetEdge);
        // item 18369
        if ((isNakedCorner(graph, targetEdge)) || (targetHead.y < head.y)) {
            // item 18378
            return null
        } else {
            // item 18377
            var rightDown = graph.getNodeDown(tail)
            // item 18373
            if ((detectInternalCycle(graph, 
rightDown, targetEdge.tail)) || (isNextToCorner(graph, targetTail))) {
                // item 18378
                return null
            } else {
                // item 18368
                return "leftInnerLineEx";
            }
        }
    } else {
        // item 18378
        return null
    }
}

function findTExitSockets(graph, edge) {
    // item 18348
    var sockets = []
    // item 183460001
    var _ind18346 = 0;
    var _col18346 = graph.edges;
    var _keys18346 = Object.keys(_col18346); 
    var _len18346 = _keys18346.length;
    while (true) {
        // item 183460002
        if (_ind18346 < _len18346) {
            
        } else {
            break;
        }
        // item 183460004
        var targetId = _keys18346[_ind18346]; var targetEdge = _col18346[targetId];
        // item 18350
        if ((targetEdge.role == "down") || (targetEdge.role == "par-down")) {
            // item 18356
            joinType = findTExitSocket(
            	graph,
            	edge,
            	targetEdge
            );
            // item 18357
            if (joinType) {
                // item 18358
                appendSocket(
                	sockets,
                	targetId,
                	joinType
                );
            }
        }
        // item 183460003
        _ind18346++;
    }
    // item 18349
    return sockets
}

function findTargetSockets(graph, id, poisoned, isArrow) {
    var _sw39540000_ = 0;
    // item 3401
    var sockets = [];
    var edge = graph.getEdge(id);
    // item 5282
    var tJoint = isFromTJoint(graph, edge);
    // item 34040001
    var _ind3404 = 0;
    var _col3404 = graph.items;
    var _keys3404 = Object.keys(_col3404); 
    var _len3404 = _keys3404.length;
    while (true) {
        // item 34040002
        if (_ind3404 < _len3404) {
            
        } else {
            break;
        }
        // item 34040004
        var iid = _keys3404[_ind3404]; var item = _col3404[iid];
        // item 3961
        var joinType = null;
        // item 3408
        if (item.id in poisoned) {
            
        } else {
            // item 3563
            if (item.isLine) {
                // item 39540000
                _sw39540000_ = item.role;
                // item 39540001
                if ((_sw39540000_ === "down") || (_sw39540000_ === "par-down")) {
                    // item 3962
                    joinType = findDownSocket(
                    	graph,
                    	edge,
                    	item,
                    	tJoint,
                    	isArrow
                    );
                } else {
                    // item 39540003
                    if (_sw39540000_ === "left") {
                        // item 5297
                        if ((tJoint) || (isArrow)) {
                            
                        } else {
                            // item 3963
                            joinType = findLeftSocket(
                            	graph,
                            	edge,
                            	item
                            );
                        }
                    } else {
                        // item 39540004
                        if (_sw39540000_ === "sil_floor") {
                            // item 9983
                            if ((tJoint) || (isArrow)) {
                                
                            } else {
                                // item 9982
                                joinType = findSilSocket(
                                	graph,
                                	edge,
                                	item
                                );
                            }
                        } else {
                            // item 39540005
                            if (((_sw39540000_ === "right") && (!(tJoint))) && (!(isArrow))) {
                                // item 7872
                                joinType = findRightSocket(
                                	graph,
                                	edge,
                                	item
                                );
                            }
                        }
                    }
                }
            } else {
                // item 3566
                if ((((item.type === "junction") && (item.mark)) && (!(tJoint))) && (!(isArrow))) {
                    // item 3572
                    joinType = findCornerSocket(
                    	graph,
                    	edge,
                    	item
                    );
                }
            }
        }
        // item 4060
        if (joinType) {
            // item 4059
            appendSocket(
            	sockets,
            	item.id,
            	joinType
            );
        }
        // item 34040003
        _ind3404++;
    }
    // item 6095
    if ((tJoint) || (isArrow)) {
        
    } else {
        // item 6098
        findUpCycle(
        	graph,
        	edge,
        	sockets
        );
    }
    // item 3411
    return sockets;
}

function findTopMost(editor) {
    // item 20089
    var found = null
    var minY = 1000000000
    var graph = editor.storage.graph
    // item 200910001
    var _ind20091 = 0;
    var _col20091 = graph.items;
    var _keys20091 = Object.keys(_col20091); 
    var _len20091 = _keys20091.length;
    while (true) {
        // item 200910002
        if (_ind20091 < _len20091) {
            
        } else {
            break;
        }
        // item 200910004
        var id = _keys20091[_ind20091]; var item = _col20091[id];
        // item 20095
        if (item.y < minY) {
            // item 20098
            found = id
            minY = item.y
        }
        // item 200910003
        _ind20091++;
    }
    // item 20099
    var free = editor.storage.free
    // item 201000001
    var _ind20100 = 0;
    var _col20100 = free.set;
    var _keys20100 = Object.keys(_col20100); 
    var _len20100 = _keys20100.length;
    while (true) {
        // item 201000002
        if (_ind20100 < _len20100) {
            
        } else {
            break;
        }
        // item 201000004
        var id = _keys20100[_ind20100]; var item = _col20100[id];
        // item 20102
        if (item.y < minY) {
            // item 20105
            found = id
            minY = item.y
        }
        // item 201000003
        _ind20100++;
    }
    // item 20090
    return found
}

function findTransplantSource(graph, id) {
    // item 11332
    var otherId;
    var item = graph.getItem(id);
    // item 11325
    if (canTransplantFrom(graph, id)) {
        // item 11334
        return id;
    } else {
        // item 11335
        if (item.isLine) {
            // item 11338
            if (item.isVertical) {
                // item 11340
                otherId = findSourceVertical(graph, item)
            } else {
                // item 11341
                otherId = findSourceHorizontal(graph, item)
            }
            // item 11390
            if ((otherId) && (canTransplantFrom(graph, otherId))) {
                // item 11392
                return otherId;
            } else {
                // item 11346
                return null;
            }
        } else {
            // item 11343
            if (item.type == "junction") {
                // item 11342
                otherId = findSourceJunction(graph, item)
                // item 11390
                if ((otherId) && (canTransplantFrom(graph, otherId))) {
                    // item 11392
                    return otherId;
                } else {
                    // item 11346
                    return null;
                }
            } else {
                // item 11346
                return null;
            }
        }
    }
}

function findTs2Sockets(graph, id) {
    // item 20708
    var sockets = [];
    var edge = graph.getEdge(id);
    // item 20712
    var head = graph.getNode(edge.head)
    var below = graph.getNodeDownEx(head)
    // item 20710
    appendSocket(
    	sockets,
    	below.id,
    	"leftOuterCornerTs"
    )
    // item 20709
    return sockets;
}

function findTsSockets(graph, id) {
    // item 20408
    var sockets = [];
    var edge = graph.getEdge(id);
    // item 20535
    var lowerHead = goLeftToEnd(graph, edge.head)
    var lower = graph.getEdge(lowerHead.down)
    // item 20536
    var upperTail = graph.getNode(edge.head)
    var upper = graph.getEdge(upperTail.up)
    // item 20430
    appendSocket(
    	sockets,
    	upper.id,
    	"leftInnerLineTs"
    )
    // item 20539
    appendSocket(
    	sockets,
    	lower.id,
    	"leftOuterLineTs"
    )
    // item 20414
    return sockets;
}

function findUpCycle(graph, edge, sockets) {
    // item 7914
    var tail = graph.getTail(edge);
    var tailType = describeJunction(tail);
    // item 7915
    if (tailType === "right-up") {
        
    } else {
        // item 6113
        var split = findPathOrigin(graph, edge.tail);
        // item 6175
        var candidates = findCycleStartCandidates(
        	graph,
        	split,
        	edge.upperMark
        );
        // item 61980001
        var _ind6198 = 0;
        var _col6198 = candidates;
        var _len6198 = _col6198.length;
        while (true) {
            // item 61980002
            if (_ind6198 < _len6198) {
                
            } else {
                break;
            }
            // item 61980004
            var candidate = _col6198[_ind6198];
            // item 6200
            if (hasDoubleEntry(graph, split, candidate)) {
                
            } else {
                // item 6210
                appendSocket(
                	sockets,
                	candidate,
                	"createCycle"
                );
            }
            // item 61980003
            _ind6198++;
        }
    }
}

function findVisualItem(x, y) {
    // item 19052
    var item = findDraggable(x, y)
    // item 19053
    if ((item) && (!(item.type == Const.DRN_SOCKET))) {
        // item 19057
        return item
    } else {
        // item 19058
        return null
    }
}

function fireSocket(prim) {
    // item 12198
    self.canvas.render.setItemProperty(prim, "active", true);
    // item 12199
    self.dirty = true;
}

function fitItemType(render, type, width, cont) {
    // item 16036
    var item = {
    	isLine: false,
    	type: type,
    	content: cont,
    	x: 0,
    	y: 0,
    	w: width
    };
    // item 16037
    var size = Drakon.fitItem(item, render);
    // item 16038
    return size;
}

function followLink(editor, itemId) {
    // item 19827
    addTrace(
    	"followLink",
    	[itemId]
    )
    // item 19867
    var item = getAnyItem(editor.storage, itemId)
    var content = getContent(item)
    // item 19868
    if (content.link) {
        // item 19875
        var fun = Callbacks.followLink
        // item 19871
        if (fun) {
            // item 19874
            fun(content.link)
        }
    }
}

function generateId(storage) {
    // item 2499
    var id = storage.nextId
    storage.nextId++
    return String(id)
}

function getAllFreeSelected(editor, selection) {
    // item 19171
    var selectedFree = []
    // item 191650001
    var _ind19165 = 0;
    var _col19165 = selection;
    var _keys19165 = Object.keys(_col19165); 
    var _len19165 = _keys19165.length;
    while (true) {
        // item 191650002
        if (_ind19165 < _len19165) {
            
        } else {
            break;
        }
        // item 191650004
        var id = _keys19165[_ind19165]; var _ = _col19165[id];
        // item 19167
        var item = getAnyItem(editor.storage, id)
        // item 19168
        if (item.free) {
            // item 19173
            selectedFree.push(id)
        }
        // item 191650003
        _ind19165++;
    }
    // item 19172
    return selectedFree
}

function getAnyItem(storage, id) {
    // item 16813
    var item = storage.free.get(id)
    // item 16810
    if (item) {
        
    } else {
        // item 16815
        item = storage.graph.getItem(id)
    }
    // item 16814
    return item
}

function getBottom(node) {
    // item 19441
    return node.y + node.h
}

function getBox(item, render) {
    // item 2683
    var callback = Items.getItemCallback(item.type);
    // item 2684
    return callback.makeBox(
    	item,
    	item.x,
    	item.y,
    	render
    );
}

function getBranchForEdge(graph, item) {
    // item 15045
    var left;
    // item 15042
    if (item.isLine) {
        // item 11515
        left = graph.getHead(item);
    } else {
        // item 15046
        left = item;
    }
    // item 11516
    if (left.down) {
        // item 11517
        var leftDownId = graph.getNodeDown(left);
        var leftDown = graph.getNode(leftDownId);
        // item 11518
        if ((leftDown.type == "case") || (leftDown.type == "branch")) {
            // item 11522
            return leftDown;
        } else {
            // item 11525
            return null;
        }
    } else {
        // item 11525
        return null;
    }
}

function getClipboard(type) {
    // item 13423
    if (getClipboardType() == type) {
        // item 13018
        var fun = Callbacks.getClipboard;
        // item 13014
        if (fun) {
            // item 13017
            return fun();
        } else {
            // item 13019
            return null;
        }
    } else {
        // item 13019
        return null;
    }
}

function getClipboardType() {
    // item 13009
    var fun = Callbacks.getClipboardType;
    // item 13005
    if (fun) {
        // item 13008
        return fun();
    } else {
        // item 13010
        return null;
    }
}

function getContent(node) {
    // item 15950
    return node.content || new Utils.Content("", "");
}

function getDefault(key) {
    // item 17585
    var result = null
    // item 17582
    var fun = Callbacks.getDefault
    // item 17578
    if (fun) {
        // item 17581
        result = fun(key)
    }
    // item 17586
    return result
}

function getDefaultFont() {
    // item 23097
    var defaultFont = self.storage.font
    // item 23090
    defaultFont = defaultFont || getDefault("font")
    // item 23086
    var size
    var family
    // item 23083
    if (defaultFont) {
        // item 23087
        var parsed = Utils.parseFontString(defaultFont)
        // item 23089
        size = parsed.size
        family = parsed.family
    } else {
        // item 23088
        size = Config.FONT_SIZE
        family = Config.FONT_FAMILY
    }
    // item 23082
    return {
    	size: size,
    	family: family
    }
}

function getDiagramAsItems() {
    // item 17483
    var sane = getDiagramCopy(self)
    // item 17494
    var output = {
    	name: sane.name,
    	items: []
    }
    // item 17568
    setNotEmpty(
    	self.storage,
    	"background",
    	output
    )
    // item 18475
    setNotEmpty(
    	self.storage,
    	"diaLine",
    	output
    )
    // item 18820
    setNotEmpty(
    	self.storage,
    	"diaLineThickness",
    	output
    )
    // item 17621
    setNotEmpty(
    	self.storage,
    	"font",
    	output
    )
    // item 17492
    addItemsSubset(sane.nodes, output.items)
    // item 17469
    addItemsSubset(sane.edges, output.items)
    // item 17493
    addItemsSubset(sane.free, output.items)
    // item 17463
    return output
}

function getDiagramCopy(editor) {
    // item 17475
    var storage = editor.storage
    var free = storage.free
    // item 17476
    var nodes = storage.graph.nodes
    var edges = storage.graph.edges
    var output = {
    	name: storage.name,
    	type: storage.type,
    	nodes: cloneDictionary(nodes),
    	edges: cloneDictionary(edges)
    }
    // item 19565
    output.background = storage.background
    output.diaLine = storage.diaLine
    output.diaLineThickness = storage.diaLineThickness
    output.font = storage.font
    output.version = storage.version
    // item 17478
    if (free.list.length == 0) {
        
    } else {
        // item 17481
        output.free = cloneDictionary(free.set)
    }
    // item 17477
    var sane = Utils.sanitizeDiagram(output)
    // item 17622
    setNotEmpty(
    	storage,
    	"background",
    	sane
    )
    // item 18476
    setNotEmpty(
    	storage,
    	"diaLine",
    	sane
    )
    // item 18821
    setNotEmpty(
    	storage,
    	"diaLineThickness",
    	sane
    )
    // item 17623
    setNotEmpty(
    	storage,
    	"font",
    	sane
    )
    // item 17482
    return sane
}

function getEdgeHeight(head, tail) {
    // item 4192
    return tail.box.top - head.box.bottom;
}

function getEnd() {
    // item 19937
    if (gUserSettings.end) {
        // item 19940
        return gUserSettings.end
    } else {
        // item 16460
        return tr("DIA_END")
    }
}

function getFont() {
    // item 17897
    return self.storage.font
}

function getFonts(diagram) {
    // item 17879
    var fonts = {}
    // item 17898
    if (diagram.nodes) {
        // item 178640001
        var _ind17864 = 0;
        var _col17864 = diagram.nodes;
        var _keys17864 = Object.keys(_col17864); 
        var _len17864 = _keys17864.length;
        while (true) {
            // item 178640002
            if (_ind17864 < _len17864) {
                
            } else {
                break;
            }
            // item 178640004
            var nid = _keys17864[_ind17864]; var item = _col17864[nid];
            // item 17878
            rememberFont(item, fonts)
            // item 178640003
            _ind17864++;
        }
    }
    // item 17883
    if (diagram.free) {
        // item 178800001
        var _ind17880 = 0;
        var _col17880 = diagram.free;
        var _keys17880 = Object.keys(_col17880); 
        var _len17880 = _keys17880.length;
        while (true) {
            // item 178800002
            if (_ind17880 < _len17880) {
                
            } else {
                break;
            }
            // item 178800004
            var id = _keys17880[_ind17880]; var free = _col17880[id];
            // item 17882
            rememberFont(free, fonts)
            // item 178800003
            _ind17880++;
        }
    }
    // item 17886
    if (diagram.font) {
        // item 17889
        fonts[diagram.font] = true
    } else {
        // item 17890
        var font = Utils.buildFontString(
        	false,
        	false,
        	Config.FONT_SIZE_1,
        	Config.FONT_FAMILY_1
        )
        // item 17891
        fonts[font] = true
        // item 19040
        if (diagram.type == "drakon") {
            // item 19043
            var bfont = Utils.buildFontString(
            	false,
            	true,
            	Config.FONT_SIZE_1,
            	Config.FONT_FAMILY_1
            )
            // item 19044
            fonts[bfont] = true
        }
    }
    // item 17892
    return Object.keys(fonts)
}

function getFontsForItems(ids) {
    // item 22518
    var fonts = {}
    // item 225140001
    var _ind22514 = 0;
    var _col22514 = ids;
    var _len22514 = _col22514.length;
    while (true) {
        // item 225140002
        if (_ind22514 < _len22514) {
            
        } else {
            break;
        }
        // item 225140004
        var id = _col22514[_ind22514];
        // item 22515
        var item = getAnyItem(
        	self.storage,
        	id
        )
        var content = getContent(item)
        // item 22542
        var font = content.font || self.storage.font
        // item 22523
        fonts[font] = true
        // item 225140003
        _ind22514++;
    }
    // item 22526
    var result = Object.keys(fonts)
    // item 22524
    return result
}

function getFormat(ids) {
    // item 17664
    var editor = self
    var hasDr = false
    var hasComment = false
    var hasLine = false
    var lineOnly = true
    // item 17662
    var names = gFormatNames
    // item 17669
    var result = {}
    var filled = {}
    // item 176600001
    var _ind17660 = 0;
    var _col17660 = ids;
    var _len17660 = _col17660.length;
    while (true) {
        // item 176600002
        if (_ind17660 < _len17660) {
            
        } else {
            break;
        }
        // item 176600004
        var id = _col17660[_ind17660];
        // item 17663
        var item = getAnyItem(
        	editor.storage,
        	id
        )
        var content = getContent(item)
        // item 17665
        if (item.free) {
            
        } else {
            // item 17668
            hasDr = true
        }
        // item 17745
        if (((item.type == "comment") || (item.type == "insertion")) || (item.type == "shelf")) {
            // item 17748
            hasComment = true
        }
        // item 17786
        if ((item.isLine) || (item.type == "f_line")) {
            // item 17789
            hasLine = true
        } else {
            // item 18818
            lineOnly = false
        }
        // item 17785
        accumulateFormat(
        	names,
        	result,
        	filled,
        	content
        )
        // item 176600003
        _ind17660++;
    }
    // item 17697
    result.allowTransparent = !hasDr
    result.hasLine = hasLine
    result.lineOnly = lineOnly
    // item 17758
    if ((hasComment) && (ids.length == 1)) {
        // item 17762
        result.allowSecondary = true
    } else {
        // item 17763
        result.allowSecondary = false
    }
    // item 17670
    return result
}

function getGuideFormat() {
    // item 19229
    return {
    	lineThickness: 1,
    	lineColor: "#800000" //Items.getDiaLine()
    }
}

function getHardExpanders() {
    // item 20827
    if (self.storage.type == "drakon") {
        // item 14874
        return {
        	left: hardLeft,
        	up: hardUp,
        	right: hardRight,
        	down: hardDown
        };
    } else {
        // item 21200
        var returnNull = function(a, b) {
        	return b
        }
        // item 21201
        return {
        	left: returnNull,
        	up: returnNull,
        	right: returnNull,
        	down: returnNull
        };
        // item 20830
        /*
        return {
        	left: hardLeftMind,
        	up: hardUpMind,
        	right: hardRightMind,
        	down: hardDownMind
        };
        */
    }
}

function getIconCount(graph) {
    // item 14514
    var result = 0;
    // item 145150001
    var _ind14515 = 0;
    var _col14515 = graph.nodes;
    var _keys14515 = Object.keys(_col14515); 
    var _len14515 = _keys14515.length;
    while (true) {
        // item 145150002
        if (_ind14515 < _len14515) {
            
        } else {
            break;
        }
        // item 145150004
        var id = _keys14515[_ind14515]; var node = _col14515[id];
        // item 14518
        if (node.type == "junction") {
            
        } else {
            // item 14513
            result++;
        }
        // item 145150003
        _ind14515++;
    }
    // item 14517
    return result;
}

function getIntersectionDelta(box1, hitItem) {
    // item 15178
    var box2 = hitItem.box;
    // item 15179
    if (hitItem.type == "duration") {
        // item 4514
        return box1.right - box2.left;
    } else {
        // item 4510
        var m1 = (box1.left + box1.right) / 2;
        var m2 = (box2.left + box2.right) / 2;
        // item 4511
        if (m1 > m2) {
            // item 4515
            return box1.left - box2.right;
        } else {
            // item 4514
            return box1.right - box2.left;
        }
    }
}

function getItem(id) {
    // item 20364
    var editor = self
    // item 20363
    var item = getAnyItem(
    	editor.storage,
    	id
    )
    // item 20365
    if (item) {
        // item 20369
        return Utils.copyObjectDeep(item)
    } else {
        // item 20368
        return null
    }
}

function getItemRect(id) {
    // item 17831
    var editor = self
    var graph = editor.storage.graph
    // item 17832
    var item = getAnyItem(editor.storage, id)
    // item 17833
    if (item.isLine) {
        // item 17841
        var head = graph.getHead(item)
        var tail = graph.getTail(item)
        // item 17840
        return new Utils.Box(
        	head.x,
        	head.y,
        	tail.x,
        	tail.y
        )
    } else {
        // item 17836
        return Utils.boxFromPoint(
        	item.x,
        	item.y,
        	item.w,
        	item.h
        )
    }
}

function getItemText(editor, id) {
    // item 2092
    var item = editor.storage.graph.getItem(id);
    // item 2093
    return getText(item);
}

function getLeft(node) {
    // item 19423
    return node.x - node.w
}

function getMindActions(editor, item) {
    var _sw219640000_ = 0;
    // item 21315
    var graph = editor.storage.graph
    var parent = null
    var type = null
    var action = null
    // item 21282
    var result = []
    // item 21284
    if (item.isLine) {
        // item 219640000
        _sw219640000_ = item.role;
        // item 219640001
        if (_sw219640000_ === "bridge") {
            // item 21386
            above = graph.getNode(item.tail)
            var aboveSibling = leftWithDown(graph, above)
            var sibling = graph.getNodeDownEx(aboveSibling)
            // item 21327
            result.push({
            	text: "MES_ADD_ITEM",
            	itemId: sibling.id,
            	action: "mih06"
            })
        } else {
            // item 219640002
            if (_sw219640000_ === "arm") {
                // item 21971
                var lowJ = graph.getNode(item.tail)
                var sibling = goRightToEnd(graph, lowJ.id)
                // item 21972
                result.push({
                	text: "MES_ADD_ITEM",
                	itemId: sibling.id,
                	action: "miv03"
                })
            }
        }
    } else {
        // item 21285
        if (item.type == "junction") {
            // item 21305
            type = describeJunction(item)
            parent = Mind.getHorParent(graph, item.id)
            // item 213060001
            if (type === "right-down") {
                // item 21316
                var rightEdge = graph.getEdge(item.right)
                // item 21317
                if (rightEdge.role == "bridge") {
                    // item 21314
                    result.push({
                    	text: "MES_ADD_ITEM",
                    	itemId: parent.id,
                    	action: "mih05"
                    })
                }
            } else {
                // item 213060002
                if (type === "left-down") {
                    // item 21320
                    var leftEdge = graph.getEdge(item.left)
                    // item 21321
                    if (leftEdge.role == "bridge") {
                        // item 21319
                        result.push({
                        	text: "MES_ADD_ITEM",
                        	itemId: parent.id,
                        	action: "mih03"
                        })
                    }
                } else {
                    // item 213060003
                    if (type === "up-t") {
                        // item 21405
                        var leftEdge = graph.getEdge(item.left)
                        // item 21406
                        if (leftEdge.role == "bridge") {
                            // item 21409
                            var n1 = graph.getNode(leftEdge.head)
                            var sib = graph.getNodeDownEx(n1)
                            // item 21408
                            result.push({
                            	text: "MES_ADD_ITEM",
                            	itemId: sib.id,
                            	action: "mih06"
                            })
                        }
                    } else {
                        // item 213060004
                        if (type === "right-up") {
                            // item 21975
                            var upEdge = graph.getEdge(item.up)
                            // item 21978
                            if (upEdge.role == "arm") {
                                // item 21976
                                var sibling = goRightToEnd(graph, item.id)
                                // item 21977
                                result.push({
                                	text: "MES_ADD_ITEM",
                                	itemId: sibling.id,
                                	action: "miv02"
                                })
                            }
                        }
                    }
                }
            }
        } else {
            // item 21333
            if (item.up) {
                // item 21349
                var above = graph.getNodeUpEx(item)
                // item 21354
                if (above.type == "junction") {
                    // item 21353
                    parent = Mind.getHorParent(graph, above.id)
                    // item 21350
                    if (above.left) {
                        // item 21364
                        var aboveSibling = leftWithDown(graph, above)
                        var sibling = graph.getNodeDownEx(aboveSibling)
                        // item 21360
                        if (above.right) {
                            // item 21365
                            result.push({
                            	text: "MES_ADD_LEFT_ITEM",
                            	itemId: sibling.id,
                            	action: "mih06"
                            })
                            // item 21366
                            result.push({
                            	text: "MES_ADD_RIGHT_ITEM",
                            	itemId: item.id,
                            	action: "mih06"
                            })
                        } else {
                            // item 21362
                            result.push({
                            	text: "MES_ADD_LEFT_ITEM",
                            	itemId: sibling.id,
                            	action: "mih06"
                            })
                            // item 21363
                            result.push({
                            	text: "MES_ADD_RIGHT_ITEM",
                            	itemId: parent.id,
                            	action: "mih03"
                            })
                        }
                    } else {
                        // item 21358
                        result.push({
                        	text: "MES_ADD_LEFT_ITEM",
                        	itemId: parent.id,
                        	action: "mih05"
                        })
                        // item 21359
                        result.push({
                        	text: "MES_ADD_RIGHT_ITEM",
                        	itemId: item.id,
                        	action: "mih06"
                        })
                    }
                } else {
                    // item 21357
                    result.push({
                    	text: "MES_ADD_LEFT_ITEM",
                    	itemId: above.id,
                    	action: "mih04"
                    })
                    // item 21356
                    result.push({
                    	text: "MES_ADD_RIGHT_ITEM",
                    	itemId: above.id,
                    	action: "mih02"
                    })
                }
            }
            // item 21438
            if (item.left) {
                // item 21470
                var leftmost = goLeftToEnd(
                	graph,
                	item.id
                )
                // item 21442
                if (leftmost.up) {
                    // item 21474
                    result.push({
                    	text: "MES_ADD_ITEM_ABOVE",
                    	itemId: item.id,
                    	action: "miv03"
                    })
                }
                // item 21471
                if (leftmost.down) {
                    // item 21473
                    var j1 = graph.getNodeDownEx(leftmost)
                    var sibling = goRightToEnd(graph, j1.id)
                    // item 21475
                    result.push({
                    	text: "MES_ADD_ITEM_BELOW",
                    	itemId: sibling.id,
                    	action: "miv03"
                    })
                } else {
                    // item 21476
                    result.push({
                    	text: "MES_ADD_ITEM_BELOW",
                    	itemId: item.id,
                    	action: "miv02"
                    })
                }
            }
            // item 21388
            if (item.down) {
                
            } else {
                // item 21391
                if (((item.up) || (item.role == "header")) && (!(item.left))) {
                    // item 21396
                    result.push({
                    	text: "MES_ADD_CHILD",
                    	itemId: item.id,
                    	action: "mih01"
                    })
                }
                // item 21431
                if (hasVerticalChildren(graph, item)) {
                    
                } else {
                    // item 21414
                    if (item.role == "header") {
                        // item 21417
                        result.push({
                        	text: "MES_ADD_VER_CHILD",
                        	itemId: item.id,
                        	action: "miv04"
                        })
                    } else {
                        // item 21416
                        result.push({
                        	text: "MES_ADD_VER_CHILD",
                        	itemId: item.id,
                        	action: "miv01"
                        })
                    }
                }
            }
        }
    }
    // item 21573
    var mindImages = getMindImages()
    // item 21574
    addImagesToMenu(result, mindImages)
    addTypeToMenu(result)
    // item 21283
    return result
}

function getMindImages() {
    // item 21590
    return {
    	"MES_ADD_LEFT_ITEM": "mind-left.png",
    	"MES_ADD_RIGHT_ITEM": "mind-right.png",
    	"MES_ADD_ITEM_ABOVE": "mind-up.png",
    	"MES_ADD_ITEM_BELOW": "mind-down.png",
    	"MES_ADD_VER_CHILD": "mind-ver2.png",
    	"MES_ADD_CHILD": "mind-hor.png",
    	"MES_PASTE_LEFT_ITEM": "mind-left.png",
    	"MES_PASTE_RIGHT_ITEM": "mind-right.png",
    	"MES_PASTE_ITEM_ABOVE": "mind-up.png",
    	"MES_PASTE_ITEM_BELOW": "mind-down.png",
    	"MES_PASTE_VER_CHILD": "mind-ver2.png",
    	"MES_PASTE_CHILD": "mind-hor.png"
    }
}

function getMindTypes() {
    // item 21854
    var types = []
    // item 21853
    types.push({
    	image: "rectangle.png",
    	text: "BUT_RECTANGLE",
    	type: "action"
    })
    // item 21856
    types.push({
    	image: "rounded.png",
    	text: "BUT_ROUNDED",
    	type: "raction"
    })
    // item 21873
    types.push({
    	image: "collection.png",
    	text: "BUT_COLLECTION",
    	type: "collection"
    })
    // item 21857
    types.push({
    	image: "f_begin.png",
    	text: "BUT_FBEGIN",
    	type: "beginend"
    })
    // item 22590
    types.push({
    	image: "insertion.png",
    	text: "BUT_INSERTION",
    	type: "insertion"
    })
    // item 21855
    return types
}

function getOneSelectedItem(selection) {
    // item 14618
    if ((selection) && (selection.ids)) {
        // item 14610
        var keys = Object.keys(selection.ids);
        // item 14611
        if (keys.length == 1) {
            // item 14617
            var key = keys[0];
            // item 14616
            if (selection.ids[key] == "green") {
                // item 14615
                return key;
            } else {
                // item 14614
                return null;
            }
        } else {
            // item 14614
            return null;
        }
    } else {
        // item 14614
        return null;
    }
}

function getOrCreateUpdate(commands, id) {
    // item 16113
    if (id in commands) {
        // item 16116
        return commands[id];
    } else {
        // item 16117
        var command = new Command(
        	"update",
        	"nodes",
        	id,
        	{ }
        );
        commands[id] = command;
        // item 16118
        return command;
    }
}

function getParameters(editor) {
    // item 9449
    var graph = editor.storage.graph;
    // item 9468
    var node = findNodeByRole(graph, "params");
    // item 9453
    return node;
}

function getRidOfMinMax(value, defaultValue) {
    // item 185890001
    if (value === Number.MAX_VALUE) {
        // item 18597
        return defaultValue
    } else {
        // item 185890002
        if (value === -Number.MAX_VALUE) {
            // item 18598
            return defaultValue
        } else {
            // item 18599
            return value
        }
    }
}

function getRight(node) {
    // item 19429
    return node.x + node.w
}

function getRightNodes(graph, node) {
    // item 14888
    var result = [];
    while (true) {
        // item 14883
        if (node.right) {
            
        } else {
            break;
        }
        // item 14886
        var right = graph.getNodeRightEx(node);
        result.push(right.id);
        // item 14887
        node = right;
    }
    // item 14889
    return result;
}

function getSelectJoints(graph, selectId) {
    // item 8425
    var select = graph.getNode(selectId);
    var id = graph.getNodeDown(select);
    var result = [];
    var node;
    while (true) {
        // item 8430
        node = graph.getNode(id);
        result.push(node);
        // item 8426
        if (node.right) {
            
        } else {
            break;
        }
        // item 8431
        id =graph.getNodeRight(node);
    }
    // item 8429
    return result;
}

function getSelectedIds(editor) {
    // item 16347
    var ids = {};
    var selection = editor.storage.selection;
    // item 16348
    if (selection) {
        // item 16351
        ids = selection.ids;
    }
    // item 16352
    return ids;
}

function getSelectedItem(editor) {
    // item 14415
    var selection = editor.storage.selection;
    return getOneSelectedItem(selection);
}

function getSelection() {
    // item 18001
    var ids = getSelectedIds(self)
    // item 18002
    return Object.keys(ids)
}

function getSoftExpanders() {
    // item 14754
    return {
    	horizontal: softLeft,
    	vertical: softUp
    };
}

function getText(node) {
    // item 15885
    if (node.content) {
        // item 15889
        return node.content.txt;
    } else {
        // item 15888
        return "";
    }
}

function getText2(node) {
    // item 15940
    if (node.content) {
        // item 15944
        return node.content.txt2;
    } else {
        // item 15943
        return "";
    }
}

function getTop(node) {
    // item 19435
    return node.y - node.h
}

function getVerticalWidth(graph, itemId) {
    // item 16053
    var vertical = graph.getVertical(itemId);
    // item 160540001
    var _ind16054 = 0;
    var _col16054 = vertical;
    var _len16054 = _col16054.length;
    while (true) {
        // item 160540002
        if (_ind16054 < _len16054) {
            
        } else {
            // item 16072
            return Config.DEF_ICON_WIDTH;
        }
        // item 160540004
        var id = _col16054[_ind16054];
        // item 16067
        var item = graph.getItem(id);
        // item 16068
        if (Drakon.isWideIcon(item)) {
            // item 16071
            return item.w;
        }
        // item 160540003
        _ind16054++;
    }
}

function getWidthForMindRoot(itemId, action) {
    // item 22010
    if (Mind.mustFitSiblings(action)) {
        // item 22013
        var graph = self.storage.graph
        var node = graph.getNode(itemId)
        // item 22014
        return node.w
    } else {
        // item 22009
        return Config.DEF_ICON_WIDTH
    }
}

function getZoneColor(canvas, zone) {
    // item 3678
    var color;
    var colors = canvas.zoneColors;
    // item 3674
    if (zone in colors) {
        // item 3677
        color = colors[zone];
    } else {
        // item 3672
        var r = Math.floor(Math.random() * 205) + 51;
        var g = Math.floor(Math.random() * 205) + 51;
        var b = Math.floor(Math.random() * 205) + 51;
        // item 3673
        color = "rgb(" + r + ", " + g + ", " + b + ")";
        // item 3680
        colors[zone] = color;
    }
    // item 3679
    return color;
}

function glueHole(holes, id) {
    // item 5865
    var neighbours = holes[id];
    // item 5876
    delete holes[id];
    // item 5867
    var up, down;
    // item 5862
    if (neighbours.up in holes) {
        // item 5866
        var ups = glueHole(holes, neighbours.up);
        // item 5869
        up = ups.up;
    } else {
        // item 5868
        up = neighbours.up;
    }
    // item 5870
    if (neighbours.down in holes) {
        // item 5873
        var downs = glueHole(holes, neighbours.down);
        // item 5875
        down = downs.down;
    } else {
        // item 5874
        down = neighbours.down;
    }
    // item 5877
    return {
    	up: up,
    	down: down,
    	dir: neighbours.dir
    };
}

function glueHoles(plan, holes) {
    // item 5849
    var ids = Object.keys(holes);
    var visited = {};
    // item 58500001
    var _ind5850 = 0;
    var _col5850 = ids;
    var _len5850 = _col5850.length;
    while (true) {
        // item 58500002
        if (_ind5850 < _len5850) {
            
        } else {
            break;
        }
        // item 58500004
        var id = _col5850[_ind5850];
        // item 5878
        if (id in holes) {
            // item 5852
            var holeInfo = glueHole(
            	holes,
            	id
            );
            // item 5881
            visited[id] = holeInfo;
        }
        // item 58500003
        _ind5850++;
    }
    // item 78920001
    var _ind7892 = 0;
    var _col7892 = visited;
    var _keys7892 = Object.keys(_col7892); 
    var _len7892 = _keys7892.length;
    while (true) {
        // item 78920002
        if (_ind7892 < _len7892) {
            
        } else {
            break;
        }
        // item 78920004
        var id = _keys7892[_ind7892]; var info = _col7892[id];
        // item 5882
        plan.newEdges[id] = info;
        // item 78920003
        _ind7892++;
    }
}

function goDownToEnd(graph, id) {
    // item 9750
    var node = graph.getNode(id);
    while (true) {
        // item 9747
        if (node.down) {
            
        } else {
            break;
        }
        // item 9748
        id = graph.getNodeDown(node);
        node = graph.getNode(id);
    }
    // item 9751
    return node;
}

function goLeftToEnd(graph, id) {
    // item 6151
    var node = graph.getNode(id);
    while (true) {
        // item 6148
        if (node.left) {
            
        } else {
            break;
        }
        // item 6149
        id = graph.getNodeLeft(node);
        node = graph.getNode(id);
    }
    // item 6152
    return node;
}

function goRightToEnd(graph, id) {
    // item 10697
    var node = graph.getNode(id);
    while (true) {
        // item 10694
        if (node.right) {
            
        } else {
            break;
        }
        // item 10695
        id =graph.getNodeRight(node);
        node = graph.getNode(id);
    }
    // item 10698
    return node;
}

function goUpToEnd(graph, id) {
    // item 6157
    var node = graph.getNode(id);
    while (true) {
        // item 6154
        if (node.up) {
            
        } else {
            break;
        }
        // item 6155
        id = graph.getNodeUp(node);
        node = graph.getNode(id);
    }
    // item 6158
    return node;
}

function goodForPeriod(node) {
    var _sw149860000_ = 0;
    // item 149860000
    _sw149860000_ = node.type;
    // item 149860001
    if ((((((((((_sw149860000_ === "action") || (_sw149860000_ === "select")) || (_sw149860000_ === "question")) || (_sw149860000_ === "shelf")) || (_sw149860000_ === "input")) || (_sw149860000_ === "output")) || (_sw149860000_ === "sinput")) || (_sw149860000_ === "soutput")) || (_sw149860000_ === "insertion")) && (!(node.left))) {
        // item 14994
        return true;
    } else {
        // item 14996
        return false;
    }
}

function grabBack(graph, edgeId) {
    // item 4867
    var edge = graph.getEdge(edgeId);
    var node = graph.getNode(edge.head);
    // item 4868
    return {
    	edge: edge,
    	node: node
    };
}

function grabForward(graph, edgeId) {
    // item 4860
    var edge = graph.getEdge(edgeId);
    var node = graph.getNode(edge.tail);
    // item 4861
    return {
    	edge: edge,
    	node: node
    };
}

function hardDown(pgraph, skewer) {
    // item 15066
    var graph = pgraph.graph;
    // item 14897
    if (skewer) {
        // item 14798
        var result = new Utils.Set();
        // item 148980001
        var _ind14898 = 0;
        var _col14898 = skewer.list;
        var _len14898 = _col14898.length;
        while (true) {
            // item 148980002
            if (_ind14898 < _len14898) {
                
            } else {
                break;
            }
            // item 148980004
            var itemId = _col14898[_ind14898];
            // item 14902
            result.add(itemId);
            // item 14900
            var item = graph.getItem(itemId);
            // item 14803
            if (isCross(item)) {
                // item 14811
                var head = graph.getNodeUpEx(item);
                result.add(head.id);
                // item 14903
                if (head.right) {
                    // item 14906
                    var par = graph.getNodeRightEx(head);
                    result.add(head.right);
                    result.add(par.id);
                }
            }
            // item 148980003
            _ind14898++;
        }
        // item 14802
        return result;
    } else {
        // item 14806
        return null;
    }
}

function hardDownMind(pgraph, skewer) {
    // item 21015
    var graph = pgraph.graph;
    // item 21014
    if (skewer) {
        // item 21010
        var result = new Utils.Set();
        var sub = false
        // item 21070
        pullDownSkewerItem(graph, skewer.list, result)
        // item 21040
        addAllSubs(graph, skewer, result)
        // item 21011
        return result;
    } else {
        // item 21013
        return null;
    }
}

function hardLeft(pgraph, skewer) {
    // item 14935
    if (skewer) {
        // item 14939
        var result = new Utils.Set();
        // item 14946
        hardLeftCore(pgraph, skewer.list, result);
        // item 14940
        return result;
    } else {
        // item 14938
        return null;
    }
}

function hardLeftCore(pgraph, ids, result) {
    // item 15064
    var graph = pgraph.graph;
    // item 149470001
    var _ind14947 = 0;
    var _col14947 = ids;
    var _len14947 = _col14947.length;
    while (true) {
        // item 149470002
        if (_ind14947 < _len14947) {
            
        } else {
            break;
        }
        // item 149470004
        var itemId = _col14947[_ind14947];
        // item 14953
        result.add(itemId);
        // item 14949
        var item = graph.getItem(itemId);
        // item 14950
        if (((((item.isLine) || (!(item.right))) || (!(item.down))) || (item.left)) || (!((item.up) || (item.type == "beginend")))) {
            
        } else {
            // item 14965
            var right = getRightNodes(graph, item);
            // item 149670001
            var _ind14967 = 0;
            var _col14967 = right;
            var _len14967 = _col14967.length;
            while (true) {
                // item 149670002
                if (_ind14967 < _len14967) {
                    
                } else {
                    break;
                }
                // item 149670004
                var rightId = _col14967[_ind14967];
                // item 14959
                if (rightId in result.map) {
                    
                } else {
                    // item 14961
                    var vertical = pgraph.getTeam(
                    	rightId,
                    	"horizontal"
                    );
                    // item 14958
                    hardLeftCore(
                    	pgraph,
                    	vertical.list,
                    	result
                    );
                }
                // item 149670003
                _ind14967++;
            }
        }
        // item 149470003
        _ind14947++;
    }
}

function hardLeftMind(pgraph, skewer) {
    // item 20910
    return skewer;
}

function hardRight(pgraph, skewer) {
    // item 15065
    var graph = pgraph.graph;
    // item 14929
    if (skewer) {
        // item 14920
        var result = new Utils.Set();
        // item 149300001
        var _ind14930 = 0;
        var _col14930 = skewer.list;
        var _len14930 = _col14930.length;
        while (true) {
            // item 149300002
            if (_ind14930 < _len14930) {
                
            } else {
                break;
            }
            // item 149300004
            var itemId = _col14930[_ind14930];
            // item 14934
            result.add(itemId);
            // item 14932
            var item = graph.getItem(itemId);
            // item 14924
            if (isCross(item)) {
                // item 14928
                var leftUp = graph.getNodeLeftEx(item);
                var leftDown = graph.getNodeDownEx(leftUp);
                result.add(leftUp.id);
                result.add(leftDown.id);
                result.add(leftUp.down);
            }
            // item 149300003
            _ind14930++;
        }
        // item 14923
        return result;
    } else {
        // item 14927
        return null;
    }
}

function hardRightMind(pgraph, skewer) {
    // item 20911
    return skewer;
}

function hardUp(pgraph, skewer) {
    // item 14912
    return skewer;
}

function hardUpMind(pgraph, skewer) {
    // item 20926
    var graph = pgraph.graph;
    // item 20920
    if (skewer) {
        // item 20912
        var result = new Utils.Set();
        var sub = false
        // item 209460001
        var _ind20946 = 0;
        var _col20946 = skewer.list;
        var _len20946 = _col20946.length;
        while (true) {
            // item 209460002
            if (_ind20946 < _len20946) {
                
            } else {
                break;
            }
            // item 209460004
            var itemId = _col20946[_ind20946];
            // item 20950
            result.add(itemId);
            // item 20948
            var item = graph.getItem(itemId);
            // item 20951
            if ((item.type == "junction") && (item.down)) {
                // item 20945
                var below = graph.getNodeDownEx(item)
                // item 20955
                if (below.role == "sub") {
                    // item 20954
                    result.add(below.id)
                }
            }
            // item 209460003
            _ind20946++;
        }
        // item 20986
        addAllSubs(graph, skewer, result)
        // item 20915
        return result;
    } else {
        // item 20918
        return null;
    }
}

function hasDoubleEntry(graph, split, edgeId) {
    // item 6217
    var edge = graph.getEdge(edgeId);
    var target = graph.getTail(edge);
    var node = split;
    while (true) {
        // item 6234
        if (hasLeft(graph, node)) {
            // item 21183
            node = leftToEndNoDuration(graph, node.id)
        } else {
            // item 6218
            if (node.id == target.id) {
                // item 6221
                return false;
            }
            // item 6223
            if (node.x < target.x) {
                // item 6222
                return true;
            }
            // item 6231
            var id = graph.getNodeUp(node);
            // item 6232
            node = graph.getNode(id);
        }
    }
}

function hasDrakon() {
    // item 16648
    var graph = self.storage.graph;
    // item 16647
    var count = Utils.count(graph.items)
    // item 16649
    return count > 0
}

function hasItemsBelow(graph, edge) {
    // item 3448
    var tail = graph.getTail(edge);
    // item 3449
    if (tail.type === "junction") {
        // item 3513
        var desc = describeJunction(tail);
        // item 3514
        if (desc === "right-t") {
            // item 3518
            return true;
        } else {
            // item 5026
            if (desc === "left-t") {
                // item 5020
                var leftEdge = graph.getEdge(tail.left);
                var leftNode = graph.getHead(leftEdge);
                // item 5021
                if (leftNode.type === "junction") {
                    // item 5027
                    return true;
                } else {
                    // item 3517
                    return false;
                }
            } else {
                // item 3517
                return false;
            }
        }
    } else {
        // item 3452
        return true;
    }
}

function hasLeft(graph, node) {
    // item 15194
    if ((node.left) && (!(Drakon.getDuration(graph, node)))) {
        // item 15198
        return true;
    } else {
        // item 15197
        return false;
    }
}

function hasNodesOnRight(graph, nodeId, plan) {
    // item 7899
    var id = nodeId;
    var node;
    while (true) {
        // item 7903
        node = graph.getNode(id);
        // item 7900
        if (id in plan.nodes) {
            
        } else {
            // item 7904
            return true;
        }
        // item 7905
        if (node.right) {
            
        } else {
            // item 7908
            return false;
        }
        // item 7910
        id =graph.getNodeRight(node);
    }
}

function hasPipe(graph, left, top, right, bottom) {
    // item 42460001
    var x = left;
    while (true) {
        // item 42460002
        if (x < right) {
            
        } else {
            // item 4278
            return false;
        }
        // item 4248
        var box = new Utils.Box(
        	x,
        	top,
        	x + Config.METRE + 1,
        	bottom
        );
        // item 4274
        if (hitsAnyone(graph, box)) {
            
        } else {
            // item 4277
            return true;
        }
        // item 42460003
        x += Config.SNAP;
    }
}

function hasUpTs(graph, edge) {
    // item 22308
    var head = graph.getNode(edge.head)
    var tail = graph.getNode(edge.tail)
    // item 22307
    if ((isUpT(head)) || (isUpT(tail))) {
        // item 22314
        return true
    } else {
        // item 22315
        return false
    }
}

function hasUpperText(item) {
    var _sw159810000_ = 0;
    // item 159810000
    _sw159810000_ = item.type;
    // item 159810001
    if ((((_sw159810000_ === "shelf") || (_sw159810000_ === "input")) || (_sw159810000_ === "output")) || (_sw159810000_ === "process")) {
        // item 15990
        return true;
    } else {
        // item 15991
        return false;
    }
}

function hasValue(data) {
    // item 17850
    if ((typeof data == "number") || (data)) {
        // item 17853
        return true
    } else {
        // item 17858
        return false
    }
}

function hasVerticalChildren(graph, node) {
    // item 21448
    if (node.left) {
        // item 21452
        var leftEdge = graph.getEdge(node.left)
        // item 21453
        if ((leftEdge.role == "link") || (node.role == "header")) {
            // item 21451
            return true
        } else {
            // item 21454
            return false
        }
    } else {
        // item 21454
        return false
    }
}

function headerSize(size) {
    // item 17915
    return Config.HEADER_SIZE
}

function hit(pos) {
    // item 12292
    var socket = self.findSocket(pos.x, pos.y);
    // item 12293
    if (socket) {
        // item 12296
        return true;
    } else {
        // item 12291
        var item = self.findVisualItem(pos.x, pos.y);
        // item 12297
        if (item) {
            // item 12296
            return true;
        } else {
            // item 12300
            return false;
        }
    }
}

function hitFreeItem(item, x, y) {
    // item 18764
    var callback = Items.getItemCallback(item.type)
    // item 18765
    if (callback.hit) {
        // item 18768
        return callback.hit(item, x, y)
    } else {
        // item 18724
        var box = Utils.boxFromPoint(
        	item.x,
        	item.y,
        	item.w,
        	item.h
        )
        // item 18726
        return Utils.hitBox(box, x, y)
    }
}

function hitsAnyone(graph, box) {
    // item 42540001
    var _ind4254 = 0;
    var _col4254 = graph.items;
    var _keys4254 = Object.keys(_col4254); 
    var _len4254 = _keys4254.length;
    while (true) {
        // item 42540002
        if (_ind4254 < _len4254) {
            
        } else {
            // item 4272
            return null;
        }
        // item 42540004
        var iid = _keys4254[_ind4254]; var item = _col4254[iid];
        // item 4269
        if (Utils.boxesIntersect(box, item.box)) {
            // item 4273
            return item.id;
        }
        // item 42540003
        _ind4254++;
    }
}

function ignoreCommand() {
    // item 22555
    if ((self.readonly) || (self.dragOn)) {
        // item 22551
        return true
    } else {
        // item 22557
        return false
    }
}

function insertAndEdit(editor, edgeId, type) {
    // item 14544
    if (canAddMore(editor, 2)) {
        // item 2723
        var id = insertItem(editor, edgeId, type, "");
        // item 15358
        if (id) {
            // item 16357
            selectItem(editor, id);
            // item 16444
            editor.redraw();
            // item 2724
            //startEditText(id);
        }
    }
}

function insertBranch(editor, nodeId, cont, addEnd) {
    // item 18954
    addTrace(
    	"insert branch",
    	[nodeId, Utils.copyObject(cont)]
    );
    // item 10601
    var pgraph = createPhysicalGraph(
    	editor.storage.graph,
    	editor.render
    );
    var graph = pgraph.graph;
    var sGraph = editor.storage.graph;
    // item 10619
    var movedNodes = {};
    var commands = {};
    // item 10647
    var branch = graph.getNode(nodeId);
    var above = graph.getNodeUpEx(branch);
    var myRightAddress, lastAbove, lastBelow
    var rightCont
    // item 19700
    if (above.right) {
        // item 19699
        var rightAbove = graph.getNodeRightEx(above);
        var right = graph.getNodeDownEx(rightAbove);
        var rightBottom = goDownToEnd(graph, right.id);
        var rightType = sGraph.getNode(rightBottom.id).type;
        // item 19704
        rightCont = getContent(sGraph.getNode(right.id))
        lastAbove = false
        // item 19703
        if (rightBottom.type == "end") {
            // item 19707
            lastBelow = true
            // item 19698
            var bottom = goDownToEnd(graph, nodeId);
            myRightAddress = goRightToEnd(graph, bottom.id);
        } else {
            // item 19706
            lastBelow = false
            // item 19697
            myRightAddress = graph.getNodeLeftEx(rightBottom);
        }
    } else {
        // item 19705
        rightCont = Utils.copyObject(cont)
        lastAbove = true
        // item 19707
        lastBelow = true
        // item 19698
        var bottom = goDownToEnd(graph, nodeId);
        myRightAddress = goRightToEnd(graph, bottom.id);
    }
    // item 23109
    rightCont = makeCont(rightCont.txt)
    // item 19709
    var en = makeDummyItem(
    	1,
    	render,
    	"end",
    	makeCont(getEnd())
    );
    // item 16384
    var bra = makeDummyItem(
    	1,
    	editor.render,
    	"branch",
    	cont
    );
    // item 16385
    var add = makeDummyItem(
    	1,
    	editor.render,
    	"address",
    	rightCont
    );
    // item 10677
    var width = bra.w;
    // item 10733
    var oldAdd = graph.getNodeUpEx(
    	myRightAddress
    );
    // item 10712
    var dims = findLedgeDimensions(
    	graph,
    	nodeId,
    	oldAdd.id
    );
    // item 10714
    var oldBottom = myRightAddress.box.top - Config.METRE;
    // item 10715
    if (oldBottom < dims.y) {
        // item 10719
        var yDelta = dims.y - oldBottom;
        var bottom = myRightAddress.y + yDelta;
        // item 10713
        dropDownCore(
        	pgraph,
        	myRightAddress,
        	bottom,
        	oldAdd.box.right + Config.METRE,
        	movedNodes
        );
    }
    // item 10720
    dims = findLedgeDimensions(
    	graph,
    	nodeId,
    	oldAdd.id
    );
    // item 19683
    var dimX = Math.max(dims.x, oldAdd.box.right + Config.METRE)
    // item 19679
    if (lastAbove) {
        
    } else {
        // item 20350
        var branchLeft = findBranchLeft(graph, right)
        // item 10721
        var minRight = branchLeft - Config.METRE 
         - width * 2
        // item 10722
        if (dimX > minRight) {
            // item 10725
            var delta = dimX - minRight;
            // item 10679
            pgraph.moveRight(
            	right.id,
            	delta,
            	movedNodes
            );
        }
    }
    // item 10678
    var braY = above.y + Config.METRE + bra.h;
    var addY = myRightAddress.y - Config.METRE - add.h;
    var x = dimX + width;
    // item 10729
    var id = generateId(editor.storage);
    // item 10732
    var topJunId = generateId(editor.storage);
    var botJunId = generateId(editor.storage);
    var addId = generateId(editor.storage);
    // item 10731
    buildMoveCommands(
    	pgraph,
    	movedNodes,
    	commands
    );
    // item 10730
    var commandList = Utils.objectValues(commands);
    // item 19684
    if (lastAbove) {
        
    } else {
        // item 10628
        pushDeleteEdge(
        	commandList,
        	above.right
        );
    }
    // item 10700
    if (lastBelow) {
        
    } else {
        // item 10680
        pushDeleteEdge(
        	commandList,
        	myRightAddress.right
        );
    }
    // item 10637
    pushInsertJunction(
    	commandList,
    	topJunId,
    	x, above.y
    );
    // item 10610
    pushInsertNodeAt(
    	render,
    	commandList,
    	id,
    	"branch",
    	x, braY,
    	width, bra.h,
    	cont
    );
    // item 10639
    connectVer(
    	editor,
    	commandList,
    	topJunId, id,
    	null
    );
    // item 10641
    connectHor(
    	editor,
    	commandList,
    	above.id, topJunId,
    	null
    );
    // item 19713
    if (addEnd) {
        // item 19723
        var enY = braY + bra.h * 2 + en.h
        // item 19722
        pushInsertNodeAt(
        	render,
        	commandList,
        	addId,
        	"end",
        	x, enY,
        	en.w, en.h,
        	makeCont(getEnd())
        );
        // item 19724
        connectVer(
        	editor,
        	commandList,
        	id, addId,
        	"down"
        );
    } else {
        // item 10682
        pushInsertNodeAt(
        	render,
        	commandList,
        	addId,
        	"address",
        	x, addY,
        	width, add.h,
        	rightCont
        );
        // item 10683
        pushInsertJunction(
        	commandList,
        	botJunId,
        	x, myRightAddress.y
        );
        // item 10703
        connectVer(
        	editor,
        	commandList,
        	id, addId,
        	"down"
        );
        // item 10704
        connectVer(
        	editor,
        	commandList,
        	addId, botJunId,
        	null
        );
        // item 10705
        connectHor(
        	editor,
        	commandList,
        	myRightAddress.id, botJunId,
        	"sil_floor"
        );
        // item 19688
        if (lastAbove) {
            
        } else {
            // item 10706
            connectHor(
            	editor,
            	commandList,
            	topJunId, rightAbove.id,
            	null
            );
        }
        // item 19691
        if (lastBelow) {
            
        } else {
            // item 10711
            connectHor(
            	editor,
            	commandList,
            	botJunId, rightBottom.id,
            	"sil_floor"
            );
        }
    }
    // item 10607
    applyCommands(
    	editor,
    	commandList,
    	id
    );
    // item 10608
    return id;
}

function insertCanvasItem(canvas, itemData, skewers) {
    // item 11234
    var render = canvas.render
    var graph = canvas.graph
    var free = canvas.free
    // item 876
    var item = copyStorageItem(itemData)
    // item 22976
    if ((item.type == "vertical") && (item.id in skewers)) {
        // item 22980
        item.isSkewer = true
    }
    // item 16660
    if (item.free) {
        // item 16663
        free.add(item.id, item)
    } else {
        // item 875
        graph.addItem(item)
        // item 2146
        canvas.pgraph.insertPhysicalItem(
        	item
        )
    }
    // item 1923
    Items.renderItem(graph, render, item, {})
}

function insertCanvasSocket(canvas, socketInfo) {
    // item 3173
    var socket = makeAndDrawSocket(
    	canvas.render,
    	canvas.graph,
    	socketInfo.id,
    	socketInfo.type,
    	socketInfo.action
    );
    socket.name = socketInfo.name;
    // item 3174
    canvas.sockets[socket.prim] = socket;
}

function insertCase(editor, nodeId, cont) {
    // item 18955
    addTrace(
    	"insert case",
    	[nodeId, Utils.copyObject(cont)]
    );
    // item 8584
    var id = generateId(editor.storage);
    // item 8521
    var pgraph = createPhysicalGraph(
    	editor.storage.graph,
    	editor.render
    );
    var graph = pgraph.graph;
    // item 8580
    var movedNodes = {};
    var commands = {};
    // item 16358
    var cas = makeDummyItem(
    	id,
    	editor.render,
    	"case",
    	cont
    );
    // item 8571
    var old = graph.getNode(nodeId);
    var oldJunId = graph.getNodeUp(old);
    var oldJun = graph.getNode(oldJunId);
    var bottom = oldJun.y + (cas.h + Config.METRE) * 2;
    var right = old.box.right + cas.w + Config.METRE;
    var delta = right - old.x + cas.w;
    var belowId = graph.getNodeDown(old);
    // item 19086
    bottom = Math.max(
    	bottom,
    	old.y + old.h + Config.METRE
    )
    // item 8572
    var box;
    var neighbour;
    // item 8575
    if (oldJun.right) {
        // item 8579
        box = new Utils.Box(
        	old.x,
        	old.box.top,
        	old.x,
        	bottom
        );
        // item 8595
        neighbour =graph.getNodeRight(oldJun);
    } else {
        // item 8578
        box = new Utils.Box(
        	old.x,
        	oldJun.y,
        	old.x,
        	bottom
        );
        // item 8596
        neighbour = null;
    }
    // item 8583
    var directionProps = "horizontal";
    // item 13085
    var myY = oldJun.y + Config.METRE + cas.h;
    // item 8581
    extendEdge(
    	pgraph,
    	old.down,
    	Config.METRE + cas.h,
    	movedNodes
    );
    // item 8573
    pgraph.pushObjects(
        box,
        {},
        delta,
        directionProps,
        movedNodes
    );
    // item 8586
    buildMoveCommands(
    	pgraph,
    	movedNodes,
    	commands
    );
    // item 8585
    var commandList = Utils.objectValues(commands);
    // item 8590
    pushDeleteEdge(
    	commandList,
    	old.down
    );
    // item 8591
    if (oldJun.right) {
        // item 8594
        pushDeleteEdge(
        	commandList,
        	oldJun.right
        );
    }
    // item 16360
    cas.x = right;
    cas.y = myY;
    // item 16359
    pushInsertNode(
    	commandList,
    	id,
    	cas
    );
    // item 8597
    var leftJun = insertJunctionBetween(
    	editor,
    	graph,
    	old.id,
    	belowId,
    	bottom,
    	commandList
    );
    // item 8598
    var corner = generateId(editor.storage);
    var upId = generateId(editor.storage);
    // item 8599
    pushInsertJunction(
    	commandList,
    	corner,
    	right,
    	bottom, null
    );
    // item 8602
    pushInsertJunction(
    	commandList,
    	upId,
    	right,
    	oldJun.y, oldJun.group
    );
    // item 8601
    connectVer(
    	editor,
    	commandList,
    	id,
    	corner,
    	"down",
    	null
    );
    // item 8600
    connectHor(
    	editor,
    	commandList,
    	leftJun,
    	corner,
    	"left",
    	null
    );
    // item 8603
    connectHor(
    	editor,
    	commandList,
    	oldJunId,
    	upId,
    	null,
    	null
    );
    // item 8604
    connectVer(
    	editor,
    	commandList,
    	upId,
    	id,
    	null,
    	null
    );
    // item 8605
    if (oldJun.right) {
        // item 8608
        connectHor(
        	editor,
        	commandList,
        	upId,
        	neighbour,
        	null,
        	null
        );
    }
    // item 8536
    applyCommands(
    	editor,
    	commandList,
    	id
    )
    // item 8537
    return id;
}

function insertDuration(editor, itemId, cont) {
    // item 18956
    addTrace(
    	"insert duration",
    	[itemId, Utils.copyObject(cont)]
    );
    // item 15031
    var graph = editor.storage.graph;
    var render = editor.render;
    // item 15032
    var pgraph = createPhysicalGraph(graph, render);
    // item 15027
    var item = makeDummyItem(1, render, "duration", cont);
    // item 15035
    var root = graph.getNode(itemId);
    // item 15029
    var dx = root.w + item.w + Config.METRE;
    var x = root.x - dx;
    var left = x - item.w;
    // item 15030
    var commands = {};
    var movedNodes = {};
    // item 15057
    var leftBox = new Utils.Box(
    	root.x,
    	root.y,
    	root.x,
    	root.y
    );
    var leftDelta = -dx - item.w;
    // item 15056
    pgraph.pushObjects(
        leftBox,
        {},
        leftDelta,
        "horizontal",
        movedNodes
    );
    // item 15061
    var upDownBox = new Utils.Box(
    	x - item.w,
    	root.y,
    	x + item.w,
    	root.y
    );
    // item 15062
    pgraph.pushObjects(
        upDownBox,
        {},
        item.h,
        "vertical",
        movedNodes
    );
    // item 15063
    pgraph.pushObjects(
        upDownBox,
        {},
        -item.h,
        "vertical",
        movedNodes
    );
    // item 15033
    buildMoveCommands(
    	pgraph,
    	movedNodes,
    	commands
    );
    // item 15034
    var commList = Utils.objectValues(commands);
    // item 15036
    var id = generateId(editor.storage);
    // item 16362
    item.x = x;
    item.y = root.y;
    // item 16361
    pushInsertNode(
    	commList,
    	id,
    	item
    );
    // item 15037
    connectHor(
    	editor,
    	commList,
    	id,
    	itemId,
    	"lstick",
    	null
    );
    // item 15040
    applyCommands(
    	editor,
    	commList,
    	id
    );
    // item 15039
    return id;
}

function insertForeach(editor, edgeId, cont) {
    // item 12859
    var subgraph = buildMacroLoop(
    	editor.render,
    	cont,
    	makeCont("")
    );
    // item 12860
    var id = insertSubgraph(editor, edgeId, subgraph, "insert 'for each'");
    // item 12862
    return id;
}

function insertFreeItem(x, y, type, subtype) {
    // item 22568
    if (ignoreCommand()) {
        
    } else {
        // item 17399
        var x = Utils.snapPos(x)
        var y = Utils.snapPos(y)
        // item 16763
        var actionName = "Insert free item: \""
         + type + "\""
        // item 16761
        addTrace(
        	actionName,
        	[{x:x, y:y, type:type}]
        );
        // item 16762
        var editor = self
        var free = editor.storage.free
        var length = free.list.length
        var render  = editor.render
        // item 16757
        var id = generateId(editor.storage)
        var commList = []
        // item 17348
        var content = makeCont("")
        // item 18876
        var builder = gFreeBuilders[type]
        // item 18877
        if (builder) {
            // item 18881
            builder(
            	render,
            	content,
            	id,
            	x,
            	y,
            	commList,
            	subtype
            )
        } else {
            // item 18880
            defaultBuilder(
            	render,
            	content,
            	id,
            	type,
            	x,
            	y,
            	commList
            );
        }
        // item 16788
        if (length == 0) {
            
        } else {
            // item 16791
            var prevId = free.list[length - 1]
            // item 16792
            pushUpdate(
            	commList,
            	"free",
            	prevId,
            	{ next: id }
            )
        }
        // item 16760
        applyCommands(
        	editor,
        	commList,
        	id
        );
    }
}

function insertInSocket(editor, prim) {
    // item 11722
    var socket = prepareSocketOp(editor, prim);
    // item 11723
    var graph = editor.storage.graph;
    // item 11724
    var target = graph.getItem(socket.id);
    // item 15300
    if (downRole(target)) {
        // item 11728
        insertAndEdit(editor, socket.id, socket.action);
    } else {
        // item 15048
        if (target.isLine) {
            // item 11826
            if (target.isVertical) {
                // item 11832
                var below = graph.getNode(target.tail);
                // item 11834
                insertAndEdit(editor, below.id, socket.action);
            } else {
                // item 11829
                var branch = getBranchForEdge(graph, target);
                // item 11830
                if (branch) {
                    // item 11831
                    insertAndEdit(editor, branch.id, socket.action);
                } else {
                    // item 15513
                    insertAndEdit(editor, socket.id, socket.action);
                }
            }
        } else {
            // item 15049
            insertAndEdit(editor, socket.id, socket.action);
        }
    }
}

function insertItem(editor, edgeId, type, text) {
    // item 15919
    var cont = makeCont(text);
    // item 28200001
    if (type === "question") {
        // item 2871
        return insertQuestion(
        	editor,
        	edgeId,
        	cont
        );
    } else {
        // item 28200002
        if (type === "select") {
            // item 8165
            return insertSelect(
            	editor,
            	edgeId,
            	cont
            );
        } else {
            // item 28200003
            if (type === "case") {
                // item 8505
                return insertCase(
                	editor,
                	edgeId,
                	cont
                );
            } else {
                // item 28200004
                if (type === "branch") {
                    // item 10585
                    return insertBranch(
                    	editor,
                    	edgeId,
                    	cont,
                    	false
                    );
                } else {
                    // item 28200005
                    if (type === "end_branch") {
                        // item 19726
                        return insertBranch(
                        	editor,
                        	edgeId,
                        	cont,
                        	true
                        );
                    } else {
                        // item 28200006
                        if (type === "foreach") {
                            // item 9072
                            return insertForeach(
                            	editor,
                            	edgeId,
                            	cont
                            );
                        } else {
                            // item 28200007
                            if (type === "params") {
                                // item 9471
                                return insertParams(
                                	editor
                                );
                            } else {
                                // item 28200008
                                if (type === "duration") {
                                    // item 15005
                                    return insertDuration(
                                    	editor,
                                    	edgeId,
                                    	cont
                                    );
                                } else {
                                    // item 28200009
                                    if (type === "parallel") {
                                        // item 15332
                                        return insertParallel(
                                        	editor,
                                        	edgeId
                                        );
                                    } else {
                                        // item 28200010
                                        if (type === "path") {
                                            // item 15448
                                            return insertPath(
                                            	editor,
                                            	edgeId
                                            );
                                        } else {
                                            // item 2828
                                            return insertSimpleItem(
                                            	editor,
                                            	edgeId,
                                            	type,
                                            	cont
                                            );
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}

function insertJunctionBetween(editor, graph, up, down, y, commandList) {
    // item 4375
    var upNode = graph.getNode(up);
    var x = upNode.x;
    // item 4376
    var upEdge = generateId(editor.storage);
    var downEdge = generateId(editor.storage);
    var id = generateId(editor.storage);
    // item 4377
    pushInsertJunction(
    	commandList,
    	id,
    	x,
    	y
    );
    // item 4378
    pushInsertDown(
    	commandList,
    	upEdge,
    	up,
    	id
    );
    // item 4381
    if (down) {
        // item 15310
        var role = "down";
        var downNode = graph.getNode(down);
        // item 15311
        if (downNode.up) {
            // item 15314
            var edge = graph.getEdge(downNode.up);
            role = edge.role;
        }
        // item 4379
        pushInsertVertical(
        	commandList,
        	downEdge,
        	id,
        	down,
        	role
        );
    }
    // item 4380
    return id;
}

function insertParallel(editor, edgeId) {
    // item 15326
    var subgraph = buildMacroParallel(
    	editor.render
    );
    // item 15327
    insertSubgraph(editor, edgeId, subgraph, "insert 'parallel'");
    // item 15329
    return null;
}

function insertParams(editor) {
    // item 18957
    addTrace(
    	"insert parameters",
    	[]
    );
    // item 9498
    var graph = editor.storage.graph;
    var render = editor.render;
    var movedNodes = {};
    var commands = {};
    // item 9513
    var pgraph = createPhysicalGraph(graph, render);
    // item 9510
    var ibox = makeIconBoxForType(
    	render,
    	"action",
    	null,
    	Config.DEF_ICON_WIDTH_S
    );
    // item 9511
    var headerS = findNodeByRole(graph, "header");
    var header = pgraph.graph.getNode(headerS.id);
    // item 9514
    var directionProps = "horizontal";
    var fakeSkewer = {};
    fakeSkewer[header.id] = true;
    // item 9515
    var w = headerS.w;
    var delta = ibox.size.w + Config.METRE * 2 + w;
    // item 9512
    pgraph.pushObjects(
        header.box,
        fakeSkewer,
        delta,
        directionProps,
        movedNodes
    );
    // item 9517
    buildMoveCommands(
    	pgraph,
    	movedNodes,
    	commands
    );
    // item 9516
    var commList = Utils.objectValues(commands);
    // item 9491
    var id = generateId(editor.storage);
    // item 9556
    commList.push(new Command(
    	"insert",
    	"nodes",
    	id,
    	{
    		type: "action",
    		x: header.x + delta,
    		y: header.y,
    		w: ibox.size.w,
    		h: ibox.size.h,
    		content: null,
    		role: "params"
    	}
    ));
    // item 9519
    connectHor(
    	editor,
    	commList,
    	header.id,
    	id,
    	null,
    	null
    );
    // item 9509
    applyCommands(
    	editor,
    	commList,
    	id
    )
    // item 9499
    return id;
}

function insertPath(editor, itemId) {
    // item 15574
    if (canAddMore(editor, 5)) {
        // item 15457
        var graph = editor.storage.graph;
        var item = graph.getItem(itemId);
        // item 15458
        if (item.isLine) {
            // item 15462
            insertPathInside(editor, itemId);
        } else {
            // item 15461
            insertPathOutside(editor, itemId);
        }
    }
    // item 15456
    return null;
}

function insertPathInside(editor, edgeId) {
    // item 18958
    addTrace(
    	"add inside path",
    	[edgeId]
    );
    // item 15498
    var pgraph = createPhysicalGraph(
    	editor.storage.graph,
    	editor.render
    );
    // item 15501
    var movedNodes = {};
    var commands = {};
    // item 15502
    var graph = pgraph.graph;
    var edge = graph.getEdge(edgeId);
    var left = graph.getNode(edge.head);
    var right = graph.getNode(edge.tail);
    var rightDown = goDownToEnd(graph, right.id);
    var bottom = rightDown.y;
    // item 15503
    if (right.x - left.x < Config.METRE * 3) {
        // item 15506
        pgraph.moveRight(
        	right.id,
        	Config.METRE * 4,
        	movedNodes
        );
    }
    // item 15514
    var x = right.x - Config.METRE;
    // item 15507
    drill(
    	pgraph,
    	x,
    	right.y,
    	bottom,
    	movedNodes
    );
    // item 15509
    buildMoveCommands(
    	pgraph,
    	movedNodes,
    	commands
    );
    // item 15508
    var commandList = Utils.objectValues(commands);
    // item 15516
    var leftDownId = graph.getNodeLeft(rightDown);
    // item 15515
    pushDeleteEdge(
    	commandList,
    	edgeId
    );
    // item 15517
    pushDeleteEdge(
    	commandList,
    	rightDown.left
    );
    // item 15518
    var upId = generateId(editor.storage);
    var downId = generateId(editor.storage);
    // item 15519
    pushInsertJunction(
    	commandList,
    	upId,
    	x,
    	right.y
    );
    // item 15520
    pushInsertJunction(
    	commandList,
    	downId,
    	x,
    	rightDown.y
    );
    // item 15521
    connectHor(
    	editor,
    	commandList,
    	left.id, upId,
    	"parallel", null
    );
    // item 15522
    connectHor(
    	editor,
    	commandList,
    	upId, right.id,
    	"parallel", null
    );
    // item 15523
    connectHor(
    	editor,
    	commandList,
    	leftDownId, downId,
    	null, null
    );
    // item 15524
    connectHor(
    	editor,
    	commandList,
    	downId, rightDown.id,
    	null, null
    );
    // item 15525
    connectVer(
    	editor,
    	commandList,
    	upId, downId,
    	"par-down", null
    );
    // item 15499
    applyCommands(
    	editor,
    	commandList,
    	null
    );
}

function insertPathOutside(editor, nodeId) {
    // item 18959
    addTrace(
    	"add outside path",
    	[nodeId]
    );
    // item 15547
    var pgraph = createPhysicalGraph(
    	editor.storage.graph,
    	editor.render
    );
    // item 15550
    var movedNodes = {};
    var commands = {};
    // item 15551
    var graph = pgraph.graph;
    var up = graph.getNode(nodeId);
    var down = goDownToEnd(graph, nodeId);
    // item 15577
    var dims = findLedgeDimensions(
    	graph,
    	up.id,
    	down.id
    );
    // item 15602
    var x = up.x;
    var x2 = dims.x;
    var yUp = up.y;
    // item 15603
    clearPathForSquare(
    	pgraph,
    	x,
    	x2,
    	yUp,
    	dims,
    	down,
    	movedNodes
    );
    // item 15604
    if (dims.y > down.y) {
        // item 15608
        var yDelta = dims.y - down.y;
        // item 15607
        pgraph.moveDown(
        	down.id,
        	yDelta,
        	movedNodes
        );
    }
    // item 15558
    buildMoveCommands(
    	pgraph,
    	movedNodes,
    	commands
    );
    // item 15557
    var commandList = Utils.objectValues(commands);
    // item 15609
    var upId = generateId(editor.storage);
    var downId = generateId(editor.storage);
    // item 15610
    pushInsertJunction(
    	commandList,
    	upId,
    	x2,
    	up.y
    );
    // item 15611
    pushInsertJunction(
    	commandList,
    	downId,
    	x2,
    	down.y
    );
    // item 15612
    connectVer(
    	editor,
    	commandList,
    	upId, downId,
    	"par-down", null
    );
    // item 15613
    connectHor(
    	editor,
    	commandList,
    	up.id, upId,
    	"parallel", null
    );
    // item 15614
    connectHor(
    	editor,
    	commandList,
    	down.id, downId,
    	null, null
    );
    // item 15548
    applyCommands(
    	editor,
    	commandList,
    	null
    );
}

function insertQuestion(editor, edgeId, cont) {
    // item 12704
    var subgraph = buildMacroQuestion(
    	editor.render,
    	cont,
    	1
    );
    // item 12705
    var id = insertSubgraph(editor, edgeId, subgraph, "insert 'question'");
    // item 12707
    return id;
}

function insertSelect(editor, edgeId, cont) {
    // item 15918
    var c1 = makeCont("Case 1");
    var c2 = makeCont("Case 2");
    var c3 = makeCont("Case 3");
    // item 12782
    var subgraph = buildMacroSelect(
    	editor.render,
    	cont,
    	[c1, c2, c3]
    );
    // item 12783
    var id = insertSubgraph(editor, edgeId, subgraph, "insert 'select'");
    // item 12785
    return id;
}

function insertSimpleItem(editor, edgeId, type, cont) {
    // item 12907
    var subgraph = buildMacroSimple(
    	editor.render,
    	type,
    	cont
    );
    // item 12908
    var id = insertSubgraph(editor, edgeId, subgraph, "insert item");
    // item 12909
    return id;
}

function insertSubgraph(editor, edgeId, subgraph, actionName) {
    // item 18056
    var graph = editor.storage.graph
    var edge = graph.getEdge(edgeId)
    // item 18065
    var before = copyState(editor);
    var after = copyState(editor);
    after.selection = createSelection()
    // item 18066
    var commandList1 = []
    // item 18058
    if (edge.isVertical) {
        
    } else {
        // item 18067
        var pgraph = createPhysicalGraph(
        	editor.storage.graph,
        	editor.render
        );
        // item 18061
        commandList1 = expandBoltCore(editor, pgraph, edgeId)
        // item 18073
        addTrace(
        	actionName + "-expand-bolt",
        	[edgeId]
        )
        // item 18062
        edgeId = findInsertedEdge(commandList1);
        // item 18235
        commandList1 = makeUndoAndExecute(
        	editor,
        	commandList1,
        	after,
        	false
        )
    }
    // item 18071
    addTrace(
    	actionName,
    	[edgeId]
    );
    // item 18074
    var subResult = insertSubgraphOnVertical(
    	editor,
    	edgeId,
    	subgraph
    )
    // item 18236
    var commandList2 = makeUndoAndExecute(
    	editor,
    	subResult.commandList,
    	after,
    	true
    )
    // item 18245
    concatAndSaveUndo(
    	editor,
    	commandList1,
    	commandList2,
    	before,
    	after
    )
    // item 18075
    return subResult.toSelect
}

function insertSubgraphOnVertical(editor, edgeId, subgraph) {
    // item 12509
    var graph = editor.storage.graph;
    var render = editor.render;
    // item 12715
    var subpgraph = createPhysicalGraph(
    	subgraph.graph,
    	render
    );
    subgraph.pgraph = subpgraph;
    // item 16073
    var width = getVerticalWidth(graph, edgeId);
    var subCommands = {};
    // item 16330
    Drakon.setSkewerWidth(
    	render,
    	subpgraph,
    	subgraph.first,
    	width,
    	subCommands
    );
    // item 16176
    bakeCommands(subgraph.graph, subCommands);
    // item 16146
    var subp2 = createPhysicalGraph(
    	subgraph.graph,
    	render
    );
    // item 12536
    var box = findDiagramBox(subp2.graph);
    // item 12714
    box.left += Config.METRE;
    box.top += Config.METRE;
    box.right -= Config.METRE;
    box.bottom -= Config.METRE;
    // item 12516
    var edge = graph.getEdge(edgeId);
    var commands = {};
    // item 16149
    var pgraph = createPhysicalGraph(
    	graph,
    	render
    );
    // item 16147
    var insertion = makeFreeSpace(
    	editor,
    	pgraph,
    	edge.head,
    	edge.tail,
    	box,
    	commands
    );
    // item 16148
    var commList = Utils.objectValues(commands);
    // item 12531
    pushDeleteEdge(
    	commList,
    	edgeId
    );
    // item 16203
    var subNode = subgraph.graph.getNode(
    	subgraph.first
    );
    // item 12561
    var upNode = pgraph.graph.getNode(edge.head);
    var insX = upNode.x;
    var insY = upNode.box.bottom + Config.METRE -
    	subNode.y;
    // item 12562
    moveSubgraph(subgraph, insX, insY);
    // item 12563
    var newIds = addBlockItems(
    	editor,
    	subgraph,
    	commList
    );
    // item 12522
    var idUp = generateId(editor.storage);
    var idDown = generateId(editor.storage);
    // item 12527
    pushInsertDown(
    	commList,
    	idUp,
    	edge.head,
    	newIds.first
    );
    // item 12529
    pushInsertVertical(
    	commList,
    	idDown,
    	newIds.last,
    	edge.tail,
    	edge.role
    );
    // item 12510
    return {
    	commandList: commList,
    	toSelect: newIds.first
    }
}

function isAboveLastCase(graph, edge) {
    // item 11820
    var above = graph.getNode(edge.head);
    // item 11812
    if (above.type == "junction") {
        // item 11811
        var jtype = describeJunction(above);
        // item 11815
        if (jtype == "left-down") {
            // item 11816
            var below = graph.getNode(edge.tail);
            // item 11817
            if (below.type == "case") {
                // item 11818
                return true;
            } else {
                // item 11819
                return false;
            }
        } else {
            // item 11819
            return false;
        }
    } else {
        // item 11819
        return false;
    }
}

function isArrowStart(graph, node) {
    // item 6638
    var jun = describeJunction(node);
    // item 6640
    if (jun === "left-up") {
        // item 6639
        var upEdge = graph.getEdge(node.up);
        // item 6643
        if (upEdge.role) {
            // item 6645
            return false;
        } else {
            // item 10153
            var leftEdge = graph.getEdge(node.left);
            // item 10154
            if (leftEdge.role === "sil_floor") {
                // item 6645
                return false;
            } else {
                // item 6644
                return true;
            }
        }
    } else {
        // item 6645
        return false;
    }
}

function isBetweenTs(graph, item) {
    // item 20460
    if (((item.isLine) && (!(item.isVertical))) && (item.role == "left")) {
        // item 20387
        var right = graph.getTail(item)
        var left = graph.getHead(item)
        // item 20388
        var rightT = describeJunction(right)
        var leftT = describeJunction(left)
        // item 20389
        if ((leftT == "up-t") && (rightT == "up-t")) {
            // item 20393
            return true
        } else {
            // item 20394
            return false
        }
    } else {
        // item 20394
        return false
    }
}

function isBetweenTs2(graph, item) {
    // item 20695
    if ((item.isLine) && (!(item.isVertical))) {
        // item 20687
        var right = graph.getTail(item)
        var left = graph.getHead(item)
        // item 20688
        var rightT = describeJunction(right)
        var leftT = describeJunction(left)
        // item 20689
        if ((leftT == "right-t") && (rightT == "up-t")) {
            // item 20697
            var below = graph.getNodeDownEx(left)
            // item 20753
            if (below.type == "junction") {
                // item 20752
                var belowT = describeJunction(below)
                // item 20698
                if (belowT == "left-up") {
                    // item 23121
                    var edgeUp = graph.getEdge(left.up)
                    // item 23122
                    if (edgeUp.role == "par-down") {
                        // item 20694
                        return false
                    } else {
                        // item 20693
                        return true
                    }
                } else {
                    // item 20694
                    return false
                }
            } else {
                // item 20694
                return false
            }
        } else {
            // item 20694
            return false
        }
    } else {
        // item 20694
        return false
    }
}

function isBolt(graph, edge) {
    // item 5400
    var head = graph.getHead(edge);
    var tail = graph.getTail(edge);
    // item 15301
    if ((downRole(edge)) && (head.type === "junction")) {
        // item 5401
        var headType = describeJunction(head);
        // item 5402
        if ((headType === "left-down") && (tail.type === "junction")) {
            // item 5408
            var tailType = describeJunction(tail);
            // item 5410
            if (tailType === "right-up") {
                // item 5405
                return true;
            } else {
                // item 5406
                return false;
            }
        } else {
            // item 5406
            return false;
        }
    } else {
        // item 5406
        return false;
    }
}

function isCross(item) {
    // item 14856
    if (((((item.type == "junction") && (item.left)) && (item.up)) && (item.down)) && (item.right)) {
        // item 14863
        return true;
    } else {
        // item 14864
        return false;
    }
}

function isCycleStart(graph, node) {
    // item 7822
    if (node.right) {
        // item 7821
        var rightEdge = graph.getEdge(node.right);
        // item 7827
        if (rightEdge.role === "arrow") {
            // item 7825
            return true;
        } else {
            // item 7826
            return false;
        }
    } else {
        // item 7826
        return false;
    }
}

function isDegenerateExit(node) {
    // item 8829
    var type = describeJunction(node);
    // item 88190001
    if ((type === "left-t") || (type === "left-up")) {
        // item 8826
        return true;
    } else {
        // item 8827
        return false;
    }
}

function isDownLeft(node) {
    // item 18029
    if (node.type == "junction") {
        // item 18032
        var type = describeJunction(node)
        // item 18033
        if (type == "left-down") {
            // item 18034
            return true
        } else {
            // item 18035
            return false
        }
    } else {
        // item 18035
        return false
    }
}

function isDrakon() {
    // item 21108
    return self.storage.type == "drakon"
}

function isEdgeOnMainSkewer(graph, edge) {
    // item 3423
    var head = graph.getHead(edge);
    // item 3424
    return isNodeOnMainSkewer(graph, head);
}

function isEmpty(map) {
    // item 19558
    if (map) {
        // item 19562
        var keys = Object.keys(map)
        // item 19563
        if (keys.length == 0) {
            // item 19561
            return true
        } else {
            // item 19564
            return false
        }
    } else {
        // item 19561
        return true
    }
}

function isEndBranch(graph, item) {
    // item 19650
    var bottom = goDownToEnd(graph, item.id)
    // item 19647
    if (bottom.type == "end") {
        // item 19645
        return true;
    } else {
        // item 19646
        return false;
    }
}

function isFree(graph) {
    // item 18578
    var nodeIds = Object.keys(graph.nodes)
    // item 18579
    return nodeIds.length == 0
}

function isFromTJoint(graph, edge) {
    // item 5291
    var tail = graph.getTail(edge);
    // item 5288
    if (tail.type === "junction") {
        // item 5293
        var type = describeJunction(tail);
        // item 5294
        if (type === "left-t") {
            // item 5295
            return true;
        } else {
            // item 5296
            return false;
        }
    } else {
        // item 5296
        return false;
    }
}

function isInCycleBody(graph, edgeId) {
    var _sw92340000_ = 0;
    // item 7804
    var edge = graph.getEdge(edgeId);
    var node = graph.getHead(edge);
    while (true) {
        // item 7812
        if ((isCycleStart(graph, node)) && (belongsToCycle(graph, node, edgeId))) {
            // item 9226
            return true;
        }
        // item 7805
        if (node.up) {
            
        } else {
            // item 9229
            var count = 0;
            node = graph.getHead(edge);
            while (true) {
                // item 92340000
                _sw92340000_ = node.type;
                // item 92340001
                if (_sw92340000_ === "loopbegin") {
                    // item 9241
                    count--;
                } else {
                    // item 92340002
                    if (_sw92340000_ === "loopend") {
                        // item 9242
                        count++;
                    }
                }
                // item 9230
                if (node.up) {
                    
                } else {
                    break;
                }
                // item 9233
                var id = graph.getNodeUp(node);
                node = graph.getNode(id);
            }
            // item 9244
            if (count === 0) {
                // item 9247
                return false;
            } else {
                // item 9248
                return true;
            }
            break;
        }
        // item 7815
        var id = graph.getNodeUp(node);
        node = graph.getNode(id);
    }
}

function isLastBranch(graph, item) {
    // item 10564
    var aboveId = graph.getNodeUp(item);
    var above = graph.getNode(aboveId);
    // item 10570
    if (above.right) {
        // item 10569
        return false;
    } else {
        // item 10568
        return true;
    }
}

function isMind() {
    // item 21522
    if (self.storage) {
        // item 21112
        return self.storage.type == "mind"
    } else {
        // item 21525
        return false
    }
}

function isMindSocket(socket) {
    // item 22169
    return Utils.startsWith(socket, "mind-")
}

function isNakedCorner(graph, edge) {
    // item 5279
    var type;
    var gap;
    // item 5259
    var head = graph.getHead(edge);
    var tail = graph.getTail(edge);
    var gap = tail.y - head.y - 
      head.h - tail.h;
    // item 5270
    if (head.type === "junction") {
        // item 5260
        type = describeJunction(head);
        // item 5261
        if ((type === "left-down") && (!(gap > Config.METRE))) {
            // item 5264
            return true;
        } else {
            // item 5265
            return false;
        }
    } else {
        // item 5278
        if (tail.type === "junction") {
            // item 5272
            type = describeJunction(tail);
            // item 5274
            if ((type === "left-up") && (!(gap > Config.METRE))) {
                // item 5277
                return true;
            } else {
                // item 5275
                return false;
            }
        } else {
            // item 5275
            return false;
        }
    }
}

function isNextToCorner(graph, tail) {
    // item 17390
    if (tail.type == "junction") {
        // item 17389
        var type = describeJunction(tail)
        // item 17393
        if (type == "left-up") {
            // item 21190
            var above = graph.getNodeUpEx(tail)
            var bottom = above.y + above.h
            var distance = tail.y - bottom
            // item 21191
            if (distance < Config.METRE * 2) {
                // item 17394
                return true
            } else {
                // item 17395
                return false
            }
        } else {
            // item 17395
            return false
        }
    } else {
        // item 17395
        return false
    }
}

function isNodeOnMainSkewer(graph, node) {
    // item 3433
    if (node.up) {
        // item 3440
        var edge = graph.getEdge(node.up);
        // item 3439
        return isEdgeOnMainSkewer(graph, edge);
    } else {
        // item 3430
        if (node.type === "beginend") {
            // item 3434
            return true;
        } else {
            // item 3441
            return false;
        }
    }
}

function isOnBranchSkewer(graph, id) {
    // item 10470
    var top = goUpToEnd(graph, id);
    // item 10471
    if (top.type === "beginend") {
        // item 10474
        return true;
    } else {
        // item 10475
        var belowId = graph.getNodeDown(top);
        var below = graph.getNode(belowId);
        // item 10476
        if (below.type === "branch") {
            // item 10474
            return true;
        } else {
            // item 10477
            return false;
        }
    }
}

function isRightHand(graph, edge) {
    // item 5433
    var head = graph.getHead(edge);
    var tail = graph.getTail(edge);
    // item 5443
    if ((((edge.role) || (edge.isVertical)) || (!(head.type === "question"))) || (!(tail.type === "junction"))) {
        // item 5439
        return false;
    } else {
        // item 5441
        var tailType = describeJunction(tail);
        // item 5442
        if (tailType === "left-down") {
            // item 5439
            return false;
        } else {
            // item 5438
            return true;
        }
    }
}

function isSelected(id) {
    // item 14197
    if (id) {
        // item 14196
        return id in self.storage.selection.ids;
    } else {
        // item 14200
        return false;
    }
}

function isShortTExit(graph, item) {
    // item 18324
    if ((item.isLine) && (Utils.canInsertInHorizontal(graph, item))) {
        // item 18329
        var right = graph.getTail(item)
        // item 18330
        if (right.down) {
            // item 18327
            return true
        } else {
            // item 18328
            return false
        }
    } else {
        // item 18328
        return false
    }
}

function isSilhouette(graph) {
    // item 96140001
    var _ind9614 = 0;
    var _col9614 = graph.nodes;
    var _keys9614 = Object.keys(_col9614); 
    var _len9614 = _keys9614.length;
    while (true) {
        // item 96140002
        if (_ind9614 < _len9614) {
            
        } else {
            // item 9620
            return false;
        }
        // item 96140004
        var id = _keys9614[_ind9614]; var node = _col9614[id];
        // item 9616
        if (node.type === "branch") {
            // item 9619
            return true;
        }
        // item 96140003
        _ind9614++;
    }
}

function isUnderCase(graph, nodeId) {
    // item 8966
    var top = goUpToEnd(graph, nodeId);
    var belowTopId = graph.getNodeDown(top);
    var belowTop = graph.getNode(belowTopId);
    // item 8967
    if (belowTop.type === "case") {
        // item 8968
        return true;
    } else {
        // item 8969
        return false;
    }
}

function isUpT(node) {
    // item 22301
    if (((((node.type == "junction") && (node.up)) && (node.left)) && (node.right)) && (!(node.down))) {
        // item 4657
        return true;
    } else {
        // item 4658
        return false;
    }
}

function kinematicMove(pgraph, id, dx, dy, movedNodes) {
    // item 15081
    pgraph.kinematicMove(id, dx, dy);
    // item 15082
    movedNodes[id] = true;
}

function lastParallel(graph, node) {
    // item 15436
    if (((node.type == "junction") && (node.left)) && (!(node.right))) {
        // item 15441
        var edge = graph.getEdge(node.left);
        // item 15442
        if (edge.role == "parallel") {
            // item 15443
            return true;
        } else {
            // item 15444
            return false;
        }
    } else {
        // item 15444
        return false;
    }
}

function leadsToArrow(graph, edgeId) {
    // item 7147
    var edge = graph.getEdge(edgeId);
    var tail = graph.getTail(edge);
    // item 7148
    if (tail.type === "junction") {
        // item 10482
        var type = describeJunction(tail);
        // item 10481
        if (type === "right-up") {
            // item 7151
            var rightId =graph.getNodeRight(tail);
            var right = graph.getNode(rightId);
            var rightType = describeJunction(right);
            // item 7152
            if (rightType === "left-up") {
                // item 7153
                return "arrow";
            } else {
                // item 11885
                return null;
            }
        } else {
            // item 11883
            if ((type === "left-up") && (questionOnLeft(graph, tail))) {
                // item 11887
                return "sq";
            } else {
                // item 11891
                return null;
            }
        }
    } else {
        // item 11891
        return null;
    }
}

function leftInnerCorner(editor, pgraph, source, target) {
    // item 6793
    var graph = pgraph.graph;
    // item 7473
    var movedNodes = {};
    var commands = {};
    var bottom;
    var right;
    // item 7488
    extendEdge(
    	pgraph,
    	source,
    	0,
    	movedNodes
    );
    // item 7474
    var sourceEdge = graph.getEdge(source);
    var sourceTail = graph.getTail(sourceEdge);
    var sourceHead = graph.getHead(sourceEdge);
    var targetTail = graph.getNode(target);
    var targetEdge = graph.getEdge(targetTail.up);
    var targetHead = graph.getHead(targetEdge);
    // item 7633
    var dims = findLedgeFromOrigin(
    	graph,
    	sourceTail.id,
    	targetTail.id
    );
    // item 7634
    var targetY = targetTail.y;
    // item 7639
    if (dims.y > targetY) {
        // item 7637
        var vDelta = dims.y - targetY;
        bottom = targetTail.y + vDelta;
        // item 7638
        dropDown(
        	pgraph,
        	targetTail,
        	bottom,
        	movedNodes
        );
        // item 7640
        targetY = dims.y;
    }
    // item 7641
    var sourceY1 = sourceHead.box.bottom + Config.METRE;
    var sourceY2 = sourceTail.box.top - Config.METRE;
    // item 7642
    if (targetY > sourceY2) {
        // item 7648
        if (source.x < dims.x) {
            // item 7651
            var hDelta = dims.x - source.x;
            // item 7652
            pgraph.moveRight(
            	sourceHead.id,
            	hDelta,
            	movedNodes
            );
        }
        // item 7653
        drill(
        	pgraph,
        	sourceTail.x,
        	sourceTail.y,
        	targetY,
        	movedNodes
        );
        // item 7656
        bottom = targetY;
    } else {
        // item 7645
        if (targetY < sourceY1) {
            // item 7658
            var delta2 = sourceY1 - targetY;
            bottom = targetTail.y + delta2;
            // item 7654
            dropDown(
            	pgraph,
            	targetTail,
            	bottom,
            	movedNodes
            );
            // item 7655
            bottom = sourceY1;
        } else {
            // item 7657
            bottom = targetY;
        }
    }
    // item 6783
    buildMoveCommands(
    	pgraph,
    	movedNodes,
    	commands
    );
    // item 6781
    var commandList = Utils.objectValues(commands);
    // item 6792
    deleteLiana(
    	editor,
    	graph,
    	sourceEdge,
    	commandList
    );
    // item 6795
    var rightJun = insertJunctionBetween(
    	editor,
    	graph,
    	sourceEdge.head,
    	null,
    	bottom,
    	commandList
    );
    // item 6796
    var bridgeId = generateId(editor.storage);
    // item 6797
    pushInsertHorizontal(
    	commandList,
    	bridgeId,
    	target,
    	rightJun,
    	"left"
    );
    // item 6798
    return commandList;
}

function leftInnerLine(editor, pgraph, source, target) {
    // item 7550
    var graph = pgraph.graph;
    // item 10526
    var sGraph = editor.storage.graph;
    // item 7551
    var movedNodes = {};
    var commands = {};
    var bottom;
    var right;
    // item 7562
    extendEdge(
    	pgraph,
    	source,
    	0,
    	movedNodes
    );
    // item 7587
    var sourceEdge = graph.getEdge(source);
    var sourceTail = graph.getTail(sourceEdge);
    var sourceHead = graph.getHead(sourceEdge);
    var targetEdge = graph.getEdge(target);
    var targetTail = graph.getTail(targetEdge);
    // item 7589
    extendEdge(
    	pgraph,
    	targetEdge.id,
    	0,
    	movedNodes
    );
    // item 7554
    var dims = findLedgeFromOrigin(
    	graph,
    	sourceTail.id,
    	targetTail.id
    );
    // item 7607
    var targetY = targetTail.box.top - Config.METRE;
    // item 7612
    if (dims.y > targetY) {
        // item 7610
        var vDelta = dims.y - targetY;
        bottom = targetTail.y + vDelta;
        // item 7611
        dropDown(
        	pgraph,
        	targetTail,
        	bottom,
        	movedNodes
        );
        // item 7626
        targetY = dims.y;
    }
    // item 7570
    var sourceY1 = sourceHead.box.bottom + Config.METRE;
    var sourceY2 = sourceTail.box.top - Config.METRE;
    // item 7571
    if (targetY > sourceY2) {
        // item 7577
        if (source.x < dims.x) {
            // item 7580
            var hDelta = dims.x - source.x;
            // item 7581
            pgraph.moveRight(
            	sourceHead.id,
            	hDelta,
            	movedNodes
            );
        }
        // item 7582
        drill(
        	pgraph,
        	sourceTail.x,
        	sourceTail.y,
        	targetY,
        	movedNodes
        );
        // item 7585
        bottom = targetY;
    } else {
        // item 7574
        if (targetY < sourceY1) {
            // item 7614
            var delta2 = sourceY1 - targetY;
            bottom = targetTail.y + delta2;
            // item 7583
            dropDown(
            	pgraph,
            	targetTail,
            	bottom,
            	movedNodes
            );
            // item 7584
            bottom = sourceY1;
        } else {
            // item 7586
            bottom = targetY;
        }
    }
    // item 6662
    buildMoveCommands(
    	pgraph,
    	movedNodes,
    	commands
    );
    // item 6660
    var commandList = Utils.objectValues(commands);
    // item 6674
    pushDeleteEdge(
    	commandList,
    	target
    );
    // item 10527
    var stail = sGraph.getTail(sourceEdge);
    // item 10505
    if (stail.type === "address") {
        // item 10508
        commandList = deleteAddressLiana(
        	editor,
        	graph,
        	sourceEdge,
        	commandList
        );
    } else {
        // item 6673
        deleteLiana(
        	editor,
        	graph,
        	sourceEdge,
        	commandList
        );
    }
    // item 6676
    var leftJun = insertJunctionBetween(
    	editor,
    	graph,
    	targetEdge.head,
    	targetEdge.tail,
    	bottom,
    	commandList
    );
    // item 6677
    var rightJun = insertJunctionBetween(
    	editor,
    	graph,
    	sourceEdge.head,
    	null,
    	bottom,
    	commandList
    );
    // item 6678
    var bridgeId = generateId(editor.storage);
    // item 6679
    pushInsertHorizontal(
    	commandList,
    	bridgeId,
    	leftJun,
    	rightJun,
    	"left"
    );
    // item 6680
    return commandList;
}

function leftInnerLineEx(editor, pgraph, source, target) {
    // item 18390
    addTrace(
    	"transplant liana",
    	["leftInnerLineEx", source, target]
    )
    // item 18388
    var before = copyState(editor);
    var after = copyState(editor);
    after.selection = createSelection();
    // item 18386
    var commandList1 = expandBoltCore(
    	editor,
    	pgraph,
    	source
    )
    // item 18389
    commandList1 = makeUndoAndExecute(
    	editor,
    	commandList1,
    	after,
    	false
    )
    // item 18413
    var newEdgeId = null
    // item 184140001
    var _ind18414 = 0;
    var _col18414 = commandList1;
    var _len18414 = _col18414.length;
    while (true) {
        // item 184140002
        if (_ind18414 < _len18414) {
            
        } else {
            break;
        }
        // item 184140004
        var command = _col18414[_ind18414];
        // item 18416
        if (((command.type == "insert") && (command.table == "edges")) && (command.fields.role == "down")) {
            // item 18425
            newEdgeId = command.id
            break;
        }
        // item 184140003
        _ind18414++;
    }
    // item 18406
    var pgraph2 = createPhysicalGraph(
    	editor.storage.graph,
    	editor.render
    )
    // item 18407
    var commandList2 = leftInnerLine(
    	editor,
    	pgraph2,
    	newEdgeId,
    	target
    )
    // item 18408
    commandList2 = makeUndoAndExecute(
    	editor,
    	commandList2,
    	after,
    	true
    )
    // item 18427
    var commandList = commandList1.concat(
    	commandList2
    )
    // item 18428
    commandList = normalizeCommands2(commandList)
    // item 18426
    addToUndo(editor.undo, before, commandList, after)
    // item 18398
    return null
}

function leftInnerLineTs(editor, pgraph, source, target) {
    // item 20571
    var graph = pgraph.graph;
    // item 20613
    var sGraph = editor.storage.graph;
    // item 20572
    var movedNodes = {};
    var commands = {};
    // item 20599
    var sourceEdge = graph.getEdge(source);
    var sourceTail = graph.getTail(sourceEdge);
    var sourceHead = graph.getHead(sourceEdge);
    var targetEdge = graph.getEdge(target);
    var targetTail = graph.getTail(targetEdge);
    // item 20615
    graph.removeItem(source)
    pgraph.rebuildCache()
    // item 20593
    pgraph.moveDown(
    	sourceHead.id,
    	Config.METRE,
    	movedNodes
    );
    // item 20553
    buildMoveCommands(
    	pgraph,
    	movedNodes,
    	commands
    );
    // item 20552
    var commandList = Utils.objectValues(commands);
    // item 20561
    pushDeleteEdge(
    	commandList,
    	target
    );
    // item 20616
    pushDeleteEdge(
    	commandList,
    	source
    );
    // item 20562
    var leftJun = insertJunctionBetween(
    	editor,
    	graph,
    	targetEdge.head,
    	targetEdge.tail,
    	sourceTail.y,
    	commandList
    );
    // item 20564
    var bridgeId = generateId(editor.storage);
    // item 20565
    pushInsertHorizontal(
    	commandList,
    	bridgeId,
    	leftJun,
    	sourceTail.id,
    	"left"
    );
    // item 20566
    return commandList;
}

function leftOuterCorner(editor, pgraph, source, target) {
    // item 6755
    var graph = pgraph.graph;
    // item 6748
    var movedNodes = {};
    var commands = {};
    var bottom;
    var right;
    // item 7165
    var sourceEdge = graph.getEdge(source);
    var sourceTail = graph.getTail(sourceEdge);
    var sourceHead = graph.getHead(sourceEdge);
    var targetTail = graph.getNode(target);
    var targetEdge = graph.getEdge(targetTail.up);
    // item 7167
    var dims = findLedgeDimensions(
    	graph,
    	sourceTail.id,
    	targetTail.id
    );
    // item 7600
    var targetY = targetTail.y;
    // item 7605
    if (dims.y > targetY) {
        // item 7603
        var vDelta = dims.y - targetY;
        bottom = targetTail.y + vDelta;
        // item 7604
        dropDown(
        	pgraph,
        	targetTail,
        	bottom,
        	movedNodes
        );
    } else {
        // item 7606
        bottom = targetY;
    }
    // item 7362
    dims = findLedgeDimensions(
    	graph,
    	sourceTail.id,
    	targetTail.id
    );
    // item 7239
    if (dims.lowId == targetTail.id) {
        // item 7242
        right = dims.x + Config.METRE;
    } else {
        // item 7238
        right = dims.x;
    }
    // item 7234
    if (right > sourceTail.x) {
        // item 7244
        var hDelta = right - sourceTail.x;
        // item 7243
        pgraph.moveRight(
        	sourceTail.id,
        	hDelta,
        	movedNodes
        );
    } else {
        // item 7377
        right = sourceTail.x;
    }
    // item 7246
    rayTraceDown(
    	pgraph,
    	right,
    	sourceTail.y,
    	bottom + Config.METRE,
    	movedNodes
    );
    // item 6747
    buildMoveCommands(
    	pgraph,
    	movedNodes,
    	commands
    );
    // item 6746
    var commandList = Utils.objectValues(commands);
    // item 6760
    deleteLiana(
    	editor,
    	graph,
    	sourceEdge,
    	commandList
    );
    // item 6761
    var rightJun = insertJunctionBetween(
    	editor,
    	graph,
    	sourceEdge.head,
    	null,
    	bottom,
    	commandList
    );
    // item 6762
    var bridgeId = generateId(editor.storage);
    // item 6763
    pushInsertHorizontal(
    	commandList,
    	bridgeId,
    	target,
    	rightJun,
    	"left"
    );
    // item 6757
    return commandList;
}

function leftOuterCornerSil(editor, pgraph, source, target) {
    // item 10115
    var graph = pgraph.graph;
    var sGraph = editor.storage.graph;
    var render = editor.render;
    // item 10108
    var movedNodes = {};
    var commands = {};
    var commandList = [];
    var bottom;
    var right;
    // item 10121
    var sourceEdge = graph.getEdge(source);
    var sourceTail = graph.getTail(sourceEdge);
    var sourceHead = graph.getHead(sourceEdge);
    var targetTail = graph.getNode(target);
    var targetEdge = graph.getEdge(targetTail.up);
    // item 10122
    var dims = findLedgeDimensions(
    	graph,
    	sourceTail.id,
    	targetTail.id
    );
    // item 10146
    var targetY = targetTail.y;
    // item 10161
    var neighbourHead = sGraph.getNode(targetEdge.head);
    var addCont = neighbourHead.content;
    // item 10160
    var add = makeDummyItem(
    	1,
    	render,
    	"address",
    	addCont
    );
    // item 10163
    var width = getVerticalWidth(
    	sGraph,
    	sourceEdge.head
    );
    // item 10151
    if (dims.y > targetY) {
        // item 10149
        var vDelta = dims.y - targetY;
        bottom = targetTail.y + vDelta;
        // item 10228
        var oldAddress = graph.getNode(
        	targetEdge.head
        );
        // item 10227
        dropDownCore(
        	pgraph,
        	targetTail,
        	bottom,
        	oldAddress.box.right + Config.METRE,
        	movedNodes
        );
    } else {
        // item 10152
        bottom = targetY;
    }
    // item 10143
    dims = findLedgeDimensions(
    	graph,
    	sourceTail.id,
    	targetTail.id
    );
    // item 10131
    if (dims.lowId == targetTail.id) {
        // item 10134
        right = dims.x + Config.METRE;
    } else {
        // item 10130
        right = dims.x;
    }
    // item 10127
    if (right > sourceTail.x) {
        // item 10136
        var hDelta = right - sourceTail.x;
        // item 10135
        pgraph.moveRight(
        	sourceTail.id,
        	hDelta,
        	movedNodes
        );
    } else {
        // item 10145
        right = sourceTail.x;
    }
    // item 10138
    rayTraceDown(
    	pgraph,
    	right,
    	sourceTail.y,
    	bottom + Config.METRE,
    	movedNodes
    );
    // item 10117
    deleteLiana(
    	editor,
    	graph,
    	sourceEdge,
    	commandList
    );
    // item 10169
    var h = graph.getNode(sourceEdge.head);
    var addX = h.x;
    var le = graph.getNode(target);
    var addY = le.y - Config.METRE - add.h;
    // item 10165
    var commands = {};
    // item 10178
    makeHorSpace(
        pgraph,
        addX,
        addY,
        width,
        add.h,
        movedNodes
    );
    // item 10167
    buildMoveCommands(
    	pgraph,
    	movedNodes,
    	commands
    );
    // item 10166
    var commandList2 = Utils.objectValues(commands);
    commandList = commandList.concat(commandList2);
    // item 10180
    var addId = generateId(editor.storage);
    var junId = generateId(editor.storage);
    // item 10181
    pushInsertJunction(
    	commandList,
    	junId,
    	addX, le.y
    );
    // item 10182
    pushInsertNodeAt(
    	render,
    	commandList,
    	addId,
    	"address",
    	addX, addY,
    	width, add.h,
    	addCont
    );
    // item 10184
    connectVer(
    	editor,
    	commandList,
    	sourceEdge.head, addId,
    	"down", null
    );
    // item 10185
    connectVer(
    	editor,
    	commandList,
    	addId, junId,
    	null, null
    );
    // item 10183
    connectHor(
    	editor,
    	commandList,
    	target, junId,
    	"sil_floor", null
    );
    // item 10116
    return commandList;
}

function leftOuterCornerTs(editor, pgraph, source, target) {
    // item 20738
    var graph = pgraph.graph;
    // item 20744
    var sGraph = editor.storage.graph;
    // item 20739
    var movedNodes = {};
    var commands = {};
    // item 20743
    var sourceEdge = graph.getEdge(source);
    var sourceTail = graph.getTail(sourceEdge);
    var sourceHead = graph.getHead(sourceEdge);
    var targetNode = graph.getNode(target);
    var eUp = graph.getEdge(sourceHead.up)
    var above = graph.getNodeUpEx(sourceHead)
    // item 20745
    graph.removeItem(source)
    pgraph.rebuildCache()
    // item 20747
    var dy = targetNode.y - sourceTail.y
    // item 20742
    pgraph.moveDown(
    	sourceTail.id,
    	dy,
    	movedNodes
    );
    // item 20726
    buildMoveCommands(
    	pgraph,
    	movedNodes,
    	commands
    );
    // item 20725
    var commandList = Utils.objectValues(commands);
    // item 20746
    pushDeleteEdge(
    	commandList,
    	source
    );
    // item 20733
    pushDeleteEdge(
    	commandList,
    	sourceHead.up
    )
    // item 20749
    pushDeleteEdge(
    	commandList,
    	sourceHead.down
    )
    // item 20748
    pushDeleteNode(
    	commandList,
    	sourceHead.id
    );
    // item 20750
    var vId = generateId(editor.storage);
    // item 20751
    pushInsertVertical(
    	commandList,
    	vId,
    	above.id,
    	target,
    	eUp.role
    );
    // item 20735
    var bridgeId = generateId(editor.storage);
    // item 20736
    pushInsertHorizontal(
    	commandList,
    	bridgeId,
    	target,
    	sourceTail.id,
    	"left"
    );
    // item 20737
    return commandList;
}

function leftOuterLine(editor, pgraph, source, target) {
    // item 7401
    var graph = pgraph.graph;
    // item 7394
    var movedNodes = {};
    var commands = {};
    var bottom;
    var right;
    // item 7438
    extendEdge(
    	pgraph,
    	target,
    	0,
    	movedNodes
    );
    // item 7407
    var sourceEdge = graph.getEdge(source);
    var sourceTail = graph.getTail(sourceEdge);
    var sourceHead = graph.getHead(sourceEdge);
    var targetEdge = graph.getEdge(target);
    var targetTail = graph.getTail(targetEdge);
    // item 7408
    var dims = findLedgeDimensions(
    	graph,
    	sourceTail.id,
    	targetTail.id
    );
    // item 7439
    var targetY = targetTail.box.top - Config.METRE;
    // item 7597
    if (dims.y > targetY) {
        // item 7413
        var vDelta = dims.y - targetY;
        bottom = targetTail.y + vDelta;
        // item 7414
        dropDown(
        	pgraph,
        	targetTail,
        	bottom,
        	movedNodes
        );
    }
    // item 7435
    dims = findLedgeDimensions(
    	graph,
    	sourceTail.id,
    	targetTail.id
    );
    // item 7446
    targetY = targetTail.box.top - Config.METRE;
    // item 7422
    right = dims.x;
    // item 7419
    if (right > sourceTail.x) {
        // item 7428
        var hDelta = right - sourceTail.x;
        // item 7427
        pgraph.moveRight(
        	sourceTail.id,
        	hDelta,
        	movedNodes
        );
    } else {
        // item 7437
        right = sourceTail.x;
    }
    // item 7430
    rayTraceDown(
    	pgraph,
    	right,
    	sourceTail.y,
    	targetY + Config.METRE,
    	movedNodes
    );
    // item 7393
    buildMoveCommands(
    	pgraph,
    	movedNodes,
    	commands
    );
    // item 7392
    var commandList = Utils.objectValues(commands);
    // item 7441
    pushDeleteEdge(
    	commandList,
    	target
    );
    // item 7440
    deleteLiana(
    	editor,
    	graph,
    	sourceEdge,
    	commandList
    );
    // item 7442
    var leftJun = insertJunctionBetween(
    	editor,
    	graph,
    	targetEdge.head,
    	targetEdge.tail,
    	targetY,
    	commandList
    );
    // item 7443
    var rightJun = insertJunctionBetween(
    	editor,
    	graph,
    	sourceEdge.head,
    	null,
    	targetY,
    	commandList
    );
    // item 7444
    var bridgeId = generateId(editor.storage);
    // item 7445
    pushInsertHorizontal(
    	commandList,
    	bridgeId,
    	leftJun,
    	rightJun,
    	"left"
    );
    // item 7402
    return commandList;
}

function leftOuterLineTs(editor, pgraph, source, target) {
    // item 20640
    var graph = pgraph.graph;
    // item 20633
    var movedNodes = {};
    var commands = {};
    // item 20680
    extendEdge(
    	pgraph,
    	target,
    	0,
    	movedNodes
    );
    // item 20642
    var sourceEdge = graph.getEdge(source);
    var sourceTail = graph.getTail(sourceEdge);
    var sourceHead = graph.getHead(sourceEdge);
    var targetEdge = graph.getEdge(target);
    var targetTail = graph.getTail(targetEdge);
    // item 20678
    graph.removeItem(source)
    pgraph.rebuildCache()
    // item 20677
    pgraph.moveDown(
    	sourceTail.id,
    	Config.METRE,
    	movedNodes
    );
    // item 20632
    buildMoveCommands(
    	pgraph,
    	movedNodes,
    	commands
    );
    // item 20631
    var commandList = Utils.objectValues(commands);
    // item 20670
    pushDeleteEdge(
    	commandList,
    	target
    );
    // item 20679
    pushDeleteEdge(
    	commandList,
    	source
    );
    // item 20671
    var leftJun = insertJunctionBetween(
    	editor,
    	graph,
    	targetEdge.head,
    	targetEdge.tail,
    	sourceTail.y,
    	commandList
    );
    // item 20673
    var bridgeId = generateId(editor.storage);
    // item 20674
    pushInsertHorizontal(
    	commandList,
    	bridgeId,
    	leftJun,
    	sourceTail.id,
    	"left"
    );
    // item 20641
    return commandList;
}

function leftToEndNoDuration(graph, nodeId) {
    // item 21177
    var node = goLeftToEnd(graph, nodeId)
    // item 21178
    if (node.type == "duration") {
        // item 21181
        return graph.getNodeRightEx(node)
    } else {
        // item 21182
        return node
    }
}

function leftWithDown(graph, node) {
    // item 21379
    var result = graph.getNodeLeftEx(node)
    // item 21380
    if (result.down) {
        // item 21383
        return result
    } else {
        // item 21385
        return graph.getNodeLeftEx(result)
    }
}

function loadDiagram(diagram) {
    // item 12249
    var storage = new Storage(self.persistence);
    // item 12251
    storage.name = diagram.name;
    storage.type = diagram.type;
    storage.background = diagram.background
    storage.diaLine = diagram.diaLine
    storage.diaLineThickness = diagram.diaLineThickness
    storage.font = diagram.font
    storage.selection = copySelection(diagram.selection)
    storage.version = diagram.version || 0
    // item 122470001
    var _ind12247 = 0;
    var _col12247 = diagram.nodes;
    var _keys12247 = Object.keys(_col12247); 
    var _len12247 = _keys12247.length;
    while (true) {
        // item 122470002
        if (_ind12247 < _len12247) {
            
        } else {
            break;
        }
        // item 122470004
        var nid = _keys12247[_ind12247]; var it = _col12247[nid];
        // item 12250
        var item = copyStorageItem(it);
        item.isLine = false;
        storage.graph.addItem(item);
        // item 122470003
        _ind12247++;
    }
    // item 122520001
    var _ind12252 = 0;
    var _col12252 = diagram.edges;
    var _keys12252 = Object.keys(_col12252); 
    var _len12252 = _keys12252.length;
    while (true) {
        // item 122520002
        if (_ind12252 < _len12252) {
            
        } else {
            break;
        }
        // item 122520004
        var eid = _keys12252[_ind12252]; var it = _col12252[eid];
        // item 12256
        var item = copyStorageItem(it);
        item.isLine = true;
        storage.graph.addItem(item);
        // item 122520003
        _ind12252++;
    }
    // item 16772
    var error = copyAndSort(diagram.free, storage.free)
    // item 17498
    if (error) {
        // item 17501
        Utils.throwError(error)
    }
    // item 21225
    recalculateNextId(storage)
    // item 12254
    setStorage(self, storage)
    // item 17901
    self.render.setDefaultFont(
    	self.storage.font
    )
}

function makeAndDrawSocket(render, graph, id, type, action) {
    // item 3182
    var socket = makeSocket(graph, id, type, action);
    // item 3184
    socket.prim = render.addSocket(
    	socket.center.x,
    	socket.center.y
    );
    // item 3183
    return socket;
}

function makeCommonWidth(editor, pgraph, srcId, dstId, movedNodes, commands) {
    // item 5250
    var graph = pgraph.graph;
    var render = editor.render;
    // item 5236
    var srcWidth = getVerticalWidth(
    	graph,
    	srcId
    );
    // item 16392
    Drakon.setSkewerWidth(
    	render,
    	pgraph,
    	dstId,
    	srcWidth,
    	commands
    );
}

function makeCont(text) {
    // item 15895
    var content = new Utils.Content(text, "")
    // item 17902
    var defaultFont = getDefault("font")
    // item 17903
    var diagramFont = self.storage.font
    // item 17904
    if ((defaultFont) && (!(diagramFont == defaultFont))) {
        // item 17909
        content.font = defaultFont
    }
    // item 17978
    var shape = getDefault("shape")
    // item 17988
    if (shape) {
        // item 179950001
        var _ind17995 = 0;
        var _col17995 = shape;
        var _keys17995 = Object.keys(_col17995); 
        var _len17995 = _keys17995.length;
        while (true) {
            // item 179950002
            if (_ind17995 < _len17995) {
                
            } else {
                break;
            }
            // item 179950004
            var key = _keys17995[_ind17995]; var value = _col17995[key];
            // item 17992
            if (hasValue(value)) {
                // item 17991
                content[key] = value
            }
            // item 179950003
            _ind17995++;
        }
    }
    // item 17907
    return content
}

function makeDeletionPlan(editor, nodeId) {
    var _sw84040000_ = 0;
    // item 5662
    var plan = {
    	nodes: {},
    	edges: {},
    	horHoles: {},
    	verHoles: {},
    	newEdges: {},
    	stairs: {},
    	mainDeletes: [nodeId]
    };
    // item 5672
    var graph = editor.storage.graph;
    // item 5671
    var node = graph.getNode(nodeId);
    // item 84040000
    _sw84040000_ = node.type;
    // item 84040001
    if (_sw84040000_ === "question") {
        // item 8403
        planDeleteQuestion(
        	graph,
        	node,
        	plan
        );
    } else {
        // item 84040002
        if (_sw84040000_ === "select") {
            // item 8412
            planDeleteSelect(
            	graph,
            	node,
            	plan
            );
        } else {
            // item 84040003
            if (_sw84040000_ === "case") {
                // item 8478
                planDeleteCase(
                	graph,
                	node,
                	plan
                );
            } else {
                // item 84040004
                if (_sw84040000_ === "loopbegin") {
                    // item 9121
                    planDeleteLoop(
                    	graph,
                    	node,
                    	plan
                    );
                } else {
                    // item 84040005
                    if (_sw84040000_ === "loopend") {
                        
                    } else {
                        // item 84040006
                        throw "Unexpected switch value: " + _sw84040000_;
                    }
                    // item 9124
                    planDeleteLoopEnd(
                    	graph,
                    	node,
                    	plan
                    );
                }
            }
        }
    }
    // item 5843
    glueHoles(plan, plan.horHoles);
    glueHoles(plan, plan.verHoles);
    // item 5678
    return plan;
}

function makeDummyItem(id, render, type, content) {
    // item 12453
    var item = {
    	id: String(id),
    	isLine: false,
    	type: type,
    	content: content,
    	x: 0,
    	y: 0
    };
    // item 23103
    adjustFontSize(item)
    // item 16191
    var width;
    // item 16188
    if (Drakon.isWideIcon(item)) {
        // item 16192
        width = Config.DEF_ICON_WIDTH;
    } else {
        // item 16193
        width = Config.DEF_ICON_WIDTH_S;
    }
    // item 16194
    item.w = width;
    // item 12455
    var size = Drakon.fitItem(item, render);
    setItemDims(item, size);
    // item 12456
    return item;
}

function makeDummyJunction(id, x, y) {
    // item 12465
    var item = {
    	id: String(id),
    	isLine: false,
    	x: x,
    	y: y,
    	w: 0,
    	h: 0,
    	type: "junction"
    };
    // item 12466
    return item;
}

function makeDummyLine(id, isVertical, head, tail, role) {
    // item 12472
    var item = {
    	id: String(id),
    	isLine: true,
    	isVertical: isVertical,
    	head: head,
    	tail: tail,
    	role: role,
    	type: isVertical ? "vertical" : "horizontal"
    };
    // item 12473
    return item;
}

function makeFreeSpace(editor, pgraph, headId, tailId, box, commands) {
    // item 2676
    var render = editor.render;
    var graph = editor.storage.graph;
    // item 2674
    var head = graph.getNode(headId);
    var tail = graph.getNode(tailId);
    // item 2677
    var headBox = getBox(head, render);
    var tailBox = getBox(tail, render);
    // item 2706
    var insertion = new Utils.Point(
    	head.x,
    	headBox.bottom + Config.METRE - box.top
    );
    // item 2685
    var h = box.bottom - box.top;
    var dh = tail.y - tailBox.top;
    // item 2673
    var required = headBox.bottom +
     Config.METRE * 2 + h + dh;
    // item 2697
    var movedNodes = {};
    // item 2687
    if (required > tail.y) {
        // item 2694
        var delta = required - tail.y;
        // item 14706
        pgraph.moveDown(
            tailId,
            delta,
            movedNodes
        );
    }
    // item 2705
    var directionProps = "horizontal";
    // item 2702
    var fakeSkewer = {};
    // item 2701
    var leftBox = new Utils.Box(
    	box.left + insertion.x,
    	box.top + insertion.y,
    	head.x,
    	box.bottom + insertion.y
    );
    var leftItem = { box: leftBox };
    // item 2699
    pgraph.pushObjects(
        leftItem.box,
        fakeSkewer,
        box.right,
        directionProps,
        movedNodes
    );
    // item 2703
    var rightBox = new Utils.Box(
    	head.x,
    	box.top + insertion.y,
    	box.right + insertion.x,
    	box.bottom + insertion.y
    );
    var rightItem = { box: rightBox };
    // item 2704
    pgraph.pushObjects(
        rightItem.box,
        fakeSkewer,
        box.left,
        directionProps,
        movedNodes
    );
    // item 2698
    buildMoveCommands(
    	pgraph,
    	movedNodes,
    	commands
    );
    // item 2897
    return insertion;
}

function makeHeaderCont(text) {
    // item 17921
    var content = makeCont(text)
    // item 17922
    var defaultFont = getDefault("font")
    // item 17930
    var size
    var family
    // item 17924
    if (defaultFont) {
        // item 17940
        var parsed = Utils.parseFontString(defaultFont)
        // item 17944
        size = parsed.size
        family = parsed.family
    } else {
        // item 17943
        size = Config.FONT_SIZE
        family = Config.FONT_FAMILY
    }
    // item 17941
    var font = Utils.buildFontString(
    	false,
    	true,
    	headerSize(size),
    	family
    )
    // item 17942
    content.font = font
    // item 17927
    return content
}

function makeHorSpace(pgraph, x, y, w, h, movedNodes) {
    // item 14500
    var directionProps = "horizontal";
    // item 14501
    var box = Utils.boxFromPoint(x, y, 0, h);
    // item 14499
    pgraph.pushObjects(
        box,
        {},
        w,
        directionProps,
        movedNodes
    );
    // item 14502
    pgraph.pushObjects(
        box,
        {},
        -w,
        directionProps,
        movedNodes
    );
}

function makeIconBoxForType(render, type, cont, width) {
    // item 8177
    var item = {
    	type: type,
    	content: cont,
    	isLine: false,
    	x: 0,
    	y: 0,
    	w: width
    };
    // item 8178
    var callback = Items.getItemCallback(
    	type
    );
    // item 8179
    var size = Drakon.fitItem(item, render);
    setItemDims(item, size);
    // item 8180
    var box = callback.makeBox(
    	item,
    	0,
    	0,
    	render
    );
    // item 8181
    var result = {
    	size: size,
    	box: box
    };
    // item 8182
    return result;
}

function makeMindItem(id, render, type, content, width) {
    // item 22034
    var item = {
    	id: String(id),
    	isLine: false,
    	type: type,
    	content: content,
    	x: 0,
    	y: 0
    }
    // item 22043
    item.w = width
    // item 22035
    var size = Drakon.fitItem(item, render)
    setItemDims(item, size)
    // item 22036
    return item
}

function makeNewZone(canvas) {
    // item 3761
    var zone = canvas.zone;
    canvas.zone++;
    return zone;
}

function makePipe(pgraph, left, right, corner, movedNodes) {
    // item 4734
    var graph = pgraph.graph;
    // item 4230
    var leftX = left.x;
    var rightX = right.x;
    var top;
    var bottom;
    // item 4231
    if (left.y < right.y) {
        // item 4234
        top = left.y;
        bottom = right.y;
    } else {
        // item 4235
        top = right.y;
        bottom = left.y;
    }
    // item 7798
    var step = Config.SNAP;
    while (true) {
        // item 4279
        if (hasPipe(graph, leftX, top, rightX, bottom)) {
            break;
        }
        // item 4282
        pgraph.moveRight(
        	corner,
        	step,
        	movedNodes
        );
        // item 4301
        rightX += step;
    }
}

function makePipeForEdge(pgraph, leftId, rightId, movedNodes) {
    // item 4717
    var graph = pgraph.graph;
    // item 4716
    var left = nextPointBelow(
    	graph,
    	leftId
    )
    left.y -= Config.METRE / 2;
    // item 4718
    var right = nextPointBelow(
    	graph,
    	rightId
    );
    right.y -= Config.METRE / 2;
    // item 4732
    var rightEdge = graph.getEdge(
    	rightId
    );
    // item 4735
    makePipe(
    	pgraph,
    	left,
    	right,
    	rightEdge.tail,
    	movedNodes
    );
}

function makePipeForNode(pgraph, leftId, rightId, movedNodes) {
    // item 4742
    var graph = pgraph.graph;
    // item 4746
    var leftNode = graph.getNode(leftId);
    // item 4741
    var left = new Utils.Point(
    	leftNode.x,
    	leftNode.y
    );
    // item 4743
    var right = nextPointBelow(
    	graph,
    	rightId
    );
    right.y -= Config.METRE / 2;
    // item 4744
    var rightEdge = graph.getEdge(
    	rightId
    );
    // item 4745
    makePipe(
    	pgraph,
    	left,
    	right,
    	rightEdge.tail,
    	movedNodes
    );
}

function makePointToCommand(editor, addressNodeId, targetNode) {
    // item 23108
    var graph = editor.storage.graph
    var address = graph.getNode(addressNodeId)
    var cont = Utils.copyObject(getContent(address))
    // item 10265
    var text = getText(targetNode);
    cont.txt = text
    // item 10262
    var menuText = tr("MES_POINT_TO") + " \"" + text + "\"";
    // item 10263
    var result = { 
    	type: "item", 
    	text: menuText, 
    	code: function() {
     	       setItemText(editor, addressNodeId, cont);
    	}
    };
    // item 10264
    return result;
}

function makeRCont() {
    // item 20825
    var content = makeCont("")
    // item 20824
    content.radius = RoundedRadius
    // item 20826
    return content
}

function makeSecDeletionPlan(graph, edgeId, plan) {
    // item 5739
    var edge = graph.getEdge(edgeId);
    var node = graph.getTail(edge);
    // item 5741
    plan.edges[edgeId] = true;
    // item 16453
    if (isArrowStart(graph, node)) {
        // item 16455
        deleteArrow(graph, node, plan);
    } else {
        // item 5740
        var type = describeJunction(node);
        // item 5742
        if (type === "left-t") {
            // item 8471
            if (node.id in plan.stairs) {
                // item 8473
                delete plan.stairs[node.id]
                // item 5745
                var downId = graph.getNodeDown(node);
                // item 5746
                plan.edges[node.down] = true;
                plan.nodes[node.id] = true;
                // item 5747
                planDeleteMain(
                	graph,
                	downId,
                	plan,
                	false
                );
            } else {
                // item 5939
                pokeVer(
                	graph,
                	node,
                	plan
                );
            }
        } else {
            // item 5745
            var downId = graph.getNodeDown(node);
            // item 5746
            plan.edges[node.down] = true;
            plan.nodes[node.id] = true;
            // item 5747
            planDeleteMain(
            	graph,
            	downId,
            	plan,
            	false
            );
        }
    }
}

function makeSimpleSubtree(type, width) {
    // item 21992
    var empty = makeCont("")
    var id = "1"
    // item 21997
    if (type == "raction") {
        // item 22000
        empty.radius = RoundedRadius
    }
    // item 21991
    var newChild = makeMindItem(
    	id,
    	self.render,
    	type,
    	empty,
    	width
    )
    // item 21995
    newChild.x = newChild.w
    newChild.y = newChild.h
    // item 22001
    var result = new Utils.LogicalTree(id)
    // item 22003
    Utils.addLogicalTreeNode(result, newChild)
    // item 22002
    return result
}

function makeSocket(graph, id, type, action) {
    // item 3163
    var x, y
    // item 3176
    var item = graph.getItem(id)
    // item 3567
    if (item.isLine) {
        // item 3157
        var head = graph.getHead(item)
        var tail = graph.getTail(item)
        // item 3160
        if (item.isVertical) {
            // item 3158
            var top = head.y + head.h
            var bottom = tail.y - tail.h
            x = head.x
            y = Math.floor((top + bottom) / 2)
        } else {
            // item 3164
            var left = head.x + head.w
            var right = tail.x - tail.w
            y = head.y
            x = Math.floor((left + right) / 2)
        }
    } else {
        // item 22264
        if (action.action) {
            // item 22267
            x = item.x + action.dx
            y = item.y + action.dy
        } else {
            // item 3570
            x = item.x
            y = item.y
        }
    }
    // item 3165
    var pos = new Utils.Point(x, y)
    return new Socket(id, pos, type, action)
}

function makeSocketType(socketType, action, x, y) {
    // item 22245
    var type = {
    	action: action.action,
    	socketType: socketType,
    	itemId: action.itemId,
    	dx: x,
    	dy: y
    }
    // item 22246
    return type
}

function makeTurnIntoElement(itemId, avItem2) {
    // item 21835
    var item = {
    	image: avItem2.image,
    	text: tr(avItem2.text),
    	code: function() {
    		changeMindElementType(itemId, avItem2.type)
    	}
    }
    // item 21836
    return item
}

function makeUndoAndExecute(editor, commandList, after, redraw) {
    // item 18233
    var commandList2 = calculateUndo(
    	editor.storage,
    	commandList
    );
    // item 18232
    executeCommands(
    	editor,
    	commandList2,
    	after,
    	false,
    	redraw
    );
    // item 18234
    return commandList2
}

function mark2DownBig(stack, canvas, head, zone) {
    // item 8697
    var graph = canvas.graph;
    // item 8702
    var edge = graph.getEdge(head.down);
    var tail = graph.getTail(edge);
    // item 8698
    if (mark2Upper(edge, zone)) {
        // item 8703
        if (tail.right) {
            // item 15369
            var redge = graph.getEdge(tail.right);
            // item 15367
            if (redge.role == "parallel") {
                // item 15372
                stack.push(zone);
                // item 15373
                var newZone = makeNewZone(canvas);
                // item 15380
                mark2DownBig(stack, canvas, tail, newZone);
                // item 15374
                var rtail = graph.getNode(redge.tail);
                mark2parallel(canvas, rtail);
            } else {
                // item 15370
                if (edge.role == "par-down") {
                    // item 15381
                    if (tail.down) {
                        // item 15383
                        var oldZone = stack.pop();
                        // item 15384
                        mark2DownBig(stack, canvas, tail, oldZone);
                    }
                } else {
                    // item 8706
                    mark2RightUpper(stack, canvas, tail, zone);
                    // item 8707
                    if (tail.down) {
                        // item 8711
                        mark2NewZone(stack, canvas, tail);
                    }
                }
            }
        } else {
            // item 8709
            if (tail.down) {
                // item 8710
                mark2DownBig(stack, canvas,  tail, zone);
            } else {
                // item 15416
                if ((edge.role == "par-down") || (!(tail.left))) {
                    
                } else {
                    // item 9648
                    var leftEdge = graph.getEdge(tail.left);
                    // item 9649
                    if (leftEdge.role === "sil_floor") {
                        
                    } else {
                        // item 8714
                        mark2LeftLower(stack, canvas, tail, zone);
                    }
                }
            }
        }
    }
}

function mark2DownPar(stack, canvas, head, zone) {
    // item 15400
    var graph = canvas.graph;
    // item 15401
    var edge = graph.getEdge(head.down);
    var tail = graph.getTail(edge);
    // item 15402
    if (edge.role == "par-down") {
        // item 15405
        mark2DownSmall(stack, canvas, tail, zone);
    } else {
        // item 15406
        mark2DownPar(stack, canvas, tail, zone);
    }
}

function mark2DownSmall(stack, canvas, head, zone) {
    // item 8720
    var graph = canvas.graph;
    // item 8725
    var edge = graph.getEdge(head.down);
    var tail = graph.getTail(edge);
    // item 8797
    if (mark2Lower(edge, zone)) {
        // item 15389
        if (tail.right) {
            // item 15387
            var redge = graph.getEdge(tail.right);
            // item 15386
            if (redge.role == "parallel") {
                // item 15393
                mark2DownPar(stack, canvas, tail, zone);
            } else {
                // item 15388
                if (edge.role == "par-down") {
                    
                } else {
                    // item 8735
                    if (tail.left) {
                        // item 15176
                        var left = graph.getEdge(tail.left);
                        // item 15177
                        if (left.role == "lstick") {
                            // item 8729
                            if (tail.down) {
                                // item 8732
                                mark2DownSmall(stack, canvas, tail, zone);
                            } else {
                                // item 8802
                                if (tail.right) {
                                    // item 8803
                                    mark2RightLower(stack, canvas, tail, zone);
                                }
                            }
                        }
                    } else {
                        // item 8729
                        if (tail.down) {
                            // item 8732
                            mark2DownSmall(stack, canvas, tail, zone);
                        } else {
                            // item 8802
                            if (tail.right) {
                                // item 8803
                                mark2RightLower(stack, canvas, tail, zone);
                            }
                        }
                    }
                }
            }
        } else {
            // item 8735
            if (tail.left) {
                // item 15176
                var left = graph.getEdge(tail.left);
                // item 15177
                if (left.role == "lstick") {
                    // item 8729
                    if (tail.down) {
                        // item 8732
                        mark2DownSmall(stack, canvas, tail, zone);
                    } else {
                        // item 8802
                        if (tail.right) {
                            // item 8803
                            mark2RightLower(stack, canvas, tail, zone);
                        }
                    }
                }
            } else {
                // item 8729
                if (tail.down) {
                    // item 8732
                    mark2DownSmall(stack, canvas, tail, zone);
                } else {
                    // item 8802
                    if (tail.right) {
                        // item 8803
                        mark2RightLower(stack, canvas, tail, zone);
                    }
                }
            }
        }
    }
}

function mark2LeftLower(stack, canvas, tail, zone) {
    // item 8741
    var graph = canvas.graph;
    // item 8746
    var edge = graph.getEdge(tail.left);
    var head = graph.getHead(edge);
    // item 8798
    if (mark2Lower(edge, zone)) {
        // item 8749
        if (head.down) {
            // item 8750
            mark2DownBig(stack, canvas,  head, zone);
        } else {
            // item 8747
            if (head.left) {
                // item 8748
                mark2LeftLower(stack, canvas, head, zone);
            } else {
                // item 8754
                if (head.up) {
                    // item 8753
                    mark2UpSmall(stack, canvas, head, zone);
                }
            }
        }
    }
}

function mark2Lower(edge, zone) {
    // item 8790
    if (edge.lowerMark) {
        // item 8794
        return false;
    } else {
        // item 8791
        edge.lowerMark = zone;
        // item 8795
        return true;
    }
}

function mark2NewZone(stack, canvas, node) {
    // item 8669
    var graph = canvas.graph;
    // item 8660
    var nextZone = makeNewZone(canvas);
    // item 8662
    mark2RightLower(stack, canvas,
    	node,
    	nextZone
    );
    // item 8671
    mark2DownBig(stack, canvas, 
    	node,
    	nextZone
    );
}

function mark2RightLower(stack, canvas, head, zone) {
    // item 8677
    var graph = canvas.graph;
    // item 8682
    var edge = graph.getEdge(head.right);
    var tail = graph.getTail(edge);
    // item 8799
    if (mark2Lower(edge, zone)) {
        // item 8687
        if (tail.down) {
            // item 8690
            mark2DownSmall(stack, canvas, tail, zone);
        } else {
            // item 8684
            if (tail.right) {
                // item 8686
                mark2RightLower(stack, canvas, tail, zone);
            }
        }
    }
}

function mark2RightUpper(stack, canvas, head, zone) {
    // item 8640
    var graph = canvas.graph;
    // item 8645
    var edge = graph.getEdge(head.right);
    var tail = graph.getTail(edge);
    // item 8796
    if ((mark2Upper(edge, zone)) && (!(tail.up))) {
        // item 8647
        if (tail.right) {
            // item 8650
            mark2RightUpper(stack, canvas, tail, zone);
            // item 8651
            if (tail.down) {
                // item 8670
                mark2NewZone(stack, canvas, tail);
            }
        } else {
            // item 8653
            if (tail.down) {
                // item 8654
                mark2DownBig(stack, canvas,  tail, zone);
            }
        }
    }
}

function mark2UpSmall(stack, canvas, tail, zone) {
    // item 8760
    var graph = canvas.graph;
    // item 8765
    var edge = graph.getEdge(tail.up);
    var head = graph.getHead(edge);
    // item 8800
    if (mark2Lower(edge, zone)) {
        // item 8766
        if (hasLeft(graph, head)) {
            // item 8767
            mark2LeftLower(stack, canvas, head, zone);
        } else {
            // item 8773
            if (head.up) {
                // item 8772
                mark2UpSmall(stack, canvas, head, zone);
            }
        }
    }
}

function mark2Upper(edge, zone) {
    // item 8779
    if (edge.upperMark) {
        // item 8783
        return false;
    } else {
        // item 8780
        edge.upperMark = zone;
        // item 8784
        return true;
    }
}

function mark2parallel(canvas, head) {
    // item 15408
    var graph = canvas.graph;
    // item 15410
    var nextZone = makeNewZone(canvas);
    // item 15409
    var stack = [];
    // item 15407
    mark2DownBig(stack, canvas, head, nextZone);
    // item 15411
    if (head.right) {
        // item 15414
        var tail = graph.getNodeRightEx(head);
        // item 15415
        mark2parallel(canvas, tail);
    }
}

function markVerticals(graph, node, verticals) {
    // item 22982
    if (node.up) {
        // item 22981
        verticals[node.up] = true
    }
    while (true) {
        // item 22959
        verticals[node.down] = true
        // item 22962
        node = graph.getNodeDownEx(node)
        // item 22960
        if (node.down) {
            
        } else {
            break;
        }
    }
}

function measureBranch(render, graph, top) {
    // item 13322
    var nodes;
    var edges;
    // item 13311
    var headerId = graph.getNodeDown(top);
    // item 13317
    if (top.right) {
        // item 13313
        var bgraph = findBranchGraph(graph, headerId);
        // item 13314
        nodes = bgraph.nodes;
        edges = bgraph.edges;
    } else {
        // item 13320
        nodes = {};
        edges = {};
        // item 13323
        nodes[top.id] = true;
        // item 19775
        var bottom = goDownToEnd(graph, top.id)
        nodes[bottom.id] = true
        // item 13321
        graph.enumerateManhattan(
        	headerId,
        	nodes,
        	edges
        );
    }
    // item 13312
    var graph2 = copyGraphSectionNoMove(
    	graph,
    	nodes,
    	edges
    );
    // item 13373
    var pgraph = createPhysicalGraph(
    	graph2,
    	render
    );
    // item 13315
    var subBox = findDiagramBox(pgraph.graph);
    // item 13316
    return subBox;
}

function measureDiagram() {
    // item 12337
    var pgraph = createPhysicalGraph(
    	self.storage.graph,
    	self.render
    );
    // item 18714
    var left = Number.MAX_VALUE
    var right = -Number.MAX_VALUE
    var top = Number.MAX_VALUE
    var bottom = -Number.MAX_VALUE
    // item 12338
    var dbox = findDiagramBoxCore(
    	pgraph.graph,
    	left,
    	top,
    	right,
    	bottom
    );
    // item 18713
    var box = findFreeItemsBox(
    	self.storage.free,
    	dbox.left,
    	dbox.top,
    	dbox.right,
    	dbox.bottom
    )
    // item 18715
    left = getRidOfMinMax(box.left, 0)
    right = getRidOfMinMax(box.right, 300)
    top = getRidOfMinMax(box.top, 0)
    bottom = getRidOfMinMax(box.bottom, 300)
    // item 17380
    var border = Config.METRE;
    // item 17382
    return new Utils.Box(
    	left - border,
    	top - border,
    	right + border,
    	bottom + border
    );
}

function middleParallel(graph, node) {
    // item 15737
    if (((node.type == "junction") && (node.left)) && (node.right)) {
        // item 15742
        var edge = graph.getEdge(node.left);
        // item 15743
        if (edge.role == "parallel") {
            // item 15744
            return true;
        } else {
            // item 15745
            return false;
        }
    } else {
        // item 15745
        return false;
    }
}

function mih3Ok(graph, item) {
    // item 21207
    if (((item.isLine) || (item.type == "junction")) || (!(item.down))) {
        // item 21210
        return false
    } else {
        // item 21213
        var below = graph.getNodeDownEx(item)
        // item 21214
        if (below.type == "junction") {
            // item 21215
            return true
        } else {
            // item 21210
            return false
        }
    }
}

function mindAction(actionName, itemId, type) {
    // item 21399
    CallTrace.add(
    	"Editor: " + actionName,
    	[itemId]
    )
    // item 21167
    var task = createTask(itemId)
    // item 22047
    if (type) {
        // item 22015
        var width = getWidthForMindRoot(
        	itemId,
        	actionName
        )
        // item 22044
        var toInsert = makeSimpleSubtree(type, width)
        // item 22046
        task.toInsert(toInsert)
    }
    // item 22098
    runTask(task, actionName)
}

function mindPasteAction(actionName, itemId, subtree) {
    // item 22064
    CallTrace.add(
    	"Editor: " + actionName,
    	[itemId]
    )
    // item 22106
    var task = createTask(itemId)
    // item 22065
    var width = getWidthForMindRoot(
    	itemId,
    	actionName
    )
    // item 22109
    var root = subtree.nodes[subtree.root]
    // item 22108
    root.w = width
    // item 22107
    var size = Drakon.fitItem(root, self.render)
    setItemDims(root, size)
    // item 22080
    task.toInsert(subtree)
    // item 22097
    runTask(task, actionName)
}

function mouseClick(x, y) {
    // item 19038
    addTrace("mouseClick", [x, y])
    // item 20357
    self.dragOn = false
    // item 12397
    var item = self.findVisualItem(
    	x,
    	y
    );
    // item 19037
    addTrace("found vi", [item])
    // item 12407
    self.dirty = true;
    // item 12398
    if (item) {
        // item 19182
        if ((item.id) && (!(self.isSelected(item.id)))) {
            // item 12406
            deselectAll(self);
            // item 12402
            selectItem(self, item.id);
            // item 12409
            redrawCanvas(self);
        } else {
            // item 12412
            self.dirty = false;
        }
    } else {
        // item 12401
        deselectAll(self);
        // item 12410
        redrawCanvas(self);
    }
    // item 12411
    return {
    	mustRedraw: self.dirty
    };
}

function moveByArrow(dx, dy, visibleBox) {
    // item 20268
    var ids = getSelection()
    // item 20269
    if (ids.length == 1) {
        // item 20278
        var currentId = ids[0]
        // item 20279
        var current = getAnyItem(
        	self.storage,
        	currentId
        );
        // item 20266
        dx *= Config.SNAP
        dy *= Config.SNAP
        // item 20286
        startVisualDrag(currentId)
        // item 20287
        visualDrag(dx, dy, visibleBox)
        // item 20288
        endVisualDrag()
    }
}

function moveCanvasNode(canvas, id, x, y) {
    // item 11236
    var graph = canvas.graph
    var render = canvas.render
    var free = canvas.free
    var node
    // item 16664
    node = free.get(id)
    // item 16665
    if (node) {
        
    } else {
        // item 16659
        node = graph.getNode(id)
    }
    // item 11237
    Items.moveCanvasNode(
    	render,
    	id,
    	node,
    	x,
    	y
    );
}

function moveGraphBy(graph, dx, dy) {
    // item 132070001
    var _ind13207 = 0;
    var _col13207 = graph.nodes;
    var _keys13207 = Object.keys(_col13207); 
    var _len13207 = _keys13207.length;
    while (true) {
        // item 132070002
        if (_ind13207 < _len13207) {
            
        } else {
            break;
        }
        // item 132070004
        var id = _keys13207[_ind13207]; var node = _col13207[id];
        // item 13209
        node.x += dx;
        node.y += dy;
        // item 132070003
        _ind13207++;
    }
}

function moveHandle(id, handleType, dx, dy, x, y) {
    // item 19776
    if (self.readonly) {
        
    } else {
        // item 17322
        var free = self.canvas.free
        var render = self.render
        var item = free.get(id)
        var selection = getSelectedIds(self)
        // item 17323
        var newValues = Items.moveHandle(
        	item,
        	handleType,
        	dx,
        	dy,
        	x,
        	y
        )
        // item 17324
        Utils.mergeSets(item, newValues)
        // item 17325
        Items.renderItem(
        	null,
        	render,
        	item,
        	selection
        )
    }
}

function moveHorLeft(pgraph, nodeId, x, movedNodes) {
    // item 6574
    var graph = pgraph.graph;
    var id = nodeId;
    var node;
    while (true) {
        // item 6575
        node = graph.getNode(id);
        // item 6576
        if (node.right) {
            
        } else {
            break;
        }
        // item 6580
        id =graph.getNodeRight(node);
    }
    // item 6581
    var delta = x - node.box.right - Config.METRE;
    // item 6582
    pgraph.moveRight(
    	id,
    	delta,
    	movedNodes
    );
}

function moveHorLineAway(pgraph, edge, box, movedNodes) {
    // item 8285
    var graph = pgraph.graph;
    // item 8279
    var id = edge.tail;
    var rightNode;
    while (true) {
        // item 8280
        rightNode = graph.getNode(id);
        // item 8281
        if (rightNode.right) {
            
        } else {
            break;
        }
        // item 8284
        id =graph.getNodeRight(rightNode);
    }
    // item 8286
    var delta = box.left - rightNode.box.right;
    // item 8287
    pgraph.moveRight(
    	rightNode.id,
    	delta,
    	movedNodes
    );
}

function moveSubgraph(subgraph, insX, insY) {
    // item 12610
    var graph = subgraph.graph;
    // item 12609
    var dx = insX;
    var first = graph.getNode(subgraph.first);
    var dy = insY + first.h;
    // item 13210
    moveGraphBy(graph, dx, dy);
}

function moveToRightFrom(pgraph, sourceEdge, targetEdge, movedNodes) {
    // item 4468
    var srcHead = pgraph.graph.getHead(sourceEdge);
    var dstHead = pgraph.graph.getHead(targetEdge);
    // item 4639
    moveToRightFromCore(
    	pgraph,
    	srcHead,
    	dstHead,
    	movedNodes
    );
}

function moveToRightFromCore(pgraph, srcHead, dstHead, movedNodes) {
    // item 4633
    var srcX = srcHead.x;
    var dstX = dstHead.x;
    var minX = dstX + Config.METRE;
    // item 4634
    if (srcX < minX) {
        // item 4637
        var delta = minX - srcX;
        // item 4638
        pgraph.moveRight(
        	srcHead.id,
        	delta,
        	movedNodes
        );
    }
}

function nextPointBelow(graph, edgeId) {
    // item 4225
    var edge = graph.getEdge(edgeId);
    var head = graph.getHead(edge);
    var nextY = head.box.bottom + Config.METRE;
    // item 4226
    return new Utils.Point(
    	head.x,
    	nextY
    );
}

function normalizeCommands(commands) {
    // item 18129
    var inserts = new Utils.SortedSet()
    // item 181300001
    var _ind18130 = 0;
    var _col18130 = commands;
    var _len18130 = _col18130.length;
    while (true) {
        // item 181300002
        if (_ind18130 < _len18130) {
            
        } else {
            break;
        }
        // item 181300004
        var command = _col18130[_ind18130];
        // item 18132
        if (command.type === "insert") {
            // item 18135
            inserts.add(command.id, command)
        }
        // item 181300003
        _ind18130++;
    }
    // item 18112
    var deleteIds = {};
    var commands2 = [];
    // item 181100001
    var _ind18110 = 0;
    var _col18110 = commands;
    var _len18110 = _col18110.length;
    while (true) {
        // item 181100002
        if (_ind18110 < _len18110) {
            
        } else {
            break;
        }
        // item 181100004
        var command = _col18110[_ind18110];
        // item 18113
        if (command.type === "delete") {
            // item 18137
            if (command.id in inserts.set) {
                
            } else {
                // item 18116
                commands2.push(command);
            }
            // item 18140
            deleteIds[command.id] = true;
        }
        // item 181100003
        _ind18110++;
    }
    // item 181540001
    var _ind18154 = 0;
    var _col18154 = commands;
    var _len18154 = _col18154.length;
    while (true) {
        // item 181540002
        if (_ind18154 < _len18154) {
            
        } else {
            break;
        }
        // item 181540004
        var command = _col18154[_ind18154];
        // item 18157
        if (command.type == "update") {
            // item 18160
            var insertCommand = inserts.get(command.id)
            // item 18168
            if (insertCommand) {
                // item 18156
                Utils.mergeSets(
                	insertCommand.fields,
                	command.fields
                )
            }
        }
        // item 181540003
        _ind18154++;
    }
    // item 181170001
    var _ind18117 = 0;
    var _col18117 = commands;
    var _len18117 = _col18117.length;
    while (true) {
        // item 181170002
        if (_ind18117 < _len18117) {
            
        } else {
            break;
        }
        // item 181170004
        var command = _col18117[_ind18117];
        // item 18123
        if ((command.id in deleteIds) || (command.id in inserts.set)) {
            
        } else {
            // item 18119
            commands2.push(command);
        }
        // item 181170003
        _ind18117++;
    }
    // item 181710001
    var _ind18171 = 0;
    var _col18171 = inserts.list;
    var _len18171 = _col18171.length;
    while (true) {
        // item 181710002
        if (_ind18171 < _len18171) {
            
        } else {
            break;
        }
        // item 181710004
        var id = _col18171[_ind18171];
        // item 18175
        if (id in deleteIds) {
            
        } else {
            // item 18174
            var insertCommand = inserts.get(id)
            // item 18173
            commands2.push(insertCommand);
        }
        // item 181710003
        _ind18171++;
    }
    // item 18126
    return commands2;
}

function normalizeCommands2(commands) {
    // item 18447
    var inserts = {}
    var deletes = {}
    var commands2 = []
    // item 184480001
    var _ind18448 = 0;
    var _col18448 = commands;
    var _len18448 = _col18448.length;
    while (true) {
        // item 184480002
        if (_ind18448 < _len18448) {
            
        } else {
            break;
        }
        // item 184480004
        var command = _col18448[_ind18448];
        // item 18450
        if (command.type === "insert") {
            // item 18452
            inserts[command.id] = true
        } else {
            // item 18457
            if (command.type === "delete") {
                // item 18460
                deletes[command.id] = true;
            }
        }
        // item 184480003
        _ind18448++;
    }
    // item 184380001
    var _ind18438 = 0;
    var _col18438 = commands;
    var _len18438 = _col18438.length;
    while (true) {
        // item 184380002
        if (_ind18438 < _len18438) {
            
        } else {
            break;
        }
        // item 184380004
        var command = _col18438[_ind18438];
        // item 18442
        if ((command.id in deletes) && (command.id in inserts)) {
            
        } else {
            // item 18440
            commands2.push(command);
        }
        // item 184380003
        _ind18438++;
    }
    // item 18445
    return commands2;
}

function onArrow(manFinder, checkPosition) {
    // item 20236
    var id = null
    var graph = self.storage.graph
    // item 20228
    var ids = getSelection()
    // item 20229
    if (ids.length == 0) {
        // item 20232
        id = findTopMost(self)
    } else {
        // item 20239
        var currentId = ids[0]
        // item 20240
        var current = getAnyItem(
        	self.storage,
        	currentId
        );
        // item 20246
        if (current.isLine) {
            // item 20232
            id = findTopMost(self)
        } else {
            // item 20241
            if (current.free) {
                // item 20249
                var criteria = function(item) {
                	return checkPosition(item, current)
                }
                // item 20245
                id = findClosest(self, current, criteria)
            } else {
                // item 20230
                id = manFinder(graph, current)
                // item 20243
                if (id) {
                    
                } else {
                    // item 20249
                    var criteria = function(item) {
                    	return checkPosition(item, current)
                    }
                    // item 20245
                    id = findClosest(self, current, criteria)
                }
            }
        }
    }
    // item 20233
    if (id) {
        // item 20237
        selectItem(self, id)
        // item 20247
        redraw()
    }
}

function onInnerFloor(editor, pgraph, source, target) {
    // item 7007
    var graph = pgraph.graph;
    // item 7000
    var movedNodes = {};
    // item 7672
    var sourceEdge = graph.getEdge(source);
    var sourceTail = graph.getTail(sourceEdge);
    var targetEdge = graph.getEdge(target);
    var targetLeft = graph.getHead(targetEdge);
    // item 7683
    var dims = findLedgeFromOrigin(
    	graph,
    	sourceTail.id,
    	targetLeft.id
    );
    // item 7677
    var targetX;
    // item 7675
    if (dims.x > sourceTail.x) {
        // item 7679
        var hDelta = dims.x - sourceTail.x;
        // item 7681
        pgraph.moveRight(
        	sourceTail.id,
        	hDelta,
        	movedNodes
        );
        // item 7680
        targetX = dims.x;
    } else {
        // item 7678
        targetX = sourceTail.x;
    }
    // item 7674
    drill(
    	pgraph,
    	targetX,
    	sourceTail.y,
    	targetLeft.y,
    	movedNodes
    );
    // item 6997
    var commands = {};
    // item 6999
    buildMoveCommands(
    	pgraph,
    	movedNodes,
    	commands
    );
    // item 6998
    var commandList = Utils.objectValues(commands);
    // item 7013
    pushDeleteEdge(
    	commandList,
    	target
    );
    // item 7012
    deleteLiana(
    	editor,
    	graph,
    	sourceEdge,
    	commandList
    );
    // item 7014
    var newJun = insertJunctionBetween(
    	editor,
    	graph,
    	sourceEdge.head,
    	null,
    	targetLeft.y,
    	commandList
    );
    // item 7015
    var leftBridge = generateId(editor.storage);
    var rightBridge = generateId(editor.storage);
    // item 7016
    pushInsertHorizontal(
    	commandList,
    	leftBridge,
    	targetEdge.head,
    	newJun,
    	"left"
    );
    // item 7018
    pushInsertHorizontal(
    	commandList,
    	rightBridge,
    	newJun,
    	targetEdge.tail,
    	"left"
    );
    // item 7009
    return commandList;
}

function onOuterFloor(editor, pgraph, source, target) {
    // item 6971
    var graph = pgraph.graph;
    // item 6964
    var movedNodes = {};
    // item 6972
    var sourceEdge = graph.getEdge(source);
    var sourceTail = graph.getTail(sourceEdge);
    var targetEdge = graph.getEdge(target);
    var targetLeft = graph.getHead(targetEdge);
    var target2 = editor.storage.graph.getEdge(
    	target
    );
    // item 7663
    var dims = findLedgeDimensions(
    	graph,
    	sourceTail.id,
    	targetLeft.id
    );
    // item 7667
    var targetX;
    // item 7664
    if (dims.x > sourceTail.x) {
        // item 7669
        var hDelta = dims.x - sourceTail.x;
        // item 7671
        pgraph.moveRight(
        	sourceTail.id,
        	hDelta,
        	movedNodes
        );
        // item 7670
        targetX = dims.x;
    } else {
        // item 7668
        targetX = sourceTail.x;
    }
    // item 6975
    drill(
    	pgraph,
    	targetX,
    	sourceTail.y,
    	targetLeft.y,
    	movedNodes
    );
    // item 6961
    var commands = {};
    // item 6963
    buildMoveCommands(
    	pgraph,
    	movedNodes,
    	commands
    );
    // item 6962
    var commandList = Utils.objectValues(commands);
    // item 6977
    pushDeleteEdge(
    	commandList,
    	target
    );
    // item 6976
    deleteLiana(
    	editor,
    	graph,
    	sourceEdge,
    	commandList
    );
    // item 6978
    var newJun = insertJunctionBetween(
    	editor,
    	graph,
    	sourceEdge.head,
    	null,
    	targetLeft.y,
    	commandList
    );
    // item 6979
    var leftBridge = generateId(editor.storage);
    var rightBridge = generateId(editor.storage);
    // item 6980
    pushInsertHorizontal(
    	commandList,
    	leftBridge,
    	targetEdge.head,
    	newJun,
    	target2.role
    );
    // item 6982
    pushInsertHorizontal(
    	commandList,
    	rightBridge,
    	newJun,
    	targetEdge.tail,
    	target2.role
    );
    // item 6973
    return commandList;
}

function onOuterSilFloor(editor, pgraph, source, target) {
    // item 10032
    var graph = pgraph.graph;
    var render = editor.render;
    var sGraph = editor.storage.graph;
    // item 10025
    var movedNodes = {};
    var commandList = [];
    // item 10033
    var sourceEdge = graph.getEdge(source);
    var sourceTail = graph.getTail(sourceEdge);
    var targetEdge = graph.getEdge(target);
    var targetLeft = graph.getHead(targetEdge);
    var target2 = sGraph.getEdge(target);
    // item 10046
    var dims = findLedgeDimensions(
    	graph,
    	sourceTail.id,
    	targetLeft.id
    );
    // item 10060
    var neighbourId = graph.getNodeUp(targetLeft);
    var neighbourHead = sGraph.getNode(neighbourId);
    var addCont = neighbourHead.content;
    // item 10071
    var width = getVerticalWidth(
    	sGraph,
    	sourceEdge.head
    );
    // item 10059
    var add = fitItemType(
    	render,
    	"address",
    	width,
    	addCont
    )
    // item 10050
    var targetX;
    // item 10047
    if (dims.x > sourceTail.x) {
        // item 10052
        var hDelta = dims.x - sourceTail.x;
        // item 10054
        pgraph.moveRight(
        	sourceTail.id,
        	hDelta,
        	movedNodes
        );
        // item 10053
        targetX = dims.x;
    } else {
        // item 10051
        targetX = sourceTail.x;
    }
    // item 10035
    drill(
    	pgraph,
    	targetX,
    	sourceTail.y,
    	targetLeft.y,
    	movedNodes
    );
    // item 10037
    pushDeleteEdge(
    	commandList,
    	target
    );
    // item 10036
    deleteLiana(
    	editor,
    	graph,
    	sourceEdge,
    	commandList
    );
    // item 10066
    var h = graph.getNode(sourceEdge.head);
    var addX = h.x;
    var le = graph.getNode(targetEdge.head);
    var addY = le.y - Config.METRE - add.h;
    // item 10022
    var commands = {};
    // item 10081
    makeHorSpace(
        pgraph,
        addX,
        addY,
        width,
        add.h,
        movedNodes
    );
    // item 10024
    buildMoveCommands(
    	pgraph,
    	movedNodes,
    	commands
    );
    // item 10023
    var commandList2 = Utils.objectValues(commands);
    commandList = commandList.concat(commandList2);
    // item 10061
    var addId = generateId(editor.storage);
    var junId = generateId(editor.storage);
    // item 10062
    pushInsertJunction(
    	commandList,
    	junId,
    	addX, le.y
    );
    // item 10063
    pushInsertNodeAt(
    	render,
    	commandList,
    	addId,
    	"address",
    	addX, addY,
    	width, add.h,
    	addCont
    );
    // item 10065
    connectVer(
    	editor,
    	commandList,
    	sourceEdge.head, addId,
    	"down", null
    );
    // item 10067
    connectVer(
    	editor,
    	commandList,
    	addId, junId,
    	null, null
    );
    // item 10064
    connectHor(
    	editor,
    	commandList,
    	targetEdge.head, junId,
    	"sil_floor", null
    );
    // item 10068
    connectHor(
    	editor,
    	commandList,
    	junId, targetEdge.tail,
    	"sil_floor", null
    );
    // item 10034
    return commandList;
}

function paste(x, y) {
    // item 18552
    if (ignoreCommand()) {
        
    } else {
        // item 22450
        var type = getClipboardType()
        // item 18557
        if (type == "free") {
            // item 18560
            pasteFree(self, x, y)
        } else {
            // item 22449
            var socket = clipTypeToSocket(type)
            // item 22456
            if (socket) {
                // item 22451
                if (type == "mind") {
                    // item 22453
                    if (isMind()) {
                        // item 22448
                        showInsertionSockets(socket)
                    }
                } else {
                    // item 22457
                    if (isDrakon()) {
                        // item 22459
                        showInsertionSockets(socket)
                    }
                }
            }
        }
    }
}

function pasteBlock(editor, edgeId) {
    // item 13029
    var subgraph = getClipboard("block");
    // item 23113
    if (subgraph) {
        // item 13034
        subgraph.graph = createGraph(subgraph.graph);
        // item 14560
        var count = getIconCount(subgraph.graph);
        // item 14558
        if ((canAddMore(editor, count)) && (subgraph)) {
            // item 13033
            insertSubgraph(editor, edgeId, subgraph, "paste block");
        }
    }
}

function pasteBranch(editor, nodeId) {
    // item 13304
    var render = editor.render;
    var graph = editor.storage.graph;
    // item 13297
    var subgraph = getClipboard("branch");
    // item 13424
    if (subgraph) {
        // item 18960
        addTrace(
        	"paste branch",
        	[nodeId, Utils.copyObject(subgraph)]
        );
        // item 13298
        var sgraph = createGraph(subgraph.graph);
        subgraph.graph = sgraph;
        // item 13303
        subgraph.pgraph = createPhysicalGraph(
        	subgraph.graph,
        	render
        );
        // item 19895
        var leftBranch = graph.getNode(nodeId)
        var leftTop = graph.getNodeUpEx(leftBranch)
        var leftBottom, rightBox = null
        var noEnd = !leftTop.right
        // item 13300
        var bTop = sgraph.getNode(subgraph.top);
        var bBottom = sgraph.getNode(subgraph.bottom);
        var rBottom = sgraph.getNode(subgraph.rBottom);
        // item 19900
        var leftBox = measureBranch(render, graph, leftTop);
        // item 13305
        var subBox = findDiagramBox(subgraph.pgraph.graph);
        // item 19896
        if (noEnd) {
            // item 19899
            leftBottom = goDownToEnd(graph, leftTop.id)
        } else {
            // item 13299
            
            var rightTop = graph.getNodeRightEx(leftTop)
            var rightBottom = goDownToEnd(graph, rightTop.id)
            var isLast = (!rightBottom.left)
            // item 13398
            if (isLast) {
                // item 13401
                var oldBottom = goDownToEnd(graph, leftTop.id);
                leftBottom = goRightToEnd(graph, oldBottom.id);
            } else {
                // item 13402
                leftBottom = graph.getNodeLeftEx(rightBottom);
            }
            // item 13302
            rightBox = measureBranch(render, graph, rightTop);
        }
        // item 13301
        var mainHeight = leftBottom.y - leftTop.y;
        var subHeight = bBottom.y - bTop.y;
        // item 13350
        var pgraph = createPhysicalGraph(
        	graph,
        	render
        );
        // item 13348
        var movedNodes = {};
        // item 13327
        var lowerNodes = findLowerNodes(sgraph, bBottom);
        // item 13341
        var arrowCorner = goLeftToEnd(graph, leftBottom.id);
        var group = arrowCorner.id;
        // item 13343
        var yDiff;
        // item 13324
        if (mainHeight > subHeight) {
            // item 13344
            yDiff = mainHeight - subHeight;
            // item 13342
            lowerNodes.forEach(function(node) {
            	node.y += yDiff;
            });
        } else {
            // item 13345
            if (mainHeight < subHeight) {
                // item 13351
                yDiff = subHeight - mainHeight;
                // item 13349
                pgraph.moveDown(
                	leftBottom.id,
                	yDiff,
                	movedNodes
                );
            }
        }
        // item 19902
        if (noEnd) {
            
        } else {
            // item 13355
            var requiredWidth = subBox.right - subBox.left;
            var actualWidth = rightBox.left - leftBox.right;
            // item 13356
            if (requiredWidth > actualWidth) {
                // item 13359
                var xDiff = requiredWidth - actualWidth;
                // item 13360
                pgraph.moveRight(
                	rightTop.id,
                	xDiff,
                	movedNodes
                );
            }
        }
        // item 13363
        var commands = {};
        // item 13362
        buildMoveCommands(
        	pgraph,
        	movedNodes,
        	commands
        );
        // item 13361
        var commandList = Utils.objectValues(commands);
        // item 19905
        if (noEnd) {
            
        } else {
            // item 13391
            pushDeleteEdge(
            	commandList,
            	leftTop.right
            );
            // item 13393
            if (isLast) {
                
            } else {
                // item 13392
                pushDeleteEdge(
                	commandList,
                	leftBottom.right
                );
            }
        }
        // item 13396
        var idMap = {};
        // item 13397
        idMap[bBottom.group] = group;
        // item 13390
        var dx = leftBox.right - subBox.left;
        var dy = leftTop.y;
        // item 13405
        moveGraphBy(sgraph, dx, dy);
        // item 13404
        addSubgraphItems(
        	editor,
        	subgraph,
        	commandList,
        	idMap
        );
        // item 13403
        var newTopId = idMap[subgraph.top];
        var newBottomId = idMap[subgraph.bottom];
        var newRBottomId = idMap[subgraph.rBottom];
        // item 13406
        connectHor(
        	editor,
        	commandList,
        	leftTop.id, newTopId,
        	null
        );
        // item 13407
        connectHor(
        	editor,
        	commandList,
        	leftBottom.id, newBottomId,
        	"sil_floor"
        );
        // item 19908
        if (noEnd) {
            
        } else {
            // item 13408
            connectHor(
            	editor,
            	commandList,
            	newTopId, rightTop.id,
            	null
            );
            // item 13409
            if (isLast) {
                
            } else {
                // item 13412
                connectHor(
                	editor,
                	commandList,
                	newRBottomId, rightBottom.id,
                	"sil_floor"
                );
            }
        }
        // item 13242
        applyCommands(
        	editor,
        	commandList,
        	null
        );
    }
}

function pasteCase(editor, nodeId) {
    // item 13081
    var payload = getClipboard("case");
    // item 13082
    if (payload) {
        // item 13080
        insertCase(editor, nodeId, payload.content);
    }
}

function pasteDuration(editor, nodeId) {
    // item 15284
    var payload = getClipboard("duration")
    // item 15285
    if (payload) {
        // item 15283
        insertDuration(editor, nodeId, payload)
    }
}

function pasteFree(editor, x, y) {
    // item 18961
    addTrace(
    	"paste free items",
    	[]
    );
    // item 17191
    var payload = getClipboard("free")
    // item 23117
    if (payload) {
        // item 17192
        var items = payload.items
        var left = Number.MAX_VALUE
        var top = Number.MAX_VALUE
        // item 171930001
        var _ind17193 = 0;
        var _col17193 = items;
        var _len17193 = _col17193.length;
        while (true) {
            // item 171930002
            if (_ind17193 < _len17193) {
                
            } else {
                break;
            }
            // item 171930004
            var item = _col17193[_ind17193];
            // item 17249
            var box = getBox(item)
            var ix = box.left
            var iy = box.top
            // item 17195
            left = Math.min(left, ix)
            top = Math.min(top, iy)
            // item 171930003
            _ind17193++;
        }
        // item 17210
        var oldToNew = {}
        var dx = Utils.snapPos(x - left)
        var dy = Utils.snapPos(y - top)
        // item 171990001
        var _ind17199 = 0;
        var _col17199 = items;
        var _len17199 = _col17199.length;
        while (true) {
            // item 171990002
            if (_ind17199 < _len17199) {
                
            } else {
                break;
            }
            // item 171990004
            var item = _col17199[_ind17199];
            // item 17209
            var id = generateId(editor.storage)
            // item 17211
            oldToNew[item.id] = id
            // item 17201
            item.id = id
            item.x += dx
            item.y += dy
            // item 171990003
            _ind17199++;
        }
        // item 17205
        var commandList = []
        // item 172060001
        var _ind17206 = 0;
        var _col17206 = items;
        var _len17206 = _col17206.length;
        while (true) {
            // item 172060002
            if (_ind17206 < _len17206) {
                
            } else {
                break;
            }
            // item 172060004
            var item = _col17206[_ind17206];
            // item 17213
            if (item.next) {
                // item 17212
                item.next = oldToNew[item.next]
            }
            // item 17208
            commandList.push(new Command(
            	"insert",
            	"free",
            	item.id,
            	item
            ));
            // item 172060003
            _ind17206++;
        }
        // item 17216
        var firstId = items[0].id
        // item 17218
        var freeList = editor.storage.free.list
        // item 17219
        if (freeList.length == 0) {
            
        } else {
            // item 17222
            var last = freeList.length - 1
            var prevId = freeList[last]
            // item 17217
            pushUpdate(
            	commandList,
            	"free",
            	prevId,
            	{ next: firstId }
            )
        }
        // item 18018
        var ids = Utils.objectValues(oldToNew)
        // item 17223
        applyCommands(
        	editor,
        	commandList,
        	ids
        );
    }
}

function pasteInSocket(editor, prim) {
    var _sw134800000_ = 0;
    // item 13459
    var socket = prepareSocketOp(editor, prim);
    // item 13460
    var graph = editor.storage.graph;
    // item 14554
    if (canAddMore(editor, 2)) {
        // item 13461
        var target = graph.getItem(socket.id);
        // item 15302
        if (downRole(target)) {
            // item 13475
            if (socket.action == "block") {
                // item 13477
                pasteBlock(editor, socket.id);
            }
        } else {
            // item 13466
            if (target.isVertical) {
                // item 13472
                var below = graph.getNode(target.tail);
                // item 13479
                if ((below.type == socket.action) && (below.type == "case")) {
                    // item 13474
                    pasteCase(editor, below.id);
                }
            } else {
                // item 13469
                var branch = getBranchForEdge(graph, target);
                // item 13478
                if ((branch) && (branch.type == socket.action)) {
                    // item 134800000
                    _sw134800000_ = socket.action;
                    // item 134800001
                    if (_sw134800000_ === "case") {
                        // item 13471
                        pasteCase(editor, branch.id);
                    } else {
                        // item 134800002
                        if (_sw134800000_ === "branch") {
                            // item 13487
                            pasteBranch(editor, branch.id);
                        }
                    }
                } else {
                    // item 15275
                    if (socket.action == "duration") {
                        // item 15277
                        pasteDuration(editor, socket.id);
                    } else {
                        // item 18150
                        pasteBlock(editor, socket.id);
                    }
                }
            }
        }
    }
}

function pasteMind(x, y, actions) {
    // item 21923
    var menu = []
    // item 21924
    var subtree = getClipboard("mind")
    // item 21925
    if (subtree) {
        // item 219210001
        var _ind21921 = 0;
        var _col21921 = actions;
        var _len21921 = _col21921.length;
        while (true) {
            // item 219210002
            if (_ind21921 < _len21921) {
                
            } else {
                break;
            }
            // item 219210004
            var action = _col21921[_ind21921];
            // item 21920
            addMindPasteAction(action, subtree, menu)
            // item 219210003
            _ind21921++;
        }
        // item 21928
        showContextMenu(x, y - 30, menu)
    }
}

function pasteText(editor, nodeId) {
    // item 13055
    var clip = getClipboard("text");
    // item 13056
    if (clip) {
        // item 19090
        var text = ""
        // item 19088
        if (clip.content) {
            // item 19089
            text = clip.content.txt || ""
        }
        // item 17967
        var item = getAnyItem(editor.storage, nodeId)
        var old = getContent(item)
        var newContent = setContentTxt(
        	old,
        	text
        )
        // item 9579
        setItemText(editor, nodeId, newContent);
    }
}

function performChange(editor, command, isUndo) {
    var _sw14890000_ = 0;
    var _sw14970000_ = 0;
    var _sw166740000_ = 0;
    var _sw15080000_ = 0;
    // item 15763
    var storage = editor.storage;
    // item 14890000
    _sw14890000_ = command.table;
    // item 14890001
    if (_sw14890000_ === "diagrams") {
        // item 1496
        updateDiagram(
        	storage,
        	command,
        	isUndo
        );
    } else {
        // item 14890002
        if (_sw14890000_ === "nodes") {
            // item 14970000
            _sw14970000_ = command.type;
            // item 14970001
            if (_sw14970000_ === "insert") {
                // item 1504
                runItemInsert(
                	editor, 
                	command,
                	isUndo
                );
            } else {
                // item 14970002
                if (_sw14970000_ === "update") {
                    // item 1505
                    runNodeUpdate(
                    	editor, 
                    	command,
                    	isUndo
                    );
                } else {
                    // item 14970003
                    if (_sw14970000_ === "delete") {
                        
                    } else {
                        // item 14970004
                        throw "Unexpected switch value: " + _sw14970000_;
                    }
                    // item 1506
                    runItemDelete(
                    	storage, 
                    	command,
                    	isUndo
                    );
                }
            }
        } else {
            // item 14890003
            if (_sw14890000_ === "free") {
                // item 166740000
                _sw166740000_ = command.type;
                // item 166740001
                if (_sw166740000_ === "insert") {
                    // item 16681
                    runFreeInsert(
                    	editor, 
                    	command,
                    	isUndo
                    );
                } else {
                    // item 166740002
                    if (_sw166740000_ === "update") {
                        // item 16682
                        runFreeUpdate(
                        	editor, 
                        	command,
                        	isUndo
                        );
                    } else {
                        // item 166740003
                        if (_sw166740000_ === "delete") {
                            
                        } else {
                            // item 166740004
                            throw "Unexpected switch value: " + _sw166740000_;
                        }
                        // item 16683
                        runFreeDelete(
                        	storage, 
                        	command,
                        	isUndo
                        );
                    }
                }
            } else {
                // item 14890004
                if (_sw14890000_ === "edges") {
                    
                } else {
                    // item 14890005
                    throw "Unexpected switch value: " + _sw14890000_;
                }
                // item 15080000
                _sw15080000_ = command.type;
                // item 15080001
                if (_sw15080000_ === "insert") {
                    // item 1515
                    runItemInsert(
                    	editor, 
                    	command,
                    	isUndo
                    );
                } else {
                    // item 15080002
                    if (_sw15080000_ === "delete") {
                        
                    } else {
                        // item 15080003
                        throw "Unexpected switch value: " + _sw15080000_;
                    }
                    // item 1517
                    runItemDelete(
                    	storage, 
                    	command,
                    	isUndo
                    );
                }
            }
        }
    }
}

function performLocalChange(editor, commands, isUndo) {
    // item 19986
    var count = commands.length;
    var i;
    // item 19983
    if (isUndo) {
        // item 199870001
        i = count - 1;
        while (true) {
            // item 199870002
            if (i >= 0) {
                
            } else {
                break;
            }
            // item 19989
            performChange(editor, commands[i], true);
            // item 199870003
            i--;
        }
    } else {
        // item 199800001
        i = 0;
        while (true) {
            // item 199800002
            if (i < count) {
                
            } else {
                break;
            }
            // item 19982
            performChange(editor, commands[i], false);
            // item 199800003
            i++;
        }
    }
}

function performRedo() {
    // item 16476
    if (ignoreCommand()) {
        
    } else {
        // item 12362
        var undo = self.undo;
        // item 12359
        if (undo.next >= undo.steps.length) {
            
        } else {
            // item 12365
            var step = undo.steps[undo.next];
            // item 18940
            addTrace("redo", step.info)
            // item 12364
            executeCommands(
            	self,
            	step.commands,
            	step.after,
            	false,
            	true
            );
            // item 23111
            persistChanges(step.commands, false)
            // item 12363
            undo.next++;
        }
    }
}

function performUndo() {
    // item 16479
    if (ignoreCommand()) {
        
    } else {
        // item 12352
        var undo = self.undo;
        // item 12349
        if (undo.next > 0) {
            // item 12353
            undo.next--;
            // item 12355
            var step = undo.steps[undo.next];
            // item 18941
            addTrace("undo", step.info)
            // item 12354
            executeCommands(
            	self,
            	step.commands,
            	step.before,
            	true,
            	true
            );
            // item 23112
            persistChanges(step.commands, true)
        }
    }
}

function persistAndRedraw(editor, state, redraw) {
    // item 20009
    var storage = editor.storage;
    // item 20004
    var error = storage.graph.checkEdges();
    // item 20002
    if (error) {
        // item 20005
        Utils.throwError(error);
    } else {
        // item 20006
        error = rebuildFree(editor)
        // item 20008
        if (error) {
            // item 20005
            Utils.throwError(error);
        } else {
            // item 19996
            if (redraw) {
                // item 20000
                restoreState(editor, state);
                // item 20007
                buildTextBoxes()
                // item 19999
                redrawCanvas(editor);
            }
        }
    }
}

function persistChange(pers, command, isUndo) {
    var _sw231280000_ = 0;
    var _sw231360000_ = 0;
    // item 231280000
    _sw231280000_ = command.table;
    // item 231280001
    if (_sw231280000_ === "diagrams") {
        // item 23213
        var fields
        // item 23214
        if (isUndo) {
            // item 23217
            fields = command.undo
        } else {
            // item 23218
            fields = command.fields
        }
        // item 23212
        pers.updateDiagram(fields)
    } else {
        // item 231360000
        _sw231360000_ = command.type;
        // item 231360001
        if (_sw231360000_ === "insert") {
            // item 23173
            if (isUndo) {
                // item 23179
                pers.remove(command.id);
            } else {
                // item 23177
                var item = copyStorageItem(command.fields);
                item.id = command.id;
                // item 23180
                pers.add(item);
            }
        } else {
            // item 231360002
            if (_sw231360000_ === "update") {
                // item 23198
                var fields;
                // item 23193
                if (isUndo) {
                    // item 23197
                    fields = command.undo;
                } else {
                    // item 23196
                    fields = command.fields;
                }
                // item 23199
                fields.id = command.id;
                // item 23200
                pers.update(fields);
            } else {
                // item 231360003
                if (_sw231360000_ === "delete") {
                    
                } else {
                    // item 231360004
                    throw "Unexpected switch value: " + _sw231360000_;
                }
                // item 23201
                if (isUndo) {
                    // item 23206
                    var item = copyStorageItem(command.undo);
                    item.id = command.id;
                    // item 23208
                    pers.add(item);
                } else {
                    // item 23207
                    pers.remove(command.id);
                }
            }
        }
    }
}

function persistChanges(commands, isUndo) {
    // item 23222
    var pers = self.storage.persistence
    // item 232190001
    var _ind23219 = 0;
    var _col23219 = commands;
    var _len23219 = _col23219.length;
    while (true) {
        // item 232190002
        if (_ind23219 < _len23219) {
            
        } else {
            break;
        }
        // item 232190004
        var command = _col23219[_ind23219];
        // item 23221
        persistChange(
        	pers,
        	command,
        	isUndo
        )
        // item 232190003
        _ind23219++;
    }
    // item 11248
    pers.persist()
}

function planDeleteCase(graph, node, plan) {
    // item 8484
    var junId = graph.getNodeUp(node);
    var jun = graph.getNode(junId);
    var firstId = graph.getNodeDown(node);
    // item 8489
    if (jun.right) {
        // item 8486
        pokeHor(graph, jun, plan);
    } else {
        // item 8492
        plan.edges[jun.left] = true;
        plan.nodes[junId] = true;
    }
    // item 8488
    plan.edges[node.up] = true;
    // item 8487
    planDeleteMain(graph, node.id, plan);
}

function planDeleteCases(graph, nodeId, plan) {
    // item 8449
    var joints = getSelectJoints(
    	graph,
    	nodeId
    );
    // item 8450
    var count = joints.length;
    var i;
    // item 84510001
    i = count - 1;
    while (true) {
        // item 84510002
        if (i > 0) {
            
        } else {
            break;
        }
        // item 8453
        var joint = joints[i];
        // item 8457
        plan.nodes[joint.id] = true;
        // item 8456
        plan.edges[joint.left] = true;
        plan.edges[joint.down] = true;
        // item 8458
        var caseId = graph.getNodeDown(joint);
        // item 8455
        planDeleteMain(graph, caseId, plan);
        // item 84510003
        i--;
    }
}

function planDeleteLoop(graph, node, plan) {
    // item 9139
    pokeVer(graph, node, plan);
    // item 12963
    var lowId = Drakon.findEndLoop(graph, node);
    // item 12964
    if (lowId) {
        // item 9147
        var low = graph.getNode(lowId);
        // item 12968
        plan.mainDeletes.push(lowId);
        // item 12967
        pokeVer(graph, low, plan);
    }
}

function planDeleteLoopEnd(graph, node, plan) {
    // item 13850
    pokeVer(graph, node, plan);
    // item 13852
    var upId = Drakon.findBeginLoop(graph, node);
    // item 13853
    if (upId) {
        // item 13851
        var up = graph.getNode(upId);
        // item 13857
        plan.mainDeletes.push(upId);
        // item 13856
        pokeVer(graph, up, plan);
    }
}

function planDeleteMain(graph, nodeId, plan) {
    var _sw57040000_ = 0;
    // item 5697
    var node = graph.getNode(nodeId);
    // item 5698
    if (node.down) {
        // item 5724
        var downId = graph.getNodeDown(node);
        // item 57040000
        _sw57040000_ = node.type;
        // item 57040001
        if (_sw57040000_ === "question") {
            // item 5936
            plan.nodes[nodeId] = true;
            // item 5723
            plan.edges[node.down] = true;
            // item 5729
            makeSecDeletionPlan(graph, node.right, plan);
            // item 5725
            planDeleteMain(graph, downId, plan);
        } else {
            // item 57040002
            if (_sw57040000_ === "select") {
                // item 8415
                var down = graph.getNode(downId);
                var caseId = graph.getNodeDown(down);
                // item 8418
                plan.nodes[nodeId] = true;
                plan.nodes[downId] = true;
                // item 8417
                plan.edges[node.down] = true;
                plan.edges[down.down] = true;
                // item 8419
                planDeleteCases(graph, nodeId, plan);
                // item 8416
                planDeleteMain(graph, caseId, plan);
            } else {
                // item 57040003
                if (_sw57040000_ === "junction") {
                    // item 5732
                    var jType = describeJunction(node);
                    // item 5733
                    if (jType === "left-t") {
                        // item 8469
                        var leftId = graph.getNodeLeft(node);
                        var left = graph.getNode(leftId);
                        // item 8470
                        if (left.type === "question") {
                            // item 5960
                            plan.stairs[nodeId] = true;
                        } else {
                            // item 5938
                            plan.nodes[nodeId] = true;
                            plan.edges[node.down] = true;
                            // item 5728
                            planDeleteMain(graph, downId, plan);
                        }
                    } else {
                        // item 5938
                        plan.nodes[nodeId] = true;
                        plan.edges[node.down] = true;
                        // item 5728
                        planDeleteMain(graph, downId, plan);
                    }
                } else {
                    // item 5938
                    plan.nodes[nodeId] = true;
                    plan.edges[node.down] = true;
                    // item 5728
                    planDeleteMain(graph, downId, plan);
                }
            }
        }
    } else {
        // item 5716
        plan.nodes[nodeId] = true;
        // item 5820
        planDeleteSkewerEnd(
        	graph,
        	node,
        	plan
        );
    }
}

function planDeleteQuestion(graph, node, plan) {
    // item 8381
    var rightId =graph.getNodeRight(node);
    var right = graph.getNode(rightId);
    var rightType = describeJunction(right);
    // item 8385
    pokeVer(graph, node, plan);
    plan.edges[node.right] = true;
    // item 83880001
    if (rightType === "left-t") {
        // item 8386
        pokeVer(graph, right, plan);
    } else {
        // item 83880002
        if (rightType === "left-down") {
            // item 8393
            plan.nodes[rightId] = true;
            plan.edges[right.down] = true;
            // item 8395
            var downId = graph.getNodeDown(right);
            // item 8394
            planDeleteMain(graph, downId, plan, true);
        } else {
            // item 83880003
            if (rightType === "left-up") {
                
            } else {
                // item 83880004
                throw "Unexpected switch value: " + rightType;
            }
            // item 8401
            var right = graph.getNode(rightId);
            // item 8402
            deleteArrow(graph, right, plan);
        }
    }
}

function planDeleteSelect(graph, node, plan) {
    // item 8464
    var junId = graph.getNodeDown(node);
    var jun = graph.getNode(junId);
    var caseId = graph.getNodeDown(jun);
    var caseNode = graph.getNode(caseId);
    // item 9215
    plan.mainDeletes.push(caseId);
    // item 8468
    pokeVer(graph, node, plan);
    pokeVer(graph, jun, plan);
    pokeVer(graph, caseNode, plan);
    // item 8467
    planDeleteCases(graph, node.id, plan);
}

function planDeleteSkewerEnd(graph, node, plan) {
    // item 5795
    if (node.type === "junction") {
        // item 5922
        if (node.left) {
            // item 5923
            if (node.right) {
                // item 5948
                var rightId =graph.getNodeRight(node);
                // item 5946
                if (hasNodesOnRight(graph, rightId, plan)) {
                    // item 5926
                    pokeHor(
                    	graph,
                    	node,
                    	plan
                    );
                } else {
                    // item 5808
                    var leftId = graph.getNodeLeft(node);
                    var left = graph.getNode(leftId);
                    // item 5805
                    plan.edges[node.left] = true;
                    // item 5807
                    pokeVer(graph, left, plan);
                }
            } else {
                // item 5808
                var leftId = graph.getNodeLeft(node);
                var left = graph.getNode(leftId);
                // item 5805
                plan.edges[node.left] = true;
                // item 5807
                pokeVer(graph, left, plan);
            }
        } else {
            // item 5809
            if (node.right) {
                // item 5810
                var rightId =graph.getNodeRight(node);
                var right = graph.getNode(rightId);
                var rightEdge = graph.getEdge(node.right);
                // item 5811
                plan.edges[node.right] = true;
                // item 16417
                if (isArrowStart(graph, right)) {
                    // item 16419
                    deleteArrow(graph, right, plan);
                } else {
                    // item 6617
                    if (rightEdge.role === "right") {
                        // item 6619
                        deleteRight(
                        	graph,
                        	right,
                        	plan
                        );
                    } else {
                        // item 5817
                        pokeVer(graph, right, plan);
                    }
                }
            }
        }
    }
}

function pokeHor(graph, node, plan) {
    // item 5915
    pokeOut(
    	graph,
    	node,
    	plan,
    	"left",
    	"right",
    	plan.horHoles
    );
}

function pokeOut(graph, node, plan, upProp, downProp, holes) {
    // item 5909
    var id = node.id;
    var up = node[upProp];
    var down = node[downProp];
    // item 5828
    if ((up) && (down)) {
        // item 5827
        plan.nodes[id] = true;
        // item 5842
        plan.edges[up] = true;
        plan.edges[down] = true;
        // item 5832
        var headId = graph.getEdge(up).head;
        var tailId = graph.getEdge(down).tail;
        // item 5840
        holes[id] = {
        	up: headId,
        	down: tailId,
        	dir: upProp
        };
    }
}

function pokeVer(graph, node, plan) {
    // item 5921
    pokeOut(
    	graph,
    	node,
    	plan,
    	"up",
    	"down",
    	plan.verHoles
    );
}

function postEdit(commands) {
    // item 22810
    var edit = {
    	dirty: false,
    	commands: commands
    }
    // item 22736
    sameBranchHeight(edit)
    // item 22912
    sameAddressHeight(edit)
    // item 22985
    autoCycleMarks(edit)
    // item 22817
    persistChanges(
    	edit.commands,
    	false
    )
    // item 22811
    if (edit.dirty) {
        // item 22818
        buildTextBoxes()
        // item 22814
        redrawCanvas(self)
    }
    // item 22735
    return edit.commands
}

function prepareSocketOp(editor, prim) {
    // item 11718
    var socket = editor.canvas.sockets[prim];
    // item 11719
    deselectAll(editor);
    redrawCanvas(editor);
    // item 11720
    editor.dirty = true;
    // item 11721
    return socket;
}

function probeDeleteItem(graph, node, visited) {
    var _sw88420000_ = 0;
    // item 8932
    var downId, down;
    var canRight;
    // item 8837
    if (node.id in visited) {
        // item 8840
        return true;
    } else {
        // item 8841
        visited[node.id] = true;
        // item 88420000
        _sw88420000_ = node.type;
        // item 88420001
        if ((_sw88420000_ === "beginend") || (_sw88420000_ === "end")) {
            // item 8840
            return true;
        } else {
            // item 88420003
            if (_sw88420000_ === "junction") {
                // item 8877
                return probeDeleteJunction(
                	graph,
                	node,
                	visited
                );
            } else {
                // item 88420004
                if (_sw88420000_ === "question") {
                    // item 8880
                    canRight = probeDeleteQuestion(
                    	graph,
                    	node,
                    	visited
                    );
                    // item 8941
                    if (canRight) {
                        // item 8939
                        downId = graph.getNodeDown(node);
                        down = graph.getNode(downId);
                        // item 8940
                        return probeDeleteItem(graph, down, visited);
                    } else {
                        // item 8943
                        return false;
                    }
                } else {
                    // item 88420005
                    if (_sw88420000_ === "select") {
                        // item 8926
                        canRight = probeDeleteSelect(
                        	graph,
                        	node,
                        	visited
                        );
                        // item 8927
                        if (canRight) {
                            // item 8931
                            var junId = graph.getNodeDown(node);
                            var jun = graph.getNode(junId);
                            downId = graph.getNodeDown(jun);
                            down = graph.getNode(downId);
                            // item 8938
                            return probeDeleteItem(graph, down, visited);
                        } else {
                            // item 8930
                            return false;
                        }
                    } else {
                        // item 8933
                        if (node.down) {
                            // item 8936
                            downId = graph.getNodeDown(node);
                            down = graph.getNode(downId);
                            // item 8937
                            return probeDeleteItem(graph, down, visited);
                        } else {
                            // item 8929
                            return true;
                        }
                    }
                }
            }
        }
    }
}

function probeDeleteJunction(graph, node, visited) {
    // item 8865
    var type = describeJunction(node);
    // item 8866
    if (type === "right-t") {
        // item 8868
        var rightId =graph.getNodeRight(node);
        // item 8869
        if (rightId in visited) {
            // item 8871
            if (node.down) {
                // item 8876
                var downId = graph.getNodeDown(node);
                var down = graph.getNode(downId);
                // item 8874
                return probeDeleteItem(graph, down, visited);
            } else {
                // item 8873
                return true;
            }
        } else {
            // item 8901
            var edge = graph.getEdge(node.right);
            // item 8902
            if (edge.role === "arrow") {
                // item 8871
                if (node.down) {
                    // item 8876
                    var downId = graph.getNodeDown(node);
                    var down = graph.getNode(downId);
                    // item 8874
                    return probeDeleteItem(graph, down, visited);
                } else {
                    // item 8873
                    return true;
                }
            } else {
                // item 8870
                return false;
            }
        }
    } else {
        // item 8871
        if (node.down) {
            // item 8876
            var downId = graph.getNodeDown(node);
            var down = graph.getNode(downId);
            // item 8874
            return probeDeleteItem(graph, down, visited);
        } else {
            // item 8873
            return true;
        }
    }
}

function probeDeleteQuestion(graph, node, visited) {
    // item 8892
    var rightId =graph.getNodeRight(node);
    var right = graph.getNode(rightId);
    // item 8893
    if (((right.down) && (!(right.up))) && (!(probeDeleteItem(graph, right, visited)))) {
        // item 8891
        return false;
    } else {
        // item 8944
        return true;
    }
}

function probeDeleteSelect(graph, node, visited) {
    // item 8918
    var joints = getSelectJoints(graph, node.id);
    // item 8919
    var i;
    // item 89200001
    i = joints.length - 1;
    while (true) {
        // item 89200002
        if (i > 0) {
            
        } else {
            // item 8923
            return true;
        }
        // item 8922
        var joint = joints[i];
        // item 8916
        var downId = graph.getNodeDown(joint);
        var down = graph.getNode(downId);
        // item 8917
        var can = probeDeleteItem(
        	graph,
        	down,
        	visited
        );
        // item 8910
        if (can) {
            
        } else {
            // item 8908
            return false;
        }
        // item 89200003
        i--;
    }
}

function pullDownSkewerItem(graph, itemIds, result) {
    // item 210710001
    var _ind21071 = 0;
    var _col21071 = itemIds;
    var _len21071 = _col21071.length;
    while (true) {
        // item 210710002
        if (_ind21071 < _len21071) {
            
        } else {
            break;
        }
        // item 210710004
        var itemId = _col21071[_ind21071];
        // item 21073
        var item = graph.getItem(itemId);
        // item 21056
        result.add(item.id)
        // item 21057
        if (item.type == "junction") {
            // item 21059
            if (item.up) {
                // item 21053
                var above = graph.getNodeUpEx(item)
                // item 21061
                if (above.role == "header") {
                    // item 21060
                    result.add(above.id)
                }
            }
        } else {
            // item 21062
            if (item.role == "sub") {
                // item 21066
                var above = graph.getNodeUpEx(item)
                // item 21065
                var bridge = graph.getHorizontal(
                	above.id
                )
                // item 21067
                pullDownSkewerItem(
                	graph,
                	bridge,
                	result
                )
                break;
            }
        }
        // item 210710003
        _ind21071++;
    }
}

function pushAside(pgraph, node, x, movedNodes) {
    // item 6508
    var delta;
    // item 6505
    if ((node.x < x) && (!(node.type == "duration"))) {
        // item 6509
        delta = x - node.box.right - Config.METRE;
    } else {
        // item 6510
        delta = x - node.box.left + Config.METRE;
    }
    // item 6511
    pgraph.moveRight(
    	node.id,
    	delta,
    	movedNodes
    );
}

function pushDeleteArrow(editor, graph, rightBottom, commandList) {
    // item 8053
    var rightTopId = graph.getNodeUp(rightBottom);
    var rightTop = graph.getNode(rightTopId);
    var leftTopId = graph.getNodeLeft(rightTop);
    var leftTop = graph.getNode(leftTopId);
    // item 8048
    pushDeleteEdge(
    	commandList,
    	rightBottom.up
    );
    // item 8054
    pushDeleteEdge(
    	commandList,
    	rightTop.left
    );
    // item 8050
    pushDeleteNode(
    	commandList,
    	rightBottom.id
    );
    // item 8055
    pushDeleteNode(
    	commandList,
    	rightTopId
    );
    // item 8056
    deleteJunctionBetween(
    	editor,
    	graph,
    	leftTop,
    	commandList
    );
}

function pushDeleteEdge(commandList, id) {
    // item 4079
    var deleteUp = new Command(
    	"delete",
    	"edges",
    	id,
    	null
    );
    commandList.push(deleteUp);
}

function pushDeleteNode(commandList, id) {
    // item 4087
    var deleteDown = new Command(
    	"delete",
    	"nodes",
    	id,
    	null
    );
    commandList.push(deleteDown);
}

function pushDeleteNodeEx(graph, commandList, id) {
    // item 15167
    var node = graph.getNode(id);
    var duration = Drakon.getDuration(graph, node);
    // item 15168
    if (duration) {
        // item 15171
        pushDeleteEdge(
        	commandList,
        	node.left
        );
        // item 15172
        pushDeleteNode(
        	commandList,
        	duration.id
        );
    }
    // item 15173
    pushDeleteNode(
    	commandList,
    	id
    );
}

function pushDeleteSubgraph(commList, nodes, edges) {
    // item 107770001
    var _ind10777 = 0;
    var _col10777 = edges;
    var _keys10777 = Object.keys(_col10777); 
    var _len10777 = _keys10777.length;
    while (true) {
        // item 107770002
        if (_ind10777 < _len10777) {
            
        } else {
            break;
        }
        // item 107770004
        var edgeId = _keys10777[_ind10777]; var _ = _col10777[edgeId];
        // item 10779
        pushDeleteEdge(
        	commList,
        	edgeId
        );
        // item 107770003
        _ind10777++;
    }
    // item 107750001
    var _ind10775 = 0;
    var _col10775 = nodes;
    var _keys10775 = Object.keys(_col10775); 
    var _len10775 = _keys10775.length;
    while (true) {
        // item 107750002
        if (_ind10775 < _len10775) {
            
        } else {
            break;
        }
        // item 107750004
        var nodeId = _keys10775[_ind10775]; var _ = _col10775[nodeId];
        // item 10780
        pushDeleteNode(
        	commList,
        	nodeId
        );
        // item 107750003
        _ind10775++;
    }
}

function pushInsertDown(commandList, edgeId, up, down) {
    // item 6616
    pushInsertVertical(
    	commandList,
    	edgeId,
    	up,
    	down,
    	"down"
    );
}

function pushInsertFree(render, commandList, id, type, x, y, w, h, content) {
    // item 17353
    var item = makeDummyItem(
    	1,
    	render,
    	type,
    	content
    )
    // item 17354
    var fit = Drakon.fitItem(item, render)
    // item 16769
    var fields = {
    	id: id,
    	type: type,
    	free: true,
    	x: x,
    	y: y,
    	w: w,
    	h: h,
    	a: fit.a,
    	tb: fit.tb,
    	tb2: fit.tb2,
    	content: content
    };
    // item 16771
    commandList.push(new Command(
    	"insert",
    	"free",
    	id,
    	fields
    ));
}

function pushInsertHorizontal(commandList, edgeId, up, down, role) {
    // item 4123
    var newEdge = new Command(
    	"insert",
    	"edges",
    	edgeId,
    	{
    		type: "horizontal",
    		isVertical: false,
    		isLine: true,
    		head: up,
    		tail: down,
    		role: role
    	}
    );
    commandList.push(newEdge);
}

function pushInsertJunction(commList, id, x, y) {
    // item 16391
    var node = {
    	type: "junction",
    	x: x,
    	y: y,
    	w: 0,
    	h: 0
    };
    // item 4115
    pushInsertNode(
    	commList,
    	id,
    	node
    );
}

function pushInsertNode(commandList, id, node) {
    // item 16031
    var fields = 	{
    	type: node.type,
    	isLine: false,
    	x: node.x,
    	y: node.y,
    	w: node.w,
    	h: node.h,
    	a: node.a,
    	content: node.content,
    	flag1: node.flag1,
    	role: node.role
    };
    // item 16195
    if (node.tb) {
        // item 16198
        fields.tb = node.tb;
    }
    // item 16199
    if (node.tb2) {
        // item 16202
        fields.tb2 = node.tb2;
    }
    // item 16030
    commandList.push(new Command(
    	"insert",
    	"nodes",
    	id,
    	fields
    ));
}

function pushInsertNodeAt(render, commandList, id, type, x, y, w, h, content) {
    // item 16387
    var node = {
    	id: id,
    	type: type,
    	x: x,
    	y: y,
    	w: w,
    	h: h,
    	content: content
    };
    // item 23065
    adjustFontSize(node)
    // item 16390
    var size = Drakon.fitItem(node, render);
    setItemDims(node, size);
    // item 16388
    pushInsertNode(
    	commandList,
    	id,
    	node
    );
}

function pushInsertVertical(commandList, edgeId, up, down, role) {
    // item 6615
    var newEdge = new Command(
    	"insert",
    	"edges",
    	edgeId,
    	{
    		type: "vertical",
    		isVertical: true,
    		isLine: true,
    		head: up,
    		tail: down,
    		role: role
    	}
    );
    commandList.push(newEdge);
}

function pushLedgeLeft(pgraph, startNodeId, endNodeId, x, movedNodes) {
    // item 4787
    var graph = pgraph.graph;
    // item 4786
    var wall = scanLeftWall(
    	graph,
    	startNodeId,
    	endNodeId
    );
    // item 47880001
    var _ind4788 = 0;
    var _col4788 = wall.nodes;
    var _len4788 = _col4788.length;
    while (true) {
        // item 47880002
        if (_ind4788 < _len4788) {
            
        } else {
            break;
        }
        // item 47880004
        var id = _col4788[_ind4788];
        // item 4790
        var node = graph.getNode(id);
        var delta = x - node.x - Config.METRE;
        // item 4791
        if (delta < 0) {
            // item 4794
            pgraph.moveRight(
            	id,
            	delta,
            	movedNodes
            );
        }
        // item 47880003
        _ind4788++;
    }
    // item 4883
    return wall.lowest;
}

function pushUpdate(commandList, table, id, fields) {
    // item 16787
    commandList.push(new Command(
    	"update",
    	table,
    	id,
    	fields
    ));
}

function pushUpdateDiagram(commandList, name) {
    // item 11310
    var fields = {
    	name: name
    };
    // item 11312
    commandList.push(new Command(
    	"update",
    	"diagrams",
    	"diagram",
    	fields
    ));
}

function questionOnLeft(graph, node) {
    // item 11872
    var leftNodeId = graph.getNodeLeft(node);
    var leftNode = graph.getNode(leftNodeId);
    // item 11873
    if (leftNode.type == "question") {
        // item 11874
        return true;
    } else {
        // item 11871
        return false;
    }
}

function rayTraceDown(pgraph, x, y, y2, movedNodes) {
    // item 6477
    var graph = pgraph.graph;
    // item 6461
    var end = y2 + Config.METRE;
    var top = Math.floor(y + Config.METRE / 2);
    var bottom = y;
    var left = x - 1;
    var right = x + Config.METRE;
    while (true) {
        // item 6476
        bottom += Config.METRE;
        // item 6478
        if (bottom >= end) {
            break;
        }
        // item 6481
        
        var needle = new Utils.Box(left, top, right, bottom);
        // item 64620001
        var _ind6462 = 0;
        var _col6462 = graph.items;
        var _keys6462 = Object.keys(_col6462); 
        var _len6462 = _keys6462.length;
        while (true) {
            // item 64620002
            if (_ind6462 < _len6462) {
                
            } else {
                break;
            }
            // item 64620004
            var iid = _keys6462[_ind6462]; var item = _col6462[iid];
            // item 6468
            if ((Utils.boxesIntersect(needle, item.box)) && (!(item.isVertical))) {
                // item 6464
                if (item.isLine) {
                    // item 6472
                    pgraph.moveDown(
                    	item.tail,
                    	Config.METRE,
                    	movedNodes
                    );
                    break;
                }
                // item 6484
                if (item.x == x) {
                    
                } else {
                    // item 6499
                    pushAside(
                    	pgraph,
                    	item,
                    	x,
                    	movedNodes
                    );
                    break;
                }
            }
            // item 64620003
            _ind6462++;
        }
    }
}

function rayTraceDownEx(pgraph, x, y, y2, topNodeId, movedNodes) {
    // item 6528
    var graph = pgraph.graph;
    // item 6527
    var end = y2 + Config.METRE;
    var top = Math.floor(y + Config.METRE / 2);
    var bottom = y;
    var left = x - 1;
    var right = x + 1;
    // item 6529
    var probe = new Utils.Box(left, top, right, end);
    var x2 = x;
    // item 65300001
    var _ind6530 = 0;
    var _col6530 = graph.nodes;
    var _keys6530 = Object.keys(_col6530); 
    var _len6530 = _keys6530.length;
    while (true) {
        // item 65300002
        if (_ind6530 < _len6530) {
            
        } else {
            break;
        }
        // item 65300004
        var nid = _keys6530[_ind6530]; var node = _col6530[nid];
        // item 6532
        if (((node.x > x) || (node.type == "duration")) && (Utils.boxesIntersect(node.box, probe))) {
            // item 6535
            var leftEdge = node.box.left - Config.METRE;
            // item 6536
            if (leftEdge < x2) {
                // item 6537
                x2 = leftEdge;
            }
        }
        // item 65300003
        _ind6530++;
    }
    // item 6539
    if (x2 == x) {
        
    } else {
        // item 6542
        var delta = x2 - x;
        // item 6543
        pgraph.moveRight(
        	topNodeId,
        	delta,
        	movedNodes
        );
    }
    // item 6566
    left = x2 - 1;
    right = x2 + 1;
    while (true) {
        // item 6567
        bottom += Config.METRE;
        // item 6556
        if (bottom >= end) {
            break;
        }
        // item 6559
        
        var needle = new Utils.Box(left, top, right, bottom);
        // item 65470001
        var _ind6547 = 0;
        var _col6547 = graph.items;
        var _keys6547 = Object.keys(_col6547); 
        var _len6547 = _keys6547.length;
        while (true) {
            // item 65470002
            if (_ind6547 < _len6547) {
                
            } else {
                break;
            }
            // item 65470004
            var iid = _keys6547[_ind6547]; var item = _col6547[iid];
            // item 6552
            if ((Utils.boxesIntersect(needle, item.box)) && (!(item.isVertical))) {
                // item 6549
                if (item.isLine) {
                    // item 15182
                    if (item.role == "lstick") {
                        
                    } else {
                        // item 6554
                        moveHorLeft(
                        	pgraph,
                        	item.tail,
                        	x2,
                        	movedNodes
                        );
                    }
                    break;
                }
                // item 6561
                if (item.x == x2) {
                    
                } else {
                    // item 6565
                    pushAside(
                    	pgraph,
                    	item,
                    	x2,
                    	movedNodes
                    );
                    break;
                }
            }
            // item 65470003
            _ind6547++;
        }
    }
}

function rayTraceRight(pgraph, x, x2, y, movedNodes) {
    // item 6432
    var graph = pgraph.graph;
    // item 6414
    var end = x2 + Config.METRE;
    var left = Math.floor(x + Config.METRE / 2);
    var right = x;
    var top = y - Config.METRE + 1;
    var bottom = y + 1;
    while (true) {
        // item 6431
        right += Config.SNAP;
        // item 6436
        
        var needle = new Utils.Box(left, top, right, bottom);
        // item 64150001
        var _ind6415 = 0;
        var _col6415 = graph.items;
        var _keys6415 = Object.keys(_col6415); 
        var _len6415 = _keys6415.length;
        while (true) {
            // item 64150002
            if (_ind6415 < _len6415) {
                
            } else {
                break;
            }
            // item 64150004
            var iid = _keys6415[_ind6415]; var item = _col6415[iid];
            // item 6427
            var id;
            // item 6417
            if (item.isLine) {
                // item 6428
                id = item.tail;
                // item 6420
                if (item.isVertical) {
                    // item 6421
                    if (Utils.boxesIntersect(needle, item.box)) {
                        // item 6425
                        pgraph.moveRight(
                        	id,
                        	Config.SNAP,
                        	movedNodes
                        );
                        break;
                    }
                }
            } else {
                // item 6429
                id = item.id;
                // item 6421
                if (Utils.boxesIntersect(needle, item.box)) {
                    // item 6425
                    pgraph.moveRight(
                    	id,
                    	Config.SNAP,
                    	movedNodes
                    );
                    break;
                }
            }
            // item 64150003
            _ind6415++;
        }
        // item 6433
        if (right >= end) {
            break;
        }
    }
}

function rebuildFree(editor) {
    // item 16955
    var oldFree = editor.storage.free
    var newFree = new Utils.SortedSet()
    // item 16956
    var error = copyAndSort(
    	oldFree.set,
    	newFree
    )
    // item 17404
    if (error) {
        // item 17408
        return error
    } else {
        // item 16957
        editor.storage.free = newFree
        // item 17407
        return null
    }
}

function rebuildGrips(editor, ids) {
    // item 16338
    editor.grips = []
    var freeGrips = []
    var idList = Object.keys(ids)
    // item 163390001
    var _ind16339 = 0;
    var _col16339 = idList;
    var _len16339 = _col16339.length;
    while (true) {
        // item 163390002
        if (_ind16339 < _len16339) {
            
        } else {
            break;
        }
        // item 163390004
        var id = _col16339[_ind16339];
        // item 16341
        addDrnGrips(editor, id, freeGrips)
        // item 163390003
        _ind16339++;
    }
    // item 19133
    var moveAll = findGripAllPoint(freeGrips)
    // item 19136
    if (moveAll) {
        // item 19184
        var itemId = null
        // item 19185
        if (idList.length == 1) {
            // item 19188
            itemId = idList[0]
        }
        // item 19135
        addGrip(
        	editor.grips,
        	itemId,
        	moveAll.x,
        	moveAll.y,
        	Const.DRN_MOVE_ALL,
        	{}
        );
    }
    // item 19139
    gMoveAllPos = moveAll
}

function rebuildPhysicsCache(pgraph) {
    // item 14760
    //var expanders = getSoftExpanders();
    pgraph.rebuildCache();
}

function recalculateNextId(storage) {
    // item 21223
    var graphId = storage.graph.getMaxId()
    var freeId = storage.free.getMaxId()
    storage.nextId = Math.max(graphId, freeId) + 1
}

function recordDimension(node, result) {
    // item 7599
    var box = node.box;
    var right = box.right;
    var bottom  = box.bottom;
    // item 6312
    if (right > result.x) {
        // item 6315
        result.x = right;
    }
    // item 6316
    if (bottom > result.y) {
        // item 6319
        result.y = bottom;
        result.lowId = node.id;
    }
}

function redraw() {
    // item 14581
    redrawCanvas(self);
}

function redrawCanvas(editor) {
    // item 18975
    try {
    	redrawCanvasCore(editor, null)
    } catch (ex) {
    	CallTrace.error(ex)
    	throw ex
    }
}

function redrawCanvasCore(editor, insertionSocket) {
    // item 10845
    editor.render.clear();
    // item 10846
    editor.canvas = new CanvasCache(editor.render);
    // item 10844
    var graph = editor.storage.graph;
    // item 17564
    editor.render.setBackground(
    	editor.storage.background
    )
    // item 18477
    Items.setDiaLine(
    	editor.storage.diaLine,
    	editor.storage.diaLineThickness
    )
    // item 10870
    drawBasicItems(
    	editor.storage,
    	editor.canvas
    )
    // item 14593
    var ids = getSelectedIds(editor);
    // item 16353
    rebuildGrips(editor, ids);
    // item 10855
    Items.drawCandies(
    	editor.canvas.graph,
    	editor.canvas.free,
    	editor.render,
    	ids
    );
    // item 19140
    drawMoveAll(editor.render)
    // item 10866
    var selected = getSelectedItem(editor);
    var sockets;
    // item 10867
    if (selected) {
        // item 21400
        if (isMind()) {
            
        } else {
            // item 10864
            buildSideMarks(editor.canvas);
        }
        // item 10865
        sockets = buildSockets(
        	editor,
        	editor.canvas.graph, 
        	selected
        );
    } else {
        // item 11740
        if (insertionSocket) {
            // item 22118
            if (isMindSocket(insertionSocket)) {
                // item 22120
                sockets = buildMindSockets(
                	editor.canvas.graph,
                	insertionSocket
                )
            } else {
                // item 11742
                sockets = buildInsertionSockets(
                	editor.canvas.graph,
                	insertionSocket
                );
            }
        } else {
            // item 11743
            sockets = [];
        }
    }
    // item 108610001
    var _ind10861 = 0;
    var _col10861 = sockets;
    var _len10861 = _col10861.length;
    while (true) {
        // item 108610002
        if (_ind10861 < _len10861) {
            
        } else {
            break;
        }
        // item 108610004
        var socket = _col10861[_ind10861];
        // item 10863
        insertCanvasSocket(editor.canvas, socket);
        // item 108610003
        _ind10861++;
    }
    // item 14875
    editor.canvas.pgraph.rebuildCache();
}

function rememberFont(item, fonts) {
    // item 17876
    var content = item.content
    // item 17871
    if (content) {
        // item 17877
        var font = content.font
        // item 17874
        if (font) {
            // item 17875
            fonts[font] = true
        }
    }
}

function removeFormat(content) {
    // item 17962
    var copy = Utils.copyObject(content)
    // item 179630001
    var _ind17963 = 0;
    var _col17963 = gFormatNames;
    var _len17963 = _col17963.length;
    while (true) {
        // item 179630002
        if (_ind17963 < _len17963) {
            
        } else {
            break;
        }
        // item 179630004
        var name = _col17963[_ind17963];
        // item 17965
        delete copy[name]
        // item 179630003
        _ind17963++;
    }
    // item 17968
    copy.font = Utils.buildFontString(
    	false,
    	false,
    	Config.FONT_SIZE,
    	Config.FONT_FAMILY
    )
    // item 17966
    return copy
}

function renameBranch(editor, id, cont) {
    // item 10372
    var graph = editor.storage.graph;
    var node = graph.getNode(id);
    var oldCont = node.content;
    // item 10374
    var addresses = findManyNodesBy(
    	graph,
    	"type",
    	"address"
    );
    // item 10375
    var ids = [id];
    // item 103760001
    var _ind10376 = 0;
    var _col10376 = addresses;
    var _len10376 = _col10376.length;
    while (true) {
        // item 103760002
        if (_ind10376 < _len10376) {
            
        } else {
            break;
        }
        // item 103760004
        var address = _col10376[_ind10376];
        // item 10378
        if (contEqual(address.content, oldCont)) {
            // item 10381
            ids.push(address.id);
        }
        // item 103760003
        _ind10376++;
    }
    // item 10382
    setTextForManyItems(editor, ids, cont);
}

function renameDiagram(name) {
    // item 16634
    var graph = self.storage.graph
    // item 166350001
    var _ind16635 = 0;
    var _col16635 = graph.nodes;
    var _keys16635 = Object.keys(_col16635); 
    var _len16635 = _keys16635.length;
    while (true) {
        // item 166350002
        if (_ind16635 < _len16635) {
            
        } else {
            // item 19974
            var commList = []
            // item 19973
            pushUpdateDiagram(commList, name);
            // item 19972
            submitCommands(self, commList, true)
            break;
        }
        // item 166350004
        var id = _keys16635[_ind16635]; var node = _col16635[id];
        // item 16637
        if (node.role == "header") {
            // item 16642
            var old = getContent(node)
            // item 16641
            var content = setContentTxt(old, name)
            setItemText(self, id, content)
            break;
        }
        // item 166350003
        _ind16635++;
    }
}

function replaceExit(render, bgraph, graph2) {
    // item 19755
    var node
    // item 197330001
    var _ind19733 = 0;
    var _col19733 = bgraph.nodes;
    var _keys19733 = Object.keys(_col19733); 
    var _len19733 = _keys19733.length;
    while (true) {
        // item 197330002
        if (_ind19733 < _len19733) {
            
        } else {
            break;
        }
        // item 197330004
        var id = _keys19733[_ind19733]; var _ = _col19733[id];
        // item 19740
        node = graph2.getNode(id)
        // item 19735
        if (node.type == "end") {
            // item 19754
            var top = graph2.getNode(bgraph.top)
            var branch = graph2.getNodeDownEx(top)
            // item 19739
            node.type = "address"
            // item 19756
            node.w = branch.w
            node.h = branch.h
            node.content = Utils.copyObject(branch.content)
            // item 19757
            node.y += node.h
            // item 19759
            var y = node.y + node.h + Config.METRE
            // item 19760
            var jun = makeDummyJunction(
            	"jun01",
            	node.x,
            	y
            )
            // item 19761
            graph2.addItem(jun)
            // item 19762
            addDummyLine(
            	graph2,
            	"line01",
            	true,
            	node.id,
            	"jun01",
            	null
            )
            // item 19766
            bgraph.bottom = "jun01"
            bgraph.rBottom = "jun01"
            break;
        }
        // item 197330003
        _ind19733++;
    }
}

function restoreState(editor, state) {
    // item 2042
    editor.storage.selection = copySelection(
    	state.selection
    );
}

function rightCorner(editor, pgraph, source, target) {
    // item 7952
    var graph = pgraph.graph;
    // item 7942
    var movedNodes = {};
    var y;
    // item 7958
    var sourceEdge = graph.getEdge(source);
    var sourceTail = graph.getTail(sourceEdge);
    var sourceHead = graph.getHead(sourceEdge);
    var targetNode = graph.getNode(target);
    // item 7940
    extendEdge(
    	pgraph,
    	source,
    	0,
    	movedNodes
    );
    // item 7959
    var dims = findLedgeFromOrigin(
    	graph,
    	target,
    	sourceTail.id
    );
    // item 7963
    var sourceY = sourceTail.box.top - Config.METRE;
    // item 7964
    if (sourceY < dims.y) {
        // item 7967
        var vDelta = dims.y - sourceY;
        var bottom = sourceTail.y + vDelta;
        // item 7968
        dropDown(
        	pgraph,
        	sourceTail,
        	bottom,
        	movedNodes
        );
        // item 7969
        sourceY = dims.y;
    }
    // item 7970
    var targetY = targetNode.y;
    // item 7977
    var left = new Utils.Point(sourceTail.x, sourceY);
    var right = new Utils.Point(targetNode.x, targetY);
    // item 7971
    if (sourceY < targetY) {
        // item 7978
        makePipe(
        	pgraph,
        	left,
        	right,
        	target,
        	movedNodes
        );
        // item 7986
        var vDelta = targetY - sourceY;
        // item 7979
        pgraph.moveDown(
        	sourceTail.id,
        	vDelta,
        	movedNodes
        );
        // item 7980
        y = targetY;
    } else {
        // item 7974
        if (sourceY > targetY) {
            // item 7983
            makePipe(
            	pgraph,
            	left,
            	right,
            	target,
            	movedNodes
            );
            // item 7987
            var vDelta = sourceY - targetY;
            // item 7984
            pgraph.moveDown(
            	target,
            	vDelta,
            	movedNodes
            );
            // item 7985
            y = sourceY;
        } else {
            // item 7981
            y = sourceY;
        }
    }
    // item 7938
    var commands = {};
    // item 7941
    buildMoveCommands(
    	pgraph,
    	movedNodes,
    	commands
    );
    // item 7939
    var commandList = Utils.objectValues(commands);
    // item 7950
    deleteLiana(
    	editor,
    	graph,
    	sourceEdge,
    	commandList
    );
    // item 7954
    var leftJun = insertJunctionBetween(
    	editor,
    	graph,
    	sourceEdge.head,
    	null,
    	y,
    	commandList
    );
    // item 7955
    var bridgeId = generateId(editor.storage);
    // item 7956
    pushInsertHorizontal(
    	commandList,
    	bridgeId,
    	leftJun,
    	target,
    	"right"
    );
    // item 7957
    return commandList;
}

function rightLine(editor, pgraph, source, target) {
    // item 7050
    var graph = pgraph.graph;
    // item 7038
    var movedNodes = {};
    var y;
    // item 7765
    var sourceEdge = graph.getEdge(source);
    var sourceTail = graph.getTail(sourceEdge);
    var sourceHead = graph.getHead(sourceEdge);
    var targetEdge = graph.getEdge(target);
    var targetHead = graph.getHead(targetEdge);
    var targetTail = graph.getTail(targetEdge);
    // item 7036
    extendEdge(
    	pgraph,
    	source,
    	0,
    	movedNodes
    );
    // item 7040
    extendEdge(
    	pgraph,
    	target,
    	0,
    	movedNodes
    );
    // item 7766
    var dims = findLedgeFromOrigin(
    	graph,
    	targetTail.id,
    	sourceTail.id
    );
    // item 7771
    var sourceY = sourceTail.box.top - Config.METRE;
    // item 7772
    if (sourceY < dims.y) {
        // item 7775
        var vDelta = dims.y - sourceY;
        var bottom = sourceTail.y + vDelta;
        // item 7776
        dropDown(
        	pgraph,
        	sourceTail,
        	bottom,
        	movedNodes
        );
        // item 7777
        sourceY = dims.y;
    }
    // item 7778
    var targetY1 = targetHead.box.bottom + Config.METRE;
    var targetY2 = targetTail.box.top - Config.METRE;
    // item 7779
    if (sourceY < targetY1) {
        // item 7786
        var left = new Utils.Point(sourceTail.x, sourceY);
        var right = new Utils.Point(targetTail.x, targetY1);
        // item 7787
        makePipe(
        	pgraph,
        	left,
        	right,
        	targetHead.id,
        	movedNodes
        );
        // item 7796
        var vDelta = targetY1 - sourceY;
        // item 7788
        pgraph.moveDown(
        	sourceTail.id,
        	vDelta,
        	movedNodes
        );
        // item 7789
        y = targetY1;
    } else {
        // item 7782
        if (sourceY > targetY2) {
            // item 7792
            var left = new Utils.Point(sourceTail.x, sourceY);
            var right = new Utils.Point(targetTail.x, targetY2);
            // item 7793
            makePipe(
            	pgraph,
            	left,
            	right,
            	targetHead.id,
            	movedNodes
            );
            // item 7797
            var vDelta = sourceY - targetY2;
            // item 7794
            pgraph.moveDown(
            	targetTail.id,
            	vDelta,
            	movedNodes
            );
            // item 7795
            y = sourceY;
        } else {
            // item 7791
            y = sourceY;
        }
    }
    // item 7034
    var commands = {};
    // item 7037
    buildMoveCommands(
    	pgraph,
    	movedNodes,
    	commands
    );
    // item 7035
    var commandList = Utils.objectValues(commands);
    // item 7049
    pushDeleteEdge(
    	commandList,
    	target
    );
    // item 7048
    deleteLiana(
    	editor,
    	graph,
    	sourceEdge,
    	commandList
    );
    // item 7052
    var rightJun = insertJunctionBetween(
    	editor,
    	graph,
    	targetEdge.head,
    	targetEdge.tail,
    	y,
    	commandList
    );
    // item 7053
    var leftJun = insertJunctionBetween(
    	editor,
    	graph,
    	sourceEdge.head,
    	null,
    	y,
    	commandList
    );
    // item 7054
    var bridgeId = generateId(editor.storage);
    // item 7055
    pushInsertHorizontal(
    	commandList,
    	bridgeId,
    	leftJun,
    	rightJun,
    	null
    );
    // item 18278
    if (isDownLeft(sourceHead)) {
        // item 18308
        addTrace(
        	"transplant liana - right line",
        	[source, target]
        );
        // item 18286
        var newEdge = findEdgeAbove(
        	commandList,
        	leftJun
        )
        // item 18287
        runAndCollapse(
        	editor,
        	commandList,
        	newEdge
        )
        // item 18282
        return null
    } else {
        // item 7056
        return commandList;
    }
}

function runAndCollapse(editor, commandList1, edgeId) {
    // item 18223
    if (edgeId) {
        // item 18249
        var before = copyState(editor);
        var after = copyState(editor);
        after.selection = createSelection();
        // item 18251
        commandList1 = makeUndoAndExecute(
        	editor,
        	commandList1,
        	after,
        	true
        )
        // item 18258
        var graph = editor.storage.graph
        var edge = graph.getEdge(edgeId)
        var commandList2
        // item 18255
        if (isBolt(graph, edge)) {
            // item 18248
            var collapsed = collapseBoltCore(
            	editor,
            	edgeId
            )
            // item 18246
            commandList2 = makeUndoAndExecute(
            	editor,
            	collapsed.commandList,
            	after,
            	true
            )
        } else {
            // item 18259
            commandList2 = []
        }
        // item 18247
        concatAndSaveUndo(
        	editor,
        	commandList1,
        	commandList2,
        	before,
        	after
        )
    } else {
        // item 18226
        applyCommands(
        	editor,
        	commandList1,
        	null
        )
    }
}

function runAndSaveCommands(editor, before, commands, after, redraw) {
    // item 1570
    executeCommands(
    	editor,
    	commands,
    	after,
    	false,
    	redraw
    );
    // item 1572
    addToUndo(editor.undo, before, commands, after)
}

function runFreeDelete(storage, command, isUndo) {
    // item 16710
    var free = storage.free
    var pers = storage.persistence
    // item 16704
    if (isUndo) {
        // item 16709
        var item = copyStorageItem(command.undo)
        item.id = command.id
        // item 16713
        free.add(command.id, item)
    } else {
        // item 16714
        free.remove(command.id)
    }
}

function runFreeInsert(editor, command, isUndo) {
    // item 16698
    var storage = editor.storage
    // item 16695
    var free = storage.free
    var pers = storage.persistence
    // item 16689
    if (isUndo) {
        // item 16692
        free.remove(command.id)
    } else {
        // item 16693
        var item = copyStorageItem(command.fields)
        item.id = command.id
        // item 16694
        free.add(command.id, item)
    }
}

function runFreeUpdate(editor, command, isUndo) {
    // item 16730
    var storage = editor.storage
    var render = editor.render
    // item 16728
    var free = storage.free
    var pers = storage.persistence
    // item 16724
    var fields
    // item 16719
    if (isUndo) {
        // item 16723
        fields = command.undo
    } else {
        // item 16722
        fields = command.fields
    }
    // item 16726
    fields.id = command.id
    // item 16725
    updateFreeNode(free, fields)
}

function runItemDelete(storage, command, isUndo) {
    // item 11238
    var graph = storage.graph;
    var pers = storage.persistence;
    // item 1533
    if (isUndo) {
        // item 1617
        var item = copyStorageItem(command.undo);
        item.id = command.id;
        // item 1536
        graph.addItem(item);
    } else {
        // item 1537
        graph.removeItem(command.id);
    }
}

function runItemInsert(editor, command, isUndo) {
    // item 15764
    var storage = editor.storage;
    // item 11251
    var graph = storage.graph;
    var pers = storage.persistence;
    // item 1523
    if (isUndo) {
        // item 1527
        graph.removeItem(command.id);
    } else {
        // item 1616
        var item = copyStorageItem(command.fields);
        item.id = command.id;
        // item 1618
        graph.addItem(item);
    }
}

function runNodeUpdate(editor, command, isUndo) {
    // item 15766
    var storage = editor.storage;
    var render = editor.render;
    // item 11254
    var graph = storage.graph;
    var pers = storage.persistence;
    // item 1620
    var fields;
    // item 1543
    if (isUndo) {
        // item 1547
        fields = command.undo;
    } else {
        // item 1546
        fields = command.fields;
    }
    // item 2658
    fields.id = command.id;
    // item 1622
    updateNode(render, graph, fields);
}

function runTask(task, actionName) {
    // item 22094
    var action = task[actionName]
    // item 22089
    var order = action.apply(
    	task
    )
    // item 22091
    if (order) {
        // item 22095
        self.storage.nextId = order.nextId
        // item 22090
        applyCommands(
        	self,
        	order.commands,
        	null
        )
    }
}

function sameAddressHeight(edit) {
    // item 22911
    sameHeight(
    	edit,
    	"address",
    	expandBranchAddress
    )
}

function sameBranchHeight(edit) {
    // item 22888
    sameHeight(
    	edit,
    	"branch",
    	expandBranchHeader
    )
}

function sameHeight(edit, type, expand) {
    // item 22751
    var graph = self.storage.graph
    // item 22752
    var maxH = null
    // item 227530001
    var _ind22753 = 0;
    var _col22753 = graph.nodes;
    var _keys22753 = Object.keys(_col22753); 
    var _len22753 = _keys22753.length;
    while (true) {
        // item 227530002
        if (_ind22753 < _len22753) {
            
        } else {
            break;
        }
        // item 227530004
        var id = _keys22753[_ind22753]; var node = _col22753[id];
        // item 22755
        if (node.type == type) {
            // item 22819
            var fields = Drakon.fitItem(
            	node, 
            	self.render
            )
            // item 22758
            if (maxH == null) {
                // item 22761
                maxH = fields.h
            } else {
                // item 22765
                maxH = Math.max(maxH, fields.h)
            }
        }
        // item 227530003
        _ind22753++;
    }
    // item 228270001
    var _ind22827 = 0;
    var _col22827 = graph.nodes;
    var _keys22827 = Object.keys(_col22827); 
    var _len22827 = _keys22827.length;
    while (true) {
        // item 228270002
        if (_ind22827 < _len22827) {
            
        } else {
            break;
        }
        // item 228270004
        var id = _keys22827[_ind22827]; var node = _col22827[id];
        // item 22829
        if ((node.type == type) && (!(maxH == node.h))) {
            // item 22770
            var pgraph = createPhysicalGraph(
            	graph,
            	self.render
            )
            // item 22782
            var newCommands = {}
            // item 227710001
            var _ind22771 = 0;
            var _col22771 = graph.nodes;
            var _keys22771 = Object.keys(_col22771); 
            var _len22771 = _keys22771.length;
            while (true) {
                // item 227710002
                if (_ind22771 < _len22771) {
                    
                } else {
                    break;
                }
                // item 227710004
                var id = _keys22771[_ind22771]; var node = _col22771[id];
                // item 22773
                if (node.type == type) {
                    // item 22781
                    expand(
                    	pgraph, 
                    	id,
                    	maxH,
                    	newCommands
                    )
                }
                // item 227710003
                _ind22771++;
            }
            // item 22783
            combineRunCommands(
            	edit,
            	newCommands
            )
            break;
        }
        // item 228270003
        _ind22827++;
    }
}

function saveHandlePos(id) {
    // item 19779
    if (self.readonly) {
        
    } else {
        // item 18799
        addTrace(
        	"save handle pos",
        	[id]
        )
        // item 17331
        var free = self.canvas.free
        var item = free.get(id)
        var oldFree = self.storage.free
        var oldItem = oldFree.get(id)
        var fields = {}
        // item 187880001
        var _ind18788 = 0;
        var _col18788 = item;
        var _keys18788 = Object.keys(_col18788); 
        var _len18788 = _keys18788.length;
        while (true) {
            // item 187880002
            if (_ind18788 < _len18788) {
                
            } else {
                break;
            }
            // item 187880004
            var key = _keys18788[_ind18788]; var value = _col18788[key];
            // item 19545
            if ((key in gNonCopiableFields) || ((oldItem[key] == value) && (!(key == "content")))) {
                
            } else {
                // item 18809
                fields[key] = value
            }
            // item 187880003
            _ind18788++;
        }
        // item 18801
        var updates = []
        // item 18800
        var change = new Command(
        	"update",
        	"free",
        	id,
        	fields
        )
        updates.push(change)
        // item 18802
        submitCommands(self, updates, true)
    }
}

function scanDown(leftX, graph, src, targetId, result) {
    // item 6331
    var nodeId = graph.getNodeDown(src);
    var node = graph.getNode(nodeId);
    // item 6321
    if (nodeId == targetId) {
        
    } else {
        // item 6320
        recordDimension(node, result);
        // item 6324
        if (node.right) {
            // item 10882
            if (hasLeft(graph, node)) {
                // item 10884
                scanLeft(leftX, graph, node, targetId, result);
            } else {
                // item 6327
                scanRight(leftX, graph, node, targetId, result);
            }
        } else {
            // item 6328
            if (node.down) {
                // item 6370
                scanDown(leftX, graph, node, targetId, result);
            } else {
                // item 7594
                if (node.left) {
                    // item 6332
                    scanLeft(leftX, graph, node, targetId, result);
                }
            }
        }
    }
}

function scanLeft(leftX, graph, src, targetId, result) {
    // item 6375
    var nodeId = graph.getNodeLeft(src);
    var node = graph.getNode(nodeId);
    // item 6357
    recordDimension(node, result);
    // item 11393
    if (node.x < leftX) {
        // item 11857
        var target = graph.getNode(targetId);
        // item 11858
        if (node.y > target.y) {
            
        } else {
            // item 6358
            if (nodeId == targetId) {
                
            } else {
                // item 6365
                if (node.down) {
                    // item 6377
                    scanDown(leftX, graph, node, targetId, result);
                } else {
                    // item 6361
                    if (node.left) {
                        // item 18973
                        var leftNode = graph.getNodeLeftEx(node)
                        // item 18974
                        if (leftNode.type == "duration") {
                            // item 6364
                            scanUp(leftX, graph, node, targetId, result);
                        } else {
                            // item 6376
                            scanLeft(leftX, graph, node, targetId, result);
                        }
                    } else {
                        // item 6364
                        scanUp(leftX, graph, node, targetId, result);
                    }
                }
            }
        }
    } else {
        // item 6358
        if (nodeId == targetId) {
            
        } else {
            // item 6365
            if (node.down) {
                // item 6377
                scanDown(leftX, graph, node, targetId, result);
            } else {
                // item 6361
                if (node.left) {
                    // item 18973
                    var leftNode = graph.getNodeLeftEx(node)
                    // item 18974
                    if (leftNode.type == "duration") {
                        // item 6364
                        scanUp(leftX, graph, node, targetId, result);
                    } else {
                        // item 6376
                        scanLeft(leftX, graph, node, targetId, result);
                    }
                } else {
                    // item 6364
                    scanUp(leftX, graph, node, targetId, result);
                }
            }
        }
    }
}

function scanLeftWall(graph, startNodeId, endNodeId) {
    // item 4813
    var startNode = graph.getNode(
    	startNodeId
    );
    var current = {
    	node: startNode,
    	edge: { id: null }
    };
    // item 4988
    if (startNodeId == endNodeId) {
        // item 4992
        return {
        	nodes: [ startNodeId ],
        	lowest: startNode.y
        };
    } else {
        // item 4814
        var nodes = [];
        var lowestY = startNode.y;
        while (true) {
            // item 4812
            var next = findNextOnWall(
            	graph,
            	current
            );
            // item 4869
            var id = next.node.id;
            // item 4819
            nodes.push(id);
            current = next;
            // item 4816
            if (id == endNodeId) {
                break;
            }
            // item 4870
            if (next.node.y > lowestY) {
                // item 4873
                lowestY = next.node.y;
            }
        }
        // item 4815
        return {
        	nodes: nodes,
        	lowest: lowestY
        };
    }
}

function scanRight(leftX, graph, src, targetId, result) {
    // item 6371
    var nodeId =graph.getNodeRight(src);
    var node = graph.getNode(nodeId);
    var type = describeJunction(node);
    // item 7706
    if ((nodeId == targetId) || (type === "left-up")) {
        
    } else {
        // item 6339
        recordDimension(node, result);
        // item 6340
        if (nodeId == targetId) {
            
        } else {
            // item 6343
            if (node.right) {
                // item 6372
                scanRight(leftX, graph, node, targetId, result);
            } else {
                // item 6373
                scanDown(leftX, graph, node, targetId, result);
            }
        }
    }
}

function scanStartBelow(graph, source, y) {
    // item 4968
    var srcEdge = graph.getEdge(source);
    // item 5228
    return scanStartBelowCore(
    	graph,
    	srcEdge.tail,
    	y
    );
}

function scanStartBelowCore(graph, srcNodeId, y) {
    // item 5208
    var srcNode = graph.getNode(srcNodeId);
    // item 5209
    var probe = new Utils.Box(
    	Math.floor(srcNode.x - Config.METRE * 1.5),
    	Math.floor(srcNode.y + Config.METRE * 0.5),
    	Math.floor(srcNode.x + Config.METRE * 1.5),
    	Math.floor(y + Config.METRE * 0.5)
    );
    // item 5210
    var found = null;
    var highest = 10000000000;
    // item 52110001
    var _ind5211 = 0;
    var _col5211 = graph.edges;
    var _keys5211 = Object.keys(_col5211); 
    var _len5211 = _keys5211.length;
    while (true) {
        // item 52110002
        if (_ind5211 < _len5211) {
            
        } else {
            break;
        }
        // item 52110004
        var eid = _keys5211[_ind5211]; var edge = _col5211[eid];
        // item 5216
        if (Utils.boxesIntersect(probe, edge.box)) {
            // item 5217
            var head = graph.getHead(edge);
            // item 5219
            if (head.y < highest) {
                // item 5218
                found = head.id;
                highest = head.y;
            }
        }
        // item 52110003
        _ind5211++;
    }
    // item 5224
    if (found === null) {
        // item 5223
        Utils.throwError(
         "No edge on the way");
    } else {
        // item 5227
        return found;
    }
}

function scanSurface(graph, start, targetId, visitor) {
    // item 9344
    var node = start;
    var dir = "left";
    var id;
    while (true) {
        // item 9414
        visitor(node);
        // item 9345
        if (targetId == node.id) {
            break;
        }
        // item 93470001
        if (dir === "down") {
            // item 9356
            if (node.right) {
                // item 9367
                dir = "right";
                // item 9359
                id =graph.getNodeRight(node);
            } else {
                // item 9360
                if (node.down) {
                    // item 9363
                    id = graph.getNodeDown(node);
                } else {
                    // item 9364
                    if (hasLeft(graph, node)) {
                        // item 9368
                        dir = "left";
                        // item 9369
                        id = graph.getNodeLeft(node);
                    } else {
                        // item 9370
                        Utils.throwError(
                         "dead end");
                    }
                }
            }
        } else {
            // item 93470002
            if (dir === "right") {
                // item 9379
                if (node.up) {
                    // item 9386
                    Utils.throwError(
                     "dead end");
                } else {
                    // item 9371
                    if (node.right) {
                        // item 9374
                        id =graph.getNodeRight(node);
                    } else {
                        // item 9375
                        if (node.down) {
                            // item 9387
                            dir = "down";
                            // item 9378
                            id = graph.getNodeDown(node);
                        } else {
                            // item 9388
                            Utils.throwError(
                             "dead end");
                        }
                    }
                }
            } else {
                // item 93470003
                if (dir === "up") {
                    // item 9393
                    if (hasLeft(graph, node)) {
                        // item 9395
                        dir = "left";
                        // item 9396
                        id = graph.getNodeLeft(node);
                    } else {
                        // item 9389
                        if (node.up) {
                            // item 9392
                            id = graph.getNodeUp(node);
                        } else {
                            // item 9397
                            Utils.throwError(
                             "dead end");
                        }
                    }
                } else {
                    // item 93470004
                    if (dir === "left") {
                        
                    } else {
                        // item 93470005
                        throw "Unexpected switch value: " + dir;
                    }
                    // item 9403
                    if (node.down) {
                        // item 9410
                        dir = "down";
                        // item 9409
                        id = graph.getNodeDown(node);
                    } else {
                        // item 9399
                        if (hasLeft(graph, node)) {
                            // item 9406
                            id = graph.getNodeLeft(node);
                        } else {
                            // item 9425
                            if (node.up) {
                                // item 9428
                                dir = "up";
                                // item 9426
                                id = graph.getNodeUp(node);
                            } else {
                                // item 9407
                                Utils.throwError(
                                 "dead end");
                            }
                        }
                    }
                }
            }
        }
        // item 9413
        node = graph.getNode(id);
    }
}

function scanUp(leftX, graph, src, targetId, result) {
    // item 6394
    var nodeId = graph.getNodeUp(src);
    var node = graph.getNode(nodeId);
    // item 6382
    recordDimension(node, result);
    // item 6383
    if (nodeId == targetId) {
        
    } else {
        // item 6386
        if (hasLeft(graph, node)) {
            // item 6395
            scanLeft(leftX, graph, node, targetId, result);
        } else {
            // item 6389
            scanUp(leftX, graph, node, targetId, result);
        }
    }
}

function selectAll() {
    // item 18927
    var editor = self
    var storage = editor.storage
    // item 18930
    var nodes = Object.keys(storage.graph.nodes)
    var free = storage.free.list
    var all = nodes.concat(free)
    // item 18931
    selectItems(editor, all)
    // item 18926
    redrawCanvas(editor);
}

function selectItem(editor, id) {
    // item 4778
    var item = getAnyItem(editor.storage, id)
    console.log(id, item)
    // item 2040
    editor.storage.selection = createSelection();
    // item 20378
    if (item) {
        // item 2039
        editor.storage.selection.add(id, true);
    }
}

function selectItems(editor, ids) {
    // item 18009
    editor.storage.selection = createSelection();
    // item 180100001
    var _ind18010 = 0;
    var _col18010 = ids;
    var _len18010 = _col18010.length;
    while (true) {
        // item 180100002
        if (_ind18010 < _len18010) {
            
        } else {
            break;
        }
        // item 180100004
        var id = _col18010[_ind18010];
        // item 18008
        editor.storage.selection.add(id, false);
        // item 180100003
        _ind18010++;
    }
}

function selectOneItem(itemId) {
    // item 20376
    deselectAll(self)
    // item 20375
    selectItem(self, itemId)
    // item 20377
    redrawCanvas(self)
}

function setBackground(data) {
    // item 17540
    if (ignoreCommand()) {
        
    } else {
        // item 17534
        addTrace(
        	"set background",
        	[data]
        )
        // item 17536
        var editor = self
        // item 17535
        var commandList = []
        // item 17531
        var fields = {}
        // item 22601
        setNotNull(data, "background", fields)
        setNotNull(data, "diaLine", fields)
        setNotNull(data, "diaLineThickness", fields)
        // item 17532
        commandList.push(new Command(
        	"update",
        	"diagrams",
        	"diagram",
        	fields
        ));
        // item 17533
        submitCommands(editor, commandList, true)
    }
}

function setCallback(name, fun) {
    // item 12306
    Callbacks[name] = fun
}

function setContent(id, content) {
    // item 19859
    if (ignoreCommand()) {
        
    } else {
        // item 19863
        addTrace(
        	"setContent",
        	[id, content]
        );
        // item 19862
        setItemText(self, id, content)
    }
}

function setContentField(content, key, value) {
    // item 22496
    var font = content.font || self.storage.font
    // item 22498
    var parsed = Utils.parseFontString(
    	font
    )
    // item 224850001
    if (key === "font-italic") {
        // item 22499
        parsed.italic = value
        // item 22505
        var font2 =  Utils.buildFontString(
        	parsed.italic,
        	parsed.bold,
        	parsed.size,
        	parsed.family
        )
        // item 22506
        content.font = font2
    } else {
        // item 224850002
        if (key === "font-bold") {
            // item 22500
            parsed.bold = value
            // item 22505
            var font2 =  Utils.buildFontString(
            	parsed.italic,
            	parsed.bold,
            	parsed.size,
            	parsed.family
            )
            // item 22506
            content.font = font2
        } else {
            // item 224850003
            if (key === "font-size") {
                // item 22503
                parsed.size = value
                // item 22505
                var font2 =  Utils.buildFontString(
                	parsed.italic,
                	parsed.bold,
                	parsed.size,
                	parsed.family
                )
                // item 22506
                content.font = font2
            } else {
                // item 224850004
                if (key === "font-family") {
                    // item 22504
                    parsed.family = value
                    // item 22505
                    var font2 =  Utils.buildFontString(
                    	parsed.italic,
                    	parsed.bold,
                    	parsed.size,
                    	parsed.family
                    )
                    // item 22506
                    content.font = font2
                } else {
                    // item 22502
                    content[key] = value
                }
            }
        }
    }
}

function setContentForManyItems(editor, ids, makeContent) {
    // item 17818
    addTrace(
    	"set text for many items",
    	ids
    );
    // item 17817
    var before = copyState(editor);
    var after = copyState(editor);
    // item 17813
    var i;
    var count = ids.length;
    var allCommands = [];
    // item 178140001
    i = 0;
    while (true) {
        // item 178140002
        if (i < count) {
            
        } else {
            break;
        }
        // item 17812
        var id = ids[i];
        // item 17820
        var item = getAnyItem(editor.storage, id)
        // item 17821
        var newContent = makeContent(item)
        // item 17819
        allCommands = setTextExecute(
        	editor,
        	id,
        	newContent,
        	allCommands
        );
        // item 178140003
        i++;
    }
    // item 20013
    persistAndRedraw(
    	editor,
    	after,
    	true
    )
    // item 17816
    addToUndo(editor.undo, before, allCommands, after)
    // item 18012
    selectItems(editor, ids)
}

function setContentLink(content, link) {
    // item 19798
    var copy = Utils.copyObject(content)
    // item 19797
    copy.link = link
    // item 19799
    return copy
}

function setContentTxt(content, txt) {
    // item 17305
    var copy = Utils.copyObject(content)
    // item 15956
    copy.txt = txt
    // item 17306
    return copy
}

function setContentTxt2(content, txt2) {
    // item 17308
    var copy = Utils.copyObject(content)
    // item 17307
    copy.txt2 = txt2
    // item 17309
    return copy
}

function setFormat(ids, format) {
    // item 17842
    if (ignoreCommand()) {
        
    } else {
        // item 17698
        var editor = self
        // item 17716
        var makeContent = function(item) {
        	var newContent = setManyContentFields(
        		item.content,
        		format
        	)
        	return newContent
        }
        // item 17823
        setContentForManyItems(
        	editor,
        	ids,
        	makeContent
        )
    }
}

function setFreeItemSize(id, x, y, width, height) {
    // item 19782
    if (ignoreCommand()) {
        
    } else {
        // item 16891
        addTrace(
        	"resize free item",
        	id
        );
        // item 16890
        var free = self.storage.free
        // item 16883
        var item = free.get(id)
        // item 16884
        if (item) {
            // item 17094
            var changed = {
            	commands: {}
            }
            // item 17093
            Drakon.changeFreeItem(
            	render,
            	free,
            	id,
            	width,
            	height,
            	item.content,
            	changed
            );
            // item 18971
            var command = getOrCreateUpdate(
            	changed.commands,
            	id
            )
            // item 18972
            command.fields.x = x
            command.fields.y = y
            // item 17095
            var updates = Utils.objectValues(
            	changed.commands
            )
            // item 16894
            applyCommands(
            	self,
            	updates,
            	id
            );
        }
    }
}

function setItemDims(item, size) {
    // item 16020
    item.w = size.w;
    item.h = size.h;
    // item 16021
    if ("a" in size) {
        // item 16024
        item.a = size.a;
    }
    // item 16180
    if (size.tb) {
        // item 16183
        item.tb = size.tb;
    }
    // item 16184
    if (size.tb2) {
        // item 16187
        item.tb2 = size.tb2;
    }
}

function setItemText(editor, id, cont) {
    // item 17443
    cont = trimContent(cont)
    // item 18962
    addTrace(
    	"set item text",
    	[id, Utils.copyObject(cont)]
    );
    // item 10355
    var commands = {};
    var graph = editor.storage.graph;
    var render = editor.render;
    // item 2109
    var pgraph = createPhysicalGraph(graph, render);
    // item 10356
    setItemTextCore(
    	editor,
    	pgraph,
    	id,
    	cont,
    	commands
    );
    // item 2335
    var commList = Utils.objectValues(commands);
    // item 11314
    var item = getAnyItem(editor.storage, id)
    // item 11315
    if ((item.role == "header") && (cont.txt)) {
        // item 11318
        pushUpdateDiagram(commList, cont.txt);
    }
    // item 2298
    submitCommands(editor, commList, true)
}

function setItemTextCore(editor, pgraph, id, cont, commands) {
    // item 10276
    var render = editor.render;
    var graph = editor.storage.graph;
    var free = editor.storage.free
    // item 10274
    var item = getAnyItem(
    	editor.storage,
    	id
    )
    // item 16332
    var changed = {
    	commands: commands
    }
    // item 17089
    if (item.free) {
        // item 17092
        Drakon.changeFreeItem(
        	render,
        	free,
        	id,
        	item.w,
        	item.h,
        	cont,
        	changed
        );
    } else {
        // item 21513
        if (isMind()) {
            // item 21515
            Mind.changeItem(
            	render,
            	pgraph,
            	id,
            	item.w,
            	cont,
            	changed
            );
        } else {
            // item 16107
            Drakon.changeItem(
            	render,
            	pgraph,
            	id,
            	item.w,
            	cont,
            	changed
            );
        }
    }
    // item 16371
    if (changed.tb) {
        // item 16374
        item.tb = changed.tb;
    }
    // item 16375
    if (changed.tb2) {
        // item 16378
        item.tb2 = changed.tb2;
    }
}

function setItemWidth(id, width) {
    // item 16582
    if (ignoreCommand()) {
        
    } else {
        // item 16276
        addTrace(
        	"setItemWidth",
        	[id, width]
        );
        // item 16274
        var editor = self;
        // item 16278
        var graph = editor.storage.graph;
        var render = editor.render;
        // item 16279
        var pgraph = createPhysicalGraph(
        	graph,
        	render
        );
        // item 16366
        var node = graph.getNode(id);
        // item 16280
        var commands = {};
        // item 21510
        if (isMind()) {
            // item 21512
            Mind.setItemWidth(
            	render,
            	pgraph,
            	id,
            	width,
            	commands
            )
        } else {
            // item 16363
            if (Drakon.isWideIcon(node)) {
                // item 16329
                Drakon.setSkewerWidth(
                	render,
                	pgraph,
                	id,
                	width,
                	commands
                );
            } else {
                // item 16370
                var result = {
                	commands: commands
                };
                // item 16367
                Drakon.changeItem(
                	render,
                	pgraph,
                	id,
                	width,
                	node.content,
                	result
                );
            }
        }
        // item 16282
        var commList = Utils.objectValues(commands);
        // item 16275
        applyCommands(
        	editor,
        	commList,
        	id
        );
    }
}

function setManyContentFields(content, fields) {
    // item 17706
    var result
    // item 17707
    if (content) {
        // item 17710
        result = Utils.copyObject(content)
    } else {
        // item 17711
        result = new Utils.Content("", "")
    }
    // item 177120001
    var _ind17712 = 0;
    var _col17712 = fields;
    var _keys17712 = Object.keys(_col17712); 
    var _len17712 = _keys17712.length;
    while (true) {
        // item 177120002
        if (_ind17712 < _len17712) {
            
        } else {
            break;
        }
        // item 177120004
        var key = _keys17712[_ind17712]; var value = _col17712[key];
        // item 22508
        setContentField(
        	result,
        	key,
        	value
        )
        // item 177120003
        _ind17712++;
    }
    // item 17715
    return result
}

function setNextPointers(nodes) {
    // item 17136
    var i
    var last = nodes.length - 1
    // item 171320001
    i = 0;
    while (true) {
        // item 171320002
        if (i < last) {
            
        } else {
            break;
        }
        // item 17134
        var current = nodes[i]
        var next = nodes[i + 1]
        // item 17135
        current.next = next.id
        // item 171320003
        i++;
    }
    // item 17400
    if (nodes.length > 0) {
        // item 17403
        nodes[last].next = ""
    }
}

function setNotEmpty(src, name, target) {
    // item 17619
    var value = src[name]
    // item 17616
    if (value) {
        // item 17620
        target[name] = value
    }
}

function setNotNull(src, name, target, tname) {
    // item 22596
    if (name in src) {
        // item 22600
        tname = tname || name
        // item 22599
        target[tname] = src[name]
    }
}

function setNotNullFields(commandList, keys) {
    // item 17597
    var fields = {}
    var empty = true
    // item 175980001
    var _ind17598 = 0;
    var _col17598 = keys;
    var _len17598 = _col17598.length;
    while (true) {
        // item 175980002
        if (_ind17598 < _len17598) {
            
        } else {
            break;
        }
        // item 175980004
        var key = _col17598[_ind17598];
        // item 17600
        var value = getDefault(key)
        // item 17601
        if (value) {
            // item 17604
            fields[key] = value
            // item 17605
            empty = false
        }
        // item 175980003
        _ind17598++;
    }
    // item 17607
    if (empty) {
        
    } else {
        // item 17610
        commandList.push(new Command(
        	"update",
        	"diagrams",
        	"diagram",
        	fields
        ));
    }
}

function setReadonly(readonly) {
    // item 16466
    self.readonly = readonly
}

function setStorage(editor, storage) {
    // item 16624
    editor.render.clear();
    // item 16625
    editor.sockets = [];
    editor.undo = new Undo();
    editor.storage = storage;
}

function setTextExecute(editor, id, cont, allCommands) {
    // item 19968
    cont = trimContent(cont)
    // item 19955
    var graph = editor.storage.graph;
    var render = editor.render;
    // item 19961
    var commands = {};
    // item 19960
    var node = getAnyItem(editor.storage, id)
    // item 19962
    if (((node.down) || (!(node.type == "beginend"))) || (isMind())) {
        
    } else {
        // item 19966
        var update = Drakon.getOrCreateUpdate(
        	commands,
        	id
        );
        // item 19967
        update.fields.type = "end";
        node.type = "end";
    }
    // item 19949
    var pgraph = createPhysicalGraph(graph, render);
    // item 19951
    setItemTextCore(
    	editor,
    	pgraph,
    	id,
    	cont,
    	commands
    );
    // item 19950
    var commandList = Utils.objectValues(commands);
    // item 19957
    if (commandList.length == 0) {
        
    } else {
        // item 19952
        commandList = calculateUndo(
        	editor.storage,
        	commandList
        );
        // item 20012
        performLocalChange(
        	editor,
        	commandList,
        	false
        )
        // item 19954
        allCommands = allCommands.concat(commandList);
    }
    // item 19956
    return allCommands;
}

function setTextForManyItems(editor, ids, cont) {
    // item 17822
    var makeContent = function(item) {
    	var old = getContent(item)
    	var newContent = Utils.copyObject(old)
    	newContent.txt = cont.txt
    	newContent.txt2 = cont.txt2
    	return newContent
    }
    // item 10400
    setContentForManyItems(
    	editor,
    	ids,
    	makeContent
    )
}

function setUserSettings(settings) {
    // item 19936
    gUserSettings = Utils.copyObject(settings)
}

function shortCycleDown(editor, pgraph, source, target) {
    // item 11952
    var graph2 = editor.storage.graph.clone();
    // item 11916
    var graph = pgraph.graph;
    var sourceEdge = graph.getEdge(source);
    // item 11913
    var down = graph.getNode(sourceEdge.tail);
    var leftEdge = down.left;
    // item 11915
    var commands1 = expandBoltCore(editor, pgraph, leftEdge);
    // item 11918
    var newEdgeId = findInsertedEdge(commands1);
    // item 11971
    var dummyStorage = {
    	graph: graph2,
    	persistence: new FakePersistence(),
    	nextId: editor.storage.nextId
    };
    var dummyEditor = {
    	storage: dummyStorage,
    	render: render
    }
    // item 11975
    var count = commands1.length;
    // item 119720001
    var i = 0;
    while (true) {
        // item 119720002
        if (i < count) {
            
        } else {
            break;
        }
        // item 11976
        var command = commands1[i];
        // item 11974
        performChange(dummyEditor, command, false);
        // item 119720003
        i++;
    }
    // item 11977
    var pgraph3 = createPhysicalGraph(
    	graph2,
    	editor.render
    );
    // item 11978
    var commands2 = leftInnerLine(
    	dummyEditor,
    	pgraph3,
    	newEdgeId,
    	target
    );
    // item 11979
    editor.storage.nextId = dummyEditor.storage.nextId;
    // item 11982
    var deletedIn2 = commands2.filter(function(comm) {
    	return comm.type == "delete";
    });
    var insertedIn1 = commands1.filter(function(comm) {
    	return comm.type == "insert";
    });
    // item 11985
    var deleted2 = {};
    var inserted1 = {};
    // item 11994
    deletedIn2.forEach(function(comm) {
    	deleted2[comm.id] = true;
    });
    insertedIn1.forEach(function(comm) {
    	inserted1[comm.id] = true;
    });
    // item 11987
    var commands1ex = commands1.filter(function(comm) {
    	return !(comm.id in deleted2);
    });
    // item 11995
    var commands2ex = commands2.filter(function(comm) {
    	return !(comm.type == "delete" && (comm.id in inserted1));
    });
    // item 11988
    return commands1ex.concat(commands2ex);
}

function shouldResize(item) {
    // item 2334
    if (((((((((item.isLine) || (item.type === "beginend")) || (item.type === "end")) || (item.type === "junction")) || (item.type === "duration")) || (item.type === "pause")) || (item.type === "ctrlStart")) || (item.type === "ctrlEnd")) || (item.type === "timer")) {
        // item 2204
        return false;
    } else {
        // item 2205
        return true;
    }
}

function showContextMenu(x, y, menu) {
    // item 21847
    var fun = Callbacks.showContextMenu
    // item 21843
    if (fun) {
        // item 21846
        fun(x, y, menu)
    }
}

function showInputBox(title, oldText, callback, x, y) {
    // item 10881
    var fun = Callbacks.showInputBox;
    // item 10877
    if (fun) {
        // item 10880
        fun(title, oldText, callback, x, y);
    }
}

function showInsertionSockets(type) {
    // item 19785
    if (self.readonly) {
        
    } else {
        // item 12344
        deselectAll(self);
        // item 12345
        redrawCanvasCore(self, type);
    }
}

function showMessage(text) {
    // item 9604
    var fun = Callbacks.showMessage;
    // item 9593
    if (fun) {
        // item 9596
        fun(text);
    }
}

function showWarningPopup(message) {
    // item 14530
    var fun = Callbacks.showWarningPopup;
    // item 14526
    if (fun) {
        // item 14529
        fun(message);
    }
}

function sizeOrTextChanged(item, newContent, size) {
    // item 15807
    if ((((contEqual(item.content, newContent)) && (item.w == size.w)) && (item.h == size.h)) && ((size.a == null) || (item.a == size.a))) {
        // item 15817
        return false;
    } else {
        // item 15816
        return true;
    }
}

function softLeft(graph, item) {
    // item 15050
    if (item.type == "duration") {
        // item 15053
        return graph.getNodeRight(item);
    } else {
        // item 14744
        return null;
    }
}

function softUp(graph, item) {
    var _sw147120000_ = 0;
    // item 147120000
    _sw147120000_ = item.type;
    // item 147120001
    if ((_sw147120000_ === "branch") || (_sw147120000_ === "case")) {
        // item 14895
        var above = graph.getNodeUp(item);
        // item 14896
        return above;
    } else {
        // item 147120003
        if ((_sw147120000_ === "select") || (_sw147120000_ === "address")) {
            // item 14732
            var below = graph.getNodeDown(item);
            // item 14791
            return below;
        } else {
            // item 14719
            return null;
        }
    }
}

function startEdit() {
    // item 20018
    var ids = getSelection()
    // item 20019
    if (ids.length == 1) {
        // item 20037
        var id = ids[0]
        // item 20036
        if (canBeEdited(id)) {
            // item 20038
            startEditText(id)
        }
    }
}

function startEditText(id) {
    // item 12330
    var node = getAnyItem(
    	self.storage,
    	id
    );
    // item 21184
    var x = node.x + node.w
    var y = node.y - node.h
    // item 21185
    if (node.type == "f_line") {
        // item 21188
        x = node.x + 20
        y = node.y + 20
    }
    // item 12326
    var old = getContent(node);
    var setTextProc;
    // item 12331
    if (node.type === "branch") {
        // item 12329
        setTextProc = function(text) {
        	var content = setContentTxt(old, text);
        	renameBranch(self, id, content);
        };
    } else {
        // item 12328
        setTextProc = function(text) {
        	var content = setContentTxt(old, text);
        	setItemText(self, id, content);
        };
    }
    // item 12327
    showInputBox(
    	tr("MES_CHANGE_ITEM_TEXT") + ": " + id,
    	old.txt,
    	setTextProc,
    	x,
    	y
    );
}

function startEditTextAt(id, x, y) {
    // item 17088
    var node = getAnyItem(
    	self.storage,
    	id
    );
    // item 16005
    if (hasUpperText(node)) {
        // item 16010
        var middle = node.y - node.h + node.a * 2;
        // item 16011
        if (y > middle) {
            // item 16008
            startEditText(id);
        } else {
            // item 16003
            startEditUpperText(id);
        }
    } else {
        // item 16008
        startEditText(id);
    }
}

function startEditUpperText(id) {
    // item 17087
    var node = getAnyItem(
    	self.storage,
    	id
    );
    // item 21189
    var x = node.x + node.w
    var y = node.y - node.h
    // item 15968
    var old = getContent(node);
    var setTextProc;
    // item 15970
    setTextProc = function(text2) {
    	var content = setContentTxt2(old, text2);
    	setItemText(self, id, content);
    };
    // item 15969
    showInputBox(
    	tr("MES_CHANGE_ITEM_UPPER") + ": " + id,
    	old.txt2,
    	setTextProc,
    	x,
    	y
    );
}

function startVisualDrag(itemId) {
    // item 16467
    if (self.readonly) {
        
    } else {
        // item 22543
        gDragStartItem = null
        gDragItems = []
        self.changedNodes = {}
        // item 19157
        if (itemId) {
            // item 16835
            var item = getAnyItem(self.storage, itemId)
            // item 16836
            if (item.free) {
                // item 16838
                gDragItems = findItemsToDrag(self, itemId)
            } else {
                // item 12148
                gDragStartItem = itemId
                // item 12149
                var expanders = getHardExpanders()
                self.canvas.pgraph.startPhysicalDrag(itemId, expanders)
            }
        } else {
            // item 16838
            gDragItems = findItemsToDrag(self, itemId)
        }
        // item 20355
        self.dragOn = true
    }
}

function submitCommands(editor, commands, redraw) {
    // item 22718
    applyCommandsCore(
    	editor,
    	commands,
    	null,
    	false,
    	redraw
    )
}

function swapYesNo(editor, id) {
    // item 14472
    addTrace(
    	"swap 'yes' and 'no'",
    	[id]
    );
    // item 2590
    var item = editor.storage.graph.getItem(id);
    // item 2595
    var newFlag;
    // item 2596
    if (item.flag1) {
        // item 2600
        newFlag = 0;
    } else {
        // item 2599
        newFlag = 1;
    }
    // item 2594
    var myChange = new Command(
    	"update",
    	"nodes",
    	id,
    	{
    		flag1: newFlag
    	}
    );
    var commands = [ myChange ];
    // item 2601
    submitCommands(editor, commands, true)
}

function takeOldValues(fields, old, undo) {
    // item 175480001
    var _ind17548 = 0;
    var _col17548 = fields;
    var _keys17548 = Object.keys(_col17548); 
    var _len17548 = _keys17548.length;
    while (true) {
        // item 175480002
        if (_ind17548 < _len17548) {
            
        } else {
            break;
        }
        // item 175480004
        var name = _keys17548[_ind17548]; var _ = _col17548[name];
        // item 17553
        var oldValue = old[name]
        // item 19911
        if ((oldValue === null) || (oldValue === undefined)) {
            // item 19917
            oldValue = ""
        }
        // item 17550
        undo[name] = oldValue
        // item 175480003
        _ind17548++;
    }
}

function toBack(editor, itemId) {
    // item 18963
    addTrace(
    	"toBack",
    	[itemId]
    );
    // item 18673
    var list = editor.storage.free.list
    // item 18671
    var commList = []
    // item 18672
    var itemOrdinal = list.indexOf(itemId)
    // item 18674
    if (itemOrdinal == 0) {
        
    } else {
        // item 18688
        var firstId = list[0]
        // item 18670
        pushUpdate(
        	commList,
        	"free",
        	itemId,
        	{ next: firstId }
        )
        // item 18689
        var nextId
        // item 18679
        if (itemOrdinal == list.length - 1) {
            // item 18690
            nextId = ""
        } else {
            // item 18677
            nextId = list[itemOrdinal + 1]
        }
        // item 18682
        var prevId = list[itemOrdinal - 1]
        // item 18678
        pushUpdate(
        	commList,
        	"free",
        	prevId,
        	{ next: nextId }
        )
        // item 18668
        applyCommands(
        	editor,
        	commList,
        	itemId
        );
    }
}

function toFront(editor, itemId) {
    // item 18964
    addTrace(
    	"toFront",
    	[itemId]
    );
    // item 18639
    var list = editor.storage.free.list
    // item 18637
    var commList = []
    // item 18638
    var itemOrdinal = list.indexOf(itemId)
    // item 18640
    if (itemOrdinal == list.length - 1) {
        
    } else {
        // item 18636
        pushUpdate(
        	commList,
        	"free",
        	itemId,
        	{ next: "" }
        )
        // item 18645
        if (itemOrdinal == 0) {
            
        } else {
            // item 18643
            var nextId = list[itemOrdinal + 1]
            // item 18648
            var prevId = list[itemOrdinal - 1]
            // item 18644
            pushUpdate(
            	commList,
            	"free",
            	prevId,
            	{ next: nextId }
            )
        }
        // item 18649
        var lastId = list[list.length - 1]
        // item 18650
        pushUpdate(
        	commList,
        	"free",
        	lastId,
        	{ next: itemId }
        )
        // item 18634
        applyCommands(
        	editor,
        	commList,
        	itemId
        );
    }
}

function toPrimitive(editor) {
    // item 18965
    addTrace(
    	"to primitive",
    	[]
    );
    // item 9849
    var graph = editor.storage.graph;
    var render = editor.render;
    // item 9851
    var pgraph = createPhysicalGraph(graph, render);
    // item 9850
    var header = findNodeByRole(graph, "header");
    var crossId = graph.getNodeDown(header);
    var cross = graph.getNode(crossId);
    var branchId = graph.getNodeDown(cross);
    var branch = graph.getNode(branchId);
    var bottom = goDownToEnd(graph, crossId);
    // item 9853
    var edges = {};
    var nodes = {};
    // item 9873
    var secondBranchId = findSecondBranch(graph, cross);
    // item 9859
    var addresses = findSiblingAddresses(
    	graph,
    	bottom,
    	secondBranchId,
    	nodes
    );
    // item 9941
    var firstId = graph.getNodeDown(branch);
    var addressId = graph.getNodeUp(bottom);
    var address = graph.getNode(addressId);
    var lastId = graph.getNodeUp(address);
    // item 9942
    var en = makeDummyItem(
    	1,
    	render,
    	"end",
    	makeCont(getEnd())
    );
    // item 9889
    nodes[header.id] = true;
    nodes[branchId] = true;
    edges[branch.down] = true;
    // item 98900001
    var _ind9890 = 0;
    var _col9890 = addresses;
    var _len9890 = _col9890.length;
    while (true) {
        // item 98900002
        if (_ind9890 < _len9890) {
            
        } else {
            break;
        }
        // item 98900004
        var addId = _col9890[_ind9890];
        // item 9892
        nodes[addId] = true;
        // item 9893
        var address2 = graph.getNode(addId);
        edges[address2.up] = true;
        // item 98900003
        _ind9890++;
    }
    // item 9926
    graph.enumerateManhattan(
    	crossId,
    	nodes,
    	edges
    );
    // item 9938
    delete nodes[header.id];
    // item 9933
    var commList = [];
    // item 10781
    pushDeleteSubgraph(
    	commList,
    	nodes,
    	edges
    );
    // item 9947
    var endId = generateId(editor.storage);
    // item 9949
    if (addresses.length > 1) {
        // item 9955
        var y = address.y + address.h +
          Config.METRE * 2 + en.h;
        var junctions = [];
        // item 9956
        pushInsertNodeAt(
        	render,
        	commList,
        	endId,
        	"end",
        	address.x, y,
        	en.w, en.h,
        	makeCont(getEnd())
        );
        // item 10070
        connectVer(
        	editor,
        	commList,
        	header.id, firstId,
        	"down"
        );
        // item 99570001
        var _ind9957 = 0;
        var _col9957 = addresses;
        var _len9957 = _col9957.length;
        while (true) {
            // item 99570002
            if (_ind9957 < _len9957) {
                
            } else {
                break;
            }
            // item 99570004
            var addId = _col9957[_ind9957];
            // item 9960
            var add = graph.getNode(addId);
            var downId = graph.getNodeDown(add);
            var downJ = graph.getNode(downId);
            var upId = graph.getNodeUp(add);
            var jId = generateId(editor.storage);
            junctions.push(jId);
            // item 9961
            pushInsertJunction(
            	commList,
            	jId,
            	add.x, downJ.y
            );
            // item 9962
            connectVer(
            	editor,
            	commList,
            	upId, jId,
            	"down"
            );
            // item 99570003
            _ind9957++;
        }
        // item 99670001
        var i = 1;
        while (true) {
            // item 99670002
            if (i < junctions.length) {
                
            } else {
                break;
            }
            // item 9969
            connectHor(
            	editor,
            	commList,
            	junctions[i - 1], junctions[i],
            	"left"
            );
            // item 99670003
            i++;
        }
        // item 9970
        connectVer(
        	editor,
        	commList,
        	junctions[0], endId,
        	"down"
        );
    } else {
        // item 9943
        if (firstId == addressId) {
            // item 9946
            pushInsertNodeAt(
            	render,
            	commList,
            	endId,
            	"end",
            	address.x, address.y,
            	en.w, en.h,
            	makeCont(getEnd())
            );
            // item 9948
            connectVer(
            	editor,
            	commList,
            	header.id, endId,
            	"down"
            );
        } else {
            // item 9952
            pushInsertNodeAt(
            	render,
            	commList,
            	endId,
            	"end",
            	address.x, address.y,
            	en.w, en.h,
            	makeCont(getEnd())
            );
            // item 9953
            connectVer(
            	editor,
            	commList,
            	header.id, firstId,
            	"down"
            );
            // item 9954
            connectVer(
            	editor,
            	commList,
            	lastId, endId,
            	"down"
            );
        }
    }
    // item 9931
    applyCommands(
    	editor,
    	commList,
    	null
    );
}

function toSilhouette(editor) {
    // item 18966
    addTrace(
    	"to silhouette",
    	[]
    );
    // item 14551
    if (canAddMore(editor, 5)) {
        // item 9683
        var render = editor.render;
        // item 9738
        var pgraph = createPhysicalGraph(
        	editor.storage.graph, render);
        var graph = pgraph.graph
        // item 9735
        var movedNodes = {};
        var commList = [];
        // item 9737
        var commands = {};
        // item 9731
        var header = findNodeByRole(graph, "header");
        // item 21088
        adjustForWildCycles(
        	pgraph, 
        	header,
        	movedNodes
        )
        // item 9682
        var bra = makeDummyItem(
        	1,
        	render,
        	"branch",
        	makeCont("branch W")
        );
        // item 9740
        extendEdge(
        	pgraph,
        	header.down,
        	bra.h + Config.METRE / 2,
        	movedNodes
        );
        // item 9809
        var en = makeDummyItem(
        	1,
        	render,
        	"end",
        	makeCont(getEnd())
        );
        // item 9730
        var width = getVerticalWidth(
        	graph,
        	header.id
        );
        // item 9741
        var end = goDownToEnd(graph, header.id);
        // item 15227
        var leftEdge = findLeftSkewerEdge(
        	pgraph,
        	header.id
        );
        // item 9757
        var y0 = header.y + header.h + Config.METRE;
        var y1 = y0 + Config.METRE + bra.h;
        // item 10055
        var aboveEndId = graph.getNodeUp(end);
        var aboveEnd = pgraph.graph.getNode(aboveEndId);
        // item 9827
        var x2;
        // item 15160
        var braLeft = header.x - width;
        // item 15222
        var x0 = leftEdge - Config.METRE;
        // item 9834
        x2 = header.x + width + bra.w
          + Config.METRE * 4;
        // item 10800
        var diaBox = findDiagramBox(pgraph.graph);
        // item 9759
        var y2 = diaBox.bottom + bra.h;
        var y3 = y2 + Config.METRE + bra.h;
        var yEnd = y1 + Config.METRE * 4 + bra.h +
          en.h;
        // item 9830
        if (x2 < diaBox.right) {
            // item 9833
            x2 = diaBox.right;
        }
        // item 9756
        var x1 = header.x;
        var x3 = x2 + bra.w * 2 + Config.METRE * 4;
        // item 9736
        buildMoveCommands(
        	pgraph,
        	movedNodes,
        	commands
        );
        // item 9739
        commList = Utils.objectValues(commands);
        // item 9806
        if (aboveEndId == header.id) {
            
        } else {
            // item 9754
            pushDeleteEdge(
            	commList,
            	header.down
            );
        }
        // item 9755
        pushDeleteEdge(
        	commList,
        	end.up
        );
        // item 9753
        pushDeleteNode(
        	commList,
        	end.id
        );
        // item 9764
        var t0 = generateId(editor.storage);
        var t1 = generateId(editor.storage);
        var t2 = generateId(editor.storage);
        var t3 = generateId(editor.storage);
        var b1 = generateId(editor.storage);
        var b2 = generateId(editor.storage);
        var b3 = generateId(editor.storage);
        var a1 = generateId(editor.storage);
        var a2 = generateId(editor.storage);
        var f0 = generateId(editor.storage);
        var f1 = generateId(editor.storage);
        var f2 = generateId(editor.storage);
        var endId = generateId(editor.storage);
        // item 9761
        pushInsertJunction(
        	commList,
        	t0,
        	x0, y0
        );
        // item 9765
        pushInsertJunction(
        	commList,
        	t1,
        	x1, y0
        );
        // item 9767
        pushInsertJunction(
        	commList,
        	t2,
        	x2, y0
        );
        // item 9766
        pushInsertJunction(
        	commList,
        	t3,
        	x3, y0
        );
        // item 15916
        var c1 = makeCont("Branch 1");
        var c2 = makeCont("Branch 2");
        var c3 = makeCont("Branch 3");
        // item 9760
        pushInsertNodeAt(
        	render,
        	commList,
        	b1,
        	"branch",
        	x1, y1,
        	width, bra.h,
        	c1
        );
        // item 9768
        pushInsertNodeAt(
        	render,
        	commList,
        	b2,
        	"branch",
        	x2, y1,
        	bra.w, bra.h,
        	c2
        );
        // item 9769
        pushInsertNodeAt(
        	render,
        	commList,
        	b3,
        	"branch",
        	x3, y1,
        	bra.w, bra.h,
        	c3
        );
        // item 9773
        pushInsertJunction(
        	commList,
        	f0,
        	x0, y3
        );
        // item 9774
        pushInsertJunction(
        	commList,
        	f1,
        	x1, y3
        );
        // item 9776
        pushInsertJunction(
        	commList,
        	f2,
        	x2, y3
        );
        // item 9777
        pushInsertNodeAt(
        	render,
        	commList,
        	a1,
        	"address",
        	x1, y2,
        	width, bra.h,
        	c2
        );
        // item 9778
        pushInsertNodeAt(
        	render,
        	commList,
        	a2,
        	"address",
        	x2, y2,
        	bra.w, bra.h,
        	c3
        );
        // item 9763
        connectVer(
        	editor,
        	commList,
        	header.id, t1,
        	null
        );
        // item 9779
        connectHor(
        	editor,
        	commList,
        	t0, t1,
        	"rarrow"
        );
        // item 9780
        connectHor(
        	editor,
        	commList,
        	t1, t2,
        	null
        );
        // item 9781
        connectHor(
        	editor,
        	commList,
        	t2, t3,
        	null
        );
        // item 9782
        connectVer(
        	editor,
        	commList,
        	t1, b1,
        	null
        );
        // item 9783
        connectVer(
        	editor,
        	commList,
        	t2, b2,
        	null
        );
        // item 9784
        connectVer(
        	editor,
        	commList,
        	t3, b3,
        	null
        );
        // item 9788
        connectHor(
        	editor,
        	commList,
        	f0, f1,
        	null
        );
        // item 9789
        connectHor(
        	editor,
        	commList,
        	f1, f2,
        	"sil_floor"
        );
        // item 9790
        connectVer(
        	editor,
        	commList,
        	t0, f0,
        	null
        );
        // item 9791
        connectVer(
        	editor,
        	commList,
        	a1, f1,
        	null
        );
        // item 9792
        connectVer(
        	editor,
        	commList,
        	a2, f2,
        	null
        );
        // item 9798
        if (aboveEndId == header.id) {
            // item 9802
            connectVer(
            	editor,
            	commList,
            	b1, a1,
            	"down"
            );
        } else {
            // item 9803
            var belowHeaderId = graph.getNodeDown(header);
            // item 9801
            connectVer(
            	editor,
            	commList,
            	b1, belowHeaderId,
            	"down"
            );
            // item 9804
            connectVer(
            	editor,
            	commList,
            	aboveEndId, a1,
            	"down"
            );
        }
        // item 9805
        connectVer(
        	editor,
        	commList,
        	b2, a2,
        	"down"
        );
        // item 9810
        pushInsertNodeAt(
        	render,
        	commList,
        	endId,
        	"end",
        	x3, yEnd,
        	en.w, en.h,
        	makeCont(getEnd())
        );
        // item 9811
        connectVer(
        	editor,
        	commList,
        	b3, endId,
        	"down"
        );
        // item 9681
        applyCommands(
        	editor,
        	commList,
        	null
        );
    }
}

function toggleCycleMark(editor, id) {
    // item 10581
    swapYesNo(editor, id);
}

function toggleSilhouette() {
    // item 22571
    if (ignoreCommand()) {
        
    } else {
        // item 16654
        if (hasDrakon()) {
            // item 12369
            if (isSilhouette(self.storage.graph)) {
                // item 12371
                toPrimitive(self);
            } else {
                // item 12370
                toSilhouette(self);
            }
        } else {
            // item 16657
            console.log("Not DRAKON")
        }
    }
}

function toggleTreeType() {
    // item 22465
    if ((ignoreCommand()) || (!(isMind()))) {
        
    } else {
        // item 22469
        mindAction("toggleTree", null, null)
    }
}

function topInnerCorner(editor, pgraph, source, target) {
    // item 6874
    var graphS = editor.storage.graph;
    var graph = pgraph.graph;
    // item 6861
    var movedNodes = {};
    var commandList = [];
    var delta;
    // item 6868
    var sourceEdge = graph.getEdge(source);
    var targetNode = graph.getNode(target);
    var sourceHead = graph.getHead(sourceEdge);
    var sourceTail = graph.getTail(sourceEdge);
    var leftEdge = graph.getEdge(targetNode.left);
    var targetLeft = graph.getHead(leftEdge);
    // item 7715
    var dims = findLedgeFromOrigin(
    	graph,
    	sourceTail.id,
    	targetLeft.id
    );
    // item 7719
    if (dims.y > targetNode.y) {
        // item 7718
        dropDown(
        	pgraph,
        	targetNode,
        	dims.y,
        	movedNodes
        );
    }
    // item 7749
    dims = findLedgeFromOrigin(
    	graph,
    	sourceTail.id,
    	targetLeft.id
    );
    // item 7741
    if (dims.x > targetNode.x) {
        // item 7742
        delta = dims.x - targetNode.x;
        // item 7740
        pgraph.moveRight(
        	target,
        	delta,
        	movedNodes
        );
    }
    // item 6870
    var newHor = deleteLiana(
    	editor,
    	graph,
    	sourceEdge,
    	commandList
    );
    // item 6878
    deleteNodeAndUp(
    	pgraph,
    	sourceEdge.tail,
    	newHor
    );
    // item 7743
    var sourceY = sourceHead.box.bottom + Config.METRE;
    // item 7724
    if (sourceY > targetNode.y) {
        // item 7723
        dropDown(
        	pgraph,
        	targetNode,
        	sourceY,
        	movedNodes
        );
    }
    // item 7735
    if (sourceHead.x == targetNode.x) {
        
    } else {
        // item 7737
        delta = targetNode.x - sourceHead.x;
        // item 7736
        pgraph.moveRight(
        	sourceHead.id,
        	delta,
        	movedNodes
        );
    }
    // item 6889
    drill(
    	pgraph,
    	sourceHead.x,
    	sourceHead.box.bottom,
    	targetNode.y,
    	movedNodes
    );
    // item 6892
    delete movedNodes[sourceTail.id];
    // item 6893
    var commands = {};
    // item 6894
    makeCommonWidth(
    	editor,
    	pgraph,
    	sourceHead.id,
    	target,
    	movedNodes,
    	commands
    );
    // item 6860
    buildMoveCommands(
    	pgraph,
    	movedNodes,
    	commands
    );
    // item 6859
    commandList = commandList.concat(
    	Utils.objectValues(commands)
    );
    // item 6871
    var bridge = generateId(editor.storage);
    // item 6872
    pushInsertDown(
    	commandList,
    	bridge,
    	sourceHead.id,
    	target
    );
    // item 6869
    return commandList;
}

function topOuterCorner(editor, pgraph, source, target) {
    // item 6830
    var graph = pgraph.graph;
    // item 6823
    var movedNodes = {};
    var commands = {};
    var delta;
    // item 6831
    var sourceEdge = graph.getEdge(source);
    var targetNode = graph.getNode(target);
    var sourceTail = graph.getTail(sourceEdge);
    var sourceHead = graph.getHead(sourceEdge);
    // item 7687
    var dims = findLedgeDimensions(
    	graph,
    	sourceTail.id,
    	target
    );
    // item 7692
    if (dims.y > targetNode.y) {
        // item 7691
        dropDown(
        	pgraph,
        	targetNode,
        	dims.y,
        	movedNodes
        );
    }
    // item 7705
    dims = findLedgeDimensions(
    	graph,
    	sourceTail.id,
    	target
    );
    // item 7696
    if (dims.x > targetNode.x) {
        // item 7697
        delta = dims.x - targetNode.x;
        // item 7695
        pgraph.moveRight(
        	target,
        	delta,
        	movedNodes
        );
    }
    // item 7701
    if (sourceTail.x == targetNode.x) {
        
    } else {
        // item 7703
        delta = targetNode.x - sourceTail.x;
        // item 7702
        pgraph.moveRight(
        	sourceTail.id,
        	delta,
        	movedNodes
        );
    }
    // item 6834
    drill(
    	pgraph,
    	sourceTail.x,
    	sourceTail.y,
    	targetNode.y,
    	movedNodes
    );
    // item 7748
    makeCommonWidth(
    	editor,
    	pgraph,
    	sourceTail.id,
    	target,
    	movedNodes,
    	commands
    );
    // item 6822
    buildMoveCommands(
    	pgraph,
    	movedNodes,
    	commands
    );
    // item 6821
    var commandList = Utils.objectValues(commands);
    // item 6835
    deleteLiana(
    	editor,
    	graph,
    	sourceEdge,
    	commandList
    );
    // item 6836
    var bridgeId = generateId(editor.storage);
    // item 6843
    pushInsertDown(
    	commandList,
    	bridgeId,
    	sourceHead.id,
    	target
    );
    // item 6832
    return commandList;
}

function transplantLiana(editor, prim) {
    // item 3369
    var selected = editor.transplantSource;
    // item 3370
    var socket = prepareSocketOp(editor, prim);
    var target = socket.id;
    // item 4126
    if ((typeof socket.action) === "string") {
        // item 3371
        console.log("trasplant not implemented: ", selected, target, socket.action);
    } else {
        // item 14487
        addTrace(
        	"transplant liana",
        	[socket.name, selected, target]
        )
        // item 23120
        console.log(socket.name)
        // item 5038
        var item = editor.storage.graph.getItem(
        	selected
        );
        // item 5039
        if (item.isLine) {
            
        } else {
            // item 5042
            selected = item.up;
        }
        // item 4145
        var pgraph = createPhysicalGraph(
        	editor.storage.graph,
        	editor.render
        );
        // item 4129
        var commandList = socket.action(
        	editor,
        	pgraph,
        	selected,
        	target
        );
        // item 18283
        if (commandList) {
            // item 4167
            applyCommands(
            	editor,
            	commandList,
            	null
            );
        }
    }
}

function traverseDown(graph, nodeId) {
    // item 14703
    var list = graph.getVerticalDown(nodeId);
    // item 14704
    return Utils.listToSet(list);
}

function traverseHorizontal(graph, itemId) {
    // item 14687
    var list = graph.getHorizontal(itemId);
    // item 14688
    return Utils.listToSet(list);
}

function traverseRightSide(graph, start, leftX, bottomY) {
    // item 11414
    var node;
    var result = [];
    var id = start;
    var direction = "down";
    while (true) {
        // item 11437
        node = graph.getNode(id);
        // item 11431
        result.push(node);
        // item 11426
        if (((node.x < leftX) && (node.y > bottomY)) || (node.type == "address")) {
            break;
        }
        // item 114160001
        if (direction === "down") {
            // item 11433
            if (node.right) {
                // item 19080
                var rNode = graph.getNodeRightEx(node)
                // item 19081
                if (rNode.up) {
                    // item 19083
                    id = null
                } else {
                    // item 19079
                    id = rNode.id
                    direction = "right";
                }
            } else {
                // item 11439
                if (node.down) {
                    // item 11443
                    id = graph.getNodeDown(node);
                    direction = "down";
                } else {
                    // item 11441
                    if (node.left) {
                        // item 11445
                        id = graph.getNodeLeft(node);
                        direction = "left";
                    } else {
                        // item 11444
                        id = null;
                    }
                }
            }
        } else {
            // item 114160002
            if (direction === "right") {
                // item 11446
                if (node.right) {
                    // item 11448
                    id = graph.getNodeRight(node);
                    direction = "right";
                } else {
                    // item 11449
                    if (node.down) {
                        // item 11451
                        id = graph.getNodeDown(node);
                        direction = "down";
                    } else {
                        // item 11452
                        id = null;
                    }
                }
            } else {
                // item 114160003
                if (direction === "left") {
                    // item 11453
                    if (node.down) {
                        // item 11454
                        id = graph.getNodeDown(node);
                        direction = "down";
                    } else {
                        // item 11455
                        if (node.left) {
                            // item 11456
                            id = graph.getNodeLeft(node);
                            direction = "left";
                        } else {
                            // item 11459
                            if (node.up) {
                                // item 11460
                                id = graph.getNodeUp(node);
                                direction = "up";
                            } else {
                                // item 11462
                                id = null;
                            }
                        }
                    }
                } else {
                    // item 114160004
                    if (direction === "up") {
                        
                    } else {
                        // item 114160005
                        throw "Unexpected switch value: " + direction;
                    }
                    // item 11463
                    if (node.left) {
                        // item 11464
                        id = graph.getNodeLeft(node);
                        direction = "left";
                    } else {
                        // item 11466
                        if (node.up) {
                            // item 11467
                            id = graph.getNodeUp(node);
                            direction = "up";
                        } else {
                            // item 11469
                            id = null;
                        }
                    }
                }
            }
        }
        // item 11410
        if (id) {
            
        } else {
            break;
        }
    }
    // item 11415
    return result;
}

function traverseUp(graph, nodeId) {
    // item 14696
    var list = graph.getVerticalUp(nodeId);
    // item 14697
    return Utils.listToSet(list);
}

function traverseVertical(graph, itemId) {
    // item 14680
    var list = graph.getVertical(itemId);
    // item 14681
    return Utils.listToSet(list);
}

function trimContent(cont) {
    // item 17452
    cont = Utils.copyObject(cont) || makeCont("")
    // item 17451
    var text = cont.txt || ""
    cont.txt = text.trim()
    // item 17450
    var text2 = cont.txt2 || ""
    cont.txt2 = text2.trim()
    // item 17453
    return cont
}

function turnInto(x, y, itemId) {
    // item 21818
    var graph = self.storage.graph
    var item = graph.getItem(itemId)
    // item 21817
    var available = getMindTypes()
    var i
    // item 218200001
    i = 0;
    while (true) {
        // item 218200002
        if (i < available.length) {
            
        } else {
            break;
        }
        // item 21825
        var avItem = available[i]
        // item 21822
        if (avItem.type == item.type) {
            // item 21819
            available.splice(i, 1)
            break;
        }
        // item 218200003
        i++;
    }
    // item 21826
    var menu = []
    // item 218270001
    var _ind21827 = 0;
    var _col21827 = available;
    var _len21827 = _col21827.length;
    while (true) {
        // item 218270002
        if (_ind21827 < _len21827) {
            
        } else {
            break;
        }
        // item 218270004
        var avItem2 = _col21827[_ind21827];
        // item 21829
        var item = makeTurnIntoElement(
        	itemId,
        	avItem2
        )
        // item 21837
        menu.push(item)
        // item 218270003
        _ind21827++;
    }
    // item 21848
    showContextMenu(x, y - 30, menu)
}

function updateCanvasEdge(canvas, id, selection) {
    // item 11235
    var render = canvas.render;
    var graph = canvas.graph;
    // item 902
    var edge = graph.getEdge(id);
    // item 903
    Items.eraseFromRender(render, edge);
    // item 1038
    Items.renderItem(graph, render, edge, selection);
}

function updateCanvasSockets(canvas) {
    // item 3222
    var old = canvas.sockets;
    canvas.sockets = {};
    // item 32230001
    var _ind3223 = 0;
    var _col3223 = old;
    var _keys3223 = Object.keys(_col3223); 
    var _len3223 = _keys3223.length;
    while (true) {
        // item 32230002
        if (_ind3223 < _len3223) {
            
        } else {
            break;
        }
        // item 32230004
        var prim = _keys3223[_ind3223]; var oldSocket = _col3223[prim];
        // item 3228
        canvas.render.deleteItem(prim);
        // item 3255
        insertCanvasSocket(
        	canvas,
        	oldSocket
        );
        // item 32230003
        _ind3223++;
    }
}

function updateDiagram(storage, command, isUndo) {
    // item 11257
    var pers = storage.persistence;
    // item 17554
    var fields
    // item 17555
    if (isUndo) {
        // item 17558
        fields = command.undo
    } else {
        // item 17559
        fields = command.fields
    }
    // item 175600001
    var _ind17560 = 0;
    var _col17560 = fields;
    var _keys17560 = Object.keys(_col17560); 
    var _len17560 = _keys17560.length;
    while (true) {
        // item 175600002
        if (_ind17560 < _len17560) {
            
        } else {
            break;
        }
        // item 175600004
        var name = _keys17560[_ind17560]; var value = _col17560[name];
        // item 17562
        storage[name] = value
        // item 175600003
        _ind17560++;
    }
}

function updateFreeNode(free, node) {
    // item 16736
    var old = free.get(node.id);
    // item 167370001
    var _ind16737 = 0;
    var _col16737 = node;
    var _keys16737 = Object.keys(_col16737); 
    var _len16737 = _keys16737.length;
    while (true) {
        // item 167370002
        if (_ind16737 < _len16737) {
            
        } else {
            break;
        }
        // item 167370004
        var name = _keys16737[_ind16737]; var value = _col16737[name];
        // item 16739
        old[name] = value;
        // item 167370003
        _ind16737++;
    }
}

function updateNode(render, graph, node) {
    // item 15773
    var old = graph.getNode(node.id);
    // item 157740001
    var _ind15774 = 0;
    var _col15774 = node;
    var _keys15774 = Object.keys(_col15774); 
    var _len15774 = _keys15774.length;
    while (true) {
        // item 157740002
        if (_ind15774 < _len15774) {
            
        } else {
            break;
        }
        // item 157740004
        var name = _keys15774[_ind15774]; var value = _col15774[name];
        // item 15777
        if (graph.nonUpdatable[name]) {
            // item 15780
            Utils.throwError(
             "Field '" + name + "' cannot be updated.");
            break;
        }
        // item 15776
        old[name] = value;
        // item 157740003
        _ind15774++;
    }
}

function visualDrag(dx, dy, visibleBox) {
    // item 16470
    if ((self.readonly) || (!(self.dragOn))) {
        
    } else {
        // item 19211
        self.render.clearGuides()
        // item 16839
        if (gDragStartItem) {
            // item 16326
            var pgraph = self.canvas.pgraph;
            // item 12155
            var change = pgraph.physicalDrag(
            	dx,
            	dy
            );
            // item 121560001
            var _ind12156 = 0;
            var _col12156 = change.nodes;
            var _keys12156 = Object.keys(_col12156); 
            var _len12156 = _keys12156.length;
            while (true) {
                // item 121560002
                if (_ind12156 < _len12156) {
                    
                } else {
                    break;
                }
                // item 121560004
                var id = _keys12156[_ind12156]; var _ = _col12156[id];
                // item 16325
                var node = pgraph.graph.getNode(id);
                // item 12158
                self.changedNodes[id] = true;
                // item 12159
                moveCanvasNode(
                	self.canvas,
                	id,
                	node.x,
                	node.y
                );
                // item 121560003
                _ind12156++;
            }
            // item 121600001
            var _ind12160 = 0;
            var _col12160 = change.edges;
            var _keys12160 = Object.keys(_col12160); 
            var _len12160 = _keys12160.length;
            while (true) {
                // item 121600002
                if (_ind12160 < _len12160) {
                    
                } else {
                    break;
                }
                // item 121600004
                var edge = _keys12160[_ind12160]; var _ = _col12160[edge];
                // item 12162
                updateCanvasEdge(
                	self.canvas,
                	edge,
                	self.storage.selection.ids
                );
                // item 121600003
                _ind12160++;
            }
            // item 12163
            updateCanvasSockets(self.canvas);
            // item 19349
            drawDrakonGuides(
            	self.render,
            	pgraph.graph,
            	gDragStartItem,
            	visibleBox
            )
        } else {
            // item 16844
            var free = self.canvas.free
            // item 168410001
            var _ind16841 = 0;
            var _col16841 = gDragItems;
            var _len16841 = _col16841.length;
            while (true) {
                // item 168410002
                if (_ind16841 < _len16841) {
                    
                } else {
                    break;
                }
                // item 168410004
                var id = _col16841[_ind16841];
                // item 16843
                var item = free.get(id)
                // item 16845
                var x = item.x + dx
                var y = item.y + dy
                // item 16846
                moveCanvasNode(
                	self.canvas,
                	id,
                	x,
                	y
                );
                // item 168410003
                _ind16841++;
            }
            // item 19154
            if ((gMoveAllPrim) && (gShouldMoveAll)) {
                // item 19153
                gMoveAllPos.x += dx
                gMoveAllPos.y += dy
                
                render.moveItem(
                	gMoveAllPrim,
                	gMoveAllPos.x,
                	gMoveAllPos.y
                )
            }
            // item 19212
            drawFreeGuides(
            	self,
            	visibleBox
            )
        }
    }
}


this.test = {

canDeleteItem: canDeleteItem,
insertSimpleItem: insertSimpleItem,
insertQuestion: insertQuestion,
deleteItem: deleteItem,
setItemText: setItemText,
selectItem: selectItem,
transplantLiana: transplantLiana,
leftInnerLine: leftInnerLine,
leftOuterLine: leftOuterLine,
leftOuterCorner: leftOuterCorner,
onOuterFloor: onOuterFloor,
onInnerFloor: onInnerFloor,
leftOuterLine: leftOuterLine,
leftInnerLine: leftInnerLine,
leftInnerLineEx: leftInnerLineEx,
rightLine: rightLine,
rightCorner: rightCorner,
leftOuterCorner: leftOuterCorner,
leftInnerCorner: leftInnerCorner,
topOuterCorner: topOuterCorner,
topInnerCorner: topInnerCorner,
leftInnerLine: leftInnerLine,
collapseBolt: collapseBolt,
expandBolt: expandBolt,
createCycle: createCycle,
detectInternalCycle: detectInternalCycle,
detectOuterCycle: detectOuterCycle,
toSilhouette: toSilhouette,
toPrimitive: toPrimitive,
onOuterSilFloor: onOuterSilFloor,
leftOuterCornerSil: leftOuterCornerSil,
renameBranch: renameBranch,
insertBranch: insertBranch,
shortCycleDown: shortCycleDown,
insertPath: insertPath,
insertItem: insertItem,
deletePath: deletePath,
findCycleStartCandidates: findCycleStartCandidates,
pasteBlock: pasteBlock,
toFront: toFront,
toBack: toBack,
setContent: setContent
};



function FakePersistence() {
	var self = this;
	
	self.add = function(item) {}
	self.remove = function(id) {}
	self.update = function(item) {}
	self.updateDiagram = function(name) {}
	self.persist = function() {}
}

buildFreeBuilders()
}
